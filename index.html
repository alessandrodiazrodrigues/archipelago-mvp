<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago Dashboard</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* =================== VARIÁVEIS GLOBAIS - CORPORATIVO ATUALIZADO =================== */
    :root {
      /* Layout Principal - Azul Corporativo SÓLIDO */
      --nav-sidebar: #60a5fa;
      --nav-header: #3b82f6; /* SEM gradiente - azul sólido */
      --bg-primary: #3b82f6; /* Azul sólido */
      --bg-secondary: #3b82f6; /* Azul sólido */
      --card: #1a1f2e;
      --card-hover: #242938;
      --text-white: #ffffff;
      --text: #ffffff;
      --text-muted: #e2e8f0;
      --text-accent: #60a5fa;
      --border: #334155;
      --border-light: #475569;

      /* Status e Complexidade ATUALIZADO */
      --status-vago: #16a34a;
      --status-uso: #ffffff; /* BRANCO conforme solicitado */
      --status-uti: #dc2626;
      --complex-1: #22c55e;
      --complex-2: #f59e0b;
      --complex-3: #dc2626;

      /* Timeline 24h */
      --ouro: #fbbf24;
      --r2: #3b82f6;
      --r3: #8b5cf6;

      /* Campos de Destaque - Azul Claro */
      --destaque: #8FD3F4;

      /* Concessões - CORES PANTONE ATUALIZADAS */
      --conc-transicao: #007A53;
      --conc-aplicacao: #582C83;
      --conc-fisioterapia: #009639;
      --conc-fonoaudiologia: #FF671F;
      --conc-aspiracao: #2E1A47;
      --conc-banho: #8FD3F4;
      --conc-curativos: #00BFB3;
      --conc-oxigenoterapia: #64A70B;
      --conc-recarga: #00AEEF;
      --conc-nutricional-com: #FFC72C;
      --conc-nutricional-sem: #F4E285;
      --conc-clister: #E8927C;
      --conc-picc: #E03C31;

      /* Linhas de Cuidado - CORES PANTONE ATUALIZADAS */
      --linha-assiste: #ED0A72;
      --linha-aps: #007A33;
      --linha-paliativos: #00B5A2;
      --linha-ico: #A6192E;
      --linha-oncologia: #6A1B9A;
      --linha-pediatria: #5A646B;
      --linha-auto-gastro: #5C5EBE;
      --linha-auto-neuro-desm: #00AEEF;
      --linha-auto-neuro-musc: #00263A;
      --linha-auto-reumato: #582D40;
      --linha-vida-leve: #FFB81C;
      --linha-card: #C8102E;
      --linha-endocrino: #582C83;
      --linha-geriatria: #FF6F1D;
      --linha-melhor: #556F44;
      --linha-neurologia: #0072CE;
      --linha-pneumologia: #E35205;
      --linha-pos-bariatrica: #003C57;
      --linha-reumatologia: #5A0020;

      /* Cores específicas para hospitais */
      --hospital-neomater: #ffffff; /* FUNDO BRANCO conforme solicitado */
      --hospital-neomater-text: #0a2b52; /* Texto azul para contraste */
      --hospital-cruz-azul: #60a5fa;

      /* Sombras e Efeitos */
      --shadow: 0 4px 12px rgba(11,44,82,.08);
      --shadow-2: 0 10px 28px rgba(11,44,82,.12);
      --gradient-header: #3b82f6; /* SEM gradiente */
      --gradient-card: linear-gradient(145deg, var(--card) 0%, var(--card-hover) 100%);
      --gradient-button: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    /* =================== BASE STYLES =================== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0; overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
      background: var(--bg-primary); /* Fundo azul sólido */
      color: var(--text);
      padding-left: 0;
      transition: padding-left 0.3s ease;
    }

    body.menu-open {
      padding-left: 300px;
    }

    /* =================== LOADING OVERLAY =================== */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000; transition: opacity 0.3s ease;
    }

    .loading-spinner {
      width: 60px; height: 60px; border: 3px solid var(--border);
      border-top: 3px solid var(--text-accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 15px; font-size: 16px; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loadingOverlay.hidden { display: none; }

    /* =================== HEADER CORPORATIVO =================== */
    header {
      background: var(--gradient-header); /* Azul sólido */
      color: var(--text-white); padding: 15px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-2);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      transition: all 0.3s ease;
    }

    .header-left { display: flex; align-items: center; gap: 20px; }
    .hamburger-menu { 
      font-size: 24px; cursor: pointer; 
      display: block;
    }

    .brand h1 {
      margin: 0; font-size: 20px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    .header-right {
      display: flex; align-items: center; gap: 16px;
    }

    #lastUpdateInfo {
      font-size: 12px; color: var(--text-muted);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-btn {
      background: var(--gradient-button); border: 1px solid var(--border);
      color: var(--text-white); border-radius: 10px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease; position: relative;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .header-btn:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4);
    }

    /* =================== MENU LATERAL CORPORATIVO (300px) =================== */
    #side-menu {
      position: fixed; top: 0; left: -300px; width: 300px; height: 100%;
      background: var(--nav-sidebar);
      box-shadow: var(--shadow-2);
      border-right: 1px solid var(--border);
      z-index: 1001; padding-top: 60px;
      transition: left 0.3s ease; display: flex; flex-direction: column;
    }

    #side-menu.open {
      left: 0;
    }

    /* Botão de fechar dentro do menu lateral */
    .close-menu-btn { 
      position: absolute; top: 15px; right: 15px;
      font-size: 14px; cursor: pointer;
      background: rgba(255,255,255,0.15); padding: 6px 10px;
      border-radius: 6px; border: 1px solid rgba(255,255,255,0.25);
      color: var(--text-white); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      display: block;
    }

    .close-menu-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .menu-items {
      flex: 1; padding: 0 0 120px 0; overflow-y: auto;
    }

    .side-menu-item {
      display: flex; align-items: center; gap: 15px;
      padding: 20px 25px; color: var(--text-white); text-decoration: none;
      font-size: 16px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-left: 4px solid transparent;
      transition: all 0.3s ease; height: 60px;
    }

    .side-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: var(--text-white);
    }

    .side-menu-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: var(--text-white);
      color: var(--text-white);
    }

    .menu-footer {
      position: absolute; bottom: 20px; left: 20px; right: 20px;
    }

    .settings-menu-btn {
      width: 100%; background: rgba(255, 255, 255, 0.1); 
      border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-white); 
      border-radius: 12px; padding: 15px; cursor: pointer; 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; 
      transition: all 0.3s ease; display: flex; align-items: center; 
      justify-content: center; gap: 10px; position: relative;
    }

    .settings-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .settings-dropdown-menu {
      display: none; position: absolute; bottom: 110%; left: 0; right: 0;
      background: var(--card); border-radius: 12px; box-shadow: var(--shadow);
      overflow: hidden; border: 1px solid var(--border); margin-bottom: 10px;
    }

    .settings-dropdown-menu.show { display: block; }

    .settings-dropdown-item {
      padding: 12px 15px; color: var(--text); font-size: 14px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    }

    .settings-dropdown-item:last-child {
      border-bottom: none;
    }

    .settings-dropdown-item:hover {
      background: var(--card-hover);
    }

    /* =================== MAIN CONTENT =================== */
    main {
      max-width: 1600px; margin: 18px auto 100px; padding: 0 24px;
      background: rgba(26, 31, 46, 0.3); border-radius: 20px;
      backdrop-filter: blur(10px); border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    /* =================== SELETORES DE HOSPITAL =================== */
    .hospital-selector {
      display: flex; justify-content: center; gap: 20px; margin: 20px 0 30px 0;
      padding: 20px; background: rgba(26, 31, 46, 0.5); border-radius: 16px;
      border: 1px solid var(--border);
    }

    .hospital-btn {
      background: var(--gradient-button); border: 1px solid var(--border);
      color: var(--text-white); border-radius: 12px; padding: 12px 24px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
      font-size: 16px;
    }

    .hospital-btn:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4);
      transform: translateY(-2px);
    }

    .hospital-btn.active {
      background: var(--hospital-neomater); /* FUNDO BRANCO */
      color: var(--hospital-neomater-text); /* TEXTO AZUL */
      border-color: var(--hospital-neomater-text);
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.5);
    }

    .hospital-btn.active.cruz-azul {
      background: linear-gradient(135deg, var(--hospital-cruz-azul) 0%, #3b82f6 100%);
      color: var(--text-white);
      border-color: var(--hospital-cruz-azul);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.5);
    }

    /* =================== CARDS DE LEITOS ATUALIZADOS =================== */
    .grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 18px; position: relative; z-index: 1;
    }

    .card {
      background: var(--gradient-card); border-radius: 20px; padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transform: translateY(0); transition: transform 0.18s ease, box-shadow 0.18s ease;
      backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16), 0 26px 64px rgba(11,44,82,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
    }

    .card .top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; margin-bottom: 10px;
    }

    .badge {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text-accent); font-size: 12px; padding: 4px 10px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status {
      background: var(--card); border: 1px solid var(--border);
      color: var(--text); font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 4px 10px; border-radius: 999px;
      display: inline-flex; align-items: center; gap: 6px;
    }

    .status.ok {
      background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);
      color: var(--status-vago);
    }

    .status.warn {
      background: var(--status-uso); /* FUNDO BRANCO */
      border-color: rgba(0, 0, 0, 0.3);
      color: #000000; /* TEXTO PRETO para contraste */
    }

    .tipo {
      font-size: 12px; color: var(--text-white); padding: 6px 10px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center;
      min-height: 28px; /* CENTRALIZAÇÃO VERTICAL */
    }

    .tipo.uti {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
    }

    .tipo.enf {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }

    .row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }

    .field {
      background: rgba(96, 165, 250, 0.05); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px; backdrop-filter: blur(5px);
    }

    /* CAMPOS DE DESTAQUE - Tempo de Internação e Prev. Alta */
    .field.destaque {
      background: var(--destaque);
      border-color: rgba(143, 211, 244, 0.5);
      color: #000000;
    }

    .field.destaque .label {
      color: #000000;
      font-weight: 700;
    }

    .field.destaque .value {
      color: #000000;
      font-weight: 700;
    }

    .field .label {
      font-size: 11px; color: var(--text-muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .field .value {
      color: var(--text); font-weight: 600;
    }

    .wrap { display: flex; flex-wrap: wrap; gap: 6px; }

    .chip {
      font-size: 12px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-accent);
      padding: 2px 8px; border-radius: 999px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;
    }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); padding: 10px 14px; border-radius: 12px;
      cursor: pointer; transition: all 0.2s ease; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn.primary {
      background: var(--gradient-button); border-color: var(--text-accent);
      color: var(--text-white); box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .btn.danger {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
      border-color: var(--status-uti); color: var(--text-white);
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
    }

    /* =================== DASHBOARDS =================== */
    .dash-grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-6 { grid-template-columns: repeat(6, 1fr); }
    .grid-7 { grid-template-columns: repeat(7, 1fr); }

    @media (max-width: 1200px) {
      .grid-2 { grid-template-columns: 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
      .grid-7 { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 900px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-6 { grid-template-columns: repeat(2, 1fr); }
      .grid-7 { grid-template-columns: repeat(2, 1fr); }
    }

    .dashboard-card {
      background: var(--gradient-card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 20px; 
      box-shadow: var(--shadow); margin-bottom: 24px;
      backdrop-filter: blur(10px);
    }

    .dashboard-card h3 {
      margin: 0 0 15px 0; font-size: 18px; color: var(--text-white);
      text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .dashboard-card h4 {
      margin: 20px 0 10px 0; font-size: 14px; color: var(--text-white);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .kpi-card {
      background: var(--gradient-card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 15px; text-align: center; 
      position: relative; box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .kpi-value {
      font-size: 36px; font-weight: 700; color: var(--text-accent);
    }

    .kpi-label {
      font-size: 13px; color: var(--text-muted); margin-top: 5px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    /* KPI com gauge */
    .kpi-card-with-gauge {
      position: relative; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-gauge-mini {
      width: 80px; 
      height: 50px;
      margin-bottom: 10px;
    }

    .kpi-gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      margin-top: -10px;
    }

    /* Gauge específico para Dashboard Hospitais */
    .dash-hospital-header { 
      display: flex; align-items: center; gap: 24px; margin-bottom: 20px; 
    }
    
    .gauge-wrapper { 
      position: relative; width: 150px; height: 100px; 
    }
    
    .gauge-wrapper canvas { 
      width: 100% !important; height: auto !important; 
    }
    
    .gauge-text { 
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); 
      text-align: center; 
    }
    
    .gauge-text .percent { 
      font-size: 24px; font-weight: 700; color: var(--text-accent); 
    }

    .gauge-text .label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-stats { 
      flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
    }
    
    .header-stats .stat-box { 
      padding: 10px; text-align: left; background: rgba(96, 165, 250, 0.1); 
      border-radius: 10px; border: 1px solid var(--border);
      backdrop-filter: blur(5px);
    }

    .header-stats .stat-value { 
      font-size: 22px; font-weight: bold; color: var(--text-accent); 
    }

    .header-stats .stat-label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .chart-container { position: relative; width: 100%; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    /* =================== RESPONSIVIDADE =================== */
    @media (max-width: 1024px) {
      /* Em telas pequenas, o comportamento permanece o mesmo */
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .dash-hospital-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-stats {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }

    /* =================== MODAIS =================== */
    .backdrop {
      position: fixed; inset: 0; background: rgba(10, 15, 28, 0.8);
      backdrop-filter: blur(10px); display: none; align-items: center;
      justify-content: center; padding: 16px; z-index: 2000; overflow: auto;
    }

    .modal {
      background: var(--gradient-card); max-width: 860px; width: 100%;
      max-height: 90vh; border-radius: 20px; border: 1px solid var(--border);
      box-shadow: var(--shadow-2); overflow: hidden;
      display: flex; flex-direction: column; backdrop-filter: blur(15px);
    }

    .modal header {
      background: var(--gradient-header); border-bottom: 1px solid var(--border);
      color: var(--text-white); display: flex; align-items: center;
      justify-content: space-between; padding: 12px 16px; flex-shrink: 0;
    }

    .modal header strong {
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .modal .content {
      padding: 16px; overflow-y: auto; flex: 1;
    }

    .modal .actions {
      background: rgba(26, 31, 46, 0.5); border-top: 1px solid var(--border);
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 12px 16px; flex-shrink: 0;
    }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    .input, .select2, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 12px; background: var(--card); color: var(--text);
      font-weight: 600;
    }

    .label {
      font-size: 12px; color: var(--text-muted); margin-bottom: 4px;
      display: block; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* =================== COLOR PICKER MODAL =================== */
    .color-picker-modal {
      max-width: 800px;
    }

    .color-section {
      margin-bottom: 20px; padding: 15px; 
      background: rgba(96, 165, 250, 0.05); border-radius: 12px;
      border: 1px solid var(--border);
    }

    .color-section h4 {
      margin: 0 0 15px 0; color: var(--text-white);
      font-weight: 600; text-transform: uppercase;
    }

    .color-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .color-item:last-child {
      border-bottom: none;
    }

    .color-preview {
      width: 30px; height: 30px; border-radius: 8px;
      border: 2px solid var(--border); cursor: pointer;
    }

    .color-input {
      width: 80px; padding: 4px 8px; border: 1px solid var(--border);
      border-radius: 8px; background: var(--card); color: var(--text);
      font-size: 12px; font-family: monospace;
    }

    /* =================== UTILIDADES =================== */
    .hidden { display: none; }

    .success-message {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--gradient-card); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px; text-align: center;
      box-shadow: var(--shadow-2); z-index: 3000; display: none;
      color: var(--text); backdrop-filter: blur(15px);
    }

    .success-message h2 {
      color: var(--text-accent); font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

 
/* =================== IMPRESSÃO DE QR CODES - VERSÃO OTIMIZADA A4 =================== */
@media print {
  @page {
    size: A4;
    margin: 3mm;
  }
  
  /* ESCONDER TUDO PRIMEIRO */
  * {
    visibility: hidden !important;
    color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* MOSTRAR APENAS O MODAL DE QR */
  #modalBulkQR {
    visibility: visible !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: white !important;
    z-index: 9999 !important;
    display: block !important;
    overflow: visible !important;
  }
  
  #modalBulkQR * {
    visibility: visible !important;
  }
  
  /* ESCONDER CONTROLES */
  #modalBulkQR header,
  #modalBulkQR .content > div:first-child,
  #modalBulkQR button {
    visibility: hidden !important;
    display: none !important;
  }
  
  /* MOSTRAR APENAS O GRID */
  #modalBulkQR .content {
    visibility: visible !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    height: 100% !important;
    overflow: visible !important;
    background: white !important;
  }
  
  #qr_grid {
    visibility: visible !important;
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 2mm !important;
    width: 100% !important;
    height: auto !important;
    padding: 2mm !important;
    margin: 0 !important;
    background: white !important;
    page-break-inside: auto !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
  }
  
  .qr-cell {
    visibility: visible !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    width: 58mm !important;
    height: 68mm !important;
    background: white !important;
    border: 2px solid #000 !important;
    border-radius: 2mm !important;
    padding: 2mm !important;
    margin: 0 !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
    box-sizing: border-box !important;
  }
  
  /* QUEBRA DE PÁGINA A CADA 9 ITENS */
  .qr-cell:nth-child(9n) {
    page-break-after: always !important;
    break-after: page !important;
  }
  
  /* QR CODE E IMAGEM */
  .qr-cell > div:first-child {
    visibility: visible !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 45mm !important;
    height: 45mm !important;
    margin: 0 !important;
    margin-bottom: 2mm !important;
    background: white !important;
  }
  
  .qr-cell img,
  .qr-cell canvas {
    visibility: visible !important;
    display: block !important;
    width: 45mm !important;
    height: 45mm !important;
    max-width: 45mm !important;
    max-height: 45mm !important;
    margin: 0 !important;
    background: white !important;
    opacity: 1 !important;
  }
  
  /* TEXTO DO LEITO */
  .qr-cell > div:last-child {
    visibility: visible !important;
    display: block !important;
    font-size: 10pt !important;
    color: #000 !important;
    font-weight: bold !important;
    text-align: center !important;
    margin: 0 !important;
    margin-top: 2mm !important;
    line-height: 1.2 !important;
    font-family: Arial, sans-serif !important;
  }
  
  /* GARANTIR QUE TUDO NO QR-CELL APAREÇA */
  .qr-cell,
  .qr-cell * {
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  /* LIMPAR BODY */
  body {
    margin: 0 !important;
    padding: 0 !important;
    background: white !important;
    overflow: visible !important;
  }
}
  </style>
</head>

<!-- 
═════════════════════════════════════════════════════════════════
🎯 AQUI TERMINA A PARTE 1 DE 4 - HEAD + CSS ATUALIZADO
═════════════════════════════════════════════════════════════════
✅ IMPLEMENTADO:
- Cores Pantone completas (19 linhas + 13 concessões)  
- Fundo azul sólido (sem gradiente)
- Status "Em uso" = fundo branco
- Ícones centralizados
- Campos de destaque em azul claro
- CSS de impressão TOTALMENTE CORRIGIDO com paginação

🚀 PRÓXIMA: PARTE 2/4 - HTML/BODY
═════════════════════════════════════════════════════════════════
-->
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <!-- Menu Lateral -->
  <div id="side-menu">
    <!-- Botão de fechar dentro do menu -->
    <button class="close-menu-btn" id="closeMenuBtn">✕ Fechar</button>

    <!-- Items do Menu -->
    <div class="menu-items">
      <a href="#" class="side-menu-item active" data-tab="leitos">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2.5 12a.5.5 0 0 1 .5-.5h18a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
          <path d="M20 16H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2zM9 8H7v6h2V8z"/>
        </svg>
        <span>Leitos (Cards)</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash1">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 20v-6M12 8V2M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M17.66 6.34l-4.24 4.24M6.34 17.66l-4.24 4.24M22 12h-6M8 12H2"/>
        </svg>
        <span>Dash Hospitais</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash2">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 20V10M12 20V4M6 20V14"/>
        </svg>
        <span>Dashboard Executivo</span>
      </a>
    </div>

    <!-- Footer do Menu com Configurações -->
    <div class="menu-footer">
      <button class="settings-menu-btn" id="settingsMenuBtn">
        <span>⚙️</span>
        <span>Configurações</span>
        <div class="settings-dropdown-menu" id="settingsMenuDropdown">
          <div class="settings-dropdown-item" id="btnReadQR">Ler QR Code</div>
          <div class="settings-dropdown-item" id="btnPrintQR">Imprimir QR Codes</div>
          <div class="settings-dropdown-item" id="btnColors">Seleção de Cores</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-left">
      <div class="hamburger-menu" id="hamburgerMenu">☰</div>
      <div class="brand">
        <h1>Archipelago Dashboard</h1>
      </div>
    </div>
    
    <div class="header-right">
      <span id="lastUpdateInfo"></span>
      <button class="header-btn" id="refreshBtn">Atualizar</button>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Leitos View -->
    <section id="leitosView">
      <!-- Seletor de Hospitais -->
      <div class="hospital-selector">
        <button class="hospital-btn active" id="btnNeomater" data-hospital="H1">
          🏥 Neomater
        </button>
        <button class="hospital-btn" id="btnCruzAzul" data-hospital="H2">
          🏥 Cruz Azul
        </button>
      </div>
      
      <!-- Grid de Cards -->
      <div class="grid" id="cardsContainer"></div>
    </section>

    <!-- Dashboard Hospitais -->
    <section id="dash1" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dash Hospitais: Visão Detalhada por Hospital</h2>
      <div class="dash-grid grid-2">
        <!-- Neomater -->
        <div class="dashboard-card" id="dash-card-h1">
          <h3>Neomater</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacao1"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercent1">0%</div>
                <div class="label">Ocupação</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statTotal1">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statOcupados1">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagos1">0</div>
                <div class="stat-label">Vagos</div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <h4>Projeção de Concessões</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoes1"></canvas>
          </div>

          <h4>Projeção de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhas1"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidade1"></canvas>
          </div>
        </div>

        <!-- Cruz Azul -->
        <div class="dashboard-card" id="dash-card-h2">
          <h3>Cruz Azul</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacao2"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercent2">0%</div>
                <div class="label">Ocupação</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statTotal2">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statOcupados2">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagos2">0</div>
                <div class="stat-label">Vagos</div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <h4>Projeção de Concessões</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoes2"></canvas>
          </div>

          <h4>Projeção de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhas2"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidade2"></canvas>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Dashboard Executivo -->
    <section id="dash2" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dashboard Executivo: Rede Hospitalar Externa</h2>
      
      <!-- KPIs Operacionais Consolidados -->
      <div class="dashboard-card">
        <h3>KPIs Operacionais Consolidados</h3>
        <div class="dash-grid grid-7">
          <div class="kpi-card kpi-card-with-gauge">
            <div class="kpi-gauge-mini">
              <canvas id="kpiGaugeOcupacao"></canvas>
              <div class="kpi-gauge-text">
                <div class="kpi-value" id="kpiOcupacaoGeral" style="font-size: 24px;">0%</div>
              </div>
            </div>
            <div class="kpi-label">Taxa de Ocupação Geral</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiLeitosOcupados">0</div>
            <div class="kpi-label">Total de Leitos Ocupados</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiTMP">0 dias</div>
            <div class="kpi-label">Tempo Médio Permanência</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiRotatividade">0%</div>
            <div class="kpi-label">Taxa de Rotatividade</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiAltas24h">0</div>
            <div class="kpi-label">Altas Previstas em 24h</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiSpictPercent">0%</div>
            <div class="kpi-label">SPICT-BR Elegível</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiPpsMedia">0</div>
            <div class="kpi-label">PPS Média Geral</div>
          </div>
        </div>
      </div>

      <!-- Análise Preditiva de Altas -->
      <div class="dashboard-card">
        <h3>Análise Preditiva de Altas</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Comparativo por Prazo</h4>
            <div class="chart-container h-250">
              <canvas id="chartAltasComparativo"></canvas>
            </div>
          </div>
          <div>
            <h4>Timeline de Liberação em 24h</h4>
            <div class="chart-container h-250">
              <canvas id="chartTimeline24h"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Projeções Consolidadas -->
      <div class="dashboard-card">
        <h3>Projeções Consolidadas (7 dias)</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Concessões Necessárias</h4>
            <div class="chart-container h-300">
              <canvas id="chartConcessoesConsolidado"></canvas>
            </div>
          </div>
          <div>
            <h4>Linhas de Cuidado</h4>
            <div class="chart-container h-300">
              <canvas id="chartLinhasConsolidado"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Eficiência Operacional -->
      <div class="dashboard-card">
        <h3>Eficiência Operacional</h3>
        <div class="chart-container h-400">
          <canvas id="chartEficienciaRadar"></canvas>
        </div>
      </div>

      <!-- Análise PPS e SPICT -->
      <div class="dash-grid grid-2">
        <div class="dashboard-card">
          <h3>Análise PPS (Performance Status)</h3>
          <div class="chart-container h-250">
            <canvas id="chartPpsAnalise"></canvas>
          </div>
        </div>
        <div class="dashboard-card">
          <h3>Análise SPICT-BR</h3>
          <div class="chart-container h-250">
            <canvas id="chartSpictAnalise"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Admissão -->
  <div id="modalAdmissao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Admissão de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matrícula (número)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0–10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="a_complexidade">Complexidade</label>
            <select id="a_complexidade" class="select2">
              <option value="I">Nível I</option>
              <option value="II">Nível II</option>
              <option value="III">Nível III</option>
            </select>
          </div>
          <div>
            <label class="label" for="a_prev">Previsão de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--text-muted);font-size:12px">
          * Data e hora de admissão serão registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <!-- Modal Atualização -->
  <div id="modalAtualizacao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Atualização de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>
        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matrícula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admissão (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0–10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_complexidade">Complexidade</label>
            <select id="u_complexidade" class="select2">
              <option value="I">Nível I</option>
              <option value="II">Nível II</option>
              <option value="III">Nível III</option>
            </select>
          </div>
          <div>
            <label class="label" for="u_prev">Previsão de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>
        <div id="internadoHa" style="margin-top:8px;color:var(--text-muted);font-size:12px"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

<!-- Modal Seleção de Cores -->
  <div id="modalColors" class="backdrop">
    <div class="modal color-picker-modal">
      <header>
        <strong>Seleção de Cores Personalizadas</strong>
        <button class="btn" data-close="#modalColors">Fechar</button>
      </header>
      <div class="content">
        <div class="color-section">
          <!-- Seção 1: Interface e Fundos - será preenchida pelo JS -->
        </div>

        <div class="color-section">
          <!-- Seção 2: Dashboards - será preenchida pelo JS -->
        </div>

        <div class="color-section">
          <!-- Seção 3: Status dos Leitos - será preenchida pelo JS -->
        </div>

        <div class="color-section">
          <!-- Seção 4: Linhas de Cuidado - será preenchida pelo JS -->
        </div>

        <div class="color-section">
          <!-- Seção 5: Concessões - será preenchida pelo JS -->
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="showColorsBtn">Mostrar Cores Atuais</button>
        <button class="btn danger" id="resetColorsBtn">Restaurar Padrão</button>
        <button class="btn primary" id="saveColorsBtn">Salvar Cores</button>
      </div>
    </div>
  </div>

  <!-- Outros Modais (QR, Confirmação, etc.) -->
  <div id="modalConfirm" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Confirmação</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">Não</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop">
    <div class="modal">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-muted)">Se a câmera não abrir, use a seleção manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop">
    <div class="modal" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impressão</strong>
        <button class="btn" data-close="#modalBulkQR">✕</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:var(--card);padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" id="b_print" style="display:none;" onclick="window.print()">🖨️ Imprimir QR Codes</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;padding:20px;"></div>
      </div>
    </div>
  </div>

  <div id="modalQRExpired" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Sessão Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code próximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>
  
<div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Operação realizada com sucesso.</p>
    <p style="color:var(--text-muted);font-size:14px">Você pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
</div>

<script>

// =======================================================================
// ========================== CONFIGURAÇÃO ===============================
// =======================================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwz2o5GRiQJjpTDwve8yQAWGAO-Bb4mI_pnG8kbB_6l4wSKpde8wzALQyRJ-Zqntdo-/exec';

function logInfo(message, data = null) { console.log(`🔵 [Archipelago] ${message}`, data || ''); }
function logSuccess(message, data = null) { console.log(`🟢 [SUCCESS] ${message}`, data || ''); }
function logError(message, error = null) { console.error(`🔴 [ERROR] ${message}`, error || ''); }
function logWarning(message, data = null) { console.warn(`🟡 [WARNING] ${message}`, data || ''); }

const HOSPITAIS = {
  H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
  H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
};

const banco = { H1: [], H2: [] };

// =================== LISTAS ATUALIZADAS - 19 LINHAS + 13 CONCESSÕES ===================
const LINHAS = [
  "Assiste",
  "APS", 
  "Cuidados Paliativos",
  "ICO (Insuficiência Coronariana)",
  "Oncologia",
  "Pediatria",
  "Programa Autoimune - Gastroenterologia",
  "Programa Autoimune - Neuro-desmielinizante", 
  "Programa Autoimune - Neuro-muscular",
  "Programa Autoimune - Reumatologia",
  "Vida Mais Leve Care",
  "Crônicos - Cardiologia",
  "Crônicos - Endocrinologia", 
  "Crônicos - Geriatria",
  "Crônicos - Melhor Cuidado",
  "Crônicos - Neurologia",
  "Crônicos - Pneumologia",
  "Crônicos - Pós-bariátrica",
  "Crônicos - Reumatologia"
];

const CONC = [
  "Transição Domiciliar",
  "Aplicação domiciliar de medicamentos",
  "Fisioterapia",
  "Fonoaudiologia", 
  "Aspiração",
  "Banho",
  "Curativos",
  "Oxigenoterapia",
  "Recarga de O2",
  "Orientação Nutricional - com dispositivo",
  "Orientação Nutricional - sem dispositivo", 
  "Clister",
  "PICC"
];

// Cores dinâmicas - serão carregadas do servidor com CORES PANTONE ATUALIZADAS
let CORES_ATUAIS = {
  "status-vago": "#16a34a",
  "status-uso": "#ffffff", // BRANCO conforme solicitado
  "status-uti": "#dc2626",
  "complex-1": "#22c55e",
  "complex-2": "#f59e0b",
  "complex-3": "#dc2626",
  "ouro": "#fbbf24",
  "r2": "#3b82f6",
  "r3": "#8b5cf6",
  "hospital-neomater": "#ffffff", // BRANCO conforme solicitado  
  "hospital-cruz-azul": "#60a5fa",
  
  // === CORES DE INTERFACE E FUNDOS ===
  "bg-primary": "#3b82f6",              // Fundo principal (azul)
  "bg-secondary": "#1e40af",            // Fundo secundário  
  "nav-header": "#3b82f6",              // Header do menu
  "nav-sidebar": "#60a5fa",             // Menu lateral
  "card-background": "#1a1f2e",         // Fundo dos cards
  "main-background": "#3b82f6",         // Fundo da área principal
  
  // === CORES DOS DASHBOARDS ===
  "dashboard-background": "#1a1f2e",    // Fundo dos cards do dashboard
  "dashboard-border": "#334155",        // Bordas dos dashboards
  "chart-background": "#1f2937",        // Fundo dos gráficos
  "chart-grid": "#374151",              // Linhas de grade dos gráficos
  "chart-text": "#ffffff",              // Texto dos gráficos
  "kpi-background": "#1f2937",          // Fundo dos KPIs
  "gauge-background": "#374151",        // Fundo dos medidores
  
  // === CORES DOS HOSPITAIS NOS GRÁFICOS ===
  "hospital-neomater-graph": "#0a2b52", // Cor do Neomater nos gráficos
  "hospital-cruz-azul-graph": "#60a5fa", // Cor do Cruz Azul nos gráficos
  
  // === CORES DE ELEMENTOS ESPECÍFICOS ===
  "header-stats-bg": "#2563eb",         // Fundo das estatísticas do header
  "timeline-background": "#1e293b",     // Fundo da timeline
  "radar-grid": "#475569",              // Grade do gráfico radar
  
  // === 13 CONCESSÕES - CORES PANTONE CORRETAS ===
  "conc-transicao": "#007A53",          // Verde Esmeralda Vivo Pantone 7724 C
  "conc-aplicacao": "#582C83",          // Roxo Técnico Pantone 266 C
  "conc-fisioterapia": "#009639",       // Verde Movimento Pantone 347 C
  "conc-fonoaudiologia": "#FF671F",     // Laranja Comunicativo Pantone 165 C
  "conc-aspiracao": "#2E1A47",          // Roxo Escuro Técnico Pantone 2685 C
  "conc-banho": "#8FD3F4",              // Azul Claro Limpo Pantone 2905 C
  "conc-curativos": "#00BFB3",          // Verde Água Pantone 3252 C
  "conc-oxigenoterapia": "#64A70B",     // Verde Limão Oxigênio Pantone 368 C
  "conc-recarga": "#00AEEF",            // Azul Celeste Técnico Pantone 299 C
  "conc-nutricional-com": "#FFC72C",    // Amarelo Dourado Pantone 123 C
  "conc-nutricional-sem": "#F4E285",    // Amarelo Claro Pantone 1205 C
  "conc-clister": "#E8927C",            // Coral Suave Pantone 7415 C
  "conc-picc": "#E03C31",               // Vermelho Procedimento Pantone 199 C
  
  // === 19 LINHAS DE CUIDADO - CORES PANTONE CORRETAS ===
  "linha-assiste": "#ED0A72",           // Magenta Vivo Pantone 219 C
  "linha-aps": "#007A33",               // Verde Saúde Pantone 7739 C
  "linha-paliativos": "#00B5A2",        // Verde Turquesa Pantone 3262 C
  "linha-ico": "#A6192E",               // Vermelho Escuro Pantone 7621 C
  "linha-oncologia": "#6A1B9A",         // Violeta Intenso Pantone 2597 C
  "linha-pediatria": "#5A646B",         // Cinza Elegante Pantone 431 C
  "linha-auto-gastro": "#5C5EBE",       // Lilás Suave Pantone 2725 C
  "linha-auto-neuro-desm": "#00AEEF",   // Azul Claro Pantone 299 C
  "linha-auto-neuro-musc": "#00263A",   // Azul Profundo Pantone 295 C
  "linha-auto-reumato": "#582D40",      // Ameixa Pantone 7650 C
  "linha-vida-leve": "#FFB81C",         // Amarelo Otimista Pantone 1235 C
  "linha-card": "#C8102E",              // Vermelho Cardíaco Pantone 186 C
  "linha-endocrino": "#582C83",         // Roxo Médio Pantone 268 C
  "linha-geriatria": "#FF6F1D",         // Laranja Vibrante Pantone 1505 C
  "linha-melhor": "#556F44",            // Verde Musgo Pantone 5757 C
  "linha-neurologia": "#0072CE",        // Azul Elétrico Pantone 285 C
  "linha-pneumologia": "#E35205",       // Coral Pantone 7416 C
  "linha-pos-bariatrica": "#003C57",    // Azul Petróleo Pantone 548 C
  "linha-reumatologia": "#5A0020"       // Borgonha Pantone 505 C
};

// Mapeamento de cores para gráficos - ATUALIZADO COM NOVAS CORES PANTONE
const LINHAS_CORES = {
  "Assiste": () => CORES_ATUAIS["linha-assiste"],
  "APS": () => CORES_ATUAIS["linha-aps"], 
  "Cuidados Paliativos": () => CORES_ATUAIS["linha-paliativos"],
  "ICO (Insuficiência Coronariana)": () => CORES_ATUAIS["linha-ico"],
  "Oncologia": () => CORES_ATUAIS["linha-oncologia"],
  "Pediatria": () => CORES_ATUAIS["linha-pediatria"],
  "Programa Autoimune - Gastroenterologia": () => CORES_ATUAIS["linha-auto-gastro"],
  "Programa Autoimune - Neuro-desmielinizante": () => CORES_ATUAIS["linha-auto-neuro-desm"],
  "Programa Autoimune - Neuro-muscular": () => CORES_ATUAIS["linha-auto-neuro-musc"],
  "Programa Autoimune - Reumatologia": () => CORES_ATUAIS["linha-auto-reumato"],
  "Vida Mais Leve Care": () => CORES_ATUAIS["linha-vida-leve"],
  "Crônicos - Cardiologia": () => CORES_ATUAIS["linha-card"],
  "Crônicos - Endocrinologia": () => CORES_ATUAIS["linha-endocrino"],
  "Crônicos - Geriatria": () => CORES_ATUAIS["linha-geriatria"],
  "Crônicos - Melhor Cuidado": () => CORES_ATUAIS["linha-melhor"],
  "Crônicos - Neurologia": () => CORES_ATUAIS["linha-neurologia"], 
  "Crônicos - Pneumologia": () => CORES_ATUAIS["linha-pneumologia"],
  "Crônicos - Pós-bariátrica": () => CORES_ATUAIS["linha-pos-bariatrica"],
  "Crônicos - Reumatologia": () => CORES_ATUAIS["linha-reumatologia"]
};

const CONC_CORES = {
  "Transição Domiciliar": () => CORES_ATUAIS["conc-transicao"],
  "Aplicação domiciliar de medicamentos": () => CORES_ATUAIS["conc-aplicacao"],
  "Fisioterapia": () => CORES_ATUAIS["conc-fisioterapia"],
  "Fonoaudiologia": () => CORES_ATUAIS["conc-fonoaudiologia"],
  "Aspiração": () => CORES_ATUAIS["conc-aspiracao"],
  "Banho": () => CORES_ATUAIS["conc-banho"],
  "Curativos": () => CORES_ATUAIS["conc-curativos"],
  "Oxigenoterapia": () => CORES_ATUAIS["conc-oxigenoterapia"],
  "Recarga de O2": () => CORES_ATUAIS["conc-recarga"],
  "Orientação Nutricional - com dispositivo": () => CORES_ATUAIS["conc-nutricional-com"],
  "Orientação Nutricional - sem dispositivo": () => CORES_ATUAIS["conc-nutricional-sem"],
  "Clister": () => CORES_ATUAIS["conc-clister"],
  "PICC": () => CORES_ATUAIS["conc-picc"]
};
// =======================================================================
// ========================== ESTADO DA UI ===============================
// =======================================================================
let currentHospital = "H1";
let activeTab = "leitos";
let selectedLeito = null;
let isQRMode = false;
let qrSessionTimeout = null;
let lastUpdateTime = Date.now();
let autoRefreshInterval = null;
let updateIndicatorInterval = null;

// =======================================================================
// ===================== FUNÇÕES DE LOADING ============================
// =======================================================================
function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }, 500);
}

// =======================================================================
// ========================== FUNÇÕES HELPERS ============================
// =======================================================================
const $ = sel => document.querySelector(sel);

function openModal(sel){ const el=$(sel); if(el) { el.style.display="flex"; el.setAttribute("aria-hidden","false"); } }
function closeModal(sel){ const el=$(sel); if(el) { el.style.display="none"; el.setAttribute("aria-hidden","true"); } }

function confirmAction(msg){
  return new Promise(res=>{
    $("#confirmMsg").textContent = msg || "Confirma?";
    openModal("#modalConfirm");
    $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
    $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
  });
}

function initials(nome){ if(!nome) return "—"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }

function fmtDateTime(iso){
  if(!iso) return "—";
  const d=new Date(iso);
  return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function elapsedMsToDays(ms) {
  if (ms === null || ms === undefined) return 0;
  return Math.floor(ms / 86400000);
}

function elapsedSince(iso){
  if(!iso) return { text: "—", days: 0 };
  const ms = Date.now() - new Date(iso).getTime();
  const d = elapsedMsToDays(ms);
  const h = Math.floor((ms%86400000)/3600000);
  return { text: `${d}d ${h}h`, days: d };
}

function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }

function updateTimeIndicator() {
  if(isQRMode) return;
  const indicator = document.getElementById('lastUpdateInfo');
  if(indicator) {
    const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
    const seconds = elapsed % 60;
    const minutes = Math.floor(elapsed / 60);
    if (minutes > 0) {
      indicator.textContent = `Atualizado há ${minutes}m`;
    } else {
      indicator.textContent = `Atualizado há ${seconds}s`;
    }
  }
}

// =======================================================================
// ===================== SISTEMA DE CORES PERSONALIZÁVEIS ===============
// =======================================================================
async function loadColors() {
  try {
    const res = await fetch(API_URL + '?action=getcolors');
    if (res.ok) {
      const json = await res.json();
      if (json.ok && json.data) {
        // Atualizar cores atuais
        Object.assign(CORES_ATUAIS, json.data);
        updateCSSVariables();
        logSuccess("Cores personalizadas carregadas!");
      }
    }
  } catch(error) {
    logWarning("Usando cores padrão:", error);
  }
}

function updateCSSVariables() {
  const root = document.documentElement;
  
  // Aplicar todas as variáveis CSS
  Object.entries(CORES_ATUAIS).forEach(([key, value]) => {
    root.style.setProperty(`--${key}`, value);
  });
  
  // === APLICAR CORES ESPECÍFICAS DE INTERFACE ===
  
  // Fundo principal do body
  if (CORES_ATUAIS["bg-primary"]) {
    document.body.style.background = CORES_ATUAIS["bg-primary"];
  }
  
  // Header do sistema
  const header = document.querySelector('header');
  if (header && CORES_ATUAIS["nav-header"]) {
    header.style.background = CORES_ATUAIS["nav-header"];
  }
  
  // Menu lateral
  const sideMenu = document.getElementById('side-menu');
  if (sideMenu && CORES_ATUAIS["nav-sidebar"]) {
    sideMenu.style.background = CORES_ATUAIS["nav-sidebar"];
  }
  
  // Área principal (main)
  const main = document.querySelector('main');
  if (main && CORES_ATUAIS["main-background"]) {
    main.style.background = `rgba(26, 31, 46, 0.3)`;
    main.style.backdropFilter = 'blur(10px)';
  }
  
  // === APLICAR CORES DE DASHBOARDS ===
  
  // Cards dos dashboards
  if (CORES_ATUAIS["dashboard-background"]) {
    root.style.setProperty('--card', CORES_ATUAIS["dashboard-background"]);
    root.style.setProperty('--card-hover', CORES_ATUAIS["dashboard-background"]);
  }
  
  // Bordas dos dashboards
  if (CORES_ATUAIS["dashboard-border"]) {
    root.style.setProperty('--border', CORES_ATUAIS["dashboard-border"]);
    root.style.setProperty('--border-light', CORES_ATUAIS["dashboard-border"]);
  }
  
  // Aplicar cores nos cards de dashboard existentes
  const dashboardCards = document.querySelectorAll('.dashboard-card');
  dashboardCards.forEach(card => {
    if (CORES_ATUAIS["dashboard-background"]) {
      card.style.background = CORES_ATUAIS["dashboard-background"];
    }
    if (CORES_ATUAIS["dashboard-border"]) {
      card.style.borderColor = CORES_ATUAIS["dashboard-border"];
    }
  });
  
  // Aplicar cores nos cards de KPI
  const kpiCards = document.querySelectorAll('.kpi-card');
  kpiCards.forEach(card => {
    if (CORES_ATUAIS["kpi-background"]) {
      card.style.background = CORES_ATUAIS["kpi-background"];
    }
    if (CORES_ATUAIS["dashboard-border"]) {
      card.style.borderColor = CORES_ATUAIS["dashboard-border"];
    }
  });
}

async function saveColors() {
  try {
    // Coletar valores dos inputs
    const colorInputs = document.querySelectorAll('.color-input');
    const newColors = {};
    
    colorInputs.forEach(input => {
      const key = input.id.replace('color-', '');
      newColors[key] = input.value;
    });
    
    const params = new URLSearchParams({
      action: 'savecolors',
      colors: JSON.stringify(newColors)
    });
    
    const res = await fetch(API_URL + '?' + params.toString());
    if (res.ok) {
      const json = await res.json();
      if (json.ok) {
        // Atualizar cores locais
        Object.assign(CORES_ATUAIS, newColors);
        updateCSSVariables();
        closeModal("#modalColors");
        
        // Re-renderizar gráficos
        if (activeTab.startsWith('dash')) {
          renderDashboards();
        }
        
        alert("Cores salvas com sucesso!");
        logSuccess("Cores personalizadas salvas!");
      }
    }
  } catch(error) {
    logError("Erro ao salvar cores:", error);
    alert("Erro ao salvar cores: " + error.message);
  }
}

async function resetColors() {
  if (!await confirmAction("Restaurar todas as cores para o padrão original?")) return;
  
  try {
    const res = await fetch(API_URL + '?action=resetcolors');
    if (res.ok) {
      const json = await res.json();
      if (json.ok && json.data) {
        // Atualizar cores locais
        Object.assign(CORES_ATUAIS, json.data.colors);
        updateCSSVariables();
        initColorPicker();
        
        // Re-renderizar gráficos
        if (activeTab.startsWith('dash')) {
          renderDashboards();
        }
        
        alert("Cores restauradas para o padrão!");
        logSuccess("Cores restauradas!");
      }
    }
  } catch(error) {
    logError("Erro ao restaurar cores:", error);
    alert("Erro ao restaurar cores: " + error.message);
  }
}

function initColorPicker() {
  // === SEÇÃO 1: CORES DE INTERFACE E FUNDOS ===
  const interfaceSection = document.querySelector('.color-section:nth-child(1)');
  if (interfaceSection) {
    interfaceSection.innerHTML = `
      <h4>Cores de Interface e Fundos</h4>
      <div class="color-item">
        <span>Fundo Principal</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-bg-primary"></div>
          <input type="color" class="color-input" id="color-bg-primary" />
        </div>
      </div>
      <div class="color-item">
        <span>Área Principal</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-main-background"></div>
          <input type="color" class="color-input" id="color-main-background" />
        </div>
      </div>
      <div class="color-item">
        <span>Header do Menu</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-nav-header"></div>
          <input type="color" class="color-input" id="color-nav-header" />
        </div>
      </div>
      <div class="color-item">
        <span>Menu Lateral</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-nav-sidebar"></div>
          <input type="color" class="color-input" id="color-nav-sidebar" />
        </div>
      </div>
      <div class="color-item">
        <span>Fundo dos Cards</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-card-background"></div>
          <input type="color" class="color-input" id="color-card-background" />
        </div>
      </div>
    `;
  }
  
  // === SEÇÃO 2: CORES DOS DASHBOARDS ===
  const dashboardSection = document.querySelector('.color-section:nth-child(2)');
  if (dashboardSection) {
    dashboardSection.innerHTML = `
      <h4>Cores dos Dashboards</h4>
      <div class="color-item">
        <span>Fundo dos Dashboards</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-dashboard-background"></div>
          <input type="color" class="color-input" id="color-dashboard-background" />
        </div>
      </div>
      <div class="color-item">
        <span>Bordas dos Dashboards</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-dashboard-border"></div>
          <input type="color" class="color-input" id="color-dashboard-border" />
        </div>
      </div>
      <div class="color-item">
        <span>Fundo dos Gráficos</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-chart-background"></div>
          <input type="color" class="color-input" id="color-chart-background" />
        </div>
      </div>
      <div class="color-item">
        <span>Grade dos Gráficos</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-chart-grid"></div>
          <input type="color" class="color-input" id="color-chart-grid" />
        </div>
      </div>
      <div class="color-item">
        <span>Texto dos Gráficos</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-chart-text"></div>
          <input type="color" class="color-input" id="color-chart-text" />
        </div>
      </div>
      <div class="color-item">
        <span>Fundo dos KPIs</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-kpi-background"></div>
          <input type="color" class="color-input" id="color-kpi-background" />
        </div>
      </div>
      <div class="color-item">
        <span><strong>Neomater (Gráficos)</strong></span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-hospital-neomater-graph"></div>
          <input type="color" class="color-input" id="color-hospital-neomater-graph" />
        </div>
      </div>
      <div class="color-item">
        <span><strong>Cruz Azul (Gráficos)</strong></span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-hospital-cruz-azul-graph"></div>
          <input type="color" class="color-input" id="color-hospital-cruz-azul-graph" />
        </div>
      </div>
    `;
  }
  
  // === SEÇÃO 3: STATUS DOS LEITOS ===
  const statusSection = document.querySelector('.color-section:nth-child(3)');
  if (statusSection) {
    statusSection.innerHTML = `
      <h4>Status dos Leitos</h4>
      <div class="color-item">
        <span>Leito Vago</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-status-vago"></div>
          <input type="color" class="color-input" id="color-status-vago" />
        </div>
      </div>
      <div class="color-item">
        <span>Leito Em Uso</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-status-uso"></div>
          <input type="color" class="color-input" id="color-status-uso" />
        </div>
      </div>
      <div class="color-item">
        <span>Leito UTI</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="color-preview" id="preview-status-uti"></div>
          <input type="color" class="color-input" id="color-status-uti" />
        </div>
      </div>
    `;
  }
  
  // === SEÇÃO 4: LINHAS DE CUIDADO ===
  const linhasSection = document.querySelector('.color-section:nth-child(4)');
  if (linhasSection) {
    let linhasHTML = '<h4>Linhas de Cuidado</h4>';
    LINHAS.forEach(linha => {
      const key = getLinhaColorKey(linha);
      linhasHTML += `
        <div class="color-item">
          <span>${linha}</span>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="color-preview" id="preview-${key}"></div>
            <input type="color" class="color-input" id="color-${key}" />
          </div>
        </div>
      `;
    });
    linhasSection.innerHTML = linhasHTML;
  }
  
  // === SEÇÃO 5: CONCESSÕES ===
  const concessoesSection = document.querySelector('.color-section:nth-child(5)');
  if (concessoesSection) {
    let concessoesHTML = '<h4>Concessões</h4>';
    CONC.forEach(conc => {
      const key = getConcColorKey(conc);
      concessoesHTML += `
        <div class="color-item">
          <span>${conc}</span>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="color-preview" id="preview-${key}"></div>
            <input type="color" class="color-input" id="color-${key}" />
          </div>
        </div>
      `;
    });
    concessoesSection.innerHTML = concessoesHTML;
  }
  
  // Inicializar color picker com cores atuais
  Object.entries(CORES_ATUAIS).forEach(([key, value]) => {
    const input = document.getElementById(`color-${key}`);
    const preview = document.getElementById(`preview-${key}`);
    
    if (input && preview) {
      input.value = value;
      preview.style.backgroundColor = value;
      
      input.addEventListener('change', (e) => {
        preview.style.backgroundColor = e.target.value;
      });
    }
  });
}

function getLinhaColorKey(linha) {
  const mapping = {
    "Assiste": "linha-assiste",
    "APS": "linha-aps",
    "Cuidados Paliativos": "linha-paliativos",
    "ICO (Insuficiência Coronariana)": "linha-ico", 
    "Oncologia": "linha-oncologia",
    "Pediatria": "linha-pediatria",
    "Programa Autoimune - Gastroenterologia": "linha-auto-gastro",
    "Programa Autoimune - Neuro-desmielinizante": "linha-auto-neuro-desm",
    "Programa Autoimune - Neuro-muscular": "linha-auto-neuro-musc",
    "Programa Autoimune - Reumatologia": "linha-auto-reumato",
    "Vida Mais Leve Care": "linha-vida-leve",
    "Crônicos - Cardiologia": "linha-card",
    "Crônicos - Endocrinologia": "linha-endocrino", 
    "Crônicos - Geriatria": "linha-geriatria",
    "Crônicos - Melhor Cuidado": "linha-melhor",
    "Crônicos - Neurologia": "linha-neurologia",
    "Crônicos - Pneumologia": "linha-pneumologia",
    "Crônicos - Pós-bariátrica": "linha-pos-bariatrica",
    "Crônicos - Reumatologia": "linha-reumatologia"
  };
  return mapping[linha] || "linha-default";
}

function getConcColorKey(conc) {
  const mapping = {
    "Transição Domiciliar": "conc-transicao",
    "Aplicação domiciliar de medicamentos": "conc-aplicacao",
    "Fisioterapia": "conc-fisioterapia",
    "Fonoaudiologia": "conc-fonoaudiologia",
    "Aspiração": "conc-aspiracao", 
    "Banho": "conc-banho",
    "Curativos": "conc-curativos",
    "Oxigenoterapia": "conc-oxigenoterapia",
    "Recarga de O2": "conc-recarga",
    "Orientação Nutricional - com dispositivo": "conc-nutricional-com",
    "Orientação Nutricional - sem dispositivo": "conc-nutricional-sem",
    "Clister": "conc-clister",
    "PICC": "conc-picc"
  };
  return mapping[conc] || "conc-default";
}

function showCurrentColors() {
  const colorsList = Object.entries(CORES_ATUAIS)
    .map(([key, value]) => `${key}: ${value}`)
    .join('\n');
  
  alert(`Cores atuais:\n\n${colorsList}`);
}

// === FUNÇÃO AUXILIAR PARA APLICAR CORES NOS GRÁFICOS ===
function getChartColors() {
  return {
    background: CORES_ATUAIS["chart-background"] || '#1f2937',
    grid: CORES_ATUAIS["chart-grid"] || '#374151', 
    text: CORES_ATUAIS["chart-text"] || '#ffffff',
    neomater: CORES_ATUAIS["hospital-neomater-graph"] || '#0a2b52',
    cruzAzul: CORES_ATUAIS["hospital-cruz-azul-graph"] || '#60a5fa'
  };
}

// === FUNÇÃO PARA APLICAR ESTILO NOS GRÁFICOS ===
function applyChartStyling(chartConfig) {
  const colors = getChartColors();
  
  // Aplicar cores nos eixos (scales)
  if (chartConfig.options && chartConfig.options.scales) {
    Object.keys(chartConfig.options.scales).forEach(scaleKey => {
      const scale = chartConfig.options.scales[scaleKey];
      if (scale.ticks) scale.ticks.color = colors.text;
      if (scale.grid) scale.grid.color = colors.grid;
      if (scale.title) scale.title.color = colors.text;
    });
  }
  
  // Aplicar cores na legenda
  if (chartConfig.options && chartConfig.options.plugins && chartConfig.options.plugins.legend) {
    chartConfig.options.plugins.legend.labels.color = colors.text;
  }
  
  // Aplicar cores nos datasets dos hospitais
  if (chartConfig.data && chartConfig.data.datasets) {
    chartConfig.data.datasets.forEach(dataset => {
      if (dataset.label === 'Neomater') {
        dataset.backgroundColor = colors.neomater;
        dataset.borderColor = colors.neomater;
      } else if (dataset.label === 'Cruz Azul') {
        dataset.backgroundColor = colors.cruzAzul;
        dataset.borderColor = colors.cruzAzul;
      }
    });
  }
  
  return chartConfig;
}
// =======================================================================
// ===================== FUNÇÕES DE API (BACKEND) ========================
// =======================================================================
async function testConnection() {
  logInfo("Testando conexão com a API...");
  try {
    const res = await fetch(API_URL + '?action=test');
    if (res.ok) {
      logSuccess("Conexão com a API estabelecida!");
      return true;
    }
    logError(`Falha na conexão: HTTP ${res.status}`);
    return false;
  } catch(error) {
    logError("Erro ao testar conexão:", error);
    return false;
  }
}

async function loadAllData() {
  await Promise.all([
      loadHospital('H1'),
      loadHospital('H2')
  ]);
}

// CORREÇÃO CRÍTICA: Mapeamento correto dos dados da planilha com campo complexidade
function processarDadosLeito(dadosBrutos) {
  return dadosBrutos.map(leito => {
    // Se os dados vierem da API como objeto estruturado
    if (typeof leito === 'object' && leito !== null) {
      return {
        hospital: leito.hospital || leito.H || '',
        leito: parseInt(leito.leito || leito.bed || leito.id || 0),
        tipo: leito.tipo || leito.type || 'Enfermaria/Apto',
        status: leito.status || 'Vago',
        nome: leito.nome || leito.name || null,
        idade: parseInt(leito.idade || leito.age || 0) || null,
        matricula: leito.matricula || leito.registration || null,
        pps: parseInt(leito.pps || 0) || null,
        spict: leito.spict || 'nao_elegivel',
        complexidade: leito.complexidade || leito.complexity || null, // CAMPO ADICIONADO
        prevAlta: leito.prevAlta || leito.discharge || null,
        linhas: Array.isArray(leito.linhas) ? leito.linhas : 
                (typeof leito.linhas === 'string' && leito.linhas !== 'Sem previsao') ? 
                leito.linhas.split('|').map(l => l.trim()).filter(l => l && l !== 'Sem previsao') : [],
        concessoes: Array.isArray(leito.concessoes) ? leito.concessoes : 
                   (typeof leito.concessoes === 'string') ? 
                   leito.concessoes.split('|').map(c => c.trim()).filter(c => c) : [],
        admAt: leito.admAt || leito.admission || null
      };
    }
    
    // MAPEAMENTO CORRIGIDO: Nova estrutura da planilha com campo complexidade
    // A=hospital, B=leito, C=tipo, D=status, E=nome, F=matricula, G=idade, H=admAt, I=pps, J=spict, K=complexidade, L=prevAlta, M=linhas, N=concessoes
    if (Array.isArray(leito)) {
      return {
        hospital: leito[0] || '',
        leito: parseInt(leito[1]) || 0,
        tipo: leito[2] || 'Enfermaria/Apto', 
        status: leito[3] || 'Vago',
        nome: leito[4] || null,
        matricula: leito[5] || null,
        idade: parseInt(leito[6]) || null,
        admAt: leito[7] || null,
        pps: parseInt(leito[8]) || null,
        spict: leito[9] || 'nao_elegivel',
        complexidade: leito[10] || null,  // COLUNA K = complexidade
        prevAlta: leito[11] || null,      // COLUNA L = prevAlta  
        linhas: (leito[12] && leito[12] !== 'Sem previsao') ? 
               leito[12].split('|').map(l => l.trim()).filter(l => l) : [],
        concessoes: leito[13] ? 
                   leito[13].split('|').map(c => c.trim()).filter(c => c) : []
      };
    }
    
    return leito;
  });
}

async function loadHospital(h) {
  logInfo(`Iniciando carregamento do hospital: ${h}`);
  try {
    const url = `${API_URL}?action=state&hospital=${h}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
    
    banco[h] = processarDadosLeito(json.data);
    lastUpdateTime = Date.now();
    logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${banco[h].length}`);
    
    if (activeTab === 'leitos') renderCards();
  } catch(error) {
    logError(`Erro ao carregar hospital ${h}:`, error);
    
    // DADOS DE TESTE CORRIGIDOS COM CAMPO COMPLEXIDADE
    const dadosTesteEstruturados = [];
    
    HOSPITAIS[h].leitos.forEach((leito, index) => {
      const isOcupado = index % 3 !== 0;
      
      if (isOcupado) {
        dadosTesteEstruturados.push([
          h,                                           // hospital
          leito.id,                                   // leito  
          leito.tipo,                                 // tipo
          "Em uso",                                   // status
          `Paciente ${h}-${leito.id}`,               // nome
          `${h}${String(leito.id).padStart(6, '0')}`, // matricula
          45 + (index * 7) % 40,                      // idade
          new Date(Date.now() - (index * 24 * 60 * 60 * 1000)).toISOString(), // admAt
          (index % 10) + 1,                          // pps
          index % 2 === 0 ? "elegivel" : "nao_elegivel", // spict
          ["I", "II", "III"][index % 3],             // complexidade (COLUNA K)
          ["24h Ouro", "48h", "72h", "96h", "Sem previsao"][index % 5], // prevAlta (COLUNA L)
          LINHAS.slice(0, Math.max(1, (index % 4))).join('|'), // linhas (COLUNA M)
          CONC.slice(0, Math.max(1, (index % 3))).join('|')    // concessoes (COLUNA N)
        ]);
      } else {
        // Leito vago
        dadosTesteEstruturados.push([
          h, leito.id, leito.tipo, "Vago", null, null, null, null, null, null, null, null, "", ""
        ]);
      }
    });
    
    banco[h] = processarDadosLeito(dadosTesteEstruturados);
    logWarning(`Usando dados de teste estruturados para ${h}. Total: ${banco[h].length}`);
    
    if (activeTab === 'leitos') renderCards();
  }
}

async function apiCall(payload) {
  logInfo(`Iniciando operação: ${payload.action}`, payload);
  try {
    const params = new URLSearchParams();
    for (const [key, value] of Object.entries(payload)) {
      if (Array.isArray(value)) params.append(key, value.join('|'));
      else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
    }
    
    const url = `${API_URL}?${params.toString()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'Erro na operação');
    
    logSuccess(`Operação ${payload.action} realizada com sucesso!`);
    return json.data;
  } catch(error) {
    logError(`Erro na operação ${payload.action}:`, error);
    throw new Error(error.message || 'Erro na operação');
  }
}

// =======================================================================
// ======================= LÓGICA DE NAVEGAÇÃO =========================
// =======================================================================
function setTab(tab){
  document.querySelectorAll(".side-menu-item").forEach(b=>b.classList.remove("active"));
  
  const activeSideMenuItem = $(`.side-menu-item[data-tab='${tab}']`);
  if(activeSideMenuItem) activeSideMenuItem.classList.add("active");

  activeTab = tab;
  route();
  
  if(tab.startsWith('dash')) {
    setTimeout(() => renderDashboards(), 50);
  }
}

function route(){
  const sections = ["leitosView","dash1","dash2"];
  sections.forEach(id => {
    const el = $(`#${id}`);
    if(el) el.classList.add("hidden");
  });

  const activeSectionId = activeTab === 'leitos' ? 'leitosView' : activeTab;
  $(`#${activeSectionId}`)?.classList.remove("hidden");

  if(activeTab === "leitos") renderCards();
}

// =======================================================================
// ================= LÓGICA DOS SELETORES DE HOSPITAL ===================
// =======================================================================
function setHospital(hospitalId) {
  currentHospital = hospitalId;
  
  // Atualizar botões
  document.querySelectorAll('.hospital-btn').forEach(btn => {
    btn.classList.remove('active', 'cruz-azul');
  });
  
  const activeBtn = document.querySelector(`[data-hospital="${hospitalId}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
    if (hospitalId === 'H2') {
      activeBtn.classList.add('cruz-azul');
    }
  }
  
  // Re-renderizar cards
  renderCards();
  
  logInfo(`Hospital selecionado: ${HOSPITAIS[hospitalId].nome}`);
}

// =======================================================================
// ======================= RENDERIZAÇÃO DE LEITOS ======================
// =======================================================================
function renderCards(){
  const container = $("#cardsContainer");
  if(!container) return;
  
  container.innerHTML = "";
  const leitos = banco[currentHospital] || [];

  if(leitos.length === 0) {
      container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted);">Nenhum leito para exibir ou aguardando dados...</p>`;
      return;
  }

  leitos.forEach(l=>{
    const card = document.createElement("div");
    card.className = "card";

    const statusClass = l.status==="Em uso" ? "warn" : "ok";
    const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
    
    const chipsLinhas = (l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join("");
    const chipsConc   = (l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join("");
    const complexidadeDisplay = l.complexidade ? `Nível ${l.complexidade}` : "—";
    
    card.innerHTML = `
      <div class="top">
        <div class="wrap">
          <span class="status ${statusClass}">Leito ${l.leito} — ${l.status}</span>
          <span class="tipo ${tipoClass}">${l.tipo}</span>
        </div>
        <span class="badge">${HOSPITAIS[l.hospital].nome}</span>
      </div>
      <div class="row">
        <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"—"}</div></div>
        <div class="field"><div class="label">Matrícula</div><div class="value">${l.matricula||"—"}</div></div>
        <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"—"}</div></div>
        <div class="field destaque"><div class="label">Tempo de Internação</div><div class="value">${l.status === "Em uso" ? elapsedSince(l.admAt).text : "—"}</div></div>
        <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"—"}</div></div>
        <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Elegível":(l.spict==="nao_elegivel"?"Não elegível":"—")}</div></div>
        <div class="field"><div class="label">Complexidade</div><div class="value">${complexidadeDisplay}</div></div>
        <div class="field destaque" style="grid-column: 4 / 5"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||"—"}</div></div>
        <div class="field" style="grid-column:1/3">
          <div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||"—"}</div>
        </div>
        <div class="field" style="grid-column:3/5">
          <div class="label">Concessões</div><div class="wrap">${chipsConc||"—"}</div>
        </div>
      </div>
      <div class="actions">
        ${l.status==="Vago"
          ? `<button class="btn primary" data-act="admitir">Admitir</button>`
          : `<button class="btn" data-act="atualizar">Atualizar / Ver Detalhes</button>`
        }
      </div>
    `;

    const admitBtn = card.querySelector('[data-act="admitir"]');
    if(admitBtn) admitBtn.addEventListener('click', () => openAdmissao(l.leito));
    
    const updateBtn = card.querySelector('[data-act="atualizar"]');
    if(updateBtn) updateBtn.addEventListener('click', () => openAtualizacao(l.leito));

    container.appendChild(card);
  });
}

// =======================================================================
// ======================== FLUXOS DE MODAIS ===========================
// =======================================================================
function openAdmissao(leito){
  selectedLeito = leito;
  const l = HOSPITAIS[currentHospital].leitos.find(x=>x.id===leito);
  const hospitalEl = $("#a_hospital");
  const leitoEl = $("#a_leito");
  const tipoEl = $("#a_tipo");
  const linhasEl = $("#a_linhas");
  const concessoesEl = $("#a_concessoes");
  
  if(hospitalEl) hospitalEl.textContent = HOSPITAIS[currentHospital].nome;
  if(leitoEl) leitoEl.textContent = "Leito " + l.id;
  if(tipoEl) tipoEl.textContent = l.tipo;
  if(linhasEl) linhasEl.innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
  if(concessoesEl) concessoesEl.innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
  
  // Limpar campos
  const campos = ["#a_nome", "#a_idade", "#a_matricula", "#a_pps"];
  campos.forEach(campo => {
    const el = $(campo);
    if(el) el.value = "";
  });
  
  const selectFields = ["#a_spict", "#a_prev", "#a_complexidade"];
  selectFields.forEach(field => {
    const el = $(field);
    if(el && field === "#a_spict") el.value = "elegivel";
    if(el && field === "#a_prev") el.value = "24h Ouro";
    if(el && field === "#a_complexidade") el.value = "I";
  });
  
  openModal("#modalAdmissao");
}

function openAtualizacao(leito){
  selectedLeito = leito;
  const l = banco[currentHospital].find(x=>x.leito===leito);
  if(!l) return;
  
  const hospitalEl = $("#u_hospital");
  const leitoEl = $("#u_leito"); 
  const tipoEl = $("#u_tipo");
  const nomeEl = $("#u_nome");
  const matriculaEl = $("#u_matricula");
  const admEl = $("#u_adm");
  const idadeEl = $("#u_idade");
  const ppsEl = $("#u_pps");
  const spictEl = $("#u_spict");
  const prevEl = $("#u_prev");
  const complexidadeEl = $("#u_complexidade");
  const linhasEl = $("#u_linhas");
  const concessoesEl = $("#u_concessoes");
  const internadoEl = $("#internadoHa");
  
  if(hospitalEl) hospitalEl.textContent = HOSPITAIS[currentHospital].nome;
  if(leitoEl) leitoEl.textContent = "Leito " + l.leito;
  if(tipoEl) tipoEl.textContent = l.tipo;
  if(nomeEl) nomeEl.value = l.nome||"";
  if(matriculaEl) matriculaEl.value = l.matricula||"";
  if(admEl) admEl.value = fmtDateTime(l.admAt)||"";
  if(idadeEl) idadeEl.value = l.idade??"";
  if(ppsEl) ppsEl.value = l.pps??"";
  if(spictEl) spictEl.value = l.spict||"elegivel";
  if(prevEl) prevEl.value = l.prevAlta||"Sem previsao";
  if(complexidadeEl) complexidadeEl.value = l.complexidade||"I";
  if(linhasEl) linhasEl.innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.linhas||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
  if(concessoesEl) concessoesEl.innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.concessoes||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
  if(internadoEl) internadoEl.textContent = `Internado há ${elapsedSince(l.admAt).text}`;
  
  openModal("#modalAtualizacao");
}

async function darAltaFlow(leito){
  if(!await confirmAction("Confirmar ALTA deste paciente?")) return;
  try {
    await apiCall({ action:'alta', hospital: currentHospital, leito: leito });
    if (isQRMode) {
      closeModal("#modalAtualizacao");
      showSuccessMessage();
    } else {
      await loadHospital(currentHospital);
    }
  } catch(error) { alert('Erro ao dar alta: ' + error.message); }
}


// =======================================================================
// ==================== LÓGICA DOS DASHBOARDS ============================
// =======================================================================
function getDiasAteAlta(prevAlta) {
  if (!prevAlta || prevAlta === 'Sem previsao') return 7;
  if (prevAlta.includes('24h')) return 1;
  if (prevAlta === '48h') return 2;
  if (prevAlta === '72h') return 3;
  if (prevAlta === '96h') return 4;
  return 7;
}

function createChart(canvasId, chartInstanceName, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        logError(`Canvas com ID '${canvasId}' não encontrado.`);
        return;
    }
    const ctx = canvas.getContext('2d');
    if (window[chartInstanceName]) window[chartInstanceName].destroy();
    window[chartInstanceName] = new Chart(ctx, config);
}

async function renderDashboards() {
    logInfo("Renderizando dashboards...");
    showLoading();
    
    await loadAllData();
    const allData = [...banco.H1, ...banco.H2];

    if (activeTab === 'dash1') renderDash1();
    if (activeTab === 'dash2') renderDash2(allData);
    
    hideLoading();
}

function renderDash1() {
  logInfo("Renderizando Dashboard Hospitais...");
  
  ['H1', 'H2'].forEach(h => {
    const dados = banco[h] || [];
    const totalLeitos = HOSPITAIS[h].leitos.length;
    const ocupados = dados.filter(l => l.status === 'Em uso').length;
    const vagos = totalLeitos - ocupados;
    const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
    
    // NOVA ORDEM: Total primeiro, depois ocupados, depois vagos
    const statTotalH = $(`#statTotal${h.charAt(1)}`);
    const statOcupadosH = $(`#statOcupados${h.charAt(1)}`);
    const statVagosH = $(`#statVagos${h.charAt(1)}`);
    const gaugePercentH = $(`#gaugePercent${h.charAt(1)}`);
    
    if (statTotalH) statTotalH.textContent = totalLeitos;
    if (statOcupadosH) statOcupadosH.textContent = ocupados;
    if (statVagosH) statVagosH.textContent = vagos;
    if (gaugePercentH) gaugePercentH.textContent = taxaOcupacao + '%';

    // Criar gauge semicírculo
    let corGauge = CORES_ATUAIS["status-vago"];
    if (taxaOcupacao > 90) corGauge = CORES_ATUAIS["status-uti"];
    else if (taxaOcupacao > 80) corGauge = CORES_ATUAIS["status-uso"];

    createChart(`chartOcupacao${h.charAt(1)}`, `chartGauge${h.charAt(1)}`, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [taxaOcupacao, 100 - taxaOcupacao],
          backgroundColor: [corGauge, '#e5e7eb'],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,
        rotation: -90,
        cutout: '75%',
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false }
        }
      }
    });

    // FILTRAR APENAS PACIENTES COM PREVISÃO VÁLIDA (EXCLUIR "Sem previsao")
    const pacientesComPrevisao = dados.filter(p => 
      p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao' && p.prevAlta !== null
    );

    // Labels das datas com formato correto
    const hoje = new Date();
    const labels = [];
    for (let i = 0; i < 7; i++) {
      const data = new Date(hoje);
      data.setDate(hoje.getDate() + i);
      if (i === 0) {
        labels.push(`Hoje (${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else if (i === 1) {
        labels.push(`24h (${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else if (i === 2) {
        labels.push(`48h (${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else {
        labels.push(`${i * 24}h (${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      }
    }

    // PRIMEIRO GRÁFICO: PROJEÇÃO DE CONCESSÕES (barras verticais)
    const concessoesDataHospital = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      const concessoesPaciente = Array.isArray(paciente.concessoes) ? paciente.concessoes : 
                                (typeof paciente.concessoes === 'string' ? paciente.concessoes.split('|') : []);
      
      concessoesPaciente.forEach(conc => {
        const concLimpa = conc.trim();
        if (!concessoesDataHospital[concLimpa]) concessoesDataHospital[concLimpa] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          concessoesDataHospital[concLimpa][d]++;
        }
      });
    });

    const sortedConcessoes = Object.entries(concessoesDataHospital).sort((a,b) => a[0].localeCompare(b[0]));
    
    createChart(`chartConcessoes${h.charAt(1)}`, `chartConcessoesInst${h.charAt(1)}`, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: sortedConcessoes.map(([key, values]) => ({
          label: key,
          data: values,
          backgroundColor: CONC_CORES[key] ? CONC_CORES[key]() : '#60a5fa'
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true, 
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            },
            title: { 
              display: true, 
              text: 'Beneficiários',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // SEGUNDO GRÁFICO: PROJEÇÃO DE LINHAS DE CUIDADO (barras verticais)
    const linhasDataHospital = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      const linhasPaciente = Array.isArray(paciente.linhas) ? paciente.linhas : 
                            (typeof paciente.linhas === 'string' ? paciente.linhas.split('|') : []);
      
      linhasPaciente.forEach(linha => {
        const linhaLimpa = linha.trim();
        if (!linhasDataHospital[linhaLimpa]) linhasDataHospital[linhaLimpa] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          linhasDataHospital[linhaLimpa][d]++;
        }
      });
    });

    const sortedLinhas = Object.entries(linhasDataHospital).sort((a,b) => a[0].localeCompare(b[0]));
    
    createChart(`chartLinhas${h.charAt(1)}`, `chartLinhasInst${h.charAt(1)}`, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: sortedLinhas.map(([key, values]) => ({
          label: key,
          data: values,
          backgroundColor: LINHAS_CORES[key] ? LINHAS_CORES[key]() : '#8b5cf6'
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true, 
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            }, 
            title: { 
              display: true, 
              text: 'Beneficiários',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // TERCEIRO GRÁFICO: COMPLEXIDADE (% de pacientes por nível)
    const complexidadeDataHospital = { 'I': 0, 'II': 0, 'III': 0 };
    const totalPacientes = dados.filter(l => l.status === 'Em uso').length;
    
    dados.filter(l => l.status === 'Em uso').forEach(paciente => {
      const complexidade = paciente.complexidade || 'I';
      if (complexidadeDataHospital[complexidade] !== undefined) {
        complexidadeDataHospital[complexidade]++;
      }
    });

    // Converter para percentuais
    const complexidadePercent = {};
    Object.keys(complexidadeDataHospital).forEach(key => {
      complexidadePercent[key] = totalPacientes > 0 ? 
        ((complexidadeDataHospital[key] / totalPacientes) * 100).toFixed(1) : 0;
    });

    createChart(`chartComplexidade${h.charAt(1)}`, `chartComplexidadeInst${h.charAt(1)}`, {
      type: 'bar',
      data: {
        labels: ['Nível I', 'Nível II', 'Nível III'],
        datasets: [{
          label: '% de Pacientes',
          data: Object.values(complexidadePercent),
          backgroundColor: [
            CORES_ATUAIS["complex-1"],
            CORES_ATUAIS["complex-2"],
            CORES_ATUAIS["complex-3"]
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            max: 100,
            ticks: { 
              stepSize: 10,
              callback: function(value) {
                return value + '%';
              },
              color: '#ffffff',
              font: { size: 11 }
            },
            title: { 
              display: true, 
              text: '% de Pacientes',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });
  });
  
  logSuccess('Dashboard Hospitais renderizado com sucesso!');
}

function renderDash2(allData) {
    logInfo("Renderizando Dashboard Executivo...");
    
    // KPIs Consolidados - NOVA ORDEM
    const totalLeitos = HOSPITAIS.H1.leitos.length + HOSPITAIS.H2.leitos.length;
    const ocupados = allData.filter(p => p.status === 'Em uso').length;
    const taxaOcupacaoGeral = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
    
    const kpiOcupacaoGeral = $('#kpiOcupacaoGeral');
    const kpiLeitosOcupados = $('#kpiLeitosOcupados');
    const kpiTMP = $('#kpiTMP');
    const kpiRotatividade = $('#kpiRotatividade');
    const kpiAltas24h = $('#kpiAltas24h');
    const kpiSpictPercent = $('#kpiSpictPercent');
    const kpiPpsMedia = $('#kpiPpsMedia');
    
    if (kpiOcupacaoGeral) kpiOcupacaoGeral.textContent = `${taxaOcupacaoGeral}%`;
    if (kpiLeitosOcupados) kpiLeitosOcupados.textContent = ocupados;
    
    const tempos = allData.filter(p => p.status === 'Em uso' && p.admAt).map(p => elapsedSince(p.admAt).days);
    if (kpiTMP) kpiTMP.textContent = tempos.length > 0 ? `${Math.round(tempos.reduce((a,b)=>a+b,0)/tempos.length)} dias` : '0 dias';
    
    if (kpiRotatividade) kpiRotatividade.textContent = totalLeitos > 0 ? `${Math.round((ocupados / totalLeitos) * 30)}%` : '0%';
    if (kpiAltas24h) kpiAltas24h.textContent = allData.filter(p => p.prevAlta && p.prevAlta.includes('24h')).length;
    
    const spictElegiveis = allData.filter(p => p.status === 'Em uso' && p.spict === 'elegivel').length;
    const totalPacientes = allData.filter(p => p.status === 'Em uso').length;
    if (kpiSpictPercent) kpiSpictPercent.textContent = totalPacientes > 0 ? `${Math.round((spictElegiveis / totalPacientes) * 100)}%` : '0%';
    
    const ppsValues = allData.filter(p => p.status === 'Em uso' && p.pps).map(p => p.pps);
    if (kpiPpsMedia) kpiPpsMedia.textContent = ppsValues.length > 0 ? Math.round(ppsValues.reduce((a,b)=>a+b,0)/ppsValues.length) : '0';

    // GAUGE CORRIGIDO
    let corKpiGauge = CORES_ATUAIS["status-vago"];
    if (taxaOcupacaoGeral > 90) corKpiGauge = CORES_ATUAIS["status-uti"];
    else if (taxaOcupacaoGeral > 80) corKpiGauge = CORES_ATUAIS["status-uso"];

    createChart('kpiGaugeOcupacao', 'kpiGaugeOcupacaoInst', {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [taxaOcupacaoGeral, 100 - taxaOcupacaoGeral],
          backgroundColor: [corKpiGauge, '#e5e7eb'],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,
        rotation: -90,
        cutout: '70%',
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false }
        }
      }
    });

    // ANÁLISE PREDITIVA DE ALTAS - COMPARATIVO POR PRAZO - CORES CORRIGIDAS
    const projAltas = { "24h": {H1:0, H2:0}, "48h": {H1:0, H2:0}, "72h": {H1:0, H2:0}, "96h": {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao').forEach(p => {
      const key = p.prevAlta.includes('24h') ? '24h' : p.prevAlta;
      if(projAltas[key]) projAltas[key][p.hospital]++;
    });
    
    createChart('chartAltasComparativo', 'chartAltasComparativoInst', {
      type: 'bar',
      data: {
        labels: Object.keys(projAltas),
        datasets: [
          { 
            label: 'Neomater', 
            data: Object.values(projAltas).map(d=>d.H1), 
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          { 
            label: 'Cruz Azul', 
            data: Object.values(projAltas).map(d=>d.H2), 
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // TIMELINE DE LIBERAÇÃO EM 24H (Ouro, 2R, 3R) - CORES CORRIGIDAS
    const timeline24h = { 'Ouro': {H1:0, H2:0}, '2R': {H1:0, H2:0}, '3R': {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta.includes('24h')).forEach(p => {
      if (p.prevAlta.includes('Ouro')) timeline24h.Ouro[p.hospital]++;
      else if (p.prevAlta.includes('2R')) timeline24h['2R'][p.hospital]++;
      else if (p.prevAlta.includes('3R')) timeline24h['3R'][p.hospital]++;
    });
    
    createChart('chartTimeline24h', 'chartTimeline24hInst', {
      type: 'bar',
      data: {
        labels: Object.keys(timeline24h),
        datasets: [
          { 
            label: 'Neomater', 
            data: Object.values(timeline24h).map(d=>d.H1), 
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          { 
            label: 'Cruz Azul', 
            data: Object.values(timeline24h).map(d=>d.H2), 
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // PROJEÇÕES CONSOLIDADAS (7 dias)
    const pacientesComPrevisao = allData.filter(p => 
      p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao'
    );

    // Labels das datas corretas
    const hoje = new Date();
    const labelsConsolidado = [];
    for (let i = 0; i < 7; i++) {
      const data = new Date(hoje);
      data.setDate(hoje.getDate() + i);
      if (i === 0) {
        labelsConsolidado.push(`Hoje\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else if (i === 1) {
        labelsConsolidado.push(`24h\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else if (i === 2) {
        labelsConsolidado.push(`48h\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      } else {
        labelsConsolidado.push(`${i * 24}h\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      }
    }

    // CONCESSÕES CONSOLIDADAS
    const concessoesConsolidadoH1 = {};
    const concessoesConsolidadoH2 = {};
    
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      const target = paciente.hospital === 'H1' ? concessoesConsolidadoH1 : concessoesConsolidadoH2;
      
      (paciente.concessoes || []).forEach(conc => {
        if (!target[conc]) target[conc] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          target[conc][d]++;
        }
      });
    });

    const allConcessoes = [...new Set([...Object.keys(concessoesConsolidadoH1), ...Object.keys(concessoesConsolidadoH2)])].sort();
    
    createChart('chartConcessoesConsolidado', 'chartConcessoesConsolidadoInst', {
      type: 'bar',
      data: {
        labels: labelsConsolidado,
        datasets: [
          {
            label: 'Neomater',
            data: labelsConsolidado.map((_, index) => 
              allConcessoes.reduce((sum, conc) => sum + (concessoesConsolidadoH1[conc]?.[index] || 0), 0)
            ),
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          {
            label: 'Cruz Azul', 
            data: labelsConsolidado.map((_, index) => 
              allConcessoes.reduce((sum, conc) => sum + (concessoesConsolidadoH2[conc]?.[index] || 0), 0)
            ),
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            title: { 
              display: true, 
              text: 'Concessões', 
              color: '#ffffff',
              font: { size: 12 }
            },
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // LINHAS DE CUIDADO CONSOLIDADAS
    const linhasConsolidadoH1 = {};
    const linhasConsolidadoH2 = {};
    
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      const target = paciente.hospital === 'H1' ? linhasConsolidadoH1 : linhasConsolidadoH2;
      
      (paciente.linhas || []).forEach(linha => {
        if (!target[linha]) target[linha] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          target[linha][d]++;
        }
      });
    });

    const allLinhas = [...new Set([...Object.keys(linhasConsolidadoH1), ...Object.keys(linhasConsolidadoH2)])].sort();
    
    createChart('chartLinhasConsolidado', 'chartLinhasConsolidadoInst', {
      type: 'bar',
      data: {
        labels: labelsConsolidado,
        datasets: [
          {
            label: 'Neomater',
            data: labelsConsolidado.map((_, index) => 
              allLinhas.reduce((sum, linha) => sum + (linhasConsolidadoH1[linha]?.[index] || 0), 0)
            ),
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          {
            label: 'Cruz Azul',
            data: labelsConsolidado.map((_, index) => 
              allLinhas.reduce((sum, linha) => sum + (linhasConsolidadoH2[linha]?.[index] || 0), 0)
            ),
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            title: { 
              display: true, 
              text: 'Cuidados', 
              color: '#ffffff',
              font: { size: 12 }
            },
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // EFICIÊNCIA OPERACIONAL (radar)
    const H1Data = banco.H1.filter(p => p.status === 'Em uso');
    const H2Data = banco.H2.filter(p => p.status === 'Em uso');
    const H1Recursos = H1Data.reduce((acc, p) => acc + (p.concessoes?.length || 0) + (p.linhas?.length || 0), 0);
    const H2Recursos = H2Data.reduce((acc, p) => acc + (p.concessoes?.length || 0) + (p.linhas?.length || 0), 0);
    
    const H1Complexidade = H1Data.filter(p => p.complexidade).reduce((acc, p) => {
        const nivel = p.complexidade === 'I' ? 1 : p.complexidade === 'II' ? 2 : 3;
        return acc + nivel;
    }, 0) / Math.max(H1Data.filter(p => p.complexidade).length, 1);
    
    const H2Complexidade = H2Data.filter(p => p.complexidade).reduce((acc, p) => {
        const nivel = p.complexidade === 'I' ? 1 : p.complexidade === 'II' ? 2 : 3;
        return acc + nivel;
    }, 0) / Math.max(H2Data.filter(p => p.complexidade).length, 1);

    createChart('chartEficienciaRadar', 'chartEficienciaRadarInst', {
        type: 'radar',
        data: {
            labels: ['Taxa Ocupação', 'Concessões por Leito', 'Nível Complexidade'],
            datasets: [
                {
                    label: 'Neomater',
                    data: [
                        (H1Data.length / HOSPITAIS.H1.leitos.length) * 100,
                        (H1Recursos / Math.max(H1Data.length, 1)) * 10,
                        H1Complexidade * 33.33
                    ],
                    backgroundColor: 'rgba(10, 43, 82, 0.2)',
                    borderColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52',
                    borderWidth: 2
                },
                {
                    label: 'Cruz Azul',
                    data: [
                        (H2Data.length / HOSPITAIS.H2.leitos.length) * 100,
                        (H2Recursos / Math.max(H2Data.length, 1)) * 10,
                        H2Complexidade * 33.33
                    ],
                    backgroundColor: 'rgba(96, 165, 250, 0.2)',
                    borderColor: CORES_ATUAIS["hospital-cruz-azul"],
                    borderWidth: 2
                }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { 
                        color: '#ffffff',
                        font: { size: 12 }
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: '#ffffff',
                        font: { size: 10 }
                    },
                    grid: { color: 'rgba(255,255,255,0.2)' },
                    angleLines: { color: 'rgba(255,255,255,0.2)' },
                    pointLabels: {
                        color: '#ffffff',
                        font: { size: 11 }
                    }
                }
            }
        }
    });

    // ANÁLISE PPS
    const ppsRanges = { '0-3': {H1:0, H2:0}, '4-6': {H1:0, H2:0}, '7-10': {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.pps).forEach(p => {
      const pps = p.pps;
      let range = '7-10';
      if (pps <= 3) range = '0-3';
      else if (pps <= 6) range = '4-6';
      ppsRanges[range][p.hospital]++;
    });
    
    createChart('chartPpsAnalise', 'chartPpsAnaliseInst', {
      type: 'bar',
      data: {
        labels: Object.keys(ppsRanges),
        datasets: [
          { 
            label: 'Neomater', 
            data: Object.values(ppsRanges).map(r=>r.H1), 
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          { 
            label: 'Cruz Azul', 
            data: Object.values(ppsRanges).map(r=>r.H2), 
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // ANÁLISE SPICT-BR
    const spictData = { H1: { elegivel: 0, nao_elegivel: 0 }, H2: { elegivel: 0, nao_elegivel: 0 } };
    allData.filter(p => p.status === 'Em uso').forEach(p => {
        if (p.spict && spictData[p.hospital]) spictData[p.hospital][p.spict]++;
    });
    
    createChart('chartSpictAnalise', 'chartSpictAnaliseInst', {
      type: 'bar',
      data: {
        labels: ['Elegível', 'Não Elegível'],
        datasets: [
          { 
            label: 'Neomater', 
            data: [spictData.H1.elegivel, spictData.H1.nao_elegivel], 
            backgroundColor: CORES_ATUAIS["hospital-neomater-text"] || '#0a2b52'
          },
          { 
            label: 'Cruz Azul', 
            data: [spictData.H2.elegivel, spictData.H2.nao_elegivel], 
            backgroundColor: CORES_ATUAIS["hospital-cruz-azul"]
          }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    logSuccess('Dashboard Executivo renderizado com sucesso!');
}

// =======================================================================
// ================= LÓGICA DE QR CODE (CORRIGIDA) =====================
// =======================================================================
let qrReader = null;

function handleScan(text) { 
  try {
    const u = new URL(String(text));
    const h = u.searchParams.get('h'); 
    const leito = Number(u.searchParams.get('leito')); 
    
    if(h && ["H1","H2"].includes(h) && leito > 0) {
      logSuccess(`QR Code válido detectado: Hospital ${h}, Leito ${leito}`);
      closeModal("#modalQRScan"); 
      stopScan(); 
      initQRSession(h, leito);
    } else {
      logWarning("QR Code inválido:", text);
    }
  } catch(e) {
    logWarning("QR Code não reconhecido:", text);
  }
}

function initQRSession(hospital, leito) {
  logInfo(`Iniciando sessão QR para ${hospital} - Leito ${leito}`);
  isQRMode = true;
  currentHospital = hospital;
  selectedLeito = leito;
  
  // Ocultar navegação e toolbars
  const header = document.querySelector('header');
  const main = document.querySelector('main');
  const body = document.body;
  const sideMenu = document.getElementById('side-menu');
  
  if (header) header.style.display = 'none';
  if (main) main.style.padding = '20px';
  if (body) {
    body.style.paddingLeft = '0';
    body.classList.remove('menu-open');
  }
  if (sideMenu) sideMenu.style.display = 'none';
  
  // Carregar dados do hospital
  loadHospital(hospital).then(() => {
    const leitoData = banco[hospital].find(l => l.leito === leito);
    if (!leitoData) {
      alert(`Leito ${leito} não encontrado no hospital ${hospital}`);
      return;
    }
    
    // Abrir modal apropriado
    if (leitoData.status === 'Vago') {
      openAdmissao(leito);
    } else {
      openAtualizacao(leito);
    }
    
    // Configurar timeout de 2 minutos
    qrSessionTimeout = setTimeout(() => {
      closeAllModals();
      openModal("#modalQRExpired");
    }, 120000);
  });
}

function closeAllModals() {
  closeModal("#modalAdmissao");
  closeModal("#modalAtualizacao");
  if (qrSessionTimeout) {
    clearTimeout(qrSessionTimeout);
    qrSessionTimeout = null;
  }
}

async function startScan(){
  if(!window.Html5Qrcode){
    alert("Leitor não disponível.");
    return;
  }
  
  try{
    if(qrReader) await stopScan();
    qrReader = new Html5Qrcode('qrRegion');
    await qrReader.start(
      { facingMode:'environment' },
      { fps:10, qrbox:250 },
      handleScan,
      ()=>{}
    );
  } catch(e){
    logError("Erro ao acessar câmera:", e);
    alert("Não foi possível acessar a câmera.");
    stopScan();
    closeModal("#modalQRScan");
  }
}

function stopScan(){
  if(!qrReader) return Promise.resolve();
  return qrReader.stop().then(()=>{
    qrReader.clear();
    qrReader=null;
  }).catch(()=>{});
}

function buildQRGrid(){
  const h = $("#b_hospital").value;
  const from = Math.max(1, parseInt($("#b_from").value||"1"));
  const to   = Math.max(from, parseInt($("#b_to").value||"1"));
  const limit = h==="H1"?13:16;
  const f = Math.min(from, limit);
  const t = Math.min(to, limit);
  const base = `${location.origin}${location.pathname}`;
  const grid = $("#qr_grid");
  const printBtn = $("#b_print");
  
  // Esconder botão e limpar grid
  if (printBtn) printBtn.style.display = "none";
  grid.innerHTML = "";
  
  // Estrutura simplificada
  for(let i=f; i<=t; i++){
    const url = `${base}?h=${h}&leito=${i}`;
    
    // Cell principal
    const cell = document.createElement("div");
    cell.className = "qr-cell";
    cell.style.cssText = `
      background: white;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      page-break-inside: avoid;
    `;
    
    // Container QR (será preenchido pela biblioteca)
    const qrDiv = document.createElement("div");
    qrDiv.style.cssText = "margin-bottom: 15px;";
    
    // Label
    const labelDiv = document.createElement("div");
    labelDiv.style.cssText = "font-size: 16px; color: #333; font-weight: bold;";
    labelDiv.textContent = `Leito ${i} • ${HOSPITAIS[h].nome}`;
    
    cell.appendChild(qrDiv);
    cell.appendChild(labelDiv);
    grid.appendChild(cell);
    
    // Gerar QR
    try {
      new QRCode(qrDiv, {
        text: url,
        width: 180,
        height: 180,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
    } catch(error) {
      qrDiv.innerHTML = `<div style="width:180px;height:180px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:12px;">Erro QR</div>`;
    }
  }
  
  // Mostrar botão após pequeno delay
  setTimeout(() => {
    if (printBtn) printBtn.style.display = "inline-block";
    logSuccess(`QR codes gerados: ${t-f+1} códigos para ${HOSPITAIS[h].nome}`);
  }, 1000);
}

// Verificar se a URL contém parâmetros QR na inicialização
function checkQRParams() {
  const params = new URLSearchParams(window.location.search);
  const h = params.get('h');
  const leito = params.get('leito');
  
  if (h && leito && ["H1","H2"].includes(h)) {
    logInfo("Parâmetros QR detectados na URL");
    initQRSession(h, parseInt(leito));
    return true;
  }
  return false;
}

// =======================================================================
// =================== CONTROLE DO MENU RESPONSIVO ======================
// =======================================================================
function toggleMenu() {
  const body = document.body;
  const sideMenu = document.getElementById('side-menu');
  
  if (sideMenu.classList.contains('open')) {
    // Fechar menu
    body.classList.remove('menu-open');
    sideMenu.classList.remove('open');
  } else {
    // Abrir menu
    body.classList.add('menu-open');
    sideMenu.classList.add('open');
  }
}

function closeMenu() {
  const body = document.body;
  const sideMenu = document.getElementById('side-menu');
  
  body.classList.remove('menu-open');
  sideMenu.classList.remove('open');
}

// =======================================================================
// ===================== INICIALIZAÇÃO E EVENTOS =========================
// =======================================================================
function setupEventListeners() {
  // Navegação Principal (Menu Lateral)
  document.querySelectorAll(".side-menu-item").forEach(b=> {
    b.onclick = (e)=> {
      e.preventDefault();
      setTab(b.dataset.tab);
      // Fechar menu após seleção
      closeMenu();
    };
  });
  
  // Botões do Header
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.onclick = () => { 
      logInfo("Refresh manual"); 
      if (activeTab.startsWith('dash')) { 
        renderDashboards() 
      } else { 
        loadHospital(currentHospital) 
      } 
    };
  }

  // Menu Lateral - Hamburger (mostrar)
  const hamburgerMenu = document.getElementById('hamburgerMenu');
  if (hamburgerMenu) {
    hamburgerMenu.onclick = toggleMenu;
  }
  
  // Menu Lateral - Botão de fechar dentro do menu
  const closeMenuBtn = document.getElementById('closeMenuBtn');
  if (closeMenuBtn) {
    closeMenuBtn.onclick = closeMenu;
  }

  // Seletores de Hospital
  const btnNeomater = document.getElementById('btnNeomater');
  const btnCruzAzul = document.getElementById('btnCruzAzul');
  
  if (btnNeomater) {
    btnNeomater.onclick = () => setHospital('H1');
  }
  
  if (btnCruzAzul) {
    btnCruzAzul.onclick = () => setHospital('H2');
  }

  // Configurações no Menu Lateral
  const settingsMenuBtn = document.getElementById('settingsMenuBtn');
  const settingsMenuDropdown = document.getElementById('settingsMenuDropdown');
  
  if (settingsMenuBtn && settingsMenuDropdown) {
    settingsMenuBtn.onclick = () => {
      settingsMenuDropdown.classList.toggle('show');
    };
  }

  const btnReadQR = document.getElementById('btnReadQR');
  if (btnReadQR && settingsMenuDropdown) {
    btnReadQR.onclick = () => { 
      settingsMenuDropdown.classList.remove('show'); 
      openModal("#modalQRScan"); 
      startScan(); 
    };
  }

  const btnPrintQR = document.getElementById('btnPrintQR');
  if (btnPrintQR && settingsMenuDropdown) {
    btnPrintQR.onclick = () => { 
      settingsMenuDropdown.classList.remove('show'); 
      openModal("#modalBulkQR"); 
    };
  }

  const btnColors = document.getElementById('btnColors');
  if (btnColors && settingsMenuDropdown) {
    btnColors.onclick = () => { 
      settingsMenuDropdown.classList.remove('show'); 
      openModal("#modalColors"); 
      initColorPicker();
    };
  }
  
  // Fechar dropdowns se clicar fora
  window.onclick = (event) => {
      if (!event.target.closest('.settings-menu-btn')) {
          if (settingsMenuDropdown && settingsMenuDropdown.classList.contains('show')) {
            settingsMenuDropdown.classList.remove('show');
          }
      }
  };

  // Ações dos Modais
  document.querySelectorAll("[data-close]").forEach(b=> {
    b.onclick = ()=> closeModal(b.getAttribute("data-close"));
  });

  const bGenerate = document.getElementById("b_generate");
  if (bGenerate) bGenerate.onclick = buildQRGrid;
  
  const reloadPage = document.getElementById("reloadPage");
  if (reloadPage) reloadPage.onclick = ()=> location.reload();

  // Modal de Admissão
  const aCancelBtn = document.getElementById('a_cancel');
  const aSaveBtn = document.getElementById('a_save');
  
  if (aCancelBtn) {
    aCancelBtn.onclick = async () => { 
      if (await confirmAction("Cancelar admissão?")) closeModal("#modalAdmissao"); 
    };
  }
  
  if (aSaveBtn) {
    aSaveBtn.onclick = async ()=>{ 
      if(!await confirmAction("Salvar e admitir paciente?")) return; 
      try { 
        const payload = { 
          action: 'admit', 
          hospital: currentHospital, 
          leito: selectedLeito, 
          nome: $("#a_nome")?.value.trim() || '', 
          idade: Number($("#a_idade")?.value)||null, 
          matricula: $("#a_matricula")?.value.trim() || '', 
          pps: Number($("#a_pps")?.value)||null, 
          spict: $("#a_spict")?.value || 'elegivel', 
          complexidade: $("#a_complexidade")?.value || 'I',
          prevAlta: $("#a_prev")?.value || '24h Ouro', 
          linhas: Array.from(document.querySelectorAll("#a_linhas input:checked")).map(i=>i.value), 
          concessoes: Array.from(document.querySelectorAll("#a_concessoes input:checked")).map(i=>i.value) 
        }; 
        await apiCall(payload); 
        closeModal("#modalAdmissao"); 
        if (isQRMode) { 
          showSuccessMessage(); 
        } else { 
          await loadHospital(currentHospital); 
        } 
      } catch(error) { 
        alert('Erro: ' + error.message); 
      } 
    };
  }

  // Modal de Atualização
  const uCancelBtn = document.getElementById('u_cancel');
  const uAltaBtn = document.getElementById('u_alta');
  const uSaveBtn = document.getElementById('u_save');
  
  if (uCancelBtn) {
    uCancelBtn.onclick = async () => { 
      if (await confirmAction("Cancelar alterações?")) closeModal("#modalAtualizacao"); 
    };
  }
  
  if (uAltaBtn) {
    uAltaBtn.onclick = ()=> darAltaFlow(selectedLeito);
  }
  
  if (uSaveBtn) {
    uSaveBtn.onclick = async ()=>{ 
      if(!await confirmAction("Salvar alterações?")) return; 
      try { 
        const payload = { 
          action: 'update', 
          hospital: currentHospital, 
          leito: selectedLeito, 
          idade: Number($("#u_idade")?.value)||null, 
          pps: Number($("#u_pps")?.value)||null, 
          spict: $("#u_spict")?.value || 'elegivel',
          complexidade: $("#u_complexidade")?.value || 'I', 
          prevAlta: $("#u_prev")?.value || '24h Ouro', 
          linhas: Array.from(document.querySelectorAll("#u_linhas input:checked")).map(i=>i.value), 
          concessoes: Array.from(document.querySelectorAll("#u_concessoes input:checked")).map(i=>i.value) 
        }; 
        await apiCall(payload); 
        closeModal("#modalAtualizacao"); 
        if (isQRMode) { 
          showSuccessMessage(); 
        } else { 
          await loadHospital(currentHospital); 
        } 
      } catch(error) { 
        alert('Erro: ' + error.message); 
      } 
    };
  }

  // Eventos do Modal de Cores
  const saveColorsBtn = document.getElementById('saveColorsBtn');
  const resetColorsBtn = document.getElementById('resetColorsBtn');
  const showColorsBtn = document.getElementById('showColorsBtn');
  
  if (saveColorsBtn) saveColorsBtn.onclick = saveColors;
  if (resetColorsBtn) resetColorsBtn.onclick = resetColors;
  if (showColorsBtn) showColorsBtn.onclick = showCurrentColors;

  // Eventos de redimensionamento da janela
  window.addEventListener('resize', () => {
    // Fechar menu automaticamente em telas grandes
    if (window.innerWidth > 1024) {
      closeMenu();
    }
  });
}

// Função de inicialização
(async function init(){
  logInfo("=== INICIALIZANDO ARCHIPELAGO DASHBOARD CORPORATIVO ATUALIZADO ===");
  showLoading();
  
  // Aguardar um pouco para garantir que o DOM esteja pronto
  await new Promise(resolve => setTimeout(resolve, 100));
  
  setupEventListeners();
  
  await testConnection();
  
  // Verificar se é acesso via QR Code primeiro
  if (checkQRParams()) {
    hideLoading();
    return;
  }
  
  logInfo("💼 MODO PORTAL DETECTADO - Sessão gestor iniciada");
  setTab("leitos");
  
  // Carregar cores personalizadas
  await loadColors();
  
  await loadAllData();
  
  autoRefreshInterval = setInterval(() => {
    if (!isQRMode) {
      logInfo("Auto-refresh executado");
      Promise.all([loadHospital("H1"), loadHospital("H2")]).then(() => {
        if(activeTab.startsWith('dash')) renderDashboards();
      });
    }
  }, 60000);
  
  updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
  
  hideLoading();
  logInfo("=== DASHBOARD ATUALIZADO INICIALIZADO COM SUCESSO ===");
  logInfo("🎯 19 LINHAS DE CUIDADO + 13 CONCESSÕES + CORES PANTONE + BUG IMPRESSÃO CORRIGIDO");
})();

</script>
</body>
</html>
