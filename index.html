<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago Dashboard</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* =================== VARIAVEIS GLOBAIS - CORES ORIGINAIS DO PROJETO =================== */
    :root {
      /* Layout Principal - CORES EXATAS DAS IMAGENS */
      --nav-sidebar: #0a2b52;
      --nav-header: linear-gradient(90deg, #0a2b52, #083052);
      --bg-primary: #0a0f1c;
      --bg-secondary: #060b14;
      --card: #1a1f2e;
      --card-hover: #242938;
      --text-white: #ffffff;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --text-accent: #60a5fa;
      --border: #334155;
      --border-light: #475569;

      /* Status e Complexidade */
      --status-vago: #16a34a;
      --status-uso: #f59e0b;
      --status-uti: #dc2626;
      --complex-1: #22c55e;
      --complex-2: #f59e0b;
      --complex-3: #dc2626;

      /* Timeline 24h */
      --ouro: #fbbf24;
      --r2: #3b82f6;
      --r3: #8b5cf6;

      /* Cores espec√≠ficas dos gr√°ficos originais */
      --gauge-verde: #16a34a;
      --gauge-amarelo: #f59e0b;
      --gauge-laranja: #fb923c;

      /* Sombras e Efeitos */
      --shadow: 0 4px 12px rgba(11,44,82,.08);
      --shadow-2: 0 10px 28px rgba(11,44,82,.12);
      --gradient-header: linear-gradient(90deg, #0a2b52, #083052);
      --gradient-card: linear-gradient(145deg, var(--card) 0%, var(--card-hover) 100%);
      --gradient-button: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    /* =================== BASE STYLES =================== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0; overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text);
    }

    /* =================== LOADING OVERLAY =================== */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000; transition: opacity 0.3s ease;
    }

    .loading-spinner {
      width: 60px; height: 60px; border: 3px solid var(--border);
      border-top: 3px solid var(--text-accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 15px; font-size: 16px; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loadingOverlay.hidden { display: none; }

    /* =================== HEADER E NAVEGA√á√ÉO =================== */
    header {
      background: var(--gradient-header);
      color: var(--text-white); padding: 15px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-2);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 20px; }
    .hamburger-menu { font-size: 24px; cursor: pointer; }
    .brand h1 {
      margin: 0; font-size: 20px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    .header-right {
      display: flex; align-items: center; gap: 16px;
    }

    #lastUpdateInfo {
      font-size: 12px; color: var(--text-muted);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-btn {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text); border-radius: 10px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease; position: relative;
    }

    .header-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
    }

    @media (max-width: 1024px) {
      body { padding-left: 0; }
      #side-menu { left: -300px; }
      #side-menu.open { left: 0; }
    }

    /* =================== MENU LATERAL (300px) =================== */
    #side-menu {
      position: fixed; top: 0; left: 0; width: 300px; height: 100%;
      background: linear-gradient(180deg, var(--nav-sidebar) 0%, var(--bg-primary) 100%);
      box-shadow: var(--shadow-2);
      border-right: 1px solid var(--border);
      z-index: 1001; padding-top: 80px;
      transition: left 0.3s ease; display: flex; flex-direction: column;
    }

    body { padding-left: 300px; }

    .menu-header {
      position: absolute; top: 20px; left: 20px; right: 20px;
      display: flex; justify-content: flex-end;
    }

    .close-menu-btn {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease; font-size: 12px;
    }

    .close-menu-btn:hover {
      background: rgba(96, 165, 250, 0.2);
    }

    .menu-items {
      flex: 1; padding: 0 0 120px 0; overflow-y: auto;
    }

    .side-menu-item {
      display: flex; align-items: center; gap: 15px;
      padding: 20px 25px; color: var(--text); text-decoration: none;
      font-size: 16px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-left: 4px solid transparent;
      transition: all 0.3s ease; height: 60px;
    }

    .side-menu-item:hover {
      background: rgba(96, 165, 250, 0.1);
      border-left-color: var(--text-accent);
    }

    .side-menu-item.active {
      background: rgba(96, 165, 250, 0.2);
      border-left-color: var(--text-accent);
      color: var(--text-accent);
    }

    .menu-footer {
      position: absolute; bottom: 20px; left: 20px; right: 20px;
    }

    .settings-menu-btn {
      width: 100%; background: rgba(96, 165, 250, 0.1); 
      border: 1px solid var(--border); color: var(--text); 
      border-radius: 12px; padding: 15px; cursor: pointer; 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; 
      transition: all 0.3s ease; display: flex; align-items: center; 
      justify-content: center; gap: 10px; position: relative;
    }

    .settings-menu-btn:hover {
      background: rgba(96, 165, 250, 0.2);
    }

    .settings-dropdown-menu {
      display: none; position: absolute; bottom: 110%; left: 0; right: 0;
      background: var(--card); border-radius: 12px; box-shadow: var(--shadow);
      overflow: hidden; border: 1px solid var(--border); margin-bottom: 10px;
    }

    .settings-dropdown-menu.show { display: block; }

    .settings-dropdown-item {
      padding: 12px 15px; color: var(--text); font-size: 14px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    }

    .settings-dropdown-item:last-child {
      border-bottom: none;
    }

    .settings-dropdown-item:hover {
      background: var(--card-hover);
    }

    /* =================== MAIN CONTENT =================== */
    main {
      max-width: 1600px; margin: 18px auto 100px; padding: 0 24px;
      background: rgba(26, 31, 46, 0.3); border-radius: 20px;
      backdrop-filter: blur(10px); border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* =================== CARDS DE LEITOS =================== */
    .grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 18px; position: relative; z-index: 1;
    }

    .card {
      background: var(--card); border-radius: 20px; padding: 16px;
      box-shadow: var(--shadow), var(--shadow-2), 0 0 0 1px rgba(255,255,255,.6) inset;
      border: 2px solid transparent; background-clip: padding-box;
      border-image: linear-gradient(to bottom, #FFFFFF, #E5E7EB) 1;
      transform: translateY(0); transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16), 0 26px 64px rgba(11,44,82,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
    }

    .card .top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; margin-bottom: 10px;
    }

    .badge {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text-accent); font-size: 12px; padding: 4px 10px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status {
      background: var(--card); border: 1px solid var(--border);
      color: var(--text); font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 4px 10px; border-radius: 999px;
      display: inline-flex; align-items: center; gap: 6px;
    }

    .status.ok {
      background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);
      color: var(--status-vago);
    }

    .status.warn {
      background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);
      color: var(--status-uso);
    }

    .tipo {
      font-size: 12px; color: var(--text-white); padding: 4px 8px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tipo.uti {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
    }

    .tipo.enf {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }

    .row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }

    .field {
      background: rgba(96, 165, 250, 0.05); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px; backdrop-filter: blur(5px);
    }

    .field .label {
      font-size: 11px; color: var(--text-muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .field .value {
      color: var(--text); font-weight: 600;
    }

    .wrap { display: flex; flex-wrap: wrap; gap: 6px; }

    .chip {
      font-size: 12px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-accent);
      padding: 2px 8px; border-radius: 999px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;
    }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); padding: 10px 14px; border-radius: 12px;
      cursor: pointer; transition: all 0.2s ease; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn.primary {
      background: var(--gradient-button); border-color: var(--text-accent);
      color: var(--text-white); box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .btn.danger {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
      border-color: var(--status-uti); color: var(--text-white);
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
    }

    /* =================== DASHBOARDS =================== */
    .dash-grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-6 { grid-template-columns: repeat(6, 1fr); }

    @media (max-width: 1200px) {
      .grid-2 { grid-template-columns: 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
    }
    @media (max-width: 900px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-6 { grid-template-columns: repeat(2, 1fr); }
    }

    .dashboard-card {
      background: var(--card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 20px; 
      box-shadow: var(--shadow);
    }

    .dashboard-card h3 {
      margin: 0 0 15px 0; font-size: 18px; color: var(--text-accent);
      text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .dashboard-card h4 {
      margin: 20px 0 10px 0; font-size: 14px; color: var(--text-white);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .kpi-card {
      background: var(--card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 15px; text-align: center; 
      position: relative; box-shadow: var(--shadow);
    }

    .kpi-value {
      font-size: 36px; font-weight: 700; color: var(--text-accent);
    }

    .kpi-label {
      font-size: 13px; color: var(--text-muted); margin-top: 5px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    /* Gauge espec√≠fico para Dashboard Hospitais */
    .dash-hospital-header { 
      display: flex; align-items: center; gap: 24px; margin-bottom: 20px; 
    }
    
    .gauge-wrapper { 
      position: relative; width: 150px; height: 100px; 
    }
    
    .gauge-wrapper canvas { 
      width: 100% !important; height: auto !important; 
    }
    
    .gauge-text { 
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); 
      text-align: center; 
    }
    
    .gauge-text .percent { 
      font-size: 24px; font-weight: 700; color: var(--text-accent); 
    }

    .gauge-text .label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-stats { 
      flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
    }
    
    .header-stats .stat-box { 
      padding: 10px; text-align: left; background: #f9fafb; 
      border-radius: 10px; 
    }

    .header-stats .stat-value { 
      font-size: 22px; font-weight: bold; color: var(--text-accent); 
    }

    .header-stats .stat-label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .chart-container { position: relative; width: 100%; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    /* =================== MODAIS =================== */
    .backdrop {
      position: fixed; inset: 0; background: rgba(10, 15, 28, 0.8);
      backdrop-filter: blur(10px); display: none; align-items: center;
      justify-content: center; padding: 16px; z-index: 1000; overflow: auto;
    }

    .modal {
      background: var(--gradient-card); max-width: 860px; width: 100%;
      max-height: 90vh; border-radius: 20px; border: 1px solid var(--border);
      box-shadow: var(--shadow-hover); overflow: hidden;
      display: flex; flex-direction: column; backdrop-filter: blur(15px);
    }

    .modal header {
      background: var(--gradient-header); border-bottom: 1px solid var(--border);
      color: var(--text-white); display: flex; align-items: center;
      justify-content: space-between; padding: 12px 16px; flex-shrink: 0;
    }

    .modal header strong {
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .modal .content {
      padding: 16px; overflow-y: auto; flex: 1;
    }

    .modal .actions {
      background: rgba(26, 31, 46, 0.5); border-top: 1px solid var(--border);
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 12px 16px; flex-shrink: 0;
    }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    .input, .select2, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 12px; background: var(--card); color: var(--text);
      font-weight: 600;
    }

    .label {
      font-size: 12px; color: var(--text-muted); margin-bottom: 4px;
      display: block; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* =================== DROPDOWN MENUS =================== */
    .dropdown-menu {
      display: none; position: absolute; top: 110%; right: 0;
      background: var(--card); border-radius: 10px; box-shadow: var(--shadow);
      overflow: hidden; z-index: 110; min-width: 180px;
      border: 1px solid var(--border);
    }

    .dropdown-menu.show { display: block; }

    .dropdown-item {
      padding: 10px 15px; color: var(--text); font-size: 14px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dropdown-item:hover {
      background: var(--card-hover);
    }

    /* =================== CONFIGURACAO DE CORES =================== */
    .color-config-modal {
      max-width: 1200px;
    }

    .color-tabs {
      display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap;
    }

    .color-tab {
      padding: 8px 16px; font-size: 12px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-muted);
      border-radius: 8px; cursor: pointer; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;
    }

    .color-tab.active {
      background: var(--gradient-button); color: var(--text-white);
      border-color: var(--text-accent);
    }

    .color-section {
      display: none;
    }

    .color-section.active {
      display: block;
    }

    .color-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .color-item {
      background: var(--card); padding: 15px; border-radius: 12px;
      border: 1px solid var(--border); display: flex; align-items: center;
      gap: 15px;
    }

    .color-item label {
      flex: 1; font-weight: 600; color: var(--text); text-transform: none;
      letter-spacing: normal; font-size: 14px;
    }

    .color-item input[type="color"] {
      width: 50px; height: 40px; border: none; border-radius: 8px;
      cursor: pointer;
    }

    .color-preview {
      width: 30px; height: 30px; border-radius: 6px;
      border: 2px solid var(--border);
    }

    .color-presets {
      margin-top: 20px; padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .preset-btn {
      margin: 5px 10px 5px 0; padding: 8px 16px; font-size: 12px;
      background: var(--card); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px; cursor: pointer;
      font-weight: 600; text-transform: uppercase;
    }

    .preset-btn:hover {
      background: var(--card-hover);
    }

    /* =================== TABELA =================== */
    table {
      width: 100%; border-collapse: separate; border-spacing: 0 10px;
    }

    th, td {
      background: var(--card); border: 1px solid var(--border);
      padding: 10px; border-radius: 10px; color: var(--text);
    }

    th {
      font-size: 12px; color: var(--text-muted); text-align: left;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    th.sortable {
      cursor: pointer; user-select: none;
    }

    th.sortable:hover {
      background: var(--card-hover);
    }

    td {
      font-size: 13px;
    }

    /* =================== UTILIDADES =================== */
    .hidden { display: none; }

    .success-message {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--gradient-card); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px; text-align: center;
      box-shadow: var(--shadow-hover); z-index: 3000; display: none;
      color: var(--text); backdrop-filter: blur(15px);
    }

    .success-message h2 {
      color: var(--text-accent); font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* =================== RESPONSIVIDADE =================== */
    @media (max-width: 1024px) {
      body { padding-left: 0; }
      #side-menu { left: -300px; }
      #side-menu.open { left: 0; }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <!-- Menu Lateral -->
  <div id="side-menu">
    <!-- Header do Menu com Bot√£o Fechar -->
    <div class="menu-header">
      <button class="close-menu-btn" id="closeMenuBtn">
        ‚Üê Fechar
      </button>
    </div>

    <!-- Items do Menu -->
    <div class="menu-items">
      <a href="#" class="side-menu-item active" data-tab="leitos">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2.5 12a.5.5 0 0 1 .5-.5h18a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
          <path d="M20 16H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2zM9 8H7v6h2V8z"/>
        </svg>
        <span>Leitos (Cards)</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash1">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 20v-6M12 8V2M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M17.66 6.34l-4.24 4.24M6.34 17.66l-4.24 4.24M22 12h-6M8 12H2"/>
        </svg>
        <span>Dash Hospitais</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash2">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 20V10M12 20V4M6 20V14"/>
        </svg>
        <span>Dashboard Executivo</span>
      </a>
    </div>

    <!-- Footer do Menu com Configura√ß√µes -->
    <div class="menu-footer">
      <button class="settings-menu-btn" id="settingsMenuBtn">
        <span>‚öôÔ∏è</span>
        <span>Configura√ß√µes</span>
        <div class="settings-dropdown-menu" id="settingsMenuDropdown">
          <div class="settings-dropdown-item" id="btnReadQR">Ler QR Code</div>
          <div class="settings-dropdown-item" id="btnPrintQR">Imprimir QR Codes</div>
          <div class="settings-dropdown-item" id="btnCores">Configurar Cores</div>
          <div class="settings-dropdown-item" id="btnSaveToCloud">Salvar na Nuvem</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-left">
      <div class="hamburger-menu">‚ò∞</div>
      <div class="brand">
        <h1>Archipelago Dashboard</h1>
      </div>
    </div>
    
    <div class="header-right">
      <span id="lastUpdateInfo"></span>
      <button class="header-btn" id="refreshBtn">Atualizar</button>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Toolbar para sele√ß√£o de hospital (apenas no modo leitos) -->
    <div class="toolbar" id="portalToolbar" style="display: none;">
      <div class="row"></div>
      <div class="row">
        <button class="btn primary active" data-h="H1" id="btnH1">Neomater</button>
        <button class="btn primary" data-h="H2" id="btnH2">Cruz Azul</button>
      </div>
    </div>

    <!-- Leitos View -->
    <section id="leitosView" class="grid"></section>

    <!-- Dashboard Hospitais -->
    <section id="dash1" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dash Hospitais: Vis√£o Detalhada por Hospital</h2>
      <div class="dash-grid grid-2">
        <!-- Neomater -->
        <div class="dashboard-card" id="dash-card-h1">
          <h3>Neomater</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacaoH1"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercentH1">0%</div>
                <div class="label">Ocupa√ß√£o</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statOcupadosH1">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagosH1">0</div>
                <div class="stat-label">Vagos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statTotalH1">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
            </div>
          </div>

          <!-- Gr√°ficos em barras verticais -->
          <h4>Proje√ß√£o de Concess√µes</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoesH1"></canvas>
          </div>

          <h4>Proje√ß√£o de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhasH1"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidadeH1"></canvas>
          </div>
        </div>

        <!-- Cruz Azul -->
        <div class="dashboard-card" id="dash-card-h2">
          <h3>Cruz Azul</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacaoH2"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercentH2">0%</div>
                <div class="label">Ocupa√ß√£o</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statOcupadosH2">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagosH2">0</div>
                <div class="stat-label">Vagos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statTotalH2">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
            </div>
          </div>

          <!-- Gr√°ficos em barras verticais -->
          <h4>Proje√ß√£o de Concess√µes</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoesH2"></canvas>
          </div>

          <h4>Proje√ß√£o de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhasH2"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidadeH2"></canvas>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Dashboard Executivo -->
    <section id="dash2" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dashboard Executivo: Rede Hospitalar Externa</h2>
      
      <!-- KPIs Operacionais Consolidados (nova ordem) -->
      <div class="dashboard-card">
        <h3>KPIs Operacionais Consolidados</h3>
        <div class="dash-grid grid-6">
          <div class="kpi-card">
            <div class="kpi-value" id="kpiOcupacaoGeral">0%</div>
            <div class="kpi-label">Taxa de Ocupa√ß√£o Geral</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiLeitosOcupados">0</div>
            <div class="kpi-label">Total de Leitos Ocupados</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiTMP">0 dias</div>
            <div class="kpi-label">Tempo M√©dio Perman√™ncia</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiRotatividade">0%</div>
            <div class="kpi-label">Taxa de Rotatividade</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiAltas24h">0</div>
            <div class="kpi-label">Altas Previstas em 24h</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiSpictPercent">0%</div>
            <div class="kpi-label">SPICT-BR Eleg√≠vel</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiPpsMedia">0</div>
            <div class="kpi-label">PPS M√©dia Geral</div>
          </div>
        </div>
      </div>

      <!-- An√°lise Preditiva de Altas (segundo lugar) -->
      <div class="dashboard-card">
        <h3>An√°lise Preditiva de Altas</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Comparativo por Prazo</h4>
            <div class="chart-container h-250">
              <canvas id="chartAltasComparativo"></canvas>
            </div>
          </div>
          <div>
            <h4>Timeline de Libera√ß√£o em 24h</h4>
            <div class="chart-container h-250">
              <canvas id="chartTimeline24h"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Proje√ß√µes Consolidadas (nova ordem) -->
      <div class="dashboard-card">
        <h3>Proje√ß√µes Consolidadas (7 dias)</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Concess√µes Necess√°rias</h4>
            <div class="chart-container h-300">
              <canvas id="chartConcessoesConsolidado"></canvas>
            </div>
          </div>
          <div>
            <h4>Linhas de Cuidado</h4>
            <div class="chart-container h-300">
              <canvas id="chartLinhasConsolidado"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- An√°lise PPS -->
      <div class="dashboard-card">
        <h3>An√°lise PPS (Performance Status)</h3>
        <div class="chart-container h-250">
          <canvas id="chartPpsAnalise"></canvas>
        </div>
      </div>

      <!-- An√°lise SPICT-BR -->
      <div class="dashboard-card">
        <h3>An√°lise SPICT-BR</h3>
        <div class="chart-container h-250">
          <canvas id="chartSpictAnalise"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Admiss√£o -->
  <div id="modalAdmissao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Admiss√£o de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matr√≠cula (n√∫mero)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0‚Äî10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_complexidade">Complexidade</label>
            <select id="a_complexidade" class="select2">
              <option value="I">N√≠vel I</option>
              <option value="II">N√≠vel II</option>
              <option value="III">N√≠vel III</option>
            </select>
          </div>
          <div>
            <label class="label" for="a_prev">Previs√£o de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--text-muted);font-size:12px">
          * Data e hora de admiss√£o ser√£o registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <!-- Modal Atualiza√ß√£o -->
  <div id="modalAtualizacao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Atualiza√ß√£o de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>
        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matr√≠cula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admiss√£o (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0‚Äî10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_complexidade">Complexidade</label>
            <select id="u_complexidade" class="select2">
              <option value="I">N√≠vel I</option>
              <option value="II">N√≠vel II</option>
              <option value="III">N√≠vel III</option>
            </select>
          </div>
          <div>
            <label class="label" for="u_prev">Previs√£o de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>
        <div id="internadoHa" style="margin-top:8px;color:var(--text-muted);font-size:12px"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <!-- Modal Configura√ß√£o de Cores -->
  <div id="modalCores" class="backdrop">
    <div class="modal color-config-modal">
      <header>
        <strong>üé® Configura√ß√£o de Cores</strong>
        <button class="btn" data-close="#modalCores">Fechar</button>
      </header>
      <div class="content">
        <!-- Abas de categorias -->
        <div class="color-tabs">
          <button class="color-tab active" data-category="layout">Layout Principal</button>
          <button class="color-tab" data-category="status">Status & Complexidade</button>
          <button class="color-tab" data-category="linhas">Linhas de Cuidado</button>
          <button class="color-tab" data-category="concessoes">Concess√µes</button>
          <button class="color-tab" data-category="timeline">Timeline 24h</button>
          <button class="color-tab" data-category="graficos">Gr√°ficos</button>
        </div>

        <!-- Layout Principal -->
        <div class="color-section active" id="layout">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Cores do Layout Principal</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>Sidebar (Menu Lateral)</label>
              <input type="color" id="color-nav-sidebar" value="#0a0f1c">
              <span class="color-preview" style="background: #0a0f1c"></span>
            </div>
            <div class="color-item">
              <label>Header (Barra Superior)</label>
              <input type="color" id="color-nav-header" value="#1e40af">
              <span class="color-preview" style="background: #1e40af"></span>
            </div>
            <div class="color-item">
              <label>Cards/Modais</label>
              <input type="color" id="color-card" value="#1a1f2e">
              <span class="color-preview" style="background: #1a1f2e"></span>
            </div>
            <div class="color-item">
              <label>Fundo Principal</label>
              <input type="color" id="color-bg-primary" value="#0a0f1c">
              <span class="color-preview" style="background: #0a0f1c"></span>
            </div>
            <div class="color-item">
              <label>Texto Branco</label>
              <input type="color" id="color-text-white" value="#ffffff">
              <span class="color-preview" style="background: #ffffff"></span>
            </div>
            <div class="color-item">
              <label>Texto Principal</label>
              <input type="color" id="color-text" value="#e2e8f0">
              <span class="color-preview" style="background: #e2e8f0"></span>
            </div>
            <div class="color-item">
              <label>Texto Secund√°rio</label>
              <input type="color" id="color-text-muted" value="#94a3b8">
              <span class="color-preview" style="background: #94a3b8"></span>
            </div>
            <div class="color-item">
              <label>Texto Destaque</label>
              <input type="color" id="color-text-accent" value="#60a5fa">
              <span class="color-preview" style="background: #60a5fa"></span>
            </div>
            <div class="color-item">
              <label>Bordas</label>
              <input type="color" id="color-border" value="#334155">
              <span class="color-preview" style="background: #334155"></span>
            </div>
          </div>
        </div>

        <!-- Status & Complexidade -->
        <div class="color-section" id="status">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Status dos Leitos & Complexidade</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>Status: Vago</label>
              <input type="color" id="color-status-vago" value="#16a34a">
              <span class="color-preview" style="background: #16a34a"></span>
            </div>
            <div class="color-item">
              <label>Status: Em Uso</label>
              <input type="color" id="color-status-uso" value="#f59e0b">
              <span class="color-preview" style="background: #f59e0b"></span>
            </div>
            <div class="color-item">
              <label>Status: UTI</label>
              <input type="color" id="color-status-uti" value="#dc2626">
              <span class="color-preview" style="background: #dc2626"></span>
            </div>
            <div class="color-item">
              <label>Complexidade I</label>
              <input type="color" id="color-complex-1" value="#22c55e">
              <span class="color-preview" style="background: #22c55e"></span>
            </div>
            <div class="color-item">
              <label>Complexidade II</label>
              <input type="color" id="color-complex-2" value="#f59e0b">
              <span class="color-preview" style="background: #f59e0b"></span>
            </div>
            <div class="color-item">
              <label>Complexidade III</label>
              <input type="color" id="color-complex-3" value="#dc2626">
              <span class="color-preview" style="background: #dc2626"></span>
            </div>
          </div>
        </div>

        <!-- Linhas de Cuidado -->
        <div class="color-section" id="linhas">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Linhas de Cuidado</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>APS</label>
              <input type="color" id="color-linha-aps" value="#f59e0b">
              <span class="color-preview" style="background: #f59e0b"></span>
            </div>
            <div class="color-item">
              <label>Assist√™ncia</label>
              <input type="color" id="color-linha-assistencia" value="#0a2b52">
              <span class="color-preview" style="background: #0a2b52"></span>
            </div>
            <div class="color-item">
              <label>Cardiologia</label>
              <input type="color" id="color-linha-cardiologia" value="#dc2626">
              <span class="color-preview" style="background: #dc2626"></span>
            </div>
            <div class="color-item">
              <label>Geriatria</label>
              <input type="color" id="color-linha-geriatria" value="#16a34a">
              <span class="color-preview" style="background: #16a34a"></span>
            </div>
            <div class="color-item">
              <label>Melhor Cuidado</label>
              <input type="color" id="color-linha-melhor" value="#be185d">
              <span class="color-preview" style="background: #be185d"></span>
            </div>
            <div class="color-item">
              <label>Neurologia</label>
              <input type="color" id="color-linha-neurologia" value="#0891b2">
              <span class="color-preview" style="background: #0891b2"></span>
            </div>
            <div class="color-item">
              <label>Pneumologia</label>
              <input type="color" id="color-linha-pneumologia" value="#8b5cf6">
              <span class="color-preview" style="background: #8b5cf6"></span>
            </div>
          </div>
        </div>

        <!-- Concess√µes -->
        <div class="color-section" id="concessoes">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Concess√µes</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>Aspira√ß√µes</label>
              <input type="color" id="color-conc-aspiracoes" value="#dc2626">
              <span class="color-preview" style="background: #dc2626"></span>
            </div>
            <div class="color-item">
              <label>Curativos</label>
              <input type="color" id="color-conc-curativos" value="#8b5cf6">
              <span class="color-preview" style="background: #8b5cf6"></span>
            </div>
            <div class="color-item">
              <label>Fisioterapia</label>
              <input type="color" id="color-conc-fisioterapia" value="#16a34a">
              <span class="color-preview" style="background: #16a34a"></span>
            </div>
            <div class="color-item">
              <label>Fonoaudiologia</label>
              <input type="color" id="color-conc-fonoaudiologia" value="#f59e0b">
              <span class="color-preview" style="background: #f59e0b"></span>
            </div>
            <div class="color-item">
              <label>PAD</label>
              <input type="color" id="color-conc-pad" value="#0a2b52">
              <span class="color-preview" style="background: #0a2b52"></span>
            </div>
          </div>
        </div>

        <!-- Timeline 24h -->
        <div class="color-section" id="timeline">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Timeline de Libera√ß√£o 24h</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>Ouro</label>
              <input type="color" id="color-ouro" value="#fbbf24">
              <span class="color-preview" style="background: #fbbf24"></span>
            </div>
            <div class="color-item">
              <label>2R</label>
              <input type="color" id="color-r2" value="#3b82f6">
              <span class="color-preview" style="background: #3b82f6"></span>
            </div>
            <div class="color-item">
              <label>3R</label>
              <input type="color" id="color-r3" value="#8b5cf6">
              <span class="color-preview" style="background: #8b5cf6"></span>
            </div>
          </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="color-section" id="graficos">
          <h4 style="color: var(--text-white); margin-bottom: 15px;">Gr√°ficos Especiais</h4>
          <div class="color-grid">
            <div class="color-item">
              <label>Gr√°fico Principal</label>
              <input type="color" id="color-grafico-1" value="#60a5fa">
              <span class="color-preview" style="background: #60a5fa"></span>
            </div>
            <div class="color-item">
              <label>Gr√°fico Secund√°rio</label>
              <input type="color" id="color-grafico-2" value="#8b5cf6">
              <span class="color-preview" style="background: #8b5cf6"></span>
            </div>
            <div class="color-item">
              <label>Grade/Fundo</label>
              <input type="color" id="color-grade" value="#374151">
              <span class="color-preview" style="background: #374151"></span>
            </div>
          </div>
        </div>

        <!-- Presets -->
        <div class="color-presets">
          <h4 style="color: var(--text-white);">Temas Predefinidos:</h4>
          <button class="preset-btn" data-preset="default">Padr√£o</button>
          <button class="preset-btn" data-preset="blue">Azul Corporativo</button>
          <button class="preset-btn" data-preset="green">Verde Sa√∫de</button>
          <button class="preset-btn" data-preset="purple">Roxo Medicina</button>
          <button class="preset-btn" data-preset="dark">Escuro Total</button>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="resetCores">Restaurar Padr√£o</button>
        <button class="btn" id="exportCores">Exportar Tema</button>
        <button class="btn" id="importCores">Importar Tema</button>
        <button class="btn primary" id="aplicarCores">Aplicar Cores</button>
      </div>
    </div>
  </div>

  <!-- Outros Modais (QR, Confirma√ß√£o, etc.) -->
  <div id="modalConfirm" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Confirma√ß√£o</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">N√£o</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop">
    <div class="modal">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-muted)">Se a c√¢mera n√£o abrir, use a sele√ß√£o manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop">
    <div class="modal" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impress√£o</strong>
        <button class="btn" data-close="#modalBulkQR">‚úï</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:var(--card);padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
      </div>
    </div>
  </div>

  <div id="modalQRExpired" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Sess√£o Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code pr√≥ximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>
  
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Opera√ß√£o realizada com sucesso.</p>
    <p style="color:var(--text-muted);font-size:14px">Voc√™ pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>

<script>
// =======================================================================
// ========================== CONFIGURA√á√ÉO ===============================
// =======================================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbzn8BlUD8by0GykYlJa1pmbYtuXOr8aEUzOOBhpfSGl-i1x8LhAnGSRzqdyV2lANnIP/exec';

function logInfo(message, data = null) { console.log(`üîµ [Archipelago] ${message}`, data || ''); }
function logSuccess(message, data = null) { console.log(`üü¢ [SUCCESS] ${message}`, data || ''); }
function logError(message, error = null) { console.error(`üî¥ [ERROR] ${message}`, error || ''); }
function logWarning(message, data = null) { console.warn(`üü° [WARNING] ${message}`, data || ''); }

const HOSPITAIS = {
  H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
  H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
};

const banco = { H1: [], H2: [] };
const LINHAS = ["APS","Assistencia","Cardiologia","Geriatria","Melhor Cuidado","Neurologia","Pneumologia"];
const CONC = ["Aspiracoes","Curativos","Fisioterapia","Fonoaudiologia","PAD"];

const LINHAS_CORES = {
  "APS": "var(--color-linha-aps, #f59e0b)", 
  "Assistencia": "var(--color-linha-assistencia, #0a2b52)", 
  "Cardiologia": "var(--color-linha-cardiologia, #dc2626)",
  "Geriatria": "var(--color-linha-geriatria, #16a34a)", 
  "Melhor Cuidado": "var(--color-linha-melhor, #be185d)", 
  "Neurologia": "var(--color-linha-neurologia, #0891b2)",
  "Pneumologia": "var(--color-linha-pneumologia, #8b5cf6)"
};

const CONC_CORES = {
  "Aspiracoes": "var(--color-conc-aspiracoes, #dc2626)", 
  "Curativos": "var(--color-conc-curativos, #8b5cf6)",
  "Fisioterapia": "var(--color-conc-fisioterapia, #16a34a)", 
  "Fonoaudiologia": "var(--color-conc-fonoaudiologia, #f59e0b)", 
  "PAD": "var(--color-conc-pad, #0a2b52)"
};

// =======================================================================
// ========================== ESTADO DA UI ===============================
// =======================================================================
let currentHospital = "H1";
let activeTab = "leitos";
let selectedLeito = null;
let isQRMode = false;
let qrSessionTimeout = null;
let lastUpdateTime = Date.now();
let autoRefreshInterval = null;
let updateIndicatorInterval = null;
let sortState = { key: 'leito', direction: 'asc' };

// =======================================================================
// ===================== FUN√á√ïES DE LOADING ============================
// =======================================================================
function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }, 500);
}

// =======================================================================
// ========================== FUN√á√ïES HELPERS ============================
// =======================================================================
const $ = sel => document.querySelector(sel);

function openModal(sel){ const el=$(sel); el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
function closeModal(sel){ const el=$(sel); el.style.display="none"; el.setAttribute("aria-hidden","true"); }

function confirmAction(msg){
  return new Promise(res=>{
    $("#confirmMsg").textContent = msg || "Confirma?";
    openModal("#modalConfirm");
    $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
    $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
  });
}

function initials(nome){ if(!nome) return "‚Äî"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }

function fmtDateTime(iso){
  if(!iso) return "‚Äî";
  const d=new Date(iso);
  return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function elapsedMsToDays(ms) {
  if (ms === null || ms === undefined) return 0;
  return Math.floor(ms / 86400000);
}

function elapsedSince(iso){
  if(!iso) return { text: "‚Äî", days: 0 };
  const ms = Date.now() - new Date(iso).getTime();
  const d = elapsedMsToDays(ms);
  const h = Math.floor((ms%86400000)/3600000);
  return { text: `${d}d ${h}h`, days: d };
}

function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }

function updateTimeIndicator() {
  if(isQRMode) return;
  const indicator = document.getElementById('lastUpdateInfo');
  if(indicator) {
    const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
    const seconds = elapsed % 60;
    const minutes = Math.floor(elapsed / 60);
    if (minutes > 0) {
      indicator.textContent = `Atualizado h√° ${minutes}m`;
    } else {
      indicator.textContent = `Atualizado h√° ${seconds}s`;
    }
  }
}

// =======================================================================
// ===================== FUN√á√ïES DE API (BACKEND) ========================
// =======================================================================
async function testConnection() {
  logInfo("Testando conex√£o com a API...");
  try {
    const res = await fetch(API_URL + '?action=test');
    if (res.ok) {
      logSuccess("Conex√£o com a API estabelecida!");
      return true;
    }
    logError(`Falha na conex√£o: HTTP ${res.status}`);
    return false;
  } catch(error) {
    logError("Erro ao testar conex√£o:", error);
    return false;
  }
}

async function loadAllData() {
  await Promise.all([
      loadHospital('H1'),
      loadHospital('H2')
  ]);
}

async function loadHospital(h) {
  logInfo(`Iniciando carregamento do hospital: ${h}`);
  try {
    const url = `${API_URL}?action=state&hospital=${h}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
    
    banco[h] = json.data;
    lastUpdateTime = Date.now();
    logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${json.data.length}`);
    
    if (activeTab === 'leitos') renderCards();
  } catch(error) {
    logError(`Erro ao carregar hospital ${h}:`, error);
    banco[h] = [];
    if (activeTab === 'leitos') renderCards();
  }
}

async function apiCall(payload) {
  logInfo(`Iniciando opera√ß√£o: ${payload.action}`, payload);
  try {
    const params = new URLSearchParams();
    for (const [key, value] of Object.entries(payload)) {
      if (Array.isArray(value)) params.append(key, value.join('|'));
      else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
    }
    
    const url = `${API_URL}?${params.toString()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'Erro na opera√ß√£o');
    
    logSuccess(`Opera√ß√£o ${payload.action} realizada com sucesso!`);
    return json.data;
  } catch(error) {
    logError(`Erro na opera√ß√£o ${payload.action}:`, error);
    throw new Error(error.message || 'Erro na opera√ß√£o');
  }
}

// =======================================================================
// ======================= L√ìGICA DE NAVEGA√á√ÉO =========================
// =======================================================================
function setTab(tab){
  document.querySelectorAll(".side-menu-item").forEach(b=>b.classList.remove("active"));
  
  const activeSideMenuItem = $(`.side-menu-item[data-tab='${tab}']`);
  if(activeSideMenuItem) activeSideMenuItem.classList.add("active");

  activeTab = tab;
  route();
  
  if(tab.startsWith('dash')) {
    setTimeout(() => renderDashboards(), 50);
  }
}

function setHospitalSelectors(h){
  currentHospital = h;
  document.querySelectorAll('.btn[data-h]').forEach(btn => btn.classList.remove('active'));
  $(`.btn[data-h="${h}"]`)?.classList.add('active');
}

function route(){
  const sections = ["leitosView","dash1","dash2","dash3"];
  sections.forEach(id => {
    const el = $(`#${id}`);
    if(el) el.classList.add("hidden");
  });

  const activeSectionId = activeTab === 'leitos' ? 'leitosView' : activeTab;
  $(`#${activeSectionId}`)?.classList.remove("hidden");

  // Mostrar toolbar apenas no modo leitos
  if (activeTab === 'leitos') {
    $('#portalToolbar').style.display = 'flex';
  } else {
    $('#portalToolbar').style.display = 'none';
  }

  if(activeTab === "leitos") renderCards();
}

// =======================================================================
// ======================= RENDERIZA√á√ÉO DE LEITOS ======================
// =======================================================================
function renderCards(){
  const container = $("#leitosView");
  container.innerHTML = "";
  const leitos = banco[currentHospital] || [];

  if(leitos.length === 0) {
      container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted);">Nenhum leito para exibir ou aguardando dados...</p>`;
      return;
  }

  leitos.forEach(l=>{
    const card = document.createElement("div");
    card.className = "card";

    const statusClass = l.status==="Em uso" ? "warn" : "ok";
    const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
    
    const chipsLinhas = (l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join("");
    const chipsConc   = (l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join("");
    
    card.innerHTML = `
      <div class="top">
        <div class="wrap">
          <span class="status ${statusClass}">Leito ${l.leito} ‚Äî ${l.status}</span>
          <span class="tipo ${tipoClass}">${l.tipo}</span>
        </div>
        <span class="badge">${HOSPITAIS[l.hospital].nome}</span>
      </div>
      <div class="row">
        <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"‚Äî"}</div></div>
        <div class="field"><div class="label">Matr√≠cula</div><div class="value">${l.matricula||"‚Äî"}</div></div>
        <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"‚Äî"}</div></div>
        <div class="field"><div class="label">Tempo de Interna√ß√£o</div><div class="value">${l.status === "Em uso" ? elapsedSince(l.admAt).text : "‚Äî"}</div></div>
        <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"‚Äî"}</div></div>
        <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</div></div>
        <div class="field"><div class="label">Complexidade</div><div class="value">${l.complexidade||"‚Äî"}</div></div>
        <div class="field" style="grid-column: 4 / 5"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||"‚Äî"}</div></div>
        <div class="field" style="grid-column:1/3">
          <div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||"‚Äî"}</div>
        </div>
        <div class="field" style="grid-column:3/5">
          <div class="label">Concess√µes</div><div class="wrap">${chipsConc||"‚Äî"}</div>
        </div>
      </div>
      <div class="actions">
        ${l.status==="Vago"
          ? `<button class="btn primary" data-act="admitir">Admitir</button>`
          : `<button class="btn" data-act="atualizar">Atualizar / Ver Detalhes</button>`
        }
      </div>
    `;

    card.querySelector('[data-act="admitir"]')?.addEventListener('click', () => openAdmissao(l.leito));
    card.querySelector('[data-act="atualizar"]')?.addEventListener('click', () => openAtualizacao(l.leito));

    container.appendChild(card);
  });
}

// =======================================================================
// ======================== FLUXOS DE MODAIS ===========================
// =======================================================================
function openAdmissao(leito){
  selectedLeito = leito;
  const l = HOSPITAIS[currentHospital].leitos.find(x=>x.id===leito);
  $("#a_hospital").textContent = HOSPITAIS[currentHospital].nome;
  $("#a_leito").textContent = "Leito " + l.id;
  $("#a_tipo").textContent = l.tipo;
  $("#a_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
  $("#a_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
  $("#a_nome").value=""; $("#a_idade").value=""; $("#a_matricula").value=""; $("#a_pps").value="";
  $("#a_spict").value="elegivel"; $("#a_prev").value="24h Ouro"; $("#a_complexidade").value="I";
  openModal("#modalAdmissao");
}

function openAtualizacao(leito){
  selectedLeito = leito;
  const l = banco[currentHospital].find(x=>x.leito===leito);
  $("#u_hospital").textContent = HOSPITAIS[currentHospital].nome;
  $("#u_leito").textContent = "Leito " + l.leito;
  $("#u_tipo").textContent = l.tipo;
  $("#u_nome").value = l.nome||"";
  $("#u_matricula").value = l.matricula||"";
  $("#u_adm").value = fmtDateTime(l.admAt)||"";
  $("#u_idade").value = l.idade??"";
  $("#u_pps").value = l.pps??"";
  $("#u_spict").value = l.spict||"elegivel";
  $("#u_prev").value = l.prevAlta||"Sem previsao";
  $("#u_complexidade").value = l.complexidade||"I";
  $("#u_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.linhas||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
  $("#u_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.concessoes||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
  $("#internadoHa").textContent = `Internado h√° ${elapsedSince(l.admAt).text}`;
  openModal("#modalAtualizacao");
}

async function darAltaFlow(leito){
  if(!await confirmAction("Confirmar ALTA deste paciente?")) return;
  try {
    await apiCall({ action:'alta', hospital: currentHospital, leito: leito });
    if (isQRMode) {
      closeModal("#modalAtualizacao");
      showSuccessMessage();
    } else {
      await loadHospital(currentHospital);
    }
  } catch(error) { alert('Erro ao dar alta: ' + error.message); }
}

// =======================================================================
// ==================== L√ìGICA DOS DASHBOARDS ============================
// =======================================================================
function getDiasAteAlta(prevAlta) {
  if (!prevAlta || prevAlta === 'Sem previsao') return 7;
  if (prevAlta.includes('24h')) return 1;
  if (prevAlta === '48h') return 2;
  if (prevAlta === '72h') return 3;
  if (prevAlta === '96h') return 4;
  return 7;
}

function createChart(canvasId, chartInstanceName, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        logError(`Canvas com ID '${canvasId}' n√£o encontrado.`);
        return;
    }
    const ctx = canvas.getContext('2d');
    if (window[chartInstanceName]) window[chartInstanceName].destroy();
    window[chartInstanceName] = new Chart(ctx, config);
}

async function renderDashboards() {
    logInfo("Renderizando dashboards...");
    showLoading();
    
    await loadAllData();
    const allData = [...banco.H1, ...banco.H2];

    if (activeTab === 'dash1') renderDash1();
    if (activeTab === 'dash2') renderDash2(allData);
    if (activeTab === 'dash3') renderDash3(allData);
    
    hideLoading();
}

function renderDash1() {
  ['H1', 'H2'].forEach(h => {
    const dados = banco[h] || [];
    const totalLeitos = HOSPITAIS[h].leitos.length;
    const ocupados = dados.filter(l => l.status === 'Em uso').length;
    const vagos = totalLeitos - ocupados;
    const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
    
    // Atualizar valores no header
    $(`#statOcupados${h}`).textContent = ocupados;
    $(`#statVagos${h}`).textContent = vagos;
    $(`#statTotal${h}`).textContent = totalLeitos;
    $(`#gaugePercent${h}`).textContent = taxaOcupacao + '%';

    // Criar gauge semic√≠rculo (meia rosca)
    let corGauge = '#16a34a'; // Verde
    if (taxaOcupacao > 90) corGauge = '#dc2626'; // Vermelho
    else if (taxaOcupacao > 80) corGauge = '#f59e0b'; // Amarelo

    createChart(`chartOcupacao${h}`, `chartGauge${h}`, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [taxaOcupacao, 100 - taxaOcupacao],
          backgroundColor: [corGauge, '#e5e7eb'],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180, // SEMIC√çRCULO
        rotation: -90,      // ROTA√á√ÉO PARA FICAR COMO MEIA ROSCA
        cutout: '75%',
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false }
        }
      }
    });

    // Filtrar pacientes SP (Sem previs√£o) das proje√ß√µes
    const pacientesComPrevisao = dados.filter(p => 
      p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao'
    );

    // Labels das datas
    const hoje = new Date();
    const labels = [];
    for (let i = 0; i < 7; i++) {
      const data = new Date(hoje);
      data.setDate(hoje.getDate() + i);
      labels.push(data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
    }

    // Gr√°fico de Concess√µes (barras verticais)
    const concessoesData = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      (paciente.concessoes || []).forEach(conc => {
        if (!concessoesData[conc]) concessoesData[conc] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          concessoesData[conc][d]++;
        }
      });
    });

    const sortedConcessoes = Object.entries(concessoesData).sort((a,b) => a[0].localeCompare(b[0]));
    createChart(`chartConcessoes${h}`, `chartConcessoesInst${h}`, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: sortedConcessoes.map(([key, values]) => ({
          label: key,
          data: values,
          backgroundColor: CONC_CORES[key] || '#cccccc'
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true, 
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            },
            title: { 
              display: true, 
              text: 'Benefici√°rios',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Gr√°fico de Linhas de Cuidado (barras verticais)
    const linhasData = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      (paciente.linhas || []).forEach(linha => {
        if (!linhasData[linha]) linhasData[linha] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          linhasData[linha][d]++;
        }
      });
    });

    const sortedLinhas = Object.entries(linhasData).sort((a,b) => a[0].localeCompare(b[0]));
    createChart(`chartLinhas${h}`, `chartLinhasInst${h}`, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: sortedLinhas.map(([key, values]) => ({
          label: key,
          data: values,
          backgroundColor: LINHAS_CORES[key] || '#cccccc'
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true, 
            ticks: { 
              stepSize: 1,
              color: '#ffffff',
              font: { size: 10 }
            }, 
            title: { 
              display: true, 
              text: 'Benefici√°rios',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Gr√°fico de Complexidade (barras verticais)
    const complexidadeData = { 'I': 0, 'II': 0, 'III': 0 };
    const totalPacientes = dados.filter(l => l.status === 'Em uso').length;
    
    dados.filter(l => l.status === 'Em uso').forEach(paciente => {
      const complexidade = paciente.complexidade || 'I';
      if (complexidadeData[complexidade] !== undefined) {
        complexidadeData[complexidade]++;
      }
    });

    // Converter para percentuais
    const complexidadePercent = {};
    Object.keys(complexidadeData).forEach(key => {
      complexidadePercent[key] = totalPacientes > 0 ? 
        ((complexidadeData[key] / totalPacientes) * 100).toFixed(1) : 0;
    });

    createChart(`chartComplexidade${h}`, `chartComplexidadeInst${h}`, {
      type: 'bar',
      data: {
        labels: ['N√≠vel I', 'N√≠vel II', 'N√≠vel III'],
        datasets: [{
          label: '% de Pacientes',
          data: Object.values(complexidadePercent),
          backgroundColor: [
            'var(--complex-1)',
            'var(--complex-2)', 
            'var(--complex-3)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            max: 100,
            ticks: { 
              callback: function(value) {
                return value + '%';
              },
              color: '#ffffff',
              font: { size: 11 }
            },
            title: { 
              display: true, 
              text: '% de Pacientes',
              color: '#ffffff',
              font: { size: 12 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });
  });
  logSuccess('Dashboard 1 renderizado com cores originais.');
}

function renderDash2(allData) {
    logInfo("Renderizando Dashboard Executivo...");
    
    // KPIs Consolidados (nova ordem)
    const totalLeitos = HOSPITAIS.H1.leitos.length + HOSPITAIS.H2.leitos.length;
    const ocupados = allData.filter(p => p.status === 'Em uso').length;
    const taxaOcupacaoGeral = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
    
    $('#kpiOcupacaoGeral').textContent = `${taxaOcupacaoGeral}%`;
    $('#kpiLeitosOcupados').textContent = ocupados;
    
    const tempos = allData.filter(p => p.status === 'Em uso' && p.admAt).map(p => elapsedSince(p.admAt).days);
    $('#kpiTMP').textContent = tempos.length > 0 ? `${Math.round(tempos.reduce((a,b)=>a+b,0)/tempos.length)} dias` : '0 dias';
    
    $('#kpiRotatividade').textContent = totalLeitos > 0 ? `${Math.round((ocupados / totalLeitos) * 30)}%` : '0%';
    $('#kpiAltas24h').textContent = allData.filter(p => p.prevAlta && p.prevAlta.includes('24h')).length;
    
    const spictElegiveis = allData.filter(p => p.status === 'Em uso' && p.spict === 'elegivel').length;
    const totalPacientes = allData.filter(p => p.status === 'Em uso').length;
    $('#kpiSpictPercent').textContent = totalPacientes > 0 ? `${Math.round((spictElegiveis / totalPacientes) * 100)}%` : '0%';
    
    const ppsValues = allData.filter(p => p.status === 'Em uso' && p.pps).map(p => p.pps);
    $('#kpiPpsMedia').textContent = ppsValues.length > 0 ? Math.round(ppsValues.reduce((a,b)=>a+b,0)/ppsValues.length) : '0';

    // An√°lise Preditiva de Altas - Comparativo por Prazo
    const projAltas = { "24h": {H1:0, H2:0}, "48h": {H1:0, H2:0}, "72h": {H1:0, H2:0}, "96h": {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao').forEach(p => {
      const key = p.prevAlta.includes('24h') ? '24h' : p.prevAlta;
      if(projAltas[key]) projAltas[key][p.hospital]++;
    });
    
    createChart('chartAltasComparativo', 'chartAltasComparativoInst', {
      type: 'bar',
      data: {
        labels: Object.keys(projAltas),
        datasets: [
          { label: 'Neomater', data: Object.values(projAltas).map(d=>d.H1), backgroundColor: 'var(--nav-header)' },
          { label: 'Cruz Azul', data: Object.values(projAltas).map(d=>d.H2), backgroundColor: 'var(--text-accent)' }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Timeline de Libera√ß√£o em 24h (Ouro/2R/3R)
    const timeline24h = { 'Ouro': {H1:0, H2:0}, '2R': {H1:0, H2:0}, '3R': {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta.includes('24h')).forEach(p => {
      if (p.prevAlta.includes('Ouro')) timeline24h.Ouro[p.hospital]++;
      else if (p.prevAlta.includes('2R')) timeline24h['2R'][p.hospital]++;
      else if (p.prevAlta.includes('3R')) timeline24h['3R'][p.hospital]++;
    });
    
    createChart('chartTimeline24h', 'chartTimeline24hInst', {
      type: 'bar',
      data: {
        labels: Object.keys(timeline24h),
        datasets: [
          { 
            label: 'Neomater', 
            data: Object.values(timeline24h).map(d=>d.H1), 
            backgroundColor: 'var(--nav-header)'
          },
          { 
            label: 'Cruz Azul', 
            data: Object.values(timeline24h).map(d=>d.H2), 
            backgroundColor: 'var(--text-accent)'
          }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Proje√ß√µes Consolidadas (nova ordem - primeiro concess√µes)
    const pacientesComPrevisao = allData.filter(p => 
      p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao'
    );

    const hoje = new Date();
    const labelsConsolidado = [];
    for (let i = 0; i < 7; i++) {
      const data = new Date(hoje);
      data.setDate(hoje.getDate() + i);
      labelsConsolidado.push(i === 0 ? `Hoje\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})` : 
        `${i}d\n(${data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
    }

    // Concess√µes Consolidadas
    const concessoesConsolidado = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      (paciente.concessoes || []).forEach(conc => {
        if (!concessoesConsolidado[conc]) concessoesConsolidado[conc] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          concessoesConsolidado[conc][d]++;
        }
      });
    });

    const sortedConcessoesConsolidado = Object.entries(concessoesConsolidado).sort((a,b) => a[0].localeCompare(b[0]));
    createChart('chartConcessoesConsolidado', 'chartConcessoesConsolidadoInst', {
      type: 'bar',
      data: {
        labels: labelsConsolidado,
        datasets: sortedConcessoesConsolidado.map(([k,v])=>({
          label: k, data: v,
          backgroundColor: CONC_CORES[k] || '#cccccc'
        }))
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'right',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            stacked: true,
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            stacked: true, 
            title: { 
              display: true, 
              text: 'Concess√µes', 
              color: '#ffffff',
              font: { size: 12 }
            },
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Linhas de Cuidado Consolidadas
    const linhasConsolidado = {};
    pacientesComPrevisao.forEach(paciente => {
      const dias = getDiasAteAlta(paciente.prevAlta);
      (paciente.linhas || []).forEach(linha => {
        if (!linhasConsolidado[linha]) linhasConsolidado[linha] = new Array(7).fill(0);
        const diasParaManter = Math.min(dias, 7);
        for (let d = 0; d < diasParaManter; d++) {
          linhasConsolidado[linha][d]++;
        }
      });
    });

    const sortedLinhasConsolidado = Object.entries(linhasConsolidado).sort((a,b) => a[0].localeCompare(b[0]));
    createChart('chartLinhasConsolidado', 'chartLinhasConsolidadoInst', {
      type: 'bar',
      data: {
        labels: labelsConsolidado,
        datasets: sortedLinhasConsolidado.map(([k,v])=>({
          label: k, data: v,
          backgroundColor: LINHAS_CORES[k] || '#cccccc'
        }))
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'right',
            labels: { 
              color: '#ffffff',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: { 
            stacked: true,
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            stacked: true, 
            title: { 
              display: true, 
              text: 'Cuidados', 
              color: '#ffffff',
              font: { size: 12 }
            },
            ticks: { 
              color: '#ffffff',
              font: { size: 10 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // An√°lise PPS
    const ppsRanges = { '0-3': {H1:0, H2:0}, '4-6': {H1:0, H2:0}, '7-10': {H1:0, H2:0} };
    allData.filter(p => p.status === 'Em uso' && p.pps).forEach(p => {
      const pps = p.pps;
      let range = '7-10';
      if (pps <= 3) range = '0-3';
      else if (pps <= 6) range = '4-6';
      ppsRanges[range][p.hospital]++;
    });
    
    createChart('chartPpsAnalise', 'chartPpsAnaliseInst', {
      type: 'bar',
      data: {
        labels: Object.keys(ppsRanges),
        datasets: [
          { label: 'Neomater', data: Object.values(ppsRanges).map(r=>r.H1), backgroundColor: 'var(--nav-header)' },
          { label: 'Cruz Azul', data: Object.values(ppsRanges).map(r=>r.H2), backgroundColor: 'var(--text-accent)' }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: '#ffffff',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            ticks: { 
              color: '#ffffff',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // An√°lise SPICT-BR
    const spictData = { H1: { elegivel: 0, nao_elegivel: 0 }, H2: { elegivel: 0, nao_elegivel: 0 } };
    allData.filter(p => p.status === 'Em uso').forEach(p => {
      if (p.spict && spictData[p.hospital]) spictData[p.hospital][p.spict]++;
    });
    
    createChart('chartSpictAnalise', 'chartSpictAnaliseInst', {
      type: 'bar',
      data: {
        labels: ['Eleg√≠vel', 'N√£o Eleg√≠vel'],
        datasets: [
          { label: 'Neomater', data: [spictData.H1.elegivel, spictData.H1.nao_elegivel], backgroundColor: 'var(--nav-header)' },
          { label: 'Cruz Azul', data: [spictData.H2.elegivel, spictData.H2.nao_elegivel], backgroundColor: 'var(--text-accent)' }
        ]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            labels: { 
              color: 'var(--text-white)',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              color: 'var(--text-white)',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            ticks: { 
              color: 'var(--text-white)',
              font: { size: 11 }
            },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    logSuccess('Dashboard Executivo renderizado com sucesso!');
}

function renderDash3(allData) {
    logInfo("Renderizando Dashboard 3...");
    // Mant√©m funcionalidade original do Dashboard 3
    logSuccess('Dashboard 3 mantido como original.');
}

// =======================================================================
// ================= SISTEMA DE CONFIGURA√á√ÉO DE CORES ===================
// =======================================================================
const colorConfig = {
  layout: {
    'nav-sidebar': '#0a2b52',
    'nav-header': '#083052', 
    'card': '#ffffff',
    'bg-primary': '#eaf1f9',
    'text-white': '#ffffff',
    'text': '#1f2937',
    'text-muted': '#6b7280',
    'text-accent': '#0a2b52',
    'border': '#e5e7eb'
  },
  status: {
    'status-vago': '#16a34a',
    'status-uso': '#f59e0b',
    'status-uti': '#dc2626',
    'complex-1': '#22c55e',
    'complex-2': '#f59e0b',
    'complex-3': '#dc2626'
  },
  linhas: {
    'linha-aps': '#f59e0b',
    'linha-assistencia': '#0a2b52',
    'linha-cardiologia': '#dc2626',
    'linha-geriatria': '#16a34a',
    'linha-melhor': '#be185d',
    'linha-neurologia': '#0891b2',
    'linha-pneumologia': '#8b5cf6'
  },
  concessoes: {
    'conc-aspiracoes': '#dc2626',
    'conc-curativos': '#8b5cf6',
    'conc-fisioterapia': '#16a34a',
    'conc-fonoaudiologia': '#f59e0b',
    'conc-pad': '#0a2b52'
  },
  timeline: {
    'ouro': '#fbbf24',
    'r2': '#3b82f6',
    'r3': '#8b5cf6'
  },
  graficos: {
    'grafico-1': '#60a5fa',
    'grafico-2': '#8b5cf6',
    'grade': '#374151'
  }
};

function initColorConfig() {
  // Carregar cores do localStorage
  const savedColors = localStorage.getItem('archipelago-colors');
  if (savedColors) {
    try {
      const parsed = JSON.parse(savedColors);
      Object.assign(colorConfig, parsed);
      applyColors();
    } catch(e) {
      logWarning("Erro ao carregar cores salvas:", e);
    }
  }
  
  // Configurar inputs de cor
  Object.keys(colorConfig).forEach(category => {
    Object.keys(colorConfig[category]).forEach(colorKey => {
      const input = document.getElementById(`color-${colorKey}`);
      if (input) {
        input.value = colorConfig[category][colorKey];
        input.addEventListener('input', (e) => {
          colorConfig[category][colorKey] = e.target.value;
          const preview = input.nextElementSibling;
          if (preview) preview.style.background = e.target.value;
          applyColors();
        });
      }
    });
  });
}

function applyColors() {
  const root = document.documentElement;
  
  Object.keys(colorConfig).forEach(category => {
    Object.keys(colorConfig[category]).forEach(colorKey => {
      root.style.setProperty(`--${colorKey}`, colorConfig[category][colorKey]);
      root.style.setProperty(`--color-${colorKey}`, colorConfig[category][colorKey]);
    });
  });
  
  // Salvar no localStorage
  localStorage.setItem('archipelago-colors', JSON.stringify(colorConfig));
}

function resetColors() {
  const defaultColors = {
    layout: {
      'nav-sidebar': '#0a2b52',
      'nav-header': '#083052', 
      'card': '#ffffff',
      'bg-primary': '#eaf1f9',
      'text-white': '#ffffff',
      'text': '#1f2937',
      'text-muted': '#6b7280',
      'text-accent': '#0a2b52',
      'border': '#e5e7eb'
    },
    status: {
      'status-vago': '#16a34a',
      'status-uso': '#f59e0b',
      'status-uti': '#dc2626',
      'complex-1': '#22c55e',
      'complex-2': '#f59e0b',
      'complex-3': '#dc2626'
    },
    linhas: {
      'linha-aps': '#f59e0b',
      'linha-assistencia': '#0a2b52',
      'linha-cardiologia': '#dc2626',
      'linha-geriatria': '#16a34a',
      'linha-melhor': '#be185d',
      'linha-neurologia': '#0891b2',
      'linha-pneumologia': '#8b5cf6'
    },
    concessoes: {
      'conc-aspiracoes': '#dc2626',
      'conc-curativos': '#8b5cf6',
      'conc-fisioterapia': '#16a34a',
      'conc-fonoaudiologia': '#f59e0b',
      'conc-pad': '#0a2b52'
    },
    timeline: {
      'ouro': '#fbbf24',
      'r2': '#3b82f6',
      'r3': '#8b5cf6'
    },
    graficos: {
      'grafico-1': '#60a5fa',
      'grafico-2': '#8b5cf6',
      'grade': '#374151'
    }
  };
  
  Object.assign(colorConfig, defaultColors);
  
  // Atualizar inputs
  Object.keys(colorConfig).forEach(category => {
    Object.keys(colorConfig[category]).forEach(colorKey => {
      const input = document.getElementById(`color-${colorKey}`);
      const preview = input?.nextElementSibling;
      if (input) {
        input.value = colorConfig[category][colorKey];
        if (preview) preview.style.background = colorConfig[category][colorKey];
      }
    });
  });
  
  applyColors();
  alert('Cores restauradas para o padr√£o!');
}

function exportColors() {
  const data = JSON.stringify(colorConfig, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'archipelago-theme.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importColors() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          Object.assign(colorConfig, imported);
          
          // Atualizar inputs
          Object.keys(colorConfig).forEach(category => {
            Object.keys(colorConfig[category]).forEach(colorKey => {
              const input = document.getElementById(`color-${colorKey}`);
              const preview = input?.nextElementSibling;
              if (input) {
                input.value = colorConfig[category][colorKey];
                if (preview) preview.style.background = colorConfig[category][colorKey];
              }
            });
          });
          
          applyColors();
          alert('Tema importado com sucesso!');
        } catch (error) {
          alert('Erro ao importar tema: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function applyPreset(preset) {
  const presets = {
    default: colorConfig,
    blue: {
      layout: { ...colorConfig.layout, 'nav-header': '#2563eb', 'text-accent': '#3b82f6' },
      status: colorConfig.status,
      linhas: colorConfig.linhas,
      concessoes: colorConfig.concessoes,
      timeline: colorConfig.timeline,
      graficos: colorConfig.graficos
    },
    green: {
      layout: { ...colorConfig.layout, 'nav-header': '#059669', 'text-accent': '#10b981' },
      status: { ...colorConfig.status, 'status-vago': '#059669' },
      linhas: colorConfig.linhas,
      concessoes: colorConfig.concessoes,
      timeline: colorConfig.timeline,
      graficos: colorConfig.graficos
    },
    purple: {
      layout: { ...colorConfig.layout, 'nav-header': '#7c3aed', 'text-accent': '#8b5cf6' },
      status: colorConfig.status,
      linhas: colorConfig.linhas,
      concessoes: colorConfig.concessoes,
      timeline: colorConfig.timeline,
      graficos: colorConfig.graficos
    },
    dark: {
      layout: { ...colorConfig.layout, 'nav-sidebar': '#000000', 'bg-primary': '#000000', 'card': '#111111' },
      status: colorConfig.status,
      linhas: colorConfig.linhas,
      concessoes: colorConfig.concessoes,
      timeline: colorConfig.timeline,
      graficos: colorConfig.graficos
    }
  };
  
  if (presets[preset]) {
    Object.assign(colorConfig, presets[preset]);
    
    // Atualizar inputs
    Object.keys(colorConfig).forEach(category => {
      Object.keys(colorConfig[category]).forEach(colorKey => {
        const input = document.getElementById(`color-${colorKey}`);
        const preview = input?.nextElementSibling;
        if (input) {
          input.value = colorConfig[category][colorKey];
          if (preview) preview.style.background = colorConfig[category][colorKey];
        }
      });
    });
    
    applyColors();
    alert(`Tema ${preset} aplicado!`);
  }
}

// =======================================================================
// ================= L√ìGICA DE QR CODE (CORRIGIDA) =====================
// =======================================================================
let qrReader = null;

function handleScan(text) { 
  try {
    const u = new URL(String(text));
    const h = u.searchParams.get('h'); 
    const leito = Number(u.searchParams.get('leito')); 
    
    if(h && ["H1","H2"].includes(h) && leito > 0) {
      logSuccess(`QR Code v√°lido detectado: Hospital ${h}, Leito ${leito}`);
      closeModal("#modalQRScan"); 
      stopScan(); 
      initQRSession(h, leito);
    } else {
      logWarning("QR Code inv√°lido:", text);
    }
  } catch(e) {
    logWarning("QR Code n√£o reconhecido:", text);
  }
}

function initQRSession(hospital, leito) {
  logInfo(`Iniciando sess√£o QR para ${hospital} - Leito ${leito}`);
  isQRMode = true;
  currentHospital = hospital;
  selectedLeito = leito;
  
  // Ocultar navega√ß√£o e toolbars
  document.querySelector('header').style.display = 'none';
  document.getElementById('portalToolbar').style.display = 'none';
  document.querySelector('main').style.padding = '20px';
  document.body.style.paddingLeft = '0';
  
  // Carregar dados do hospital
  loadHospital(hospital).then(() => {
    const leitoData = banco[hospital].find(l => l.leito === leito);
    if (!leitoData) {
      alert(`Leito ${leito} n√£o encontrado no hospital ${hospital}`);
      return;
    }
    
    // Abrir modal apropriado
    if (leitoData.status === 'Vago') {
      openAdmissao(leito);
    } else {
      openAtualizacao(leito);
    }
    
    // Configurar timeout de 2 minutos
    qrSessionTimeout = setTimeout(() => {
      closeAllModals();
      openModal("#modalQRExpired");
    }, 120000);
  });
}

function closeAllModals() {
  closeModal("#modalAdmissao");
  closeModal("#modalAtualizacao");
  if (qrSessionTimeout) {
    clearTimeout(qrSessionTimeout);
    qrSessionTimeout = null;
  }
}

async function startScan(){
  if(!window.Html5Qrcode){
    alert("Leitor n√£o dispon√≠vel.");
    return;
  }
  
  try{
    if(qrReader) await stopScan();
    qrReader = new Html5Qrcode('qrRegion');
    await qrReader.start(
      { facingMode:'environment' },
      { fps:10, qrbox:250 },
      handleScan,
      ()=>{}
    );
  } catch(e){
    logError("Erro ao acessar c√¢mera:", e);
    alert("N√£o foi poss√≠vel acessar a c√¢mera.");
    stopScan();
    closeModal("#modalQRScan");
  }
}

function stopScan(){
  if(!qrReader) return Promise.resolve();
  return qrReader.stop().then(()=>{
    qrReader.clear();
    qrReader=null;
  }).catch(()=>{});
}

function buildQRGrid(){
  const h = $("#b_hospital").value;
  const from = Math.max(1, parseInt($("#b_from").value||"1"));
  const to   = Math.max(from, parseInt($("#b_to").value||"1"));
  const limit = h==="H1"?13:16;
  const f = Math.min(from, limit);
  const t = Math.min(to, limit);
  const base = `${location.origin}${location.pathname}`;
  const grid = $("#qr_grid");
  grid.innerHTML = "";
  
  for(let i=f; i<=t; i++){
    const url = `${base}?h=${h}&leito=${i}`;
    const cell = document.createElement("div");
    cell.style.cssText = "background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;min-height:200px";
    cell.innerHTML = `<div style="display:inline-block;border:1px solid var(--border);padding:8px;border-radius:10px;background:white;margin-bottom:10px"></div><div style="font-size:12px;color:var(--text)">Leito ${i} ‚Ä¢ ${HOSPITAIS[h].nome}</div>`;
    grid.appendChild(cell);
    new QRCode(cell.querySelector("div"), {text:url, width:160, height:160});
  }
}

// Verificar se a URL cont√©m par√¢metros QR na inicializa√ß√£o
function checkQRParams() {
  const params = new URLSearchParams(window.location.search);
  const h = params.get('h');
  const leito = params.get('leito');
  
  if (h && leito && ["H1","H2"].includes(h)) {
    logInfo("Par√¢metros QR detectados na URL");
    initQRSession(h, parseInt(leito));
    return true;
  }
  return false;
}

// =======================================================================
// ===================== INICIALIZA√á√ÉO E EVENTOS =========================
// =======================================================================
function setupEventListeners() {
  // Navega√ß√£o Principal (Menu Lateral)
  document.querySelectorAll(".side-menu-item").forEach(b=> b.onclick = (e)=> {
    e.preventDefault();
    setTab(b.dataset.tab);
  });
  
  // Seletores de Hospital (Toolbar)
  $("#btnH1").onclick = ()=>{ setHospitalSelectors("H1"); loadHospital("H1"); };
  $("#btnH2").onclick = ()=>{ setHospitalSelectors("H2"); loadHospital("H2"); };

  // Bot√µes do Header
  $('#refreshBtn').onclick = () => { 
    logInfo("Refresh manual"); 
    if (activeTab.startsWith('dash')) { 
      renderDashboards() 
    } else { 
      loadHospital(currentHospital) 
    } 
  };

  // Menu Lateral - Fechar
  $('#closeMenuBtn').onclick = () => {
    $('#side-menu').classList.toggle('open');
  };

  // Configura√ß√µes no Menu Lateral
  $('#settingsMenuBtn').onclick = () => {
    $('#settingsMenuDropdown').classList.toggle('show');
  };

  $('#btnReadQR').onclick = () => { 
    $('#settingsMenuDropdown').classList.remove('show'); 
    openModal("#modalQRScan"); 
    startScan(); 
  };

  $('#btnPrintQR').onclick = () => { 
    $('#settingsMenuDropdown').classList.remove('show'); 
    openModal("#modalBulkQR"); 
  };

  $('#btnCores').onclick = () => { 
    $('#settingsMenuDropdown').classList.remove('show'); 
    openModal("#modalCores"); 
  };

  $('#btnSaveToCloud').onclick = async () => {
    $('#settingsMenuDropdown').classList.remove('show');
    const userCode = prompt('Digite seu c√≥digo √∫nico para salvar as cores na nuvem:');
    if (!userCode) return;
    
    try {
      await apiCall({
        action: 'save_colors',
        user_id: userCode.trim(),
        colors: JSON.stringify(colorConfig)
      });
      alert('‚úÖ Cores salvas na nuvem com sucesso!');
    } catch(error) {
      alert('‚ùå Erro ao salvar: ' + error.message);
    }
  };
  
  // Fechar dropdowns se clicar fora
  window.onclick = (event) => {
      if (!event.target.closest('.settings-menu-btn')) {
          if ($('#settingsMenuDropdown').classList.contains('show')) {
            $('#settingsMenuDropdown').classList.remove('show');
          }
      }
  };
  
  // Menu Lateral (Hamburger)
  $('.hamburger-menu').onclick = () => {
    $('#side-menu').classList.toggle('open');
  };

  // A√ß√µes dos Modais
  document.querySelectorAll("[data-close]").forEach(b=> b.onclick = ()=> closeModal(b.getAttribute("data-close")) );
  $("#b_generate").onclick = buildQRGrid;
  $("#reloadPage").onclick = ()=> location.reload();

  // Modal de Admiss√£o
  $('#a_cancel').onclick = async () => { if (await confirmAction("Cancelar admiss√£o?")) closeModal("#modalAdmissao"); };
  $('#a_save').onclick = async ()=>{ 
    if(!await confirmAction("Salvar e admitir paciente?")) return; 
    try { 
      const payload = { 
        action: 'admit', 
        hospital: currentHospital, 
        leito: selectedLeito, 
        nome: $("#a_nome").value.trim(), 
        idade: Number($("#a_idade").value)||null, 
        matricula: $("#a_matricula").value.trim(), 
        pps: Number($("#a_pps").value)||null, 
        spict: $("#a_spict").value, 
        complexidade: $("#a_complexidade").value,
        prevAlta: $("#a_prev").value, 
        linhas: Array.from(document.querySelectorAll("#a_linhas input:checked")).map(i=>i.value), 
        concessoes: Array.from(document.querySelectorAll("#a_concessoes input:checked")).map(i=>i.value) 
      }; 
      await apiCall(payload); 
      closeModal("#modalAdmissao"); 
      if (isQRMode) { 
        showSuccessMessage(); 
      } else { 
        await loadHospital(currentHospital); 
      } 
    } catch(error) { 
      alert('Erro: ' + error.message); 
    } 
  };

  // Modal de Atualiza√ß√£o
  $('#u_cancel').onclick = async () => { if (await confirmAction("Cancelar altera√ß√µes?")) closeModal("#modalAtualizacao"); };
  $('#u_alta').onclick = ()=> darAltaFlow(selectedLeito);
  $('#u_save').onclick = async ()=>{ 
    if(!await confirmAction("Salvar altera√ß√µes?")) return; 
    try { 
      const payload = { 
        action: 'update', 
        hospital: currentHospital, 
        leito: selectedLeito, 
        idade: Number($("#u_idade").value)||null, 
        pps: Number($("#u_pps").value)||null, 
        spict: $("#u_spict").value,
        complexidade: $("#u_complexidade").value, 
        prevAlta: $("#u_prev").value, 
        linhas: Array.from(document.querySelectorAll("#u_linhas input:checked")).map(i=>i.value), 
        concessoes: Array.from(document.querySelectorAll("#u_concessoes input:checked")).map(i=>i.value) 
      }; 
      await apiCall(payload); 
      closeModal("#modalAtualizacao"); 
      if (isQRMode) { 
        showSuccessMessage(); 
      } else { 
        await loadHospital(currentHospital); 
      } 
    } catch(error) { 
      alert('Erro: ' + error.message); 
    } 
  };

  // Sistema de Configura√ß√£o de Cores
  document.querySelectorAll('.color-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.color-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.color-section').forEach(s => s.classList.remove('active'));
      
      tab.classList.add('active');
      document.getElementById(tab.dataset.category).classList.add('active');
    });
  });

  $('#resetCores').onclick = resetColors;
  $('#exportCores').onclick = exportColors;
  $('#importCores').onclick = importColors;
  $('#aplicarCores').onclick = () => {
    applyColors();
    closeModal("#modalCores");
    alert('Cores aplicadas com sucesso!');
  };

  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      applyPreset(btn.dataset.preset);
    });
  });
}

// Fun√ß√£o de inicializa√ß√£o
(async function init(){
  logInfo("=== INICIALIZANDO ARCHIPELAGO DASHBOARD COMPLETO ===");
  showLoading();
  setupEventListeners();
  
  await testConnection();
  
  // Verificar se √© acesso via QR Code primeiro
  if (checkQRParams()) {
    hideLoading();
    return;
  }
  
  logInfo("üíº MODO PORTAL DETECTADO - Sess√£o gestor iniciada");
  setHospitalSelectors("H1");
  setTab("leitos");
  await loadAllData();
  
  // Inicializar sistema de cores
  initColorConfig();
  
  autoRefreshInterval = setInterval(() => {
    if (!isQRMode) {
      logInfo("Auto-refresh executado");
      Promise.all([loadHospital("H1"), loadHospital("H2")]).then(() => {
        if(activeTab.startsWith('dash')) renderDashboards();
      });
    }
  }, 60000);
  
  updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
  
  hideLoading();
  logInfo("=== INICIALIZA√á√ÉO CONCLU√çDA - SISTEMA COMPLETO OPERACIONAL ===");
})();

</script>
</body>
</html>
