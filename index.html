<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago ‚Äì Gest√£o de Leitos (MVP)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>


  <style>
    :root{
      --nav:#0a2b52;
      --nav-2:#083052;
      --bg:#eaf1f9;
      --bg-deep:#d9e7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#dc2626;
      --blue-veil:#4f86ff33;
      --shadow-1:0 4px 12px rgba(11,44,82,.08);
      --shadow-2:0 10px 28px rgba(11,44,82,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0; overflow-x: hidden;}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 100%);
      transition: padding-left 0.3s ease;
    }

    /* =================== HEADER E NAVEGA√á√ÉO =================== */
    header{
      background:linear-gradient(90deg,var(--nav),var(--nav-2));
      color:#fff; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      box-shadow:0 6px 18px rgba(8,48,82,.20);
      position:sticky; top: 0; z-index:100;
    }
    .header-left, .header-right { display: flex; align-items: center; gap: 16px; }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff33;backdrop-filter:blur(2px)}
    .logo::after{content:"PS";font-weight:700}
    .title h1{margin:0;font-size:18px}
    .title small{display:block;color:#dbe7f5; font-size: 12px;}

    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--nav);border-color:#fff}

    .header-btn { background: #ffffff1a; border: 1px solid #ffffff33; color: #fff; border-radius: 10px; padding: 8px 12px; cursor: pointer; position: relative; }
    .header-btn:hover { background: #ffffff2a; }
    .dropdown-menu { display: none; position: absolute; top: 110%; right: 0; background: white; border-radius: 10px; box-shadow: var(--shadow-2); overflow: hidden; z-index: 110; min-width: 180px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 10px 15px; color: var(--text); font-size: 14px; cursor: pointer; }
    .dropdown-item:hover { background-color: #f3f4f6; }

    /* =================== LAYOUT V2: MENU LATERAL =================== */
    #hamburger-menu { font-size: 24px; cursor: pointer; display: none; }
    #side-menu {
        position: fixed; top: 0; left: -260px; width: 250px; height: 100%;
        background: var(--nav); color: white;
        box-shadow: 6px 0 20px rgba(8,48,82,.25);
        transition: left 0.3s ease; z-index: 1001; padding-top: 80px;
    }
    #side-menu.open { left: 0; }
    body.side-menu-open { padding-left: 250px; }
    .side-menu-item {
        display: flex; align-items: center; gap: 15px;
        padding: 15px 20px; color: #e5e7eb;
        text-decoration: none; font-size: 14px;
        border-left: 4px solid transparent;
    }
    .side-menu-item:hover { background: #ffffff1a; border-left-color: #3b82f6; }
    .side-menu-item.active { background: #ffffff2a; border-left-color: #fff; font-weight: 600; color: #fff;}
    .layout-v2 .tabs { display: none; }
    .layout-v2 #hamburger-menu { display: block; }
    .layout-v2 #v1-header-buttons { display: none; }
    #v2-header-buttons { display: none; }
    .layout-v2 #v2-header-buttons { display: flex; }


    /* =================== LAYOUT SWITCHER =================== */
    .layout-switcher { display: flex; align-items: center; gap: 8px; }
    .switch { position: relative; display: inline-block; width: 38px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ffffff33; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #3b82f6; }
    input:checked + .slider:before { transform: translateX(16px); }

    /* =================== LAYOUT GERAL =================== */
    main{max-width:1600px;margin:18px auto 100px;padding:0 24px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--nav);border-color:var(--nav);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.hospital{ background:var(--nav); border-color:var(--nav); color:#fff; transition: all 0.2s ease; }
    .btn.hospital.active{ background:#1e40af; border-color:#1e40af; box-shadow:0 0 0 3px rgba(30,64,175,0.3); transform: translateY(-1px); }
    .btn.hospital:hover{ background:#1e40af; }
    .select{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px}
    #lastUpdateInfo { font-size: 12px; color: #dbe7f5; }

    /* =================== CARD DE LEITO =================== */
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(450px, 1fr));gap:18px;position:relative;z-index:1}
    .card{
      position:relative; background:var(--card); 
      border-radius:20px; padding:16px;
      box-shadow: var(--shadow-1), var(--shadow-2), 0 0 0 1px rgba(255,255,255,.6) inset;
      transform:translateY(0); transition:transform .18s ease, box-shadow .18s ease;
      /* Efeito 3D com borda gradiente */
      border: 2px solid transparent;
      background-clip: padding-box;
      border-image: linear-gradient(to bottom, #FFFFFF, #E5E7EB) 1;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16), 0 26px 64px rgba(11,44,82,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
    }
    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted);font-size:12px}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;color:#111;border:1px solid var(--border);background:#fff}
    .status.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .status.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}
    .tipo{font-size:12px;color:#fff;background:#6b7280;border-radius:999px;padding:4px 8px}
    .tipo.uti{background:var(--danger)}
    .tipo.enf{background:#0ea5e9}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px}
    .field .label{font-size:11px;color:#6b7280}
    .field .value{font-weight:600}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* =================== TABELA DE LEITOS =================== */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
    th{font-size:12px;color:#6b7280;text-align:left}
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f9fafb; }
    td{font-size:13px}
    .hidden{display:none}

    /* =================== MODAIS =================== */
    .backdrop{position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;overflow:auto}
    .modal{background:#fff;max-width:860px;width:100%;max-height:90vh;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
    .modal .content{padding:16px;overflow-y:auto;flex:1}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .input,.select2,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    .label{font-size:12px;color:#6b7280;margin-bottom:4px;display:block}
    
    /* =================== DASHBOARDS =================== */
    .dash-grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    @media (max-width: 900px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    @media (max-width: 1000px) { .grid-5 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } }
    .span-2 { grid-column: span 2; }
    @media (max-width: 1200px) { .span-2 { grid-column: span 1; } }

    .dashboard-card {
      background: #fff; border: 1px solid var(--border); border-radius: 16px;
      padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .dashboard-card h3 {
      margin: 0 0 15px 0; font-size: 18px; color: var(--nav); text-align: center;
      padding-bottom: 10px; border-bottom: 1px solid var(--border);
    }
    .dashboard-card h4 { margin: 20px 0 10px 0; font-size: 14px; color: var(--text); }
    
    .kpi-card {
        background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 15px; text-align: center; position: relative;
    }
    .kpi-value { font-size: 36px; font-weight: 700; color: var(--nav); }
    .kpi-label { font-size: 13px; color: var(--muted); margin-top: 5px; }
    .kpi-gauge-wrapper { position: absolute; top: 10px; right: 10px; width: 40px; height: 25px; }
    
    .chart-container { position: relative; width:100%; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    .dash-hospital-header { display: flex; align-items: center; gap: 24px; margin-bottom: 20px; }
    .gauge-wrapper { position: relative; width: 150px; height: 100px; }
    .gauge-wrapper canvas { width: 100% !important; height: auto !important; }
    .gauge-text { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center; }
    .gauge-text .percent { font-size: 24px; font-weight: 700; color: var(--nav); }
    .gauge-text .label { font-size: 11px; color: var(--muted); }
    .header-stats { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .header-stats .stat-box { padding: 10px; text-align: left; background: #f9fafb; border-radius: 10px; }
    .header-stats .stat-value { font-size: 22px; font-weight: bold; color: var(--nav); }
    .header-stats .stat-label { font-size: 11px; color: var(--muted); }
    
    .dash-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .dash-table th, .dash-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
    .dash-table th { font-size: 12px; color: var(--muted); }

    .view-switcher { display: flex; gap: 5px; margin-bottom: 10px; }
    .switcher-btn { padding: 4px 10px; font-size: 12px; background: #f3f4f6; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; cursor: pointer; }
    .switcher-btn.active { background: var(--nav); color: #fff; border-color: var(--nav); }
    .kpi-grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px 0; min-height: 120px;}
    .kpi-grid-item { background: #f9fafb; border-radius: 12px; padding: 15px; text-align: center; }
    .kpi-grid-value { font-size: 24px; font-weight: 700; color: var(--nav); }
    .kpi-grid-label { font-size: 12px; color: var(--muted); }
    .kpi-grid-trend { font-size: 12px; margin-top: 5px; }
  </style>
</head>
<body>

  <div id="side-menu">
    <a href="#" class="side-menu-item active" data-tab="leitos">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 12a.5.5 0 0 1 .5-.5h18a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/><path d="M20 16H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2zM9 8H7v6h2V8z"/></svg>
      <span>Leitos (Cards)</span>
    </a>
    <a href="#" class="side-menu-item" data-tab="leitos2">
       <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
      <span>Leitos (Tabela)</span>
    </a>
    <a href="#" class="side-menu-item" data-tab="dash1">
       <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 8V2M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M17.66 6.34l-4.24 4.24M6.34 17.66l-4.24 4.24M22 12h-6M8 12H2"/></svg>
      <span>Dash Geral 1</span>
    </a>
    <a href="#" class="side-menu-item" data-tab="dash2">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10M12 20V4M6 20V14"/></svg>
      <span>Dash Geral 2</span>
    </a>
  </div>

  <header id="appHeader">
    <div class="header-left">
      <div id="hamburger-menu">‚ò∞</div>
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Archipelago ‚Äì Gest√£o de Leitos</h1>
          <small>Prot√≥tipo (estado atual, sem hist√≥rico)</small>
        </div>
      </div>
      <div class="layout-switcher">
        <label class="switch">
          <input type="checkbox" id="layoutToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="leitos">Leitos (Cards)</button>
      <button class="tab" data-tab="leitos2">Leitos (Tabela)</button>
      <button class="tab" data-tab="dash1">Dash Geral</button>
      <button class="tab" data-tab="dash2">Dash Geral 2</button>
    </nav>

    <div class="header-right">
        <span id="lastUpdateInfo"></span>
        <div id="v1-header-buttons" class="header-left">
            <button class="header-btn" id="qrCodeBtn">
                <span>QR Code</span>
                <div class="dropdown-menu" id="qrDropdown">
                    <div class="dropdown-item" id="btnReadQR_v1">Ler QR Code</div>
                    <div class="dropdown-item" id="btnPrintQR_v1">Imprimir QR Codes</div>
                </div>
            </button>
            <button class="header-btn" id="refreshBtn_v1">Atualizar</button>
        </div>
        <div id="v2-header-buttons" class="header-left">
             <button class="header-btn" id="refreshBtn_v2">Atualizar</button>
             <button class="header-btn" id="settingsBtn">
                <span>‚öôÔ∏è</span>
                <div class="dropdown-menu" id="settingsDropdown">
                    <div class="dropdown-item" id="btnReadQR_v2">Ler QR Code</div>
                    <div class="dropdown-item" id="btnPrintQR_v2">Imprimir QR Codes</div>
                </div>
            </button>
        </div>
    </div>
  </header>

  <main>
    <div class="toolbar" id="portalToolbar">
      <div class="row">
        </div>
      <div class="row">
        <button class="btn hospital active" data-h="H1" id="btnH1">Neomater</button>
        <button class="btn hospital" data-h="H2" id="btnH2">Cruz Azul</button>
      </div>
    </div>

    <section id="leitosView" class="grid"></section>

    <section id="leitos2View" class="hidden">
      <div style="margin-bottom:8px">
        <select id="selHospital2" class="select">
          <option value="H1">Neomater</option>
          <option value="H2">Cruz Azul</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th class="sortable" data-sort="leito">Leito</th>
            <th class="sortable" data-sort="tipo">Tipo</th>
            <th class="sortable" data-sort="status">Status</th>
            <th class="sortable" data-sort="nome">Nome</th>
            <th class="sortable" data-sort="idade">Idade</th>
            <th class="sortable" data-sort="tempoInternacao">Tempo de Interna√ß√£o</th>
            <th class="sortable" data-sort="pps">PPS</th>
            <th class="sortable" data-sort="spict">SPICT-BR</th>
            <th class="sortable" data-sort="prevAlta">Prev. Alta</th>
          </tr>
        </thead>
        <tbody id="tbLeitos"></tbody>
      </table>
    </section>

    <section id="dash1" class="hidden">
        <h2 style="margin-bottom:20px">Dash Geral 1: Vis√£o Detalhada por Hospital</h2>
        <div class="dash-grid grid-2">
            <div class="dashboard-card" id="dash-card-h1">
                <h3>Neomater</h3>
                <div class="dash-hospital-header">
                    <div class="gauge-wrapper"><canvas id="chartOcupacaoH1"></canvas><div class="gauge-text"><div class="percent" id="gaugePercentH1">0%</div><div class="label">Ocupa√ß√£o</div></div></div>
                    <div class="header-stats">
                        <div class="stat-box"><div class="stat-value" id="statOcupadosH1">0</div><div class="stat-label">Ocupados</div></div>
                        <div class="stat-box"><div class="stat-value" id="statVagosH1">0</div><div class="stat-label">Vagos</div></div>
                        <div class="stat-box"><div class="stat-value" id="statTotalH1">0</div><div class="stat-label">Total Leitos</div></div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>Proje√ß√£o de Altas (4 dias)</h4>
                    <div class="view-switcher">
                        <button class="switcher-btn active" data-view="line" data-h="H1">Linha</button>
                        <button class="switcher-btn" data-view="hbar" data-h="H1">Barras</button>
                        <button class="switcher-btn" data-view="kpi" data-h="H1">KPIs</button>
                    </div>
                </div>
                <div id="altas-view-line-H1" class="chart-container h-250"><canvas id="chartAltasH1_line"></canvas></div>
                <div id="altas-view-hbar-H1" class="chart-container h-250 hidden"><canvas id="chartAltasH1_hbar"></canvas></div>
                <div id="altas-view-kpi-H1" class="kpi-grid-container hidden"></div>

                <h4>Proje√ß√£o de Linhas de Cuidado</h4>
                <div class="chart-container h-300"><canvas id="chartLinhasH1"></canvas></div>
                <h4>Proje√ß√£o de Concess√µes</h4>
                <div class="chart-container h-250"><canvas id="chartConcessoesH1"></canvas></div>
            </div>

            <div class="dashboard-card" id="dash-card-h2">
                <h3>Cruz Azul</h3>
                <div class="dash-hospital-header">
                    <div class="gauge-wrapper"><canvas id="chartOcupacaoH2"></canvas><div class="gauge-text"><div class="percent" id="gaugePercentH2">0%</div><div class="label">Ocupa√ß√£o</div></div></div>
                    <div class="header-stats">
                        <div class="stat-box"><div class="stat-value" id="statOcupadosH2">0</div><div class="stat-label">Ocupados</div></div>
                        <div class="stat-box"><div class="stat-value" id="statVagosH2">0</div><div class="stat-label">Vagos</div></div>
                        <div class="stat-box"><div class="stat-value" id="statTotalH2">0</div><div class="stat-label">Total Leitos</div></div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>Proje√ß√£o de Altas (4 dias)</h4>
                    <div class="view-switcher">
                        <button class="switcher-btn active" data-view="line" data-h="H2">Linha</button>
                        <button class="switcher-btn" data-view="hbar" data-h="H2">Barras</button>
                        <button class="switcher-btn" data-view="kpi" data-h="H2">KPIs</button>
                    </div>
                </div>
                <div id="altas-view-line-H2" class="chart-container h-250"><canvas id="chartAltasH2_line"></canvas></div>
                <div id="altas-view-hbar-H2" class="chart-container h-250 hidden"><canvas id="chartAltasH2_hbar"></canvas></div>
                <div id="altas-view-kpi-H2" class="kpi-grid-container hidden"></div>
                
                <h4>Proje√ß√£o de Linhas de Cuidado</h4>
                <div class="chart-container h-300"><canvas id="chartLinhasH2"></canvas></div>
                <h4>Proje√ß√£o de Concess√µes</h4>
                <div class="chart-container h-250"><canvas id="chartConcessoesH2"></canvas></div>
            </div>
        </div>
    </section>
    
    <section id="dash2" class="hidden">
        <h2 style="margin-bottom:20px">Dash Geral 2: Vis√£o Consolidada e Comparativa</h2>
        <div class="dash-grid grid-5" style="margin-bottom: 24px;">
            <div class="kpi-card">
                <div class="kpi-gauge-wrapper"><canvas id="kpiGaugeOcupacao"></canvas></div>
                <div class="kpi-value" id="kpiOcupacaoGeral">0%</div>
                <div class="kpi-label">Taxa de Ocupa√ß√£o Geral</div>
            </div>
            <div class="kpi-card"><div class="kpi-value" id="kpiAltas48h">0</div><div class="kpi-label">Altas Previstas (48h)</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiUtiOcupados">0</div><div class="kpi-label">Leitos de UTI Ocupados</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiTMP">0 dias</div><div class="kpi-label">Tempo M√©dio Perman√™ncia</div></div>
            <div class="kpi-card"><div class="kpi-value" id="kpiIdadeMedia">0</div><div class="kpi-label">Idade M√©dia</div></div>
        </div>
        <div class="dashboard-card" style="margin-bottom: 24px;">
             <h4>Vis√£o Consolidada (Neomater + Cruz Azul)</h4>
             <div class="dash-grid grid-2">
                <div class="chart-container h-300"><canvas id="chartLinhasConsolidado"></canvas></div>
                <div class="chart-container h-300"><canvas id="chartConcessoesConsolidado"></canvas></div>
             </div>
        </div>
        <div class="dashboard-card">
            <h4>An√°lise Comparativa por Hospital</h4>
            <div class="dash-grid grid-2">
                <div>
                    <h5>Efici√™ncia de Recursos</h5>
                    <div id="comparativoRecursos"></div>
                </div>
                <div>
                    <h5>Proje√ß√£o de Altas</h5>
                     <div class="chart-container h-250"><canvas id="chartAltasComparativo"></canvas></div>
                </div>
            </div>
        </div>
    </section>
    
    <section id="dash3" class="hidden"></section>
    <section id="dash4" class="hidden"></section>
  </main>

  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Admiss√£o de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matr√≠cula (n√∫mero)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0‚Äì10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="a_prev">Previs√£o de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:8px;color:#6b7280">
          * Data e hora de admiss√£o ser√£o registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Atualiza√ß√£o de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>

        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matr√≠cula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admiss√£o (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0‚Äì10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_prev">Previs√£o de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>

        <div class="mini" id="internadoHa" style="margin-top:8px;color:#6b7280"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Confirma√ß√£o</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">N√£o</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div class="mini" style="margin-bottom:8px">Se a c√¢mera n√£o abrir, use a sele√ß√£o manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impress√£o</strong>
        <button class="btn" data-close="#modalBulkQR" style="padding:5px 10px;font-size:16px;line-height:1">‚úï</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:#fff;padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" class="qr-grid"></div>
      </div>
    </div>
  </div>

  <div id="modalQRExpired" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Sess√£o Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code pr√≥ximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>
  
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Opera√ß√£o realizada com sucesso.</p>
    <p style="color:#6b7280;font-size:14px">Voc√™ pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>
  
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


  <script>
  // =======================================================================
  // ========================== CONFIGURA√á√ÉO ===============================
  // =======================================================================
  const API_URL = 'https://script.google.com/macros/s/AKfycbzn8BlUD8by0GykYlJa1pmbYtuXOr8aEUzOOBhpfSGl-i1x8LhAnGSRzqdyV2lANnIP/exec';

  function logInfo(message, data = null) { console.log(`üîµ [Archipelago] ${message}`, data || ''); }
  function logSuccess(message, data = null) { console.log(`üü¢ [SUCCESS] ${message}`, data || ''); }
  function logError(message, error = null) { console.error(`üî¥ [ERROR] ${message}`, error || ''); }
  function logWarning(message, data = null) { console.warn(`üü° [WARNING] ${message}`, data || ''); }

  const HOSPITAIS = {
    H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
    H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
  };

  const banco = { H1: [], H2: [] };
  const LINHAS = ["Assistencia","Geriatria","APS","Cardiologia","Pneumologia","Neurologia","Melhor Cuidado"];
  const CONC   = ["PAD","Fisioterapia","Fonoaudiologia","Aspiracoes","Curativos"];
  
  LINHAS.sort((a, b) => a.localeCompare(b));
  CONC.sort((a, b) => a.localeCompare(b));

  const LINHAS_CORES = {
    "APS": "#f59e0b", "Assistencia": "#0a2b52", "Cardiologia": "#dc2626", "Geriatria": "#16a34a",
    "Melhor Cuidado": "#be185d", "Neurologia": "#0891b2", "Pneumologia": "#8b5cf6"
  };
  const CONC_CORES = {
    "Aspiracoes": "#dc2626", "Curativos": "#8b5cf6", "Fisioterapia": "#16a34a",
    "Fonoaudiologia": "#f59e0b", "PAD": "#0a2b52"
  };

  // =======================================================================
  // ========================== ESTADO DA UI ===============================
  // =======================================================================
  let currentHospital = "H1";
  let activeTab = "leitos";
  let selectedLeito = null;
  let isQRMode = false;
  let lastUpdateTime = Date.now();
  let autoRefreshInterval = null;
  let updateIndicatorInterval = null;
  
  let sortState = { key: 'leito', direction: 'asc' };

  const $ = sel => document.querySelector(sel);
  
  function openModal(sel){ const el=$(sel); el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
  function closeModal(sel){ const el=$(sel); el.style.display="none"; el.setAttribute("aria-hidden","true"); }
  
  function confirmAction(msg){
    return new Promise(res=>{
      $("#confirmMsg").textContent = msg || "Confirma?";
      openModal("#modalConfirm");
      $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
      $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
    });
  }
  
  function initials(nome){ if(!nome) return "‚Äî"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }
  
  function fmtDateTime(iso){
    if(!iso) return "‚Äî";
    const d=new Date(iso);
    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function elapsedMsToDays(ms) {
    if (ms === null || ms === undefined) return 0;
    return Math.floor(ms / 86400000);
  }
  
  function elapsedSince(iso){
    if(!iso) return { text: "‚Äî", days: 0 };
    const ms = Date.now() - new Date(iso).getTime();
    const d = elapsedMsToDays(ms);
    const h = Math.floor((ms%86400000)/3600000);
    return { text: `${d}d ${h}h`, days: d };
  }
  
  function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }
  
  function updateTimeIndicator() {
    if(isQRMode) return;
    const indicator = document.getElementById('lastUpdateInfo');
    if(indicator) {
      const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
      const seconds = elapsed % 60;
      const minutes = Math.floor(elapsed / 60);
      if (minutes > 0) {
        indicator.textContent = `Atualizado h√° ${minutes}m`;
      } else {
        indicator.textContent = `Atualizado h√° ${seconds}s`;
      }
    }
  }

  async function testConnection() {
    logInfo("Testando conex√£o com a API...");
    try {
      const res = await fetch(API_URL + '?action=test');
      if (res.ok) {
        logSuccess("Conex√£o com a API estabelecida!");
        return true;
      }
      logError(`Falha na conex√£o: HTTP ${res.status}`);
      return false;
    } catch(error) {
      logError("Erro ao testar conex√£o:", error);
      return false;
    }
  }
  
  async function loadAllData() {
    await Promise.all([
        banco.H1.length === 0 ? loadHospital('H1') : Promise.resolve(),
        banco.H2.length === 0 ? loadHospital('H2') : Promise.resolve()
    ]);
  }

  async function loadHospital(h) {
    logInfo(`Iniciando carregamento do hospital: ${h}`);
    try {
      const url = `${API_URL}?action=state&hospital=${h}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
      
      banco[h] = json.data;
      lastUpdateTime = Date.now();
      logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${json.data.length}`);
      
      if (activeTab === 'leitos') renderCards();
      if (activeTab === 'leitos2') renderTable();
    } catch(error) {
      logError(`Erro ao carregar hospital ${h}:`, error);
      alert(`Erro ao conectar com a planilha: ${error.message}\n\nVerifique se o deploy do Google Apps Script est√° como 'Acess√≠vel para qualquer pessoa'.`);
      banco[h] = [];
      if (activeTab === 'leitos') renderCards();
      if (activeTab === 'leitos2') renderTable();
    }
  }

  async function apiCall(payload) {
    logInfo(`Iniciando opera√ß√£o: ${payload.action}`, payload);
    try {
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(payload)) {
        if (Array.isArray(value)) params.append(key, value.join('|'));
        else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
      }
      
      const url = `${API_URL}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Erro na opera√ß√£o');
      
      logSuccess(`Opera√ß√£o ${payload.action} realizada com sucesso!`);
      return json.data;
    } catch(error) {
      logError(`Erro na opera√ß√£o ${payload.action}:`, error);
      throw new Error(error.message || 'Erro na opera√ß√£o');
    }
  }
  
  function setTab(tab){
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".side-menu-item").forEach(b=>b.classList.remove("active"));
    
    const activeTabEl = $(`.tab[data-tab='${tab}']`);
    if(activeTabEl) activeTabEl.classList.add("active");
    
    const activeSideMenuItem = $(`.side-menu-item[data-tab='${tab}']`);
    if(activeSideMenuItem) activeSideMenuItem.classList.add("active");

    activeTab = tab;
    route();
    
    if(tab.startsWith('dash')) {
      setTimeout(() => renderDashboards(), 50);
    }
  }

  function setHospitalSelectors(h){
    currentHospital = h;
    $('#selHospital2').value = h;
    document.querySelectorAll('.btn.hospital').forEach(btn => btn.classList.remove('active'));
    $(`.btn.hospital[data-h="${h}"]`)?.classList.add('active');
  }
  
  function route(){
    const sections = ["leitosView","leitos2View","dash1","dash2","dash3","dash4"];
    sections.forEach(id => {
      const el = $(`#${id}`);
      if(el) el.classList.add("hidden");
    });

    const activeSectionId = activeTab === 'leitos' ? 'leitosView' : (activeTab === 'leitos2' ? 'leitos2View' : activeTab);
    $(`#${activeSectionId}`)?.classList.remove("hidden");

    if (!document.body.classList.contains('layout-v2')) {
        $('#portalToolbar').style.display = activeTab.startsWith('dash') ? 'none' : 'flex';
    } else {
        $('#portalToolbar').style.display = 'none';
    }

    if(activeTab === "leitos") renderCards();
    if(activeTab === "leitos2") renderTable();
  }

  function renderCards(){
    const container = $("#leitosView");
    container.innerHTML = "";
    const leitos = banco[currentHospital] || [];

    if(leitos.length === 0) {
        container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">Nenhum leito para exibir ou aguardando dados...</p>`;
        return;
    }

    leitos.forEach(l=>{
      const card = document.createElement("div");
      card.className = "card";

      const statusClass = l.status==="Em uso" ? "warn" : "ok";
      const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
      
      card.innerHTML = `
        <div class="top">
          <div class="wrap">
            <span class="status ${statusClass}">Leito ${l.leito} ‚Äì ${l.status}</span>
            <span class="tipo ${tipoClass}">${l.tipo}</span>
          </div>
          <span class="badge">${HOSPITAIS[l.hospital].nome}</span>
        </div>
        <div class="row">
          <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"‚Äî"}</div></div>
          <div class="field"><div class="label">Matr√≠cula</div><div class="value">${l.matricula||"‚Äî"}</div></div>
          <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"‚Äî"}</div></div>
          <div class="field"><div class="label">Tempo de Interna√ß√£o</div><div class="value">${l.status === "Em uso" ? elapsedSince(l.admAt).text : "‚Äî"}</div></div>
          <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"‚Äî"}</div></div>
          <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</div></div>
          <div class="field" style="grid-column: 3 / 5"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||"‚Äî"}</div></div>
        </div>
        <div class="actions">
          ${l.status==="Vago"
            ? `<button class="btn primary" data-act="admitir">Admitir</button>`
            : `<button class="btn" data-act="atualizar">Atualizar / Ver Detalhes</button>`
          }
        </div>
      `;

      card.querySelector('[data-act="admitir"]')?.addEventListener('click', () => openAdmissao(l.leito));
      card.querySelector('[data-act="atualizar"]')?.addEventListener('click', () => openAtualizacao(l.leito));

      container.appendChild(card);
    });
  }

  function renderTable(){
      const tb = $("#tbLeitos");
      const headers = document.querySelectorAll('#leitos2View th.sortable');
      tb.innerHTML = "";

      const sortedData = [...banco[currentHospital]].sort((a, b) => {
          const key = sortState.key;
          const dir = sortState.direction === 'asc' ? 1 : -1;
          
          let aVal = a[key], bVal = b[key];
          if (key === 'tempoInternacao') {
              aVal = a.admAt ? Date.now() - new Date(a.admAt).getTime() : 0;
              bVal = b.admAt ? Date.now() - new Date(b.admAt).getTime() : 0;
          }
          
          aVal = aVal === null || aVal === undefined ? '' : aVal;
          bVal = bVal === null || bVal === undefined ? '' : bVal;

          if (!isNaN(aVal) && !isNaN(bVal) && aVal !== '' && bVal !== '') {
              return (Number(aVal) - Number(bVal)) * dir;
          }
          return String(aVal).localeCompare(String(bVal)) * dir;
      });
      
      sortedData.forEach(l => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${l.leito}</td><td>${l.tipo}</td><td>${l.status}</td>
          <td>${l.nome||"‚Äî"}</td><td>${l.idade??"‚Äî"}</td>
          <td>${l.status === "Em uso" ? elapsedSince(l.admAt).text : "‚Äî"}</td>
          <td>${l.pps??"‚Äî"}</td>
          <td>${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</td>
          <td>${l.prevAlta||"‚Äî"}</td>
        `;
        tr.style.cursor="pointer";
        tr.onclick = ()=> {  
          if(l.status==="Vago") openAdmissao(l.leito);  
          else openAtualizacao(l.leito);  
        };
        tb.appendChild(tr);
      });
      
      headers.forEach(th => {
          let text = th.dataset.sort;
          if (th.dataset.sort === 'admAt') text = 'Admiss√£o';
          if (th.dataset.sort === 'prevAlta') text = 'Prev. Alta';
          if (th.dataset.sort === 'spict') text = 'SPICT-BR';
          if (th.dataset.sort === 'pps') text = 'PPS';
          if (th.dataset.sort === 'tempoInternacao') text = 'Tempo de Interna√ß√£o';
          text = text.charAt(0).toUpperCase() + text.slice(1);

          if (th.dataset.sort === sortState.key) {
              text += sortState.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
          }
          th.textContent = text;
      });
  }

  function openAdmissao(leito){
    selectedLeito = leito;
    const l = HOSPITAIS[currentHospital].leitos.find(x=>x.id===leito);
    $("#a_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#a_leito").textContent = "Leito " + l.id;
    $("#a_tipo").textContent = l.tipo;
    $("#a_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
    $("#a_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
    $("#a_nome").value=""; $("#a_idade").value=""; $("#a_matricula").value=""; $("#a_pps").value="";
    $("#a_spict").value="elegivel"; $("#a_prev").value="24h Ouro";
    openModal("#modalAdmissao");
  }

  function openAtualizacao(leito){
    selectedLeito = leito;
    const l = banco[currentHospital].find(x=>x.leito===leito);
    $("#u_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#u_leito").textContent = "Leito " + l.leito;
    $("#u_tipo").textContent = l.tipo;
    $("#u_nome").value = l.nome||"";
    $("#u_matricula").value = l.matricula||"";
    $("#u_adm").value = fmtDateTime(l.admAt)||"";
    $("#u_idade").value = l.idade??"";
    $("#u_pps").value = l.pps??"";
    $("#u_spict").value = l.spict||"elegivel";
    $("#u_prev").value = l.prevAlta||"Sem previsao";
    $("#u_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.linhas||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
    $("#u_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.concessoes||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
    $("#internadoHa").textContent = `Internado h√° ${elapsedSince(l.admAt).text}`;
    openModal("#modalAtualizacao");
  }

  async function darAltaFlow(leito){
    if(!await confirmAction("Confirmar ALTA deste paciente?")) return;
    try {
      await apiCall({ action:'alta', hospital: currentHospital, leito: leito });
      if (isQRMode) {
        closeModal("#modalAtualizacao");
        showSuccessMessage();
      } else {
        await loadHospital(currentHospital);
      }
    } catch(error) { alert('Erro ao dar alta: ' + error.message); }
  }

  function getDiasAteAlta(prevAlta) {
    if (!prevAlta || prevAlta === 'Sem previsao') return 7; 
    if (prevAlta.includes('24h')) return 0;
    if (prevAlta === '48h') return 1;
    if (prevAlta === '72h') return 2;
    if (prevAlta === '96h') return 3;
    return 7;
  }

  function createChart(canvasId, chartInstanceName, config) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
          logError(`Canvas com ID '${canvasId}' n√£o encontrado.`);
          return;
      }
      const ctx = canvas.getContext('2d');
      if (window[chartInstanceName]) window[chartInstanceName].destroy();
      window[chartInstanceName] = new Chart(ctx, config);
  }

  async function renderDashboards() {
      logInfo("Renderizando dashboards...");
      await loadAllData();
      const allData = [...banco.H1, ...banco.H2];

      if (activeTab === 'dash1') renderDash1();
      if (activeTab === 'dash2') renderDash2(allData);
  }
  
  function calculateHospitalProjections(hospitalData) {
      const hoje = new Date();
      const labels = [`Hoje (${hoje.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`];
      for (let i = 1; i <= 7; i++) {
          const diaFuturo = new Date(hoje);
          diaFuturo.setDate(hoje.getDate() + i);
          labels.push(`D+${i} (${diaFuturo.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      }

      const linhasData = {};
      const concessoesData = {};

      (hospitalData || []).filter(p => p.status === 'Em uso').forEach(paciente => {
          const dias = getDiasAteAlta(paciente.prevAlta) + 1; 
          (paciente.linhas || []).forEach(linha => {
              if (!linhasData[linha]) linhasData[linha] = new Array(8).fill(0);
              for (let d = 0; d < Math.min(dias, 8); d++) {
                  linhasData[linha][d]++;
              }
          });
          (paciente.concessoes || []).forEach(conc => {
              if (!concessoesData[conc]) concessoesData[conc] = new Array(8).fill(0);
              for (let d = 0; d < Math.min(dias, 8); d++) {
                  concessoesData[conc][d]++;
              }
          });
      });
      return { labels, linhasData, concessoesData };
  }

  function renderDash1() {
      ['H1', 'H2'].forEach(h => {
          const dados = banco[h] || [];
          const totalLeitos = HOSPITAIS[h].leitos.length;
          const ocupados = dados.filter(l => l.status === 'Em uso').length;
          const vagos = totalLeitos - ocupados;
          const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
          
          $(`#statOcupados${h}`).textContent = ocupados;
          $(`#statVagos${h}`).textContent = vagos;
          $(`#statTotal${h}`).textContent = totalLeitos;
          $(`#gaugePercent${h}`).textContent = taxaOcupacao + '%';

          createChart(`chartOcupacao${h}`, `chartGauge${h}`, { type: 'doughnut', data: { datasets: [{ data: [taxaOcupacao, 100 - taxaOcupacao], backgroundColor: [taxaOcupacao > 90 ? '#dc2626' : taxaOcupacao > 80 ? '#f59e0b' : '#16a34a', '#e5e7eb'], borderWidth: 0, }] }, options: { responsive: true, maintainAspectRatio: false, circumference: 180, rotation: -90, cutout: '75%', plugins: { tooltip: { enabled: false }, legend: { display: false } } } });
          
          const projAltas = { "24h": 0, "48h": 0, "72h": 0, "96h": 0 };
          dados.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao').forEach(p => {
              const key = p.prevAlta.includes('24h') ? '24h' : p.prevAlta;
              if (projAltas.hasOwnProperty(key)) projAltas[key]++;
          });
          const projAltasData = Object.values(projAltas);
          createChart(`chartAltas${h}_line`, `chartAltasInst${h}_line`, { type: 'line', data: { labels: Object.keys(projAltas), datasets: [{ label: 'N¬∫ de Altas', data: projAltasData, backgroundColor: '#3b82f633', borderColor: '#3b82f6', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
          createChart(`chartAltas${h}_hbar`, `chartAltasInst${h}_hbar`, { type: 'bar', data: { labels: Object.keys(projAltas), datasets: [{ label: 'N¬∫ de Altas', data: projAltasData, backgroundColor: '#3b82f6' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
          
          let kpiHtml = '';
          let lastVal = 0;
          Object.entries(projAltas).forEach(([key, value], index) => {
              let trendIcon = '';
              if (index > 0) {
                  if (value > lastVal) trendIcon = '<span style="color:green">‚ñ≤</span>';
                  else if (value < lastVal) trendIcon = '<span style="color:red">‚ñº</span>';
                  else trendIcon = '<span style="color:gray">‚ñ¨</span>';
              }
              kpiHtml += `<div class="kpi-grid-item"><div class="kpi-grid-value">${value}</div><div class="kpi-grid-label">em ${key}</div><div class="kpi-grid-trend">${trendIcon}</div></div>`;
              lastVal = value;
          });
          $(`#altas-view-kpi-${h}`).innerHTML = kpiHtml;

          const projections = calculateHospitalProjections(dados);
          const sortedLinhas = Object.entries(projections.linhasData).sort((a,b) => a[0].localeCompare(b[0]));
          const sortedConcessoes = Object.entries(projections.concessoesData).sort((a,b) => a[0].localeCompare(b[0]));

          const yAxisConfig = { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Benefici√°rios' } };
          createChart(`chartLinhas${h}`, `chartLinhasInst${h}`, { type: 'line', data: { labels: projections.labels, datasets: sortedLinhas.map(([key, values]) => ({ label: key, data: values, borderColor: LINHAS_CORES[key] || '#cccccc', backgroundColor: (LINHAS_CORES[key] || '#cccccc') + '20', fill: false, tension: 0.3 })) }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: yAxisConfig } } });
          createChart(`chartConcessoes${h}`, `chartConcessoesInst${h}`, { type: 'line', data: { labels: projections.labels, datasets: sortedConcessoes.map(([key, values]) => ({ label: key, data: values, borderColor: CONC_CORES[key] || '#cccccc', backgroundColor: (CONC_CORES[key] || '#cccccc') + '20', fill: false, tension: 0.3 })) }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: yAxisConfig } } });
      });
      logSuccess('Dashboard 1 renderizado.');
  }

  function renderDash2(allData) {
      const totalLeitos = HOSPITAIS.H1.leitos.length + HOSPITAIS.H2.leitos.length;
      const ocupados = allData.filter(p => p.status === 'Em uso').length;
      const taxaOcupacaoGeral = totalLeitos > 0 ? Math.round(ocupados/totalLeitos*100) : 0;
      $('#kpiOcupacaoGeral').textContent = `${taxaOcupacaoGeral}%`;
      createChart('kpiGaugeOcupacao', 'kpiGaugeOcupacaoInst', { type: 'doughnut', data: { datasets: [{ data: [taxaOcupacaoGeral, 100-taxaOcupacaoGeral], backgroundColor: [taxaOcupacaoGeral > 90 ? '#dc2626' : taxaOcupacaoGeral > 80 ? '#f59e0b' : '#16a34a', '#e5e7eb'], borderWidth: 0, }] }, options: { responsive: true, maintainAspectRatio: false, circumference: 180, rotation: -90, cutout: '75%', plugins: { tooltip: { enabled: false } } } });

      $('#kpiAltas48h').textContent = allData.filter(p => p.prevAlta && (p.prevAlta.includes('24h') || p.prevAlta === '48h')).length;
      $('#kpiUtiOcupados').textContent = allData.filter(p => p.tipo === 'UTI' && p.status === 'Em uso').length;
      const tempos = allData.filter(p => p.status === 'Em uso' && p.admAt).map(p => elapsedSince(p.admAt).days);
      $('#kpiTMP').textContent = tempos.length > 0 ? `${Math.round(tempos.reduce((a,b)=>a+b,0)/tempos.length)} dias` : '0 dias';
      const idades = allData.filter(p => p.status === 'Em uso' && p.idade).map(p => p.idade);
      $('#kpiIdadeMedia').textContent = idades.length > 0 ? `${Math.round(idades.reduce((a,b)=>a+b,0)/idades.length)}` : '0';

      const projConsolidada = calculateHospitalProjections(allData);
      const sortedLinhas = Object.entries(projConsolidada.linhasData).sort((a,b) => a[0].localeCompare(b[0]));
      const sortedConcessoes = Object.entries(projConsolidada.concessoesData).sort((a,b) => a[0].localeCompare(b[0]));
      createChart('chartLinhasConsolidado', 'chartLinhasConsolidadoInst', { type: 'line', data: { labels: projConsolidada.labels, datasets: sortedLinhas.map(([k,v])=>({label:k, data:v, borderColor:LINHAS_CORES[k], backgroundColor:LINHAS_CORES[k]+'20', tension: 0.3}))}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{y:{title:{display:true, text:'Benefici√°rios'}}}});
      createChart('chartConcessoesConsolidado', 'chartConcessoesConsolidadoInst', { type: 'bar', data: { labels: projConsolidada.labels, datasets: sortedConcessoes.map(([k,v])=>({label:k, data:v, backgroundColor:CONC_CORES[k]}))}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{x:{stacked:true}, y:{stacked:true, title:{display:true, text:'Benefici√°rios'}}}});

      const projGeralAltas = { "24h":{H1:0, H2:0}, "48h":{H1:0, H2:0}, "72h":{H1:0, H2:0}, "96h":{H1:0, H2:0} };
      allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'Sem previsao').forEach(p => { const key=p.prevAlta.includes('24h')?'24h':p.prevAlta; if(projGeralAltas[key]) projGeralAltas[key][p.hospital]++; });
      createChart('chartAltasComparativo', 'chartAltasComparativoInst', {type:'bar', data: {labels: Object.keys(projGeralAltas), datasets: [{label: 'Neomater', data: Object.values(projGeralAltas).map(d=>d.H1), backgroundColor: '#0a2b52'}, {label: 'Cruz Azul', data: Object.values(projGeralAltas).map(d=>d.H2), backgroundColor: '#3b82f6'}]}, options: {responsive:true, maintainAspectRatio:false}});
      
      const H1Ocupados = banco.H1.filter(p=>p.status==='Em uso').length;
      const H2Ocupados = banco.H2.filter(p=>p.status==='Em uso').length;
      const H1Recursos = banco.H1.reduce((acc, p) => acc + (p.concessoes?.length || 0) + (p.linhas?.length || 0), 0);
      const H2Recursos = banco.H2.reduce((acc, p) => acc + (p.concessoes?.length || 0) + (p.linhas?.length || 0), 0);
      $('#comparativoRecursos').innerHTML = `<table class="dash-table"><thead><tr><th>M√©trica</th><th>Neomater</th><th>Cruz Azul</th></tr></thead><tbody>
        <tr><td>Recursos por Leito Ocupado</td><td>${(H1Recursos / H1Ocupados || 0).toFixed(2)}</td><td>${(H2Recursos / H2Ocupados || 0).toFixed(2)}</td></tr>
      </tbody></table>`;

      logSuccess('Dashboard 2 renderizado.');
  }

  function setupEventListeners() {
    document.querySelectorAll(".tab, .side-menu-item").forEach(b=> b.onclick = (e)=> {
      e.preventDefault();
      setTab(b.dataset.tab);
      if(document.body.classList.contains('side-menu-open')) {
        $('#side-menu').classList.remove('open');
        document.body.classList.remove('side-menu-open');
      }
    });
    
    $('#layoutToggle').onchange = (e) => {
      document.body.classList.toggle('layout-v2', e.target.checked);
      route();
    };

    $('#hamburger-menu').onclick = () => {
      $('#side-menu').classList.toggle('open');
      document.body.classList.toggle('side-menu-open');
    };

    $('#selHospital2').onchange = e=>{ setHospitalSelectors(e.target.value); loadHospital(e.target.value); };
    $("#btnH1").onclick = ()=>{ setHospitalSelectors("H1"); loadHospital("H1"); };
    $("#btnH2").onclick = ()=>{ setHospitalSelectors("H2"); loadHospital("H2"); };

    const refreshFn = () => { logInfo("Refresh manual"); if (activeTab.startsWith('dash')) { renderDashboards() } else { loadHospital(currentHospital) } };
    $('#refreshBtn_v1').onclick = refreshFn;
    $('#refreshBtn_v2').onclick = refreshFn;

    $('#qrCodeBtn').onclick = () => $('#qrDropdown').classList.toggle('show');
    $('#settingsBtn').onclick = () => $('#settingsDropdown').classList.toggle('show');

    const readQRFn = () => { $('#qrDropdown').classList.remove('show'); $('#settingsDropdown').classList.remove('show'); openModal("#modalQRScan"); startScan(); };
    $('#btnReadQR_v1').onclick = readQRFn;
    $('#btnReadQR_v2').onclick = readQRFn;

    const printQRFn = () => { $('#qrDropdown').classList.remove('show'); $('#settingsDropdown').classList.remove('show'); openModal("#modalBulkQR"); };
    $('#btnPrintQR_v1').onclick = printQRFn;
    $('#btnPrintQR_v2').onclick = printQRFn;
    
    window.onclick = (event) => {
        if (!event.target.closest('.header-btn')) {
            if ($('#qrDropdown').classList.contains('show')) $('#qrDropdown').classList.remove('show');
            if ($('#settingsDropdown').classList.contains('show')) $('#settingsDropdown').classList.remove('show');
        }
    };
    
    document.querySelectorAll("[data-close]").forEach(b=> b.onclick = ()=> closeModal(b.getAttribute("data-close")) );
    $("#b_generate").onclick = buildQRGrid;
    $("#reloadPage").onclick = ()=> location.reload();
    $('#a_cancel').onclick = async () => { if (await confirmAction("Cancelar admiss√£o?")) closeModal("#modalAdmissao"); };
    $('#u_cancel').onclick = async () => { if (await confirmAction("Cancelar altera√ß√µes?")) closeModal("#modalAtualizacao"); };
    $('#u_alta').onclick = ()=> darAltaFlow(selectedLeito);
    $('#a_save').onclick = async ()=>{ if(!await confirmAction("Salvar e admitir paciente?")) return; try { const payload = { action: 'admit', hospital: currentHospital, leito: selectedLeito, nome: $("#a_nome").value.trim(), idade: Number($("#a_idade").value)||null, matricula: $("#a_matricula").value.trim(), pps: Number($("#a_pps").value)||null, spict: $("#a_spict").value, prevAlta: $("#a_prev").value, linhas: Array.from(document.querySelectorAll("#a_linhas input:checked")).map(i=>i.value), concessoes: Array.from(document.querySelectorAll("#a_concessoes input:checked")).map(i=>i.value) }; await apiCall(payload); closeModal("#modalAdmissao"); if (isQRMode) showSuccessMessage(); else await loadHospital(currentHospital); } catch(error) { alert('Erro: ' + error.message); } };
    $('#u_save').onclick = async ()=>{ if(!await confirmAction("Salvar altera√ß√µes?")) return; try { const payload = { action: 'update', hospital: currentHospital, leito: selectedLeito, idade: Number($("#u_idade").value)||null, pps: Number($("#u_pps").value)||null, spict: $("#u_spict").value, prevAlta: $("#u_prev").value, linhas: Array.from(document.querySelectorAll("#u_linhas input:checked")).map(i=>i.value), concessoes: Array.from(document.querySelectorAll("#u_concessoes input:checked")).map(i=>i.value) }; await apiCall(payload); closeModal("#modalAtualizacao"); if (isQRMode) showSuccessMessage(); else await loadHospital(currentHospital); } catch(error) { alert('Erro: ' + error.message); } };
    
    document.querySelectorAll('#leitos2View th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.sort;
            if (sortState.key === key) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.direction = 'asc';
            }
            renderTable();
        });
    });

    document.querySelectorAll('.switcher-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const h = btn.dataset.h;
            const view = btn.dataset.view;
            document.querySelectorAll(`.switcher-btn[data-h='${h}']`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            ['line','hbar','kpi'].forEach(v => $(`#altas-view-${v}-${h}`).classList.add('hidden'));
            $(`#altas-view-${view}-${h}`).classList.remove('hidden');
        });
    });
  }
  
  (async function init(){
    logInfo("=== INICIALIZANDO ARCHIPELAGO MVP ===");
    setupEventListeners();
    
    await testConnection();
    
    logInfo("üíº MODO PORTAL DETECTADO - Sess√£o gestor iniciada");
    setHospitalSelectors("H1");
    setTab("leitos");
    await loadAllData();
    
    autoRefreshInterval = setInterval(() => {
      logInfo("Auto-refresh executado");
      Promise.all([loadHospital("H1"), loadHospital("H2")]).then(() => {
        if(activeTab.startsWith('dash')) renderDashboards();
      });
    }, 60000);
    
    updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
    
    logInfo("=== INICIALIZA√á√ÉO CONCLU√çDA ===");
  })();

</script>
</body>
</html>
