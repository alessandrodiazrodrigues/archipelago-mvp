<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago ‚Äî Dashboard Corporativo</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --primary-blue:#4a90e2;
      --dark-blue:#0a2b52;
      --darker-blue:#083052;
      --bg:#0f1419;
      --bg-deep:#1a1f2e;
      --card:#1e293b;
      --text:#e2e8f0;
      --text-white:#ffffff;
      --muted:#94a3b8;
      --border:#334155;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#dc2626;
      --gold:#fbbf24;
      --blue-veil:#4f86ff33;
      --shadow-1:0 4px 12px rgba(11,44,82,.08);
      --shadow-2:0 10px 28px rgba(11,44,82,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; padding:0; overflow-x: hidden;}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 100%);
      transition: padding-left 0.3s ease;
      padding-left: 300px;
      min-height: 100vh;
    }

    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(234, 241, 249, 0.95); backdrop-filter: blur(3px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000; transition: opacity 0.3s ease;
    }
    .loading-spinner {
      width: 60px; height: 60px; border: 3px solid #e5e7eb;
      border-top: 3px solid var(--primary-blue); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-text {
      margin-top: 15px; font-size: 16px; color: var(--primary-blue); font-weight: 500;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loadingOverlay.hidden { display: none; }

    header{
      background:linear-gradient(90deg,var(--primary-blue),var(--dark-blue));
      color:#fff; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      box-shadow:0 6px 18px rgba(74,144,226,.20);
      position:sticky; top: 0; z-index:100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff33;backdrop-filter:blur(2px)}
    .logo::after{content:"AD";font-weight:700;font-size:14px}
    .title h1{margin:0;font-size:18px}
    .title small{display:block;color:#dbe7f5; font-size: 12px;}

    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-btn { 
      background: var(--primary-blue); 
      border: 1px solid rgba(255,255,255,0.3); 
      color: #fff; 
      border-radius: 10px; 
      padding: 10px 16px; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .header-btn:hover { 
      background: rgba(255,255,255,0.2); 
      transform: translateY(-1px);
    }
    #lastUpdateInfo { font-size: 12px; color: #dbe7f5; }

    #side-menu {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 300px;
        height: 100vh;
        background: linear-gradient(180deg, var(--dark-blue) 0%, var(--darker-blue) 100%);
        box-shadow: 6px 0 30px rgba(0,0,0,0.4);
        border-right: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        z-index: 1001;
        padding-top: 80px;
        transition: left 0.3s ease;
    }
    
    .side-menu-item {
        display: flex; 
        align-items: center; 
        gap: 20px;
        padding: 18px 25px;
        color: #e5e7eb;
        text-decoration: none; 
        font-size: 16px;
        font-weight: 600;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
        min-height: 50px;
    }
    
    .side-menu-item:hover { 
        background: rgba(74,144,226,0.2); 
        border-left-color: var(--primary-blue); 
        color: #fff;
    }
    
    .side-menu-item.active { 
        background: rgba(74,144,226,0.3); 
        border-left-color: var(--primary-blue); 
        font-weight: 700; 
        color: #fff;
        box-shadow: inset 0 0 20px rgba(74,144,226,0.3);
    }

    #sidebar-settings {
        position: absolute;
        bottom: 20px;
        left: 25px;
        right: 25px;
    }
    
    .sidebar-settings-item {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 18px 20px;
        color: #e5e7eb;
        font-size: 16px;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(74,144,226,0.05);
        position: relative;
        min-height: 50px;
    }
    
    .sidebar-settings-item:hover {
        color: #fff;
        background: rgba(74,144,226,0.15);
        box-shadow: 0 4px 12px rgba(74,144,226,0.3);
    }

    main{max-width:1600px;margin:18px auto 100px;padding:0 24px}
    
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--card);
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition: all 0.3s ease;
    }
    .btn.primary{
      background:var(--primary-blue);
      border-color:var(--primary-blue);
      color:#fff;
    }
    .btn.primary:hover{
      background:var(--dark-blue);
      transform: translateY(-1px);
    }
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    
    .select{
      appearance:none;
      border:1px solid var(--border);
      background:var(--card);
      padding:12px 14px;
      border-radius:12px;
      font-weight:500;
    }

    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(450px, 1fr));gap:18px;position:relative;z-index:1}
    .card{
      position:relative; 
      background:var(--card); 
      border-radius:20px; 
      padding:18px;
      box-shadow: var(--shadow-1), var(--shadow-2), 0 0 0 1px rgba(255,255,255,.6) inset;
      transform:translateY(0); 
      transition:transform .18s ease, box-shadow .18s ease;
      border: 2px solid transparent;
      background-clip: padding-box;
      border-image: linear-gradient(to bottom, #FFFFFF, #E5E7EB) 1;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow: 0 16px 38px rgba(74,144,226,.16), 0 26px 64px rgba(74,144,226,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
    }
    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted);font-size:12px;font-weight:600}
    
    .status{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;color:#111;border:1px solid var(--border);background:#fff;font-weight:600}
    .status.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .status.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}
    
    .tipo{font-size:12px;color:#fff;background:#6b7280;border-radius:999px;padding:6px 10px;font-weight:600}
    .tipo.uti{background:var(--danger)}
    .tipo.enf{background:var(--primary-blue)}
    
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:12px}
    .field .label{font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .field .value{font-weight:700;margin-top:4px}
    .wrap{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;color:var(--primary-blue);padding:4px 10px;border-radius:999px;font-weight:600}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:15px}

    .dash-grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-6 { grid-template-columns: repeat(6, 1fr); }
    .span-2 { grid-column: span 2; }
    
    @media (max-width: 1200px) { 
      .grid-2, .grid-3, .grid-4, .grid-5, .grid-6 { grid-template-columns: 1fr; } 
      .span-2 { grid-column: span 1; }
      body { padding-left: 0; }
      #side-menu { left: -300px; }
    }

    .dashboard-card {
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 16px;
      padding: 24px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transform: translateY(-2px);
    }
    
    .dashboard-card h3 {
      margin: 0 0 20px 0; 
      font-size: 20px; 
      color: var(--text-white); 
      text-align: center;
      padding-bottom: 15px; 
      border-bottom: 2px solid var(--primary-blue);
      font-weight: 700;
    }
    
    .dashboard-card h4 { 
      margin: 24px 0 12px 0; 
      font-size: 16px; 
      color: var(--text-white); 
      font-weight: 700;
    }
    
    .kpi-card {
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: 16px; 
        padding: 20px; 
        text-align: left; 
        position: relative;
        transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    
    .kpi-value { 
        font-size: 42px; 
        font-weight: 800; 
        color: var(--text-white); 
        margin-bottom: 8px;
        line-height: 1;
    }
    
    .kpi-label { 
        font-size: 14px; 
        color: var(--muted); 
        margin: 0;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #dash2 {
        background: var(--darker-blue);
        border-radius: 20px;
        padding: 24px;
        margin: -24px;
        margin-bottom: 24px;
    }
    
    #dash2 .metric-card {
        background: var(--card);
        border-color: var(--border);
    }
    
    #dash2 .dashboard-card h3,
    #dash2 .dashboard-card h4,
    #dash2 .kpi-label,
    #dash2 .metric-title,
    #dash2 .dash-table th,
    #dash2 .dash-table td,
    #dash2 h2 {
        color: var(--text-white) !important;
    }
    
    #dash2 .kpi-card {
        background: var(--card);
        border-color: var(--border);
    }
    
    #dash2 .kpi-value {
        color: var(--text-white) !important;
    }

    .metric-card {
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: 16px; 
        padding: 24px; 
        margin-bottom: 24px;
    }
    
    .metric-title { 
        font-size: 18px; 
        font-weight: 700; 
        color: var(--primary-blue); 
        margin-bottom: 10px; 
    }
    
    .metric-subtitle { 
        font-size: 14px; 
        color: var(--muted); 
        margin-bottom: 20px; 
    }
    
    .chart-container { 
        position: relative; 
        width:100%; 
    }
    .h-200 { height: 200px; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    .kpi-gauge-wrapper {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 70px;
        height: 45px;
    }
    
    #dash1 .kpi-gauge-wrapper,
    #dash3 .kpi-gauge-wrapper {
        display: none !important;
    }

    .dash-table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 15px; 
    }
    .dash-table th, .dash-table td { 
        padding: 12px; 
        text-align: left; 
        border-bottom: 1px solid var(--border); 
        font-size: 14px; 
    }
    .dash-table th { 
        font-size: 12px; 
        color: var(--muted); 
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .backdrop{
      position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;overflow:auto
    }
    .modal{
      background:var(--card);max-width:860px;width:100%;max-height:90vh;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column
    }
    .modal header{
      display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--primary-blue)
    }
    .modal header strong {
      color: white;
      font-size: 18px;
      font-weight: 700;
    }
    .modal .content{
      padding:24px;overflow-y:auto;flex:1
    }
    .modal .actions{
      display:flex;gap:12px;justify-content:flex-end;padding:20px 24px;border-top:1px solid var(--border);flex-shrink:0;background:#f9fafb
    }
    
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .input,.select2,textarea{
      width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;font-size:14px
    }
    .label{
      font-size:13px;color:var(--muted);margin-bottom:6px;display:block;font-weight:600;text-transform:uppercase;letter-spacing:0.5px
    }
    
    .qr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-height:none;overflow:visible}
    .qr-cell{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center;min-height:220px}
    .qr-box{display:inline-block;border:1px solid var(--border);padding:12px;border-radius:12px;background:var(--card)}
    
    .success-message{
      position:fixed; top:50%;left:50%; transform:translate(-50%,-50%);
      background:var(--card); border:1px solid var(--border); border-radius:20px;
      padding:50px; text-align:center; box-shadow:0 10px 28px rgba(0,0,0,.25);
      z-index:3000; display:none;
    }
    
    @media (max-width: 1024px) {
        body { padding-left: 0; }
        #side-menu { left: -300px; }
        #side-menu.open { left: 0; }
        .grid { grid-template-columns: 1fr; }
        .row { grid-template-columns: repeat(2, 1fr); }
        .dash-grid.grid-6 { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
        .row { grid-template-columns: 1fr; }
        .row2, .row3 { grid-template-columns: 1fr; }
        .dash-grid.grid-6 { grid-template-columns: 1fr; }
        .header-left, .header-right { flex-wrap: wrap; }
    }

    .hidden{display:none}
    
    .dropdown-menu {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        margin-bottom: 15px;
        background: var(--card);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 1020;
        display: none;
        overflow: hidden;
    }
    
    .dropdown-menu.show {
        display: block;
    }
    
    .dropdown-item {
        padding: 16px 20px;
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background: var(--primary-blue);
        color: white;
    }

    .complexidade-i { background: #ecfdf5; color: #065f46; }
    .complexidade-ii { background: #fff7ed; color: #92400e; }
    .complexidade-iii { background: #fef2f2; color: #991b1b; }
    
    .prev-alta-ouro { 
      background: #fef3c7; 
      color: #92400e; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 700;
      border: 1px solid #fbbf24;
    }
    .prev-alta-24h { 
      background: #dbeafe; 
      color: #1e40af; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 600;
      border: 1px solid #3b82f6;
    }
    .prev-alta-48h { 
      background: #dcfce7; 
      color: #166534; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 600;
      border: 1px solid #16a34a;
    }
    .prev-alta-72h { 
      background: #fed7aa; 
      color: #92400e; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 600;
      border: 1px solid #f59e0b;
    }
    .prev-alta-96h { 
      background: #fecaca; 
      color: #991b1b; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 600;
      border: 1px solid #dc2626;
    }
  </style>
</head>
<body>

  <div id="side-menu">
    <a href="#" class="side-menu-item active" data-tab="leitos">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2.5 12a.5.5 0 0 1 .5-.5h18a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
        <path d="M20 16H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2zM9 8H7v6h2V8z"/>
      </svg>
      <span>Leitos (Cards)</span>
    </a>
    
    <a href="#" class="side-menu-item" data-tab="dash1">
       <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
         <path d="M12 20v-6M12 8V2M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M17.66 6.34l-4.24 4.24M6.34 17.66l-4.24 4.24M22 12h-6M8 12H2"/>
       </svg>
      <span>Dash Hospitais</span>
    </a>
    
    <a href="#" class="side-menu-item" data-tab="dash2">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 20V10M12 20V4M6 20V14"/>
      </svg>
      <span>Dashboard Executivo</span>
    </a>

    <div id="sidebar-settings">
        <div class="sidebar-settings-item" id="sidebar-config">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>Configura√ß√µes</span>
            <div class="dropdown-menu" id="config-dropdown">
                <div class="dropdown-item" onclick="openQRScan()">Ler QR Code</div>
                <div class="dropdown-item" onclick="openQRPrint()">Imprimir QR Codes</div>
            </div>
        </div>
    </div>
  </div>

  <header id="appHeader">
    <div class="header-left">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>ARCHIPELAGO DASHBOARD</h1>
          <small>Dashboard Corporativo</small>
        </div>
      </div>
    </div>
    
    <div class="header-right">
        <span id="lastUpdateInfo"></span>
        <button class="header-btn" id="refreshBtn">Atualizar</button>
        <button class="header-btn" id="settingsBtn">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <main>
    <section id="leitosView" class="grid"></section>

    <section id="dash1" class="hidden">
        <h2 style="margin-bottom:24px;color:var(--primary-blue);font-size:28px;font-weight:800">Dash Hospitais: Vis√£o Detalhada</h2>
        <div class="dash-grid grid-2"></div>
    </section>

    <section id="dash2" class="hidden">
        <h2 style="margin-bottom:24px;color:var(--text-white);font-size:28px;font-weight:800">Dashboard Executivo: Rede Hospitalar Externa</h2>
        
        <div class="metric-card">
            <div class="metric-title">KPIs Operacionais Consolidados</div>
            <div class="dash-grid grid-5">
                <div class="kpi-card">
                    <div class="kpi-gauge-wrapper"><canvas id="kpiGaugeOcupacao"></canvas></div>
                    <div class="kpi-value" id="kpiOcupacaoGeral">0%</div>
                    <div class="kpi-label">Taxa de Ocupa√ß√£o Geral</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTotalLeitos">0</div>
                    <div class="kpi-label">Total de Leitos</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiLeitosOcupados">0</div>
                    <div class="kpi-label">Leitos Ocupados</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiTMP">0 dias</div>
                    <div class="kpi-label">Tempo M√©dio Perman√™ncia</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpiRotatividade">0%</div>
                    <div class="kpi-label">Taxa de Rotatividade</div>
                </div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">An√°lise Preditiva de Altas</div>
            <div class="dash-grid grid-2">
                <div>
                    <h4 style="text-align: center; color: var(--text-white);">Comparativo por Prazo</h4>
                    <div class="chart-container h-250"><canvas id="chartAltasComparativo"></canvas></div>
                </div>
                <div>
                    <h4 style="text-align: center; color: var(--text-white);">Timeline de Libera√ß√£o em 24h</h4>
                    <div class="chart-container h-250"><canvas id="chartTimeline24h"></canvas></div>
                </div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">Proje√ß√µes Consolidadas (7 dias)</div>
            <div class="dash-grid grid-2">
                <div>
                    <h4 style="text-align: center; color: var(--text-white);">Concess√µes Necess√°rias</h4>
                    <div class="chart-container h-300"><canvas id="chartConcessoesConsolidado"></canvas></div>
                </div>
                <div>
                    <h4 style="text-align: center; color: var(--text-white);">Linhas de Cuidado</h4>
                    <div class="chart-container h-300"><canvas id="chartLinhasConsolidado"></canvas></div>
                </div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">An√°lise PPS (Performance Status)</div>
            <div class="chart-container h-250">
                <canvas id="chartPpsAnalise"></canvas>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">An√°lise SPICT-BR</div>
            <div class="chart-container h-250">
                <canvas id="chartSpictAnalise"></canvas>
            </div>
        </div>
    </section>
  </main>

  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Admiss√£o de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:16px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matr√≠cula (n√∫mero)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0‚Äî10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="a_prev">Previs√£o de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>SP</option>
            </select>
          </div>
          <div>
            <label class="label" for="a_complexidade">Complexidade</label>
            <select id="a_complexidade" class="select2">
              <option value="I">I - Baixa</option>
              <option value="II">II - M√©dia</option>
              <option value="III">III - Alta</option>
            </select>
          </div>
          <div></div>
        </div>

        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:12px;color:#6b7280">
          * Data e hora de admiss√£o ser√£o registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Atualiza√ß√£o de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>

        <div class="row3" style="margin-top:16px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matr√≠cula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admiss√£o (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0‚Äî10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_prev">Previs√£o de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>SP</option>
            </select>
          </div>
          <div>
            <label class="label" for="u_complexidade">Complexidade</label>
            <select id="u_complexidade" class="select2">
              <option value="I">I - Baixa</option>
              <option value="II">II - M√©dia</option>
              <option value="III">III - Alta</option>
            </select>
          </div>
          <div></div>
        </div>

        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>

        <div class="mini" id="internadoHa" style="margin-top:12px;color:#6b7280"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Confirma√ß√£o</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">N√£o</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div class="mini" style="margin-bottom:12px">Se a c√¢mera n√£o abrir, use a sele√ß√£o manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impress√£o</strong>
        <button class="btn" data-close="#modalBulkQR" style="padding:8px 12px;font-size:16px;line-height:1">‚úï</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:16px 0;position:sticky;top:0;background:var(--card);padding:16px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" class="qr-grid"></div>
      </div>
    </div>
  </div>

  <div id="modalQRExpired" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Sess√£o Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code pr√≥ximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>
  
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Opera√ß√£o realizada com sucesso.</p>
    <p style="color:#6b7280;font-size:14px">Voc√™ pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>
  
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxoleU3gSTq8psiFtVrTedgH0ZGksrAbsJPxfp9SWB7HHZRPdFAPvcfKMQH6AKuL5Gx/exec';

  function logInfo(message, data = null) { console.log(`üîµ [Archipelago] ${message}`, data || ''); }
  function logSuccess(message, data = null) { console.log(`üü¢ [SUCCESS] ${message}`, data || ''); }
  function logError(message, error = null) { console.error(`üî¥ [ERROR] ${message}`, error || ''); }
  function logWarning(message, data = null) { console.warn(`üü° [WARNING] ${message}`, data || ''); }

  const HOSPITAIS = {
    H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
    H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
  };

  const banco = { H1: [], H2: [] };
  const LINHAS = ["Assistencia","Geriatria","APS","Cardiologia","Pneumologia","Neurologia","Melhor Cuidado"];
  const CONC   = ["PAD","Fisioterapia","Fonoaudiologia","Aspiracoes","Curativos"];
  
  LINHAS.sort((a, b) => a.localeCompare(b));
  CONC.sort((a, b) => a.localeCompare(b));

  const LINHAS_CORES = {
    "APS": "#f59e0b", "Assistencia": "#4a90e2", "Cardiologia": "#dc2626", "Geriatria": "#16a34a",
    "Melhor Cuidado": "#be185d", "Neurologia": "#0891b2", "Pneumologia": "#8b5cf6"
  };
  const CONC_CORES = {
    "Aspiracoes": "#dc2626", "Curativos": "#8b5cf6", "Fisioterapia": "#16a34a",
    "Fonoaudiologia": "#f59e0b", "PAD": "#4a90e2"
  };

  let currentHospital = "H1";
  let activeTab = "leitos";
  let selectedLeito = null;
  let isQRMode = false;
  let qrSessionTimeout = null;
  let lastUpdateTime = Date.now();
  let autoRefreshInterval = null;
  let updateIndicatorInterval = null;

  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }
  
  function hideLoading() {
    setTimeout(() => {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }, 500);
  }

  const $ = sel => document.querySelector(sel);
  
  function openModal(sel){ const el=$(sel); el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
  function closeModal(sel){ const el=$(sel); el.style.display="none"; el.setAttribute("aria-hidden","true"); }
  
  function confirmAction(msg){
    return new Promise(res=>{
      $("#confirmMsg").textContent = msg || "Confirma?";
      openModal("#modalConfirm");
      $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
      $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
    });
  }
  
  function initials(nome){ if(!nome) return "‚Äî"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }
  
  function fmtDateTime(iso){
    if(!iso) return "‚Äî";
    const d=new Date(iso);
    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function elapsedMsToDays(ms) {
    if (ms === null || ms === undefined) return 0;
    return Math.floor(ms / 86400000);
  }
  
  function elapsedSince(iso){
    if(!iso) return { text: "‚Äî", days: 0 };
    const ms = Date.now() - new Date(iso).getTime();
    const d = elapsedMsToDays(ms);
    const h = Math.floor((ms%86400000)/3600000);
    return { text: `${d}d ${h}h`, days: d };
  }
  
  function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }
  
  function updateTimeIndicator() {
    if(isQRMode) return;
    const indicator = document.getElementById('lastUpdateInfo');
    if(indicator) {
      const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
      const seconds = elapsed % 60;
      const minutes = Math.floor(elapsed / 60);
      if (minutes > 0) {
        indicator.textContent = `Atualizado h√° ${minutes}m`;
      } else {
        indicator.textContent = `Atualizado h√° ${seconds}s`;
      }
    }
  }

  async function testConnection() {
    logInfo("Testando conex√£o com a API...");
    try {
      const res = await fetch(API_URL + '?action=test');
      if (res.ok) {
        logSuccess("Conex√£o com a API estabelecida!");
        return true;
      }
      logError(`Falha na conex√£o: HTTP ${res.status}`);
      return false;
    } catch(error) {
      logError("Erro ao testar conex√£o (usando dados mockados):", error);
      return false; // Continuar com dados mockados
    }
  }
  
  // Dados mockados para demonstra√ß√£o
  function generateMockData() {
    logInfo("Gerando dados mockados para demonstra√ß√£o...");
    
    const mockH1 = [
      { leito: 1, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Jo√£o Silva Santos', idade: 72, matricula: '123456', pps: 6, spict: 'elegivel', prevAlta: '24h Ouro', complexidade: 'II', admAt: new Date(Date.now() - 2*86400000).toISOString(), linhas: ['Geriatria', 'Cardiologia'], concessoes: ['PAD', 'Fisioterapia'] },
      { leito: 2, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 3, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Maria Oliveira', idade: 65, matricula: '789012', pps: 4, spict: 'nao_elegivel', prevAlta: '48h', complexidade: 'I', admAt: new Date(Date.now() - 1*86400000).toISOString(), linhas: ['APS'], concessoes: ['Curativos'] },
      { leito: 4, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Pedro Costa', idade: 58, matricula: '345678', pps: 8, spict: 'elegivel', prevAlta: '72h', complexidade: 'III', admAt: new Date(Date.now() - 4*86400000).toISOString(), linhas: ['Pneumologia', 'Neurologia'], concessoes: ['Aspiracoes', 'Fonoaudiologia'] },
      { leito: 5, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 6, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Ana Ferreira', idade: 78, matricula: '901234', pps: 3, spict: 'elegivel', prevAlta: '24h 2R', complexidade: 'II', admAt: new Date(Date.now() - 3*86400000).toISOString(), linhas: ['Melhor Cuidado'], concessoes: ['PAD'] },
      { leito: 7, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 8, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Carlos Souza', idade: 82, matricula: '567890', pps: 7, spict: 'elegivel', prevAlta: '96h', complexidade: 'III', admAt: new Date(Date.now() - 6*86400000).toISOString(), linhas: ['Assistencia', 'Cardiologia'], concessoes: ['Fisioterapia', 'Curativos'] },
      { leito: 9, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 10, hospital: 'H1', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Luiza Santos', idade: 69, matricula: '234567', pps: 5, spict: 'nao_elegivel', prevAlta: '24h 3R', complexidade: 'I', admAt: new Date(Date.now() - 1*86400000).toISOString(), linhas: ['APS', 'Assistencia'], concessoes: ['PAD'] },
      { leito: 11, hospital: 'H1', tipo: 'UTI', status: 'Em uso', nome: 'Roberto Lima', idade: 75, matricula: '890123', pps: 9, spict: 'elegivel', prevAlta: 'SP', complexidade: 'III', admAt: new Date(Date.now() - 8*86400000).toISOString(), linhas: ['Pneumologia', 'Cardiologia'], concessoes: ['Aspiracoes', 'Fisioterapia', 'Fonoaudiologia'] },
      { leito: 12, hospital: 'H1', tipo: 'UTI', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 13, hospital: 'H1', tipo: 'UTI', status: 'Em uso', nome: 'Helena Rocha', idade: 84, matricula: '456789', pps: 8, spict: 'elegivel', prevAlta: 'SP', complexidade: 'III', admAt: new Date(Date.now() - 12*86400000).toISOString(), linhas: ['Neurologia', 'Melhor Cuidado'], concessoes: ['Aspiracoes', 'PAD'] }
    ];

    const mockH2 = [
      { leito: 1, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Francisco Alves', idade: 68, matricula: '111222', pps: 5, spict: 'nao_elegivel', prevAlta: '48h', complexidade: 'I', admAt: new Date(Date.now() - 2*86400000).toISOString(), linhas: ['Geriatria'], concessoes: ['Fisioterapia'] },
      { leito: 2, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Josefa Miranda', idade: 76, matricula: '333444', pps: 6, spict: 'elegivel', prevAlta: '24h Ouro', complexidade: 'II', admAt: new Date(Date.now() - 1*86400000).toISOString(), linhas: ['Cardiologia', 'APS'], concessoes: ['PAD', 'Curativos'] },
      { leito: 3, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 4, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Ant√¥nio Dias', idade: 73, matricula: '555666', pps: 7, spict: 'elegivel', prevAlta: '72h', complexidade: 'II', admAt: new Date(Date.now() - 5*86400000).toISOString(), linhas: ['Pneumologia'], concessoes: ['Aspiracoes', 'Fisioterapia'] },
      { leito: 5, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Rosa Pereira', idade: 81, matricula: '777888', pps: 4, spict: 'nao_elegivel', prevAlta: '24h 2R', complexidade: 'I', admAt: new Date(Date.now() - 3*86400000).toISOString(), linhas: ['Assistencia'], concessoes: ['Curativos'] },
      { leito: 6, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 7, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Jos√© Barbosa', idade: 70, matricula: '999000', pps: 6, spict: 'elegivel', prevAlta: '96h', complexidade: 'III', admAt: new Date(Date.now() - 7*86400000).toISOString(), linhas: ['Neurologia', 'Melhor Cuidado'], concessoes: ['Fonoaudiologia', 'PAD'] },
      { leito: 8, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 9, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Tereza Gomes', idade: 67, matricula: '121212', pps: 3, spict: 'nao_elegivel', prevAlta: '24h 3R', complexidade: 'I', admAt: new Date(Date.now() - 2*86400000).toISOString(), linhas: ['APS'], concessoes: ['Curativos'] },
      { leito: 10, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Manuel Ribeiro', idade: 79, matricula: '343434', pps: 8, spict: 'elegivel', prevAlta: 'SP', complexidade: 'III', admAt: new Date(Date.now() - 10*86400000).toISOString(), linhas: ['Cardiologia', 'Pneumologia'], concessoes: ['Aspiracoes', 'Fisioterapia'] },
      { leito: 11, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 12, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Isabel Castro', idade: 74, matricula: '565656', pps: 5, spict: 'elegivel', prevAlta: '48h', complexidade: 'II', admAt: new Date(Date.now() - 4*86400000).toISOString(), linhas: ['Geriatria', 'Assistencia'], concessoes: ['PAD'] },
      { leito: 13, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 14, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'Paulo Martins', idade: 66, matricula: '787878', pps: 7, spict: 'elegivel', prevAlta: '72h', complexidade: 'II', admAt: new Date(Date.now() - 6*86400000).toISOString(), linhas: ['Melhor Cuidado'], concessoes: ['Fisioterapia', 'Fonoaudiologia'] },
      { leito: 15, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Vago', nome: null, idade: null, matricula: null, pps: null, spict: null, prevAlta: null, complexidade: null, admAt: null, linhas: [], concessoes: [] },
      { leito: 16, hospital: 'H2', tipo: 'Enfermaria/Apto', status: 'Em uso', nome: 'M√°rcia Vieira', idade: 71, matricula: '909090', pps: 4, spict: 'nao_elegivel', prevAlta: '24h Ouro', complexidade: 'I', admAt: new Date(Date.now() - 1*86400000).toISOString(), linhas: ['APS', 'Cardiologia'], concessoes: ['PAD', 'Curativos'] }
    ];

    banco.H1 = mockH1;
    banco.H2 = mockH2;
    
    logSuccess("Dados mockados carregados com sucesso!");
    return true;
  }

  async function loadHospital(h) {
    logInfo(`Iniciando carregamento do hospital: ${h}`);
    try {
      const url = `${API_URL}?action=state&hospital=${h}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
      
      banco[h] = json.data;
      lastUpdateTime = Date.now();
      logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${json.data.length}`);
      
      if (activeTab === 'leitos') renderCards();
    } catch(error) {
      logError(`Erro ao carregar hospital ${h}:`, error);
      banco[h] = [];
      if (activeTab === 'leitos') renderCards();
    }
  }

  async function apiCall(payload) {
    logInfo(`Iniciando opera√ß√£o: ${payload.action}`, payload);
    try {
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(payload)) {
        if (Array.isArray(value)) params.append(key, value.join('|'));
        else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
      }
      
      const url = `${API_URL}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Erro na opera√ß√£o');
      
      logSuccess(`Opera√ß√£o ${payload.action} realizada com sucesso!`);
      return json.data;
    } catch(error) {
      logError(`Erro na opera√ß√£o ${payload.action}:`, error);
      throw new Error(error.message || 'Erro na opera√ß√£o');
    }
  }
  
  function setTab(tab){
    document.querySelectorAll(".side-menu-item").forEach(b=>b.classList.remove("active"));
    
    const activeSideMenuItem = $(`.side-menu-item[data-tab='${tab}']`);
    if(activeSideMenuItem) activeSideMenuItem.classList.add("active");

    activeTab = tab;
    route();
    
    if(tab.startsWith('dash')) {
      setTimeout(() => renderDashboards(), 50);
    }
  }
  
  function route(){
    const sections = ["leitosView","dash1","dash2","dash3"];
    sections.forEach(id => {
      const el = $(`#${id}`);
      if(el) el.classList.add("hidden");
    });

    const activeSectionId = activeTab === 'leitos' ? 'leitosView' : activeTab;
    $(`#${activeSectionId}`)?.classList.remove("hidden");

    if(activeTab === "leitos") renderCards();
  }

  function renderCards(){
    const container = $("#leitosView");
    container.innerHTML = "";
    const leitos = banco[currentHospital] || [];

    if(leitos.length === 0) {
        container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">Nenhum leito para exibir ou aguardando dados...</p>`;
        return;
    }

    leitos.forEach(l=>{
      const card = document.createElement("div");
      card.className = "card";

      const statusClass = l.status==="Em uso" ? "warn" : "ok";
      const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
      
      const chipsLinhas = (l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join("");
      const chipsConc   = (l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join("");
      const complexidadeClass = l.complexidade ? `complexidade-${l.complexidade.toLowerCase()}` : "";
      const complexidadeText = l.complexidade || "‚Äî";
      
      let prevAltaClass = "";
      let prevAltaText = l.prevAlta || "‚Äî";
      if (l.prevAlta) {
        if (l.prevAlta.includes('24h Ouro')) {
          prevAltaClass = "prev-alta-ouro";
        } else if (l.prevAlta.includes('24h')) {
          prevAltaClass = "prev-alta-24h";
        } else if (l.prevAlta === '48h') {
          prevAltaClass = "prev-alta-48h";
        } else if (l.prevAlta === '72h') {
          prevAltaClass = "prev-alta-72h";
        } else if (l.prevAlta === '96h') {
          prevAltaClass = "prev-alta-96h";
        }
      }
      
      card.innerHTML = `
        <div class="top">
          <div class="wrap">
            <span class="status ${statusClass}">Leito ${l.leito} ‚Äî ${l.status}</span>
            <span class="tipo ${tipoClass}">${l.tipo}</span>
          </div>
          <span class="badge">${HOSPITAIS[l.hospital].nome}</span>
        </div>
        <div class="row">
          <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"‚Äî"}</div></div>
          <div class="field"><div class="label">Matr√≠cula</div><div class="value">${l.matricula||"‚Äî"}</div></div>
          <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"‚Äî"}</div></div>
          <div class="field"><div class="label">Tempo de Interna√ß√£o</div><div class="value">${l.status === "Em uso" ? elapsedSince(l.admAt).text : "‚Äî"}</div></div>
          <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"‚Äî"}</div></div>
          <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</div></div>
          <div class="field"><div class="label">Prev. Alta</div><div class="value"><span class="${prevAltaClass}">${prevAltaText}</span></div></div>
          <div class="field"><div class="label">Complexidade</div><div class="value"><span class="${complexidadeClass}">${complexidadeText}</span></div></div>
          <div class="field" style="grid-column:1/3">
            <div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||"‚Äî"}</div>
          </div>
          <div class="field" style="grid-column:3/5">
            <div class="label">Concess√µes</div><div class="wrap">${chipsConc||"‚Äî"}</div>
          </div>
        </div>
        <div class="actions">
          ${l.status==="Vago"
            ? `<button class="btn primary" data-act="admitir">Admitir</button>`
            : `<button class="btn" data-act="atualizar">Atualizar / Ver Detalhes</button>`
          }
        </div>
      `;

      card.querySelector('[data-act="admitir"]')?.addEventListener('click', () => openAdmissao(l.leito));
      card.querySelector('[data-act="atualizar"]')?.addEventListener('click', () => openAtualizacao(l.leito));

      container.appendChild(card);
    });
  }

  function getDiasAteAlta(prevAlta) {
    if (!prevAlta || prevAlta === 'SP') return null;
    if (prevAlta.includes('24h')) return 1;
    if (prevAlta === '48h') return 2;
    if (prevAlta === '72h') return 3;
    if (prevAlta === '96h') return 4;
    return 7;
  }

  function createChart(canvasId, chartInstanceName, config) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
          logError(`Canvas com ID '${canvasId}' n√£o encontrado.`);
          return;
      }
      const ctx = canvas.getContext('2d');
      if (window[chartInstanceName]) window[chartInstanceName].destroy();
      window[chartInstanceName] = new Chart(ctx, config);
  }

  async function renderDashboards() {
      logInfo("Renderizando dashboards...");
      
      showLoading();
      
      await loadAllData();
      const allData = [...banco.H1, ...banco.H2];

      if (activeTab === 'dash1') renderDash1();
      if (activeTab === 'dash2') renderDash2(allData);
      
      hideLoading();
  }

  function calculateHospitalProjections(hospitalData) {
      const hoje = new Date();
      const labels = [];
      
      for (let i = 0; i <= 7; i++) {
          const diaFuturo = new Date(hoje);
          diaFuturo.setDate(hoje.getDate() + i);
          
          if (i === 0) {
              labels.push(`Hoje\n(${diaFuturo.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
          } else if (i === 1) {
              labels.push(`24h\n(${diaFuturo.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
          } else if (i === 2) {
              labels.push(`48h\n(${diaFuturo.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
          } else {
              labels.push(`D+${i}\n(${diaFuturo.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
          }
      }

      const linhasData = {};
      const concessoesData = {};

      (hospitalData || []).filter(p => p.status === 'Em uso' && p.prevAlta !== 'SP').forEach(paciente => {
          const dias = getDiasAteAlta(paciente.prevAlta);
          if (dias === null) return;
          
          (paciente.linhas || []).forEach(linha => {
              if (!linhasData[linha]) linhasData[linha] = new Array(8).fill(0);
              const diasParaManterLinhas = dias === 7 ? 8 : dias;
              for (let d = 0; d < diasParaManterLinhas; d++) {
                  linhasData[linha][d]++;
              }
          });
          (paciente.concessoes || []).forEach(conc => {
              if (!concessoesData[conc]) concessoesData[conc] = new Array(8).fill(0);
              const diasParaManterConc = dias === 7 ? 8 : dias;
              for (let d = 0; d < diasParaManterConc; d++) {
                  concessoesData[conc][d]++;
              }
          });
      });
      return { labels, linhasData, concessoesData };
  }

  function renderDash1() {
      logInfo("Renderizando Dashboard 1 - Hospitais...");
      
      const dashContainer = $('#dash1 .dash-grid');
      dashContainer.innerHTML = '';
      
      ['H1', 'H2'].forEach(h => {
          const dados = banco[h] || [];
          const totalLeitos = HOSPITAIS[h].leitos.length;
          const ocupados = dados.filter(l => l.status === 'Em uso').length;
          const vagos = totalLeitos - ocupados;
          const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
          
          const hospitalCard = document.createElement('div');
          hospitalCard.className = 'dashboard-card';
          hospitalCard.id = `dash-card-${h}`;
          
          hospitalCard.innerHTML = `
              <h3>${HOSPITAIS[h].nome}</h3>
              
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                  <div style="position: relative; width: 120px; height: 80px;">
                      <canvas id="chartOcupacao${h}" width="120" height="80"></canvas>
                      <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); text-align: center;">
                          <div style="font-size: 18px; font-weight: 700; color: var(--text-white);">${taxaOcupacao}%</div>
                          <div style="font-size: 10px; color: var(--muted);">Ocupa√ß√£o</div>
                      </div>
                  </div>
                  <div style="display: flex; gap: 20px;">
                      <div style="text-align: center;">
                          <div style="font-size: 24px; font-weight: 700; color: var(--text-white);">${totalLeitos}</div>
                          <div style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Total Leitos</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="font-size: 24px; font-weight: 700; color: var(--text-white);">${ocupados}</div>
                          <div style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Ocupados</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="font-size: 24px; font-weight: 700; color: var(--text-white);">${vagos}</div>
                          <div style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Vagos</div>
                      </div>
                  </div>
              </div>
              
              <h4>Proje√ß√£o de Concess√µes</h4>
              <div class="chart-container h-250"><canvas id="chartConcessoes${h}"></canvas></div>
              
              <h4>Proje√ß√£o de Linhas de Cuidado</h4>
              <div class="chart-container h-250"><canvas id="chartLinhas${h}"></canvas></div>
              
              <h4>Complexidade dos Pacientes</h4>
              <div class="chart-container h-250"><canvas id="chartComplexidade${h}"></canvas></div>
          `;
          
          dashContainer.appendChild(hospitalCard);
          
          createChart(`chartOcupacao${h}`, `chartGauge${h}`, { 
              type: 'doughnut', 
              data: { datasets: [{ 
                  data: [taxaOcupacao, 100 - taxaOcupacao], 
                  backgroundColor: [taxaOcupacao > 90 ? '#dc2626' : taxaOcupacao > 80 ? '#f59e0b' : '#16a34a', '#334155'], 
                  borderWidth: 0, 
              }] }, 
              options: { 
                  responsive: true, 
                  maintainAspectRatio: false, 
                  circumference: 180, 
                  rotation: -90, 
                  cutout: '75%', 
                  plugins: { tooltip: { enabled: false }, legend: { display: false } } 
              } 
          });
          
          const projections = calculateHospitalProjections(dados);
          
          const sortedConcessoes = Object.entries(projections.concessoesData).sort((a,b) => a[0].localeCompare(b[0]));
          createChart(`chartConcessoes${h}`, `chartConcessoesInst${h}`, {
              type: 'bar',
              data: {
                  labels: projections.labels,
                  datasets: sortedConcessoes.map(([key, values]) => ({
                      label: key, data: values,
                      backgroundColor: CONC_CORES[key] || '#cccccc'
                  }))
              },
              options: {
                  responsive: true, maintainAspectRatio: false,
                  plugins: { legend: { position: 'bottom' } },
                  scales: { 
                      y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Pacientes' } },
                      x: { ticks: { maxRotation: 0 } }
                  }
              }
          });
          
          const sortedLinhas = Object.entries(projections.linhasData).sort((a,b) => a[0].localeCompare(b[0]));
          createChart(`chartLinhas${h}`, `chartLinhasInst${h}`, {
              type: 'bar',
              data: {
                  labels: projections.labels,
                  datasets: sortedLinhas.map(([key, values]) => ({
                      label: key, data: values,
                      backgroundColor: LINHAS_CORES[key] || '#cccccc'
                  }))
              },
              options: {
                  responsive: true, maintainAspectRatio: false,
                  plugins: { legend: { position: 'bottom' } },
                  scales: { 
                      y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Pacientes' } },
                      x: { ticks: { maxRotation: 0 } }
                  }
              }
          });
          
          const complexidadeData = { 'I': 0, 'II': 0, 'III': 0 };
          const totalPacientes = dados.filter(p => p.status === 'Em uso').length;
          
          dados.filter(p => p.status === 'Em uso').forEach(p => {
              if (p.complexidade && complexidadeData.hasOwnProperty(p.complexidade)) {
                  complexidadeData[p.complexidade]++;
              }
          });
          
          const complexidadePercent = Object.entries(complexidadeData).map(([nivel, count]) => 
              totalPacientes > 0 ? Math.round((count / totalPacientes) * 100) : 0
          );
          
          createChart(`chartComplexidade${h}`, `chartComplexidadeInst${h}`, {
              type: 'bar',
              data: {
                  labels: ['I - Baixa', 'II - M√©dia', 'III - Alta'],
                  datasets: [{
                      label: '% de Pacientes',
                      data: complexidadePercent,
                      backgroundColor: ['#16a34a', '#f59e0b', '#dc2626']
                  }]
              },
              options: {
                  responsive: true, maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: { 
                      y: { beginAtZero: true, max: 100, ticks: { stepSize: 10 }, title: { display: true, text: '% de Benefici√°rios' } }
                  }
              }
          });
      });
      
      logSuccess('Dashboard 1 - Hospitais renderizado.');
  }

  function renderDash2(allData) {
      logInfo("Renderizando Dashboard 2 Executivo...");
      
      const totalLeitos = HOSPITAIS.H1.leitos.length + HOSPITAIS.H2.leitos.length;
      const ocupados = allData.filter(p => p.status === 'Em uso').length;
      const taxaOcupacaoGeral = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
      
      $('#kpiOcupacaoGeral').textContent = `${taxaOcupacaoGeral}%`;
      $('#kpiTotalLeitos').textContent = totalLeitos;
      $('#kpiLeitosOcupados').textContent = ocupados;
      
      const tempos = allData.filter(p => p.status === 'Em uso' && p.admAt).map(p => elapsedSince(p.admAt).days);
      $('#kpiTMP').textContent = tempos.length > 0 ? `${Math.round(tempos.reduce((a,b)=>a+b,0)/tempos.length)}` : '0';
      
      $('#kpiRotatividade').textContent = totalLeitos > 0 ? `${Math.round((ocupados / totalLeitos) * 30)}%` : '0%';
      
      createChart('kpiGaugeOcupacao', 'kpiGaugeOcupacaoInst', {
          type: 'doughnut',
          data: { datasets: [{ 
              data: [taxaOcupacaoGeral, 100-taxaOcupacaoGeral],
              backgroundColor: [taxaOcupacaoGeral > 90 ? '#dc2626' : taxaOcupacaoGeral > 80 ? '#f59e0b' : '#16a34a', '#e5e7eb'],
              borderWidth: 0,
          }] },
          options: {
              responsive: true, maintainAspectRatio: false,
              circumference: 180, rotation: -90, cutout: '70%',
              plugins: { tooltip: { enabled: false }, legend: { display: false } }
          }
      });

      const projGeralAltas = { "24h":{H1:0, H2:0}, "48h":{H1:0, H2:0}, "72h":{H1:0, H2:0}, "96h":{H1:0, H2:0} };
      allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta !== 'SP').forEach(p => {
          const key = p.prevAlta.includes('24h') ? '24h' : p.prevAlta;
          if(projGeralAltas[key]) projGeralAltas[key][p.hospital]++;
      });
      
      createChart('chartAltasComparativo', 'chartAltasComparativoInst', {
          type: 'bar',
          data: {
              labels: Object.keys(projGeralAltas),
              datasets: [
                  { label: 'Neomater', data: Object.values(projGeralAltas).map(d=>d.H1), backgroundColor: '#4a90e2' },
                  { label: 'Cruz Azul', data: Object.values(projGeralAltas).map(d=>d.H2), backgroundColor: '#0a2b52' }
              ]
          },
          options: { 
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: 'white' } } },
              scales: {
                  x: { ticks: { color: 'white' } },
                  y: { ticks: { color: 'white' } }
              }
          }
      });

      const timeline24h = { "Ouro": {H1:0, H2:0}, "2R": {H1:0, H2:0}, "3R": {H1:0, H2:0} };
      allData.filter(p => p.status === 'Em uso' && p.prevAlta && p.prevAlta.includes('24h')).forEach(p => {
          if (p.prevAlta.includes('Ouro')) timeline24h.Ouro[p.hospital]++;
          else if (p.prevAlta.includes('2R')) timeline24h["2R"][p.hospital]++;
          else if (p.prevAlta.includes('3R')) timeline24h["3R"][p.hospital]++;
      });
      
      createChart('chartTimeline24h', 'chartTimeline24hInst', {
          type: 'bar',
          data: {
              labels: Object.keys(timeline24h),
              datasets: [
                  { 
                      label: 'Neomater', 
                      data: Object.values(timeline24h).map(d=>d.H1), 
                      backgroundColor: ['#fbbf24', '#4a90e2', '#0a2b52']
                  },
                  { 
                      label: 'Cruz Azul', 
                      data: Object.values(timeline24h).map(d=>d.H2), 
                      backgroundColor: ['#f59e0b', '#3b82f6', '#1e40af']
                  }
              ]
          },
          options: { 
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: 'white' } } },
              scales: {
                  x: { ticks: { color: 'white' } },
                  y: { ticks: { color: 'white' } }
              }
          }
      });

      const projConsolidada = calculateHospitalProjections(allData);
      
      const sortedConcessoes = Object.entries(projConsolidada.concessoesData).sort((a,b) => a[0].localeCompare(b[0]));
      createChart('chartConcessoesConsolidado', 'chartConcessoesConsolidadoInst', {
          type: 'bar',
          data: {
              labels: projConsolidada.labels.map(label => label.replace('\n', ' ')),
              datasets: sortedConcessoes.map(([k,v])=>({
                  label: k, data: v,
                  backgroundColor: CONC_CORES[k] || '#cccccc'
              }))
          },
          options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { 
                  legend: { 
                      position: 'right',
                      labels: { color: 'white' }
                  },
                  title: { display: true, text: 'Concess√µes', color: 'white' }
              },
              scales: {
                  x: { 
                      stacked: true,
                      ticks: { color: 'white', maxRotation: 0 }
                  },
                  y: { 
                      stacked: true, 
                      title: { display: true, text: 'Concess√µes', color: 'white' },
                      ticks: { color: 'white' }
                  }
              }
          }
      });
      
      const sortedLinhas = Object.entries(projConsolidada.linhasData).sort((a,b) => a[0].localeCompare(b[0]));
      createChart('chartLinhasConsolidado', 'chartLinhasConsolidadoInst', {
          type: 'bar',
          data: {
              labels: projConsolidada.labels.map(label => label.replace('\n', ' ')),
              datasets: sortedLinhas.map(([k,v])=>({
                  label: k, data: v,
                  backgroundColor: LINHAS_CORES[k] || '#cccccc'
              }))
          },
          options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { 
                  legend: { 
                      position: 'right',
                      labels: { color: 'white' }
                  },
                  title: { display: true, text: 'Cuidados', color: 'white' }
              },
              scales: {
                  x: { 
                      stacked: true,
                      ticks: { color: 'white', maxRotation: 0 }
                  },
                  y: { 
                      stacked: true, 
                      title: { display: true, text: 'Cuidados', color: 'white' },
                      ticks: { color: 'white' }
                  }
              }
          }
      });

      const ppsRanges = { '0-3': {H1:0, H2:0}, '4-6': {H1:0, H2:0}, '7-10': {H1:0, H2:0} };
      allData.filter(p => p.status === 'Em uso' && p.pps).forEach(p => {
          const pps = p.pps;
          let range = '7-10';
          if (pps <= 3) range = '0-3';
          else if (pps <= 6) range = '4-6';
          ppsRanges[range][p.hospital]++;
      });
      
      createChart('chartPpsAnalise', 'chartPpsAnaliseInst', {
          type: 'bar',
          data: {
              labels: Object.keys(ppsRanges),
              datasets: [
                  { label: 'Neomater', data: Object.values(ppsRanges).map(r=>r.H1), backgroundColor: '#4a90e2' },
                  { label: 'Cruz Azul', data: Object.values(ppsRanges).map(r=>r.H2), backgroundColor: '#0a2b52' }
              ]
          },
          options: { 
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: 'white' } } },
              scales: {
                  x: { ticks: { color: 'white' } },
                  y: { ticks: { color: 'white' } }
              }
          }
      });

      const spictData = { H1: { elegivel: 0, nao_elegivel: 0 }, H2: { elegivel: 0, nao_elegivel: 0 } };
      allData.filter(p => p.status === 'Em uso').forEach(p => {
          if (p.spict && spictData[p.hospital]) spictData[p.hospital][p.spict]++;
      });
      
      createChart('chartSpictAnalise', 'chartSpictAnaliseInst', {
          type: 'bar',
          data: {
              labels: ['Eleg√≠vel', 'N√£o Eleg√≠vel'],
              datasets: [
                  { label: 'Neomater', data: [spictData.H1.elegivel, spictData.H1.nao_elegivel], backgroundColor: '#4a90e2' },
                  { label: 'Cruz Azul', data: [spictData.H2.elegivel, spictData.H2.nao_elegivel], backgroundColor: '#0a2b52' }
              ]
          },
          options: { 
              responsive: true, 
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: 'white' } } },
              scales: {
                  x: { ticks: { color: 'white' } },
                  y: { ticks: { color: 'white' } }
              }
          }
      });

      logSuccess('Dashboard 2 Executivo renderizado com sucesso!');
  }

  function openAdmissao(leito){
    selectedLeito = leito;
    const l = HOSPITAIS[currentHospital].leitos.find(x=>x.id===leito);
    $("#a_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#a_leito").textContent = "Leito " + l.id;
    $("#a_tipo").textContent = l.tipo;
    $("#a_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
    $("#a_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
    $("#a_nome").value=""; $("#a_idade").value=""; $("#a_matricula").value=""; $("#a_pps").value="";
    $("#a_spict").value="elegivel"; $("#a_prev").value="24h Ouro"; $("#a_complexidade").value="I";
    openModal("#modalAdmissao");
  }

  function openAtualizacao(leito){
    selectedLeito = leito;
    const l = banco[currentHospital].find(x=>x.leito===leito);
    $("#u_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#u_leito").textContent = "Leito " + l.leito;
    $("#u_tipo").textContent = l.tipo;
    $("#u_nome").value = l.nome||"";
    $("#u_matricula").value = l.matricula||"";
    $("#u_adm").value = fmtDateTime(l.admAt)||"";
    $("#u_idade").value = l.idade??"";
    $("#u_pps").value = l.pps??"";
    $("#u_spict").value = l.spict||"elegivel";
    $("#u_prev").value = l.prevAlta||"SP";
    $("#u_complexidade").value = l.complexidade||"I";
    $("#u_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.linhas||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
    $("#u_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" ${((l.concessoes||[]).includes(v)?"checked":"")}/> ${v}</label>`).join("");
    $("#internadoHa").textContent = `Internado h√° ${elapsedSince(l.admAt).text}`;
    openModal("#modalAtualizacao");
  }

  async function darAltaFlow(leito){
    if(!await confirmAction("Confirmar ALTA deste paciente?")) return;
    try {
      await apiCall({ action:'alta', hospital: currentHospital, leito: leito });
      if (isQRMode) {
        closeModal("#modalAtualizacao");
        showSuccessMessage();
      } else {
        await loadHospital(currentHospital);
      }
    } catch(error) { alert('Erro ao dar alta: ' + error.message); }
  }

  let qrReader = null;
  
  function handleScan(text) { 
    try {
      const u = new URL(String(text));
      const h = u.searchParams.get('h'); 
      const leito = Number(u.searchParams.get('leito')); 
      
      if(h && ["H1","H2"].includes(h) && leito > 0) {
        logSuccess(`QR Code v√°lido detectado: Hospital ${h}, Leito ${leito}`);
        closeModal("#modalQRScan"); 
        stopScan(); 
        initQRSession(h, leito);
      } else {
        logWarning("QR Code inv√°lido:", text);
      }
    } catch(e) {
      logWarning("QR Code n√£o reconhecido:", text);
    }
  }
  
  function initQRSession(hospital, leito) {
    logInfo(`Iniciando sess√£o QR para ${hospital} - Leito ${leito}`);
    isQRMode = true;
    currentHospital = hospital;
    selectedLeito = leito;
    
    document.getElementById('appHeader').style.display = 'none';
    document.querySelector('main').style.padding = '20px';
    
    loadHospital(hospital).then(() => {
      const leitoData = banco[hospital].find(l => l.leito === leito);
      if (!leitoData) {
        alert(`Leito ${leito} n√£o encontrado no hospital ${hospital}`);
        return;
      }
      
      if (leitoData.status === 'Vago') {
        openAdmissao(leito);
      } else {
        openAtualizacao(leito);
      }
      
      qrSessionTimeout = setTimeout(() => {
        closeAllModals();
        openModal("#modalQRExpired");
      }, 120000);
    });
  }
  
  function closeAllModals() {
    closeModal("#modalAdmissao");
    closeModal("#modalAtualizacao");
    if (qrSessionTimeout) {
      clearTimeout(qrSessionTimeout);
      qrSessionTimeout = null;
    }
  }
  
  async function startScan(){
    if(!window.Html5Qrcode){
      alert("Leitor n√£o dispon√≠vel.");
      return;
    }
    
    try{
      if(qrReader) await stopScan();
      qrReader = new Html5Qrcode('qrRegion');
      await qrReader.start(
        { facingMode:'environment' },
        { fps:10, qrbox:250 },
        handleScan,
        ()=>{}
      );
    } catch(e){
      logError("Erro ao acessar c√¢mera:", e);
      alert("N√£o foi poss√≠vel acessar a c√¢mera.");
      stopScan();
      closeModal("#modalQRScan");
    }
  }
  
  function stopScan(){
    if(!qrReader) return Promise.resolve();
    return qrReader.stop().then(()=>{
      qrReader.clear();
      qrReader=null;
    }).catch(()=>{});
  }
  
  function buildQRGrid(){
    const h = $("#b_hospital").value;
    const from = Math.max(1, parseInt($("#b_from").value||"1"));
    const to   = Math.max(from, parseInt($("#b_to").value||"1"));
    const limit = h==="H1"?13:16;
    const f = Math.min(from, limit);
    const t = Math.min(to, limit);
    const base = `${location.origin}${location.pathname}`;
    const grid = $("#qr_grid");
    grid.innerHTML = "";
    
    for(let i=f; i<=t; i++){
      const url = `${base}?h=${h}&leito=${i}`;
      const cell = document.createElement("div");
      cell.className="qr-cell";
      cell.innerHTML = `<div class="qr-box"></div><div class="mini">Leito ${i} ‚Ä¢ ${HOSPITAIS[h].nome}</div>`;
      grid.appendChild(cell);
      new QRCode(cell.querySelector(".qr-box"), {text:url, width:160, height:160});
    }
  }
  
  function checkQRParams() {
    const params = new URLSearchParams(window.location.search);
    const h = params.get('h');
    const leito = params.get('leito');
    
    if (h && leito && ["H1","H2"].includes(h)) {
      logInfo("Par√¢metros QR detectados na URL");
      initQRSession(h, parseInt(leito));
      return true;
    }
    return false;
  }

  function openQRScan() {
    const modal = document.getElementById('modalQRScan');
    if (modal) {
        modal.style.display = 'flex';
        if (window.startScan) window.startScan();
    }
    document.getElementById('config-dropdown')?.classList.remove('show');
  }

  function openQRPrint() {
    const modal = document.getElementById('modalBulkQR');
    if (modal) {
        modal.style.display = 'flex';
    }
    document.getElementById('config-dropdown')?.classList.remove('show');
  }

  function setupEventListeners() {
    document.querySelectorAll(".side-menu-item").forEach(b=> b.onclick = (e)=> {
      e.preventDefault();
      setTab(b.dataset.tab);
    });
    
    $('#refreshBtn').onclick = () => { 
      logInfo("Refresh manual"); 
      if (activeTab.startsWith('dash')) { 
        renderDashboards() 
      } else { 
        loadAllData(); 
      } 
    };

    $('#sidebar-config').onclick = (e) => {
      e.preventDefault();
      $('#config-dropdown').classList.toggle('show');
    };
    
    window.onclick = (event) => {
        if (!event.target.closest('.sidebar-settings-item')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    };
    
    document.querySelectorAll("[data-close]").forEach(b=> b.onclick = ()=> closeModal(b.getAttribute("data-close")) );
    $("#b_generate").onclick = buildQRGrid;
    $("#reloadPage").onclick = ()=> location.reload();
    
    $('#a_cancel').onclick = async () => { if (await confirmAction("Cancelar admiss√£o?")) closeModal("#modalAdmissao"); };
    $('#u_cancel').onclick = async () => { if (await confirmAction("Cancelar altera√ß√µes?")) closeModal("#modalAtualizacao"); };
    $('#u_alta').onclick = ()=> darAltaFlow(selectedLeito);
    
    $('#a_save').onclick = async ()=>{
      if(!await confirmAction("Salvar e admitir paciente?")) return; 
      try { 
        const payload = { 
          action: 'admit', 
          hospital: currentHospital, 
          leito: selectedLeito, 
          nome: $("#a_nome").value.trim(), 
          idade: Number($("#a_idade").value)||null, 
          matricula: $("#a_matricula").value.trim(), 
          pps: Number($("#a_pps").value)||null, 
          spict: $("#a_spict").value, 
          prevAlta: $("#a_prev").value, 
          complexidade: $("#a_complexidade").value,
          linhas: Array.from(document.querySelectorAll("#a_linhas input:checked")).map(i=>i.value), 
          concessoes: Array.from(document.querySelectorAll("#a_concessoes input:checked")).map(i=>i.value) 
        }; 
        await apiCall(payload); 
        closeModal("#modalAdmissao"); 
        if (isQRMode) { 
          showSuccessMessage(); 
        } else { 
          await loadAllData(); 
        } 
      } catch(error) { 
        alert('Erro: ' + error.message); 
      } 
    };
    
    $('#u_save').onclick = async ()=>{
      if(!await confirmAction("Salvar altera√ß√µes?")) return; 
      try { 
        const payload = { 
          action: 'update', 
          hospital: currentHospital, 
          leito: selectedLeito, 
          idade: Number($("#u_idade").value)||null, 
          pps: Number($("#u_pps").value)||null, 
          spict: $("#u_spict").value, 
          prevAlta: $("#u_prev").value, 
          complexidade: $("#u_complexidade").value,
          linhas: Array.from(document.querySelectorAll("#u_linhas input:checked")).map(i=>i.value), 
          concessoes: Array.from(document.querySelectorAll("#u_concessoes input:checked")).map(i=>i.value) 
        }; 
        await apiCall(payload); 
        closeModal("#modalAtualizacao"); 
        if (isQRMode) { 
          showSuccessMessage(); 
        } else { 
          await loadAllData(); 
        } 
      } catch(error) { 
        alert('Erro: ' + error.message); 
      } 
    };
  }
  
  window.openQRScan = openQRScan;
  window.openQRPrint = openQRPrint;

  (async function init(){
    logInfo("=== INICIALIZANDO ARCHIPELAGO CORPORATIVO ===");
    showLoading();
    setupEventListeners();
    
    await testConnection();
    
    if (checkQRParams()) {
      hideLoading();
      return;
    }
    
    logInfo("üíº MODO CORPORATIVO INICIADO");
    setTab("leitos");
    await loadAllData();
    
    autoRefreshInterval = setInterval(() => {
      if (!isQRMode) {
        logInfo("Auto-refresh executado");
        Promise.all([loadHospital("H1"), loadHospital("H2")]).then(() => {
          if(activeTab.startsWith('dash')) renderDashboards();
        });
      }
    }, 60000);
    
    updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
    
    hideLoading();
    logInfo("=== INICIALIZA√á√ÉO CONCLU√çDA ===");
  })();

</script>
</body>
</html>
