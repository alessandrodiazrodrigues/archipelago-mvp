<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Protótipo MVP – Archipelago Dashboard</title>
  <style>
    :root{
      --brand:#0F3D73;
      --brand-2:#0B2C52;
      --accent:#1F73B7;
      --bg:#f6f8fa;
      --text:#1f2937;
      --muted:#6b7280;
      --success:#16a34a;
      --warning:#f59e0b;
      --danger:#dc2626;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;color:var(--text);background:var(--bg)}
    header{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      color:#fff;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff30}
    .logo::after{content:"PS";font-weight:700;letter-spacing:1px}
    .title h1{margin:0;font-size:18px}
    .title small{display:block;color:#e6ecf5}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--brand);border-color:#fff}
    .select{appearance:none;border:1px solid #ffffff66;background:#ffffff1a;color:#fff;padding:8px 10px;border-radius:10px}

    /* App root + modo Mobile */
    #appRoot{max-width:1200px;margin:0 auto}
    .mobile-sim{
      max-width:420px !important;
      margin:0 auto;
      border:10px solid #0b0b0b;
      border-radius:24px;
      box-shadow:0 20px 60px #00000033;
      overflow:hidden;
      background:#000;
    }
    .mobile-sim header{border-top-left-radius:0;border-top-right-radius:0}

    main{max-width:1200px;margin:20px auto;padding:0 16px 96px}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent;color:var(--brand);border-color:var(--brand)}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:10px 0 16px}
    .stat{background:var(--card);border:1px solid var(--border);padding:14px;border-radius:12px}
    .stat .kpi{font-size:22px;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 18px #00000012}
    .card .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.vago{background:var(--success)}
    .dot.ocupado{background:var(--warning)}
    .mini{font-size:12px;color:var(--muted)}
    .h{margin:10px 0 2px;font-weight:700}
    .badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .con{font-size:11px;background:#eef2ff;border:1px solid #dbeafe;color:#1e40af}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:0 8px}
    .table td{background:var(--card);border:1px solid var(--border);padding:8px;border-radius:10px}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid var(--border);background:#f9fafb;color:var(--muted)}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px 16px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hidden{display:none}

    /* Modais */
    .backdrop{position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal{background:#fff;max-width:820px;width:100%;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 28px #00000024}
    .modal header{background:none;color:var(--text);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .content{padding:16px}
    .field{margin-bottom:12px}
    .label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .input, .select2, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none}
    .input:focus, .select2:focus, textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px #0f3d7320}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .danger{color:var(--danger)}
    .checklist{display:flex;flex-wrap:wrap;gap:8px}
    .checklist label{display:flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#f9fafb;font-size:13px}

    /* Grades de hospitais */
    .hospital-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.hospital-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.hospital-grid{grid-template-columns:1fr}}

    /* Gestor (cards de gráfico) */
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}

    /* Gestor 2×2 */
    .gestor2-header{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:10px 0 16px}
    .gestor2-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .gestor2-card h4{margin:0 0 8px;font-size:14px}
    .gestor2-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .gestor2-mini{height:150px;position:relative}
    @media (max-width:900px){
      .gestor2-header{grid-template-columns:repeat(2,minmax(0,1fr))}
      .gestor2-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div id="appRoot">
  <header>
    <div class="brand">
      <div class="logo" aria-label="Prevent Senior logo" title="Prevent Senior"></div>
      <div class="title">
        <h1>Protótipo MVP – Archipelago Dashboard</h1>
        <small>Gestão de Leitos • Multi-Hospital (Demo)</small>
      </div>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="hospitais" aria-selected="true">Hospitais</button>
      <button class="tab" data-tab="leitos" aria-selected="false">Leitos</button>
      <button class="tab" data-tab="dashboard" aria-selected="false">Dashboard</button>
      <button class="tab" data-tab="gestor" aria-selected="false">Gestor</button>
      <button class="tab" data-tab="gestor2" aria-selected="false">Gestor 2×2</button>
    </nav>
    <select id="selHospital" class="select" title="Hospital atual">
      <option value="H1">Hospital 1</option>
      <option value="H2">Hospital 2</option>
      <option value="H3">Hospital 3</option>
      <option value="H4">Hospital 4</option>
    </select>
  </header>

  <main>
    <div class="toolbar">
      <div class="muted">Demo estática (sem backend) para apresentação do fluxo</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnQr">Ler QR Code</button>
        <button class="btn ghost" id="btnShowQRCodes">QR Leitos (1 e 3)</button>
        <button class="btn ghost" id="btnLogin">Entrar com Google</button>
        <button class="btn" id="btnRefresh">Atualizar agora</button>
        <button class="btn primary" id="btnSimularMobile">Simular Mobile</button>
      </div>
    </div>

    <!-- KPIs (por hospital) -->
    <section id="stats" class="stats hidden">
      <div class="stat"><div class="mini">Leitos em uso</div><div class="kpi" id="kpiOcupados">–</div></div>
      <div class="stat"><div class="mini">Leitos vagos</div><div class="kpi" id="kpiVagos">–</div></div>
      <div class="stat"><div class="mini">Altas 24h</div><div class="kpi" id="kpiAltas24">–</div></div>
      <div class="stat"><div class="mini">Top concessão</div><div class="kpi" id="kpiTopConc">–</div></div>
    </section>

    <!-- VISÃO GERAL DE HOSPITAIS -->
    <section id="hospitaisView">
      <h3 style="margin:4px 0 10px">Visão geral (4 hospitais)</h3>
      <div id="resumoGeral" class="stats" style="grid-template-columns:repeat(4,minmax(0,1fr));"></div>
      <div class="hospital-grid" id="hospitaisGrid"></div>
    </section>

    <!-- GRID DE LEITOS (por hospital) -->
    <section id="leitosView" class="grid hidden" aria-label="Leitos"></section>

    <!-- DASHBOARD (por hospital) -->
    <section id="dashboardView" class="hidden">
      <table class="table">
        <thead>
          <tr>
            <th>Leito</th>
            <th>Status</th>
            <th>Paciente</th>
            <th>Previsão de Alta</th>
            <th>Linha de Cuidado</th>
            <th>Concessões</th>
          </tr>
        </thead>
        <tbody id="dashBody"></tbody>
      </table>
    </section>

    <!-- GESTOR (gráficos gerais) -->
    <section id="gestorView" class="hidden" aria-label="Painel do Gestor">
      <div class="chart-grid">
        <div class="chart-card">
          <div class="mini">Ocupação por hospital</div>
          <canvas id="chartOcupacao" height="160"></canvas>
        </div>
        <div class="chart-card">
          <div class="mini">Previsão de altas (próximas 24h)</div>
          <canvas id="chartAltas24" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- GESTOR 2×2 (todos os hospitais) -->
    <section id="gestor2View" class="hidden" aria-label="Painel do Gestor (2x2)">
      <div id="gestor2Header" class="gestor2-header"></div>
      <div id="gestor2Grid" class="hospital-grid" style="margin-top:8px"></div>
    </section>
  </main>

  <!-- MODAIS -->
  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div><strong>Confirmação do paciente</strong></div>
        <button class="btn" data-close="#modalConfirm">Fechar</button>
      </header>
      <div class="content">
        <div class="field">
          <div class="label">Paciente atual</div>
          <div><strong id="c_nome"></strong> • Matrícula <span id="c_matricula" class="pill"></span></div>
        </div>
        <div class="field">
          <div class="label">Data de nascimento</div>
          <div><span class="muted">__/</span><strong id="c_mes"></strong><span class="muted">/</span><strong id="c_ano"></strong></div>
          <div class="mini" style="margin-top:4px">Digite apenas o <strong>dia</strong> (DD) de nascimento.</div>
        </div>
        <div class="field row3">
          <div>
            <label class="label" for="c_dia">Dia (DD)</label>
            <input id="c_dia" class="input" inputmode="numeric" maxlength="2" placeholder="DD"/>
          </div>
          <div>
            <label class="label">Leito</label>
            <div class="pill" id="c_leito"></div>
          </div>
          <div>
            <label class="label">Hospital</label>
            <div class="pill" id="c_hospital"></div>
          </div>
        </div>
        <div id="c_erro" class="danger hidden">Dia não confere. Tente novamente.</div>
      </div>
      <div class="actions">
        <button class="btn" data-close="#modalConfirm">Cancelar</button>
        <button class="btn primary" id="btnConfirmar">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div><strong>Admissão de Paciente</strong></div>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="field row2">
          <div><label class="label">Leito</label><div id="a_leito" class="pill"></div></div>
          <div><label class="label">Hospital</label><div id="a_hospital" class="pill"></div></div>
        </div>
        <div class="field row2">
          <div><label class="label" for="a_nome">Nome completo</label><input id="a_nome" class="input" placeholder="Nome do paciente"/></div>
          <div><label class="label" for="a_matricula">Matrícula</label><input id="a_matricula" class="input" placeholder="000000"/></div>
        </div>
        <div class="field row3">
          <div><label class="label" for="a_dia">Nascimento (dia)</label><input id="a_dia" class="input" inputmode="numeric" maxlength="2" placeholder="DD"/></div>
          <div><label class="label" for="a_mes">Nascimento (mês)</label><input id="a_mes" class="input" inputmode="numeric" maxlength="2" placeholder="MM"/></div>
          <div><label class="label" for="a_ano">Nascimento (ano)</label><input id="a_ano" class="input" inputmode="numeric" maxlength="4" placeholder="AAAA"/></div>
        </div>
        <div class="field row3">
          <div>
            <label class="label" for="a_prev">Previsão de alta</label>
            <select id="a_prev" class="select2"><option>24h</option><option>48h</option><option>72h</option><option>+72h</option></select>
          </div>
          <div>
            <label class="label" for="a_linha">Linha de cuidado</label>
            <select id="a_linha" class="select2"><option>APS</option><option>Geriatria</option><option>Outras</option></select>
          </div>
          <div>
            <label class="label" for="a_pps">PPS</label>
            <input id="a_pps" class="input" inputmode="numeric" placeholder="0–100"/>
          </div>
        </div>
        <div class="field">
          <div class="label">Concessões necessárias</div>
          <div class="checklist" id="a_concessoes"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" data-close="#modalAdmissao">Cancelar</button>
        <button class="btn primary">Salvar (demo)</button>
      </div>
    </div>
  </div>

  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div><strong>Atualização de Paciente</strong></div>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="field row2">
          <div><label class="label">Leito</label><div id="u_leito" class="pill"></div></div>
          <div><label class="label">Hospital</label><div id="u_hospital" class="pill"></div></div>
        </div>
        <div class="field row2">
          <div><label class="label">Nome</label><input id="u_nome" class="input"/></div>
          <div><label class="label">Matrícula</label><input id="u_matricula" class="input"/></div>
        </div>
        <div class="field row3">
          <div>
            <label class="label" for="u_prev">Previsão de alta</label>
            <select id="u_prev" class="select2"><option>24h</option><option>48h</option><option>72h</option><option>+72h</option></select>
          </div>
          <div>
            <label class="label" for="u_linha">Linha de cuidado</label>
            <select id="u_linha" class="select2"><option>APS</option><option>Geriatria</option><option>Outras</option></select>
          </div>
          <div>
            <label class="label" for="u_pps">PPS</label>
            <input id="u_pps" class="input" inputmode="numeric"/>
          </div>
        </div>
        <div class="field">
          <div class="label">Concessões</div>
          <div class="checklist" id="u_concessoes"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn">Salvar (demo)</button>
        <button class="btn primary">Dar Alta (demo)</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div><strong>Ler QR Code do Leito</strong></div>
        <button class="btn" id="btnCloseQR" data-close="#modalQRScan">Fechar</button>
      </header>
      <div class="content">
        <div class="mini" style="margin-bottom:8px">Se a câmera não abrir neste dispositivo, utilize a <strong>seleção manual de leito</strong> (fallback).</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions">
        <button class="btn" data-close="#modalQRScan">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modalQRCodes" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <div><strong>QR Codes dos Leitos (H1)</strong></div>
        <button class="btn" data-close="#modalQRCodes">Fechar</button>
      </header>
      <div class="content">
        <div class="row2">
          <div>
            <div class="label">Leito 1 → <code>?h=H1&leito=1</code></div>
            <div id="qr1" style="padding:8px;background:#fff;border:1px solid var(--border);border-radius:12px;display:inline-block"></div>
          </div>
          <div>
            <div class="label">Leito 3 → <code>?h=H1&leito=3</code></div>
            <div id="qr3" style="padding:8px;background:#fff;border:1px solid var(--border);border-radius:12px;display:inline-block"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:10px">Dica: imprima e fixe no leito. Ao escanear, o sistema abre direto na tela do leito.</div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.print()">Imprimir</button>
        <button class="btn" data-close="#modalQRCodes">Fechar</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>© Protótipo ilustrativo (sem dados reais).</div>
    <div><strong>Desenvolvido por Alessandro Diaz Rodrigues</strong></div>
  </div>
</div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ---------- DADOS DEMO ----------
    const concessoesCatalogo = ["Fisioterapia","Nutricionista","Psicólogo","Psiquiatra","Raio-X","Medicação"];
    const hospitais = ["H1","H2","H3","H4"];
    const hospitalNomes = {H1:"Hospital 1",H2:"Hospital 2",H3:"Hospital 3",H4:"Hospital 4"};

    function gerarLeitos(seed, hospital){
      const now = new Date();
      const arr = [];
      for(let i=1;i<=10;i++){
        const emUso = i%3 !== 0; // 3,6,9 vagos
        const nomes = ["Maria Aparecida Silva","João Pedro Santos","Ana Paula Reis","Carlos Souza","Luciana Matos","Paulo Andrade","Beatriz Gomes","Rafael Lima","Sônia Oliveira","Marcelo Freitas"];
        const nome = emUso ? nomes[i-1] : "";
        const iniciais = nome ? nome.split(" ").map(n=>n[0]).slice(0,2).join("") : "";
        const matricula = emUso ? String(seed*1000 + i) : "";
        const previsaoBucket = emUso ? (i%2===0? "24h" : (i%5===0?"72h":"48h")) : "";
        const horas = previsaoBucket==="24h"?24:previsaoBucket==="48h"?48:previsaoBucket==="72h"?72:96;
        const previsaoAt = emUso ? new Date(now.getTime()+horas*3600*1000) : null;
        const linhaCuidado = emUso ? (i%2===0?"Geriatria":"APS") : "";
        const pps = emUso ? (50 + (i%4)*10) : null;
        const spict = emUso ? (i%4===0) : false;
        const acordo = emUso ? concessoesCatalogo.filter((_,k)=> (k+i+seed)%3===0 ) : [];
        const ano = emUso ? 1950 + ((i+seed*2)%50) : null;
        const mes = emUso ? ((i+seed)%12)+1 : null;
        const dia = emUso ? ((i+seed)%28)+1 : null;
        const dataEntrada = emUso ? new Date(now.getTime()- (i+2)*3600*1000) : null;
        arr.push({
          hospital, id:i, status: emUso?"Em uso":"Vago",
          paciente: {nome, iniciais, matricula, dia, mes, ano},
          previsaoBucket, previsaoAt, linhaCuidado, pps, spict, concessoes: acordo, dataEntrada
        });
      }
      if(hospital==="H1"){
        arr[2].status = "Vago";
        arr[2].paciente = {nome:"", iniciais:"", matricula:"", dia:null, mes:null, ano:null};
        arr[0].paciente.dia = 1;
      }
      return arr;
    }

    const banco = {};
    hospitais.forEach((h,idx)=> banco[h] = gerarLeitos(idx+1,h));

    // ---------- ESTADO & ELEMENTOS ----------
    let activeTab = "hospitais";
    let currentHospital = "H1";
    let selectedLeito = null;
    let mobileSimOn = false;

    const tabs = document.querySelectorAll(".tab");
    const selHospital = document.getElementById("selHospital");
    const hospitaisView = document.getElementById("hospitaisView");
    const hospitaisGrid = document.getElementById("hospitaisGrid");
    const resumoGeral = document.getElementById("resumoGeral");
    const leitosView = document.getElementById("leitosView");
    const dashboardView = document.getElementById("dashboardView");
    const gestorView = document.getElementById("gestorView");
    const gestor2View = document.getElementById("gestor2View");
    const stats = document.getElementById("stats");
    const kpiOcupados = document.getElementById("kpiOcupados");
    const kpiVagos = document.getElementById("kpiVagos");
    const kpiAltas24 = document.getElementById("kpiAltas24");
    const kpiTopConc = document.getElementById("kpiTopConc");
    const dashBody = document.getElementById("dashBody");
    const appRoot = document.getElementById("appRoot");

    // Gráficos Gestor
    const elChartOcup = document.getElementById("chartOcupacao");
    const elChartAltas = document.getElementById("chartAltas24");
    let chartOcup = null, chartAltas = null;

    // ---------- TABS & SELECT ----------
    tabs.forEach(t=>t.addEventListener("click",()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      t.classList.add("active");
      activeTab = t.dataset.tab;
      route();
    }));
    selHospital.addEventListener("change",()=>{
      currentHospital = selHospital.value;
      route();
    });

    // ---------- KPIs ----------
    function kpisHospital(leitos){
      const now = new Date();
      const ocupados = leitos.filter(l=>l.status==="Em uso").length;
      const vagos = leitos.length - ocupados;
      const altas24 = leitos.filter(l=>l.status==="Em uso" && (l.previsaoAt - now) <= 24*3600*1000).length;
      const concessoes = leitos.flatMap(l=>l.concessoes||[]);
      const top = concessoes.length? Object.entries(concessoes.reduce((a,c)=>(a[c]=(a[c]||0)+1,a),{})).sort((a,b)=>b[1]-a[1])[0][0] : "—";
      return {ocupados,vagos,altas24,top};
    }
    function kpisGerais(){
      const all = hospitais.flatMap(h=>banco[h]);
      const {ocupados,vagos,altas24,top} = kpisHospital(all);
      return {
        totHosp: hospitais.length,
        totLeitos: all.length,
        ocupados, vagos, altas24, top,
        taxaOcup: all.length? Math.round((ocupados/all.length)*100) : 0
      };
    }

    // ---------- RENDER HOSPITAIS ----------
    function renderHospitais(){
      const all = hospitais.flatMap(h=>banco[h]);
      const r = kpisHospital(all);
      resumoGeral.innerHTML = `
        <div class="stat"><div class="mini">Ocupados (geral)</div><div class="kpi">${r.ocupados}</div></div>
        <div class="stat"><div class="mini">Vagos (geral)</div><div class="kpi">${r.vagos}</div></div>
        <div class="stat"><div class="mini">Altas 24h (geral)</div><div class="kpi">${r.altas24}</div></div>
        <div class="stat"><div class="mini">Top concessão (geral)</div><div class="kpi">${r.top}</div></div>
      `;
      hospitaisGrid.innerHTML = "";
      hospitais.forEach(h=>{
        const lts = banco[h];
        const k = kpisHospital(lts);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <div class="badge"><span class="dot ocupado"></span> ${hospitalNomes[h]}</div>
            <div class="mini">Altas 24h: ${k.altas24}</div>
          </div>
          <div class="h">Ocupados: ${k.ocupados} • Vagos: ${k.vagos}</div>
          <div class="mini">Top concessão: ${k.top}</div>
          <div class="badges" style="margin-top:8px">
            <span class="con">Ver Leitos</span>
            <span class="con">Ver Dashboard</span>
          </div>
        `;
        card.addEventListener("click",()=>{
          currentHospital = h;
          selHospital.value = h;
          setTab("leitos");
        });
        hospitaisGrid.appendChild(card);
      });
    }

    // ---------- UTILS ----------
    function timeTo(date){
      if(!date) return "—";
      const now = new Date();
      const diff = Math.max(0, date - now);
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      return `Alta em ${String(h).padStart(2,"0")}h ${String(m).padStart(2,"0")}m`;
    }

    // ---------- RENDER LEITOS ----------
    function renderLeitos(){
      leitosView.innerHTML = "";
      const leitos = banco[currentHospital];
      leitos.forEach(l=>{
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("role","button");
        card.setAttribute("aria-label", `Leito ${l.id} ${l.status}`);
        card.innerHTML = `
          <div class="row">
            <div class="badge"><span class="dot ${l.status==='Em uso'?'ocupado':'vago'}"></span> Leito ${l.id}</div>
            <div class="mini">${l.status==='Em uso' ? timeTo(l.previsaoAt) : 'Vago'}</div>
          </div>
          <div class="h">${l.status==='Em uso'? (l.paciente.iniciais || '—') : '—'}</div>
          <div class="mini">${l.status==='Em uso'? (l.linhaCuidado || '') : ''}</div>
          <div class="badges">
            ${(l.concessoes||[]).map(c=>`<span class="con">${c}</span>`).join("")}
          </div>
        `;
        card.addEventListener("click",()=>openLeito(l.id));
        leitosView.appendChild(card);
      });
    }

    // ---------- RENDER DASHBOARD (hospital) ----------
    function renderDashboard(){
      const leitos = banco[currentHospital];
      const k = kpisHospital(leitos);
      kpiOcupados.textContent = k.ocupados;
      kpiVagos.textContent = k.vagos;
      kpiAltas24.textContent = k.altas24;
      kpiTopConc.textContent = k.top;
      dashBody.innerHTML = "";
      leitos
        .slice()
        .sort((a,b)=> (a.previsaoAt||Infinity) - (b.previsaoAt||Infinity))
        .forEach(l=>{
          const tr = document.createElement("tr");
          const conc = (l.concessoes||[]).length? l.concessoes.join(", ") : "—";
          tr.innerHTML = `
            <td><span class="badge"><span class="dot ${l.status==='Em uso'?'ocupado':'vago'}"></span> ${l.id}</span></td>
            <td>${l.status}</td>
            <td>${l.status==='Em uso'? (l.paciente.nome) : '—'}</td>
            <td>${l.status==='Em uso'? timeTo(l.previsaoAt) : '—'}</td>
            <td>${l.status==='Em uso'? (l.linhaCuidado||'—') : '—'}</td>
            <td>${conc}</td>
          `;
          dashBody.appendChild(tr);
        });
    }

    // ---------- DATASETS GRÁFICOS ----------
    function datasetOcupacaoPorHospital(){
      const labels = hospitais.map(h=>hospitalNomes[h]);
      const ocupados = hospitais.map(h=> banco[h].filter(l=>l.status==="Em uso").length );
      const vagos = hospitais.map(h=> banco[h].filter(l=>l.status!=="Em uso").length );
      return { labels, ocupados, vagos };
    }
    function datasetAltasProximas24h(){
      const now = new Date();
      const buckets = new Array(24).fill(0);
      hospitais.forEach(h=>{
        banco[h].forEach(l=>{
          if(l.status==="Em uso" && l.previsaoAt){
            const diff = l.previsaoAt - now;
            if(diff >= 0 && diff <= 24*3600*1000){
              const hour = Math.floor(diff/3600000);
              buckets[hour] += 1;
            }
          }
        });
      });
      const labels = buckets.map((_,i)=>`${i}h`);
      return { labels, buckets };
    }
    function datasetOcupacaoHospital(h){
      const lts = banco[h];
      const ocup = lts.filter(l=>l.status==="Em uso").length;
      const vag = lts.length - ocup;
      return {ocup, vag, total:lts.length, perc: lts.length? Math.round((ocup/lts.length)*100):0};
    }
    function datasetAltas24Hospital(h){
      const now = new Date();
      const buckets = new Array(6).fill(0); // 0-4,4-8,8-12,12-16,16-20,20-24
      banco[h].forEach(l=>{
        if(l.status==="Em uso" && l.previsaoAt){
          const diffh = (l.previsaoAt - now)/3600000;
          if(diffh>=0 && diffh<=24){
            const idx = Math.min(5, Math.floor(diffh/4));
            buckets[idx] += 1;
          }
        }
      });
      const labels = ["0–4h","4–8h","8–12h","12–16h","16–20h","20–24h"];
      return {labels,buckets};
    }

    // ---------- RENDER GESTOR (geral) ----------
    function renderGestor(){
      const {labels, ocupados, vagos} = datasetOcupacaoPorHospital();
      if(chartOcup){ chartOcup.destroy(); }
      chartOcup = new Chart(elChartOcup, {
        type:'bar',
        data:{ labels, datasets:[
          {label:'Ocupados', data:ocupados, borderWidth:1},
          {label:'Vagos', data:vagos, borderWidth:1}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ stacked:true, ticks:{ maxRotation:0, autoSkip:true } },
            y:{ stacked:true, beginAtZero:true, ticks:{ precision:0 } }
          },
          datasets:{ bar:{ categoryPercentage:0.6, barPercentage:0.8, maxBarThickness:38 } },
          animation:false,
          plugins:{ legend:{ position:'bottom' }, title:{ display:false } }
        }
      });

      const altas = datasetAltasProximas24h();
      if(chartAltas){ chartAltas.destroy(); }
      chartAltas = new Chart(elChartAltas, {
        type:'bar',
        data:{ labels:altas.labels, datasets:[{ label:'Altas previstas', data:altas.buckets, borderWidth:1 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
          datasets:{ bar:{ maxBarThickness:24 } },
          animation:false,
          plugins:{ legend:{ position:'bottom' }, title:{ display:false } }
        }
      });
    }

    // ---------- RENDER GESTOR 2×2 ----------
    let gestor2Charts = [];
    function destroyGestor2Charts(){
      gestor2Charts.forEach(ch=>{ try{ ch.destroy(); }catch(e){} });
      gestor2Charts = [];
    }
    function renderGestor2(){
      // KPIs gerais
      const g = kpisGerais();
      document.getElementById('gestor2Header').innerHTML = `
        <div class="stat"><div class="mini">Leitos Totais</div><div class="kpi">${g.totLeitos}</div></div>
        <div class="stat"><div class="mini">Leitos Ocupados</div><div class="kpi">${g.ocupados}</div></div>
        <div class="stat"><div class="mini">Leitos Vagos</div><div class="kpi">${g.vagos}</div></div>
        <div class="stat"><div class="mini">Taxa de Ocupação</div><div class="kpi">${g.taxaOcup}%</div></div>
      `;

      // Grid 2x2 – um cartão por hospital
      const grid = document.getElementById('gestor2Grid');
      grid.innerHTML = "";
      destroyGestor2Charts();

      hospitais.forEach(h=>{
        const card = document.createElement('div');
        card.className = "gestor2-card";
        card.innerHTML = `
          <h4>${hospitalNomes[h]}</h4>
          <div class="gestor2-grid">
            <div class="chart-card">
              <div class="mini">Ocupação (%)</div>
              <canvas id="occ_${h}" class="gestor2-mini"></canvas>
            </div>
            <div class="chart-card">
              <div class="mini">Altas (0–24h)</div>
              <canvas id="alt_${h}" class="gestor2-mini"></canvas>
            </div>
          </div>
        `;
        grid.appendChild(card);

        // Mini gráfico de ocupação (doughnut)
        const dOcc = datasetOcupacaoHospital(h);
        const c1 = new Chart(document.getElementById(`occ_${h}`), {
          type:'doughnut',
          data:{
            labels:['Ocupados','Vagos'],
            datasets:[{ data:[dOcc.ocup, dOcc.vag], borderWidth:1 }]
          },
          options:{
            responsive:true, maintainAspectRatio:false,
            cutout:'60%',
            plugins:{ legend:{ position:'bottom' }, tooltip:{ enabled:true } }
          }
        });
        gestor2Charts.push(c1);

        // Mini gráfico de altas por janela (barras)
        const dAlt = datasetAltas24Hospital(h);
        const c2 = new Chart(document.getElementById(`alt_${h}`), {
          type:'bar',
          data:{ labels:dAlt.labels, datasets:[{ label:'Altas', data:dAlt.buckets, borderWidth:1 }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
            datasets:{ bar:{ maxBarThickness:20 } },
            plugins:{ legend:{ display:false } }
          }
        });
        gestor2Charts.push(c2);
      });
    }

    // ---------- AÇÕES DE LEITO ----------
    function openLeito(id){
      const l = banco[currentHospital].find(x=>x.id===id);
      selectedLeito = id;
      if(!l) return;
      if(l.status==="Vago"){
        a_leito.textContent = `Leito ${id}`;
        a_hospital.textContent = hospitalNomes[currentHospital];
        a_concessoes.innerHTML = concessoesCatalogo.map(c=>`<label><input type="checkbox"/> ${c}</label>`).join("");
        openModal(modalAdmissao);
        return;
      }
      c_nome.textContent = l.paciente.nome;
      c_matricula.textContent = l.paciente.matricula;
      c_mes.textContent = String(l.paciente.mes).padStart(2,"0");
      c_ano.textContent = String(l.paciente.ano);
      c_leito.textContent = `Leito ${id}`;
      c_hospital.textContent = hospitalNomes[currentHospital];
      c_dia.value = "";
      c_erro.classList.add("hidden");
      openModal(modalConfirm);
    }
    document.getElementById("btnConfirmar").addEventListener("click", ()=>{
      const id = selectedLeito;
      const l = banco[currentHospital].find(x=>x.id===id);
      const dia = String(c_dia.value).padStart(2,"0");
      if(dia === String(l.paciente.dia).padStart(2,"0")){
        closeModal(modalConfirm);
        u_leito.textContent = `Leito ${id}`;
        u_hospital.textContent = hospitalNomes[currentHospital];
        u_nome.value = l.paciente.nome;
        u_matricula.value = l.paciente.matricula;
        u_prev.value = l.previsaoBucket || "48h";
        u_linha.value = l.linhaCuidado || "APS";
        u_pps.value = l.pps || "";
        u_concessoes.innerHTML = concessoesCatalogo.map(c=>{
          const checked = (l.concessoes||[]).includes(c) ? "checked" : "";
          return `<label><input type="checkbox" ${checked}/> ${c}</label>`;
        }).join("");
        openModal(modalAtualizacao);
      }else{
        c_erro.classList.remove("hidden");
      }
    });

    // ---------- MODAIS ----------
    function openModal(el){ el.style.display = "flex"; el.setAttribute("aria-hidden","false"); }
    function closeModal(el){ el.style.display = "none"; el.setAttribute("aria-hidden","true"); }
    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const sel = btn.getAttribute("data-close");
        const el = document.querySelector(sel);
        if(el) closeModal(el);
      });
    });

    // ---------- NAVEGAÇÃO ----------
    function setTab(tab){
      tabs.forEach(b=>b.classList.remove("active"));
      document.querySelector(`.tab[data-tab='${tab}']`).classList.add("active");
      activeTab = tab;
      route();
    }
    function route(){
      // esconder tudo
      hospitaisView.classList.add("hidden");
      leitosView.classList.add("hidden");
      dashboardView.classList.add("hidden");
      gestorView.classList.add("hidden");
      gestor2View.classList.add("hidden");
      stats.classList.add("hidden");

      if(activeTab==="hospitais"){ hospitaisView.classList.remove("hidden"); renderHospitais(); }
      if(activeTab==="leitos"){ leitosView.classList.remove("hidden"); renderLeitos(); }
      if(activeTab==="dashboard"){ dashboardView.classList.remove("hidden"); stats.classList.remove("hidden"); renderDashboard(); }
      if(activeTab==="gestor"){ gestorView.classList.remove("hidden"); renderGestor(); }
      if(activeTab==="gestor2"){ gestor2View.classList.remove("hidden"); renderGestor2(); }
    }

    // ---------- POLLING ----------
    let interval = null;
    function startPolling(){
      if(interval) clearInterval(interval);
      interval = setInterval(()=>{
        if(activeTab==="dashboard"){ renderDashboard(); }
        if(activeTab==="hospitais"){ renderHospitais(); }
        if(activeTab==="leitos"){ renderLeitos(); }
        if(activeTab==="gestor"){ renderGestor(); }
        if(activeTab==="gestor2"){ renderGestor2(); }
      }, 8000);
    }

    // ---------- PARAMS ----------
    function checkParams(){
      const params = new URLSearchParams(location.search);
      const h = params.get("h");
      const leito = Number(params.get("leito"));
      if(h && hospitais.includes(h)){ currentHospital = h; selHospital.value = h; }
      if(leito>=1 && leito<=10){ setTab("leitos"); setTimeout(()=>openLeito(leito), 300); }
    }

    // ---------- BOOTSTRAP ----------
    renderHospitais();
    setTab("hospitais");
    startPolling();
    checkParams();

    // ---------- Botões & QR ----------
    document.getElementById("btnLogin").addEventListener("click",()=>{ alert("Simulação de login (no MVP funcional, usar Google Identity Services)."); });
    document.getElementById("btnRefresh").addEventListener("click",()=>{ route(); });

    // Simular Mobile
    document.getElementById("btnSimularMobile").addEventListener("click", ()=>{
      mobileSimOn = !mobileSimOn;
      const btn = document.getElementById("btnSimularMobile");
      if(mobileSimOn){ appRoot.classList.add("mobile-sim"); btn.textContent = "Sair do modo Mobile"; }
      else{ appRoot.classList.remove("mobile-sim"); btn.textContent = "Simular Mobile"; }
    });

    const modalQRScan = document.getElementById('modalQRScan');
    const modalQRCodes = document.getElementById('modalQRCodes');
    const qrRegionEl = document.getElementById('qrRegion');
    const qr1El = document.getElementById('qr1');
    const qr3El = document.getElementById('qr3');

    let qrReader = null;
    function handleScan(text){
      try{
        const s = String(text).trim();
        let h=null, leito=null;
        try {
          const u = new URL(s);
          h = u.searchParams.get('h');
          leito = Number(u.searchParams.get('leito'));
        } catch(e){
          if(/^[0-9]{1,2}$/.test(s)){ h = currentHospital; leito = Number(s); }
        }
        if(h && hospitais.includes(h) && leito>=1 && leito<=10){
          currentHospital = h; selHospital.value = h;
          setTab('leitos');
          setTimeout(()=>openLeito(leito), 150);
          stopScan(); closeModal(modalQRScan);
        }
      }catch(e){ console.warn('QR parse error', e); }
    }
    async function startScan(){
      if(!window.Html5Qrcode){ alert('Leitor de QR não disponível. Use seleção manual.'); return; }
      try{
        if(qrReader){ await stopScan(); }
        qrReader = new Html5Qrcode('qrRegion');
        await qrReader.start(
          { facingMode: { exact: 'environment' } },
          { fps: 10, qrbox: 250 },
          handleScan, ()=>{}
        );
      }catch(err){
        try{
          await qrReader.start({ facingMode:'environment' },{ fps:10, qrbox:250 },handleScan,()=>{});
        }catch(e){
          alert('Não foi possível acessar a câmera neste dispositivo. Use a seleção manual.');
          stopScan(); closeModal(modalQRScan);
        }
      }
    }
    function stopScan(){
      if(qrReader){
        return qrReader.stop().then(()=>{ qrReader.clear(); qrReader=null; }).catch(()=>{});
      }
      return Promise.resolve();
    }
    document.getElementById('btnQr').addEventListener('click', ()=>{ openModal(modalQRScan); startScan(); });
    document.getElementById('btnCloseQR').addEventListener('click', ()=>{ stopScan(); });
    document.getElementById('btnShowQRCodes').addEventListener('click', ()=>{
      const base = `${location.origin}${location.pathname}`;
      const url1 = `${base}?h=H1&leito=1`;
      const url3 = `${base}?h=H1&leito=3`;
      qr1El.innerHTML = ''; qr3El.innerHTML='';
      new QRCode(qr1El, {text:url1, width:180, height:180});
      new QRCode(qr3El, {text:url3, width:180, height:180});
      openModal(modalQRCodes);
    });
    document.getElementById("btnRefresh").addEventListener("click",()=>{ route(); });
  </script>
</body>
</html>
