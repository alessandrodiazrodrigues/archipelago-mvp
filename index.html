<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Archipelago — Dashboard Ultimate (Prevent Senior)</title>
  <!-- Versão Ultimate (Layout Prevent Senior) – agosto/2025 -->

  <!-- ======= ESTILOS ======= -->
  <style>
    :root{
      --nav:#0a2b52;          /* azul escuro Prevent */
      --nav-2:#083052;
      --bg:#eaf1f9;           /* base do fundo */
      --bg-deep:#d9e7fb;      /* variação do fundo */
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;           /* VAGO */
      --warn:#f59e0b;         /* EM USO */
      --danger:#dc2626;       /* UTI / ações críticas */
      --blue-veil:#4f86ff33;  /* véu azul translúcido */
      --shadow-1:0 10px 22px rgba(11,44,82,.10);
      --shadow-2:0 18px 48px rgba(11,44,82,.14);
      --accent:#0ea5e9;       /* azul claro para detalhes */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #cfe2ff 0%, transparent 55%),
        radial-gradient(1000px 500px at 85% 0%, #c9dffe 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 100%);
    }

    /* Header */
    header{
      background:linear-gradient(90deg,var(--nav),var(--nav-2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      box-shadow:0 6px 18px rgba(8,48,82,.20);
      position:relative; z-index:5;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff33;backdrop-filter:blur(2px)}
    .logo::after{content:"PS";font-weight:700}
    .title h1{margin:0;font-size:18px;letter-spacing:.5px}
    .title small{display:block;color:#dbe7f5}

    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--nav);border-color:#fff}

    /* Layout principal */
    main{max-width:1380px;margin:18px auto 120px;padding:0 16px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--nav);border-color:var(--nav);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.ghost{background:#ffffffcc;border-color:#ffffff66}
    .select{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px}

    /* Grid de cards (Leitos – Cards) */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;position:relative;z-index:1}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow-1),var(--shadow-2),0 0 0 1px rgba(255,255,255,.6) inset;transform:translateY(0);transition:transform .18s ease, box-shadow .18s ease, filter .18s ease}
    .card::before{content:"";position:absolute;inset:-8px -8px -16px -8px;border-radius:24px;background:radial-gradient(500px 220px at 30% -20%, var(--blue-veil), transparent 70%);z-index:-1;filter:blur(8px)}
    .card:hover{transform:translateY(-2px);box-shadow:0 16px 38px rgba(11,44,82,.16),0 26px 64px rgba(11,44,82,.18),0 0 0 1px rgba(255,255,255,.7) inset;filter:saturate(1.02)}

    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted);font-size:12px}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;color:#111;border:1px solid var(--border);background:#fff}
    .status.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .status.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}
    .tipo{font-size:12px;color:#fff;background:#6b7280;border-radius:999px;padding:4px 8px}
    .tipo.uti{background:var(--danger)}
    .tipo.enf{background:#0ea5e9}

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px}
    .field .label{font-size:11px;color:#6b7280}
    .field .value{font-weight:600}
    .wrap{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;color:#1e40af;padding:2px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Tabela */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
    th{font-size:12px;color:#6b7280;text-align:left}
    td{font-size:13px}
    .hidden{display:none}

    /* Modais */
    .backdrop{position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;overflow:auto}
    .modal{background:#fff;max-width:920px;width:100%;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);max-height:90vh;overflow:auto}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .content{padding:16px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .input,.select2,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    .label{font-size:12px;color:#6b7280;margin-bottom:4px;display:block}
    .danger{color:var(--danger)}

    /* QR em massa: rolável + imprimível */
    .qr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-height:70vh;overflow:auto;padding-right:6px}
    .qr-cell{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center}
    .qr-box{display:inline-block;border:1px solid var(--border);padding:8px;border-radius:10px;background:#fff}

    /* Modo QR-only (médico) */
    .qr-only header, .qr-only .toolbar, .qr-only nav.tabs, .qr-only .footer, .qr-only #leitosView, .qr-only #leitos2View, .qr-only #dashUltimate {display:none!important}
    .qrTimerBadge{position:fixed; top:10px; right:10px; z-index:2000;background:#111827; color:#fff; border:1px solid #00000033; padding:8px 10px; border-radius:999px;box-shadow:0 8px 18px rgba(0,0,0,.25)}

    /* ======= DASHBOARD ULTIMATE ======= */
    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-bottom:14px}
    @media (max-width:1280px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:780px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow-1)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:24px;font-weight:700}
    .kpi .delta{font-size:12px;color:#059669}

    .panel{background:#fff;border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow-1)}
    .grid-ultimate{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width:1280px){.grid-ultimate{grid-template-columns:1fr}}

    .charts-2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .charts-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:1280px){.charts-3{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:920px){.charts-3{grid-template-columns:1fr}}

    .chart-card{background:#fff;border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow-1);height:300px;display:flex;flex-direction:column}
    .chart-card canvas{flex:1;min-height:0}

    .filter-group{display:flex;gap:8px;align-items:center}

    @media print{
      header,.toolbar,.footer,.modal .actions{display:none !important}
      body{background:#fff}
      .modal{box-shadow:none;border:none}
      .qr-grid{grid-template-columns:repeat(3,1fr)}
    }
  </style>
</head>
<body>
  <!-- ======= HEADER ======= -->
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Archipelago — Dashboard Ultimate</h1>
        <small>Prevent Senior • visão consolidada do gestor</small>
      </div>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="leitos">Leitos (Cards)</button>
      <button class="tab" data-tab="leitos2">Leitos (Tabela)</button>
      <button class="tab" data-tab="dashUltimate">Dashboard Ultimate</button>
    </nav>
  </header>

  <!-- ======= MAIN ======= -->
  <main>
    <!-- Toolbar (gestor) -->
    <div class="toolbar" id="portalToolbar">
      <div class="row">
        <button class="btn primary" id="btnBulkQR">QR Codes (imprimir)</button>
        <button class="btn" id="btnScan">Ler QR Code</button>
      </div>
      <div class="row">
        <button class="btn" data-h="H1" id="btnH1">Neomater</button>
        <button class="btn" data-h="H2" id="btnH2">Cruz Azul</button>
      </div>
    </div>

    <!-- Leitos – Cards -->
    <section id="leitosView" class="grid" aria-label="Leitos (Cards)"></section>

    <!-- Leitos – Tabela -->
    <section id="leitos2View" class="hidden">
      <div style="margin-bottom:8px">
        <select id="selHospital2" class="select">
          <option value="H1">Neomater</option>
          <option value="H2">Cruz Azul</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Leito</th><th>Tipo</th><th>Status</th><th>Nome</th><th>Matrícula</th><th>Idade</th>
            <th>Admissão</th><th>PPS</th><th>SPICT-BR</th><th>Prev. Alta</th>
            <th>Linhas de Cuidado</th><th>Concessões</th>
          </tr>
        </thead>
        <tbody id="tbLeitos"></tbody>
      </table>
    </section>

    <!-- ======= DASHBOARD ULTIMATE ======= -->
    <section id="dashUltimate" class="hidden" aria-label="Dashboard Ultimate">
      <div class="toolbar" style="margin-top:-6px;margin-bottom:12px">
        <div class="filter-group">
          <span class="badge">Filtro:</span>
          <button class="btn ghost" data-scope="ALL">Todos</button>
          <button class="btn ghost" data-scope="H1">Neomater</button>
          <button class="btn ghost" data-scope="H2">Cruz Azul</button>
        </div>
        <div class="row">
          <button class="btn" id="btnExportCsv">Exportar CSV</button>
        </div>
      </div>

      <!-- KPIs topo -->
      <div class="kpis" id="kpiRow">
        <!-- preenchido via JS -->
      </div>

      <div class="grid-ultimate">
        <!-- Coluna esquerda: gauge grande + linhas/concessões -->
        <div class="panel">
          <div class="charts-2">
            <div class="chart-card"><canvas id="gaugeOverall"></canvas></div>
            <div class="chart-card"><canvas id="gaugeHospitais"></canvas></div>
          </div>
          <div class="charts-2" style="margin-top:14px">
            <div class="chart-card"><canvas id="chartLinhas"></canvas></div>
            <div class="chart-card"><canvas id="chartConcessoes"></canvas></div>
          </div>
        </div>
        <!-- Coluna direita: altas previstas + pps/spict -->
        <div class="panel">
          <div class="chart-card"><canvas id="chartAltas"></canvas></div>
          <div class="charts-2" style="margin-top:14px">
            <div class="chart-card"><canvas id="chartPPS"></canvas></div>
            <div class="chart-card"><canvas id="chartSPICT"></canvas></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ======= RODAPÉ ======= -->
  <div class="footer" style="padding:16px;display:flex;justify-content:space-between;align-items:center">
    <div>© Protótipo ilustrativo – Prevent Senior (sem dados reais)</div>
    <div><strong>MVP Archipelago</strong></div>
  </div>

  <!-- ======= MODAIS ======= -->
  <!-- Admissão -->
  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Admissão de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matrícula (número)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0–10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_prev">Previsão de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsão</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:8px;color:#6b7280">* Data e hora de admissão serão registradas automaticamente ao salvar.</div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <!-- Atualização -->
  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Atualização de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>
        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matrícula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admissão (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0–10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_prev">Previsão de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsão</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" id="internadoHa" style="margin-top:8px;color:#6b7280"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <!-- Confirm genérico -->
  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Confirmação</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">Não</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>
  <!-- Obrigado -->
  <div id="modalThanks" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Concluído</strong></header>
      <div class="content"><div id="thanksMsg">Obrigado! Você pode fechar o navegador.</div></div>
      <div class="actions"><button class="btn primary" id="thanksOk">Fechar</button></div>
    </div>
  </div>
  <!-- Sessão expirada -->
  <div id="modalQrExpired" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Sessão expirada</strong></header>
      <div class="content"><div>Por favor, reescaneie o QR diretamente no leito para continuar.</div></div>
      <div class="actions"><button class="btn primary" id="qrOk">Entendi</button></div>
    </div>
  </div>
  <!-- Ler QR -->
  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div class="mini" style="margin-bottom:8px">Se a câmera não abrir, use a câmera nativa do celular para escanear o QR impresso.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>
  <!-- QR em massa -->
  <div id="modalBulkQR" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Gerar QR Codes para impressão</strong><button class="btn" data-close="#modalBulkQR">Fechar</button></header>
      <div class="content">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2"><option value="H1">Neomater</option><option value="H2">Cruz Azul</option></select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin-top:10px"><button class="btn primary" id="b_generate">Gerar</button> <button class="btn" onclick="window.print()">Imprimir</button></div>
        <div id="qr_grid" class="qr-grid" style="margin-top:12px"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalBulkQR">Fechar</button></div>
    </div>
  </div>

  <!-- ======= LIBS ======= -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ======= SCRIPT ======= -->
  <script>
  // ================== CONFIG ==================
  const API_URL = 'https://script.google.com/macros/s/AKfycbzi8YS8acCErJvedwtx6lVr2Wd_VDOfUMsOO1xXM9MNZdedzulMmZZCMHkvI6z99AWJ/exec';

  const HOSPITAIS = { H1:{nome:'Neomater',total:13}, H2:{nome:'Cruz Azul',total:16} };
  const LINHAS = ['Assistência','Geriatria','APS','Cardiologia','Pneumologia','Neurologia','Melhor Cuidado'];
  const CONC   = ['PAD','Fisioterapia','Fonoaudiologia','Aspirações','Curativos'];
  const ALTAS_BUCKETS = ['24h Ouro','24h 2R','24h 3R','48h','72h','96h','Sem previsão'];

  // ================== ESTADO UI ==================
  let currentHospital='H1', activeTab='leitos', selectedLeito=null; const banco={H1:[],H2:[]};
  let isQrMode=false, qrTick=null, qrExpiresAt=0;
  let scope='ALL'; // ALL, H1, H2 para o Ultimate

  // Chart instances para destruir antes de recriar
  const charts = {};

  // ================== HELPERS ==================
  const $ = s=>document.querySelector(s);
  function openModal(s){const el=$(s); el.style.display='flex'; el.setAttribute('aria-hidden','false');}
  function closeModal(s){const el=$(s); el.style.display='none'; el.setAttribute('aria-hidden','true');}
  function confirmAction(msg){return new Promise(r=>{ $('#confirmMsg').textContent=msg||'Confirma?'; openModal('#modalConfirm'); $('#confirmYes').onclick=()=>{closeModal('#modalConfirm');r(true)}; $('#confirmNo').onclick=()=>{closeModal('#modalConfirm');r(false)}; });}
  function showThanks(text){ $('#thanksMsg').textContent=text||'Obrigado! Você pode fechar o navegador.'; openModal('#modalThanks'); }
  $('#thanksOk').onclick=()=>{ closeModal('#modalThanks'); try{window.close()}catch(_){} };

  function initials(n){if(!n) return '—'; return n.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase()}
  function fmtDateTime(iso){ if(!iso) return '—'; const d=new Date(iso); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; }
  function elapsedSince(iso){ if(!iso) return '—'; const ms=Date.now()-new Date(iso).getTime(); const d=Math.floor(ms/86400000); const h=Math.floor((ms%86400000)/3600000); const m=Math.floor((ms%3600000)/60000); return `${d} dias, ${h} horas, ${m} minutos`; }

  function sum(arr){return arr.reduce((a,b)=>a+b,0)}

  // ================== LOAD ==================
  async function loadHospital(h){ const res=await fetch(`${API_URL}?action=state&hospital=${h}`); const j=await res.json(); if(!j.ok) throw new Error(j.error||'Falha ao carregar'); banco[h]=j.data.sort((a,b)=>a.leito-b.leito); if(!isQrMode){ if(activeTab==='leitos') renderCards(); if(activeTab==='leitos2') renderTable(); if(activeTab==='dashUltimate') renderUltimate(); } }

  // ================== RENDER – CARDS ==================
  function renderCards(){ const c=$('#leitosView'); c.innerHTML=''; (banco[currentHospital]||[]).forEach(l=>{ const card=document.createElement('div'); card.className='card'; const statusClass=l.status==='Em uso'?'warn':'ok'; const tipoClass=l.tipo==='UTI'?'uti':'enf'; const internado=l.status==='Em uso'?` • Internado há ${elapsedSince(l.admAt)}`:''; const chipsLinhas=(l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join(''); const chipsConc=(l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join(''); card.innerHTML=`
        <div class="top"><div class="wrap">
          <span class="status ${statusClass}">Leito ${l.leito} – ${l.status}</span>
          <span class="tipo ${tipoClass}">${l.tipo||''}</span>
          <span class="badge">${HOSPITAIS[l.hospital].nome}${internado? `<span class="badge" style="margin-left:6px">${internado}</span>`:''}</span>
        </div></div>
        <div class="row">
          <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==='Em uso'?initials(l.nome):'—'}</div></div>
          <div class="field"><div class="label">Matrícula</div><div class="value">${l.matricula||'—'}</div></div>
          <div class="field"><div class="label">Idade</div><div class="value">${l.idade??'—'}</div></div>
          <div class="field"><div class="label">Admissão</div><div class="value">${fmtDateTime(l.admAt)}</div></div>
          <div class="field"><div class="label">PPS</div><div class="value">${l.pps??'—'}</div></div>
          <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==='elegivel'?'Elegível':(l.spict==='nao_elegivel'?'Não elegível':'—')}</div></div>
          <div class="field"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||'—'}</div></div>
          <div class="field"><div class="label">—</div><div class="value"> </div></div>
          <div class="field" style="grid-column:1/3"><div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||'—'}</div></div>
          <div class="field" style="grid-column:3/5"><div class="label">Concessões</div><div class="wrap">${chipsConc||'—'}</div></div>
        </div>
        <div class="actions">
          ${l.status==='Vago'
            ? `<button class="btn primary" data-act="admitir">Admitir</button>`
            : `<button class="btn primary" data-act="atualizar">Atualizar</button>
               <button class="btn danger"  data-act="alta">Dar Alta</button>`}
        </div>`; const bA=card.querySelector('[data-act="admitir"]'); const bU=card.querySelector('[data-act="atualizar"]'); const bD=card.querySelector('[data-act="alta"]'); if(bA) bA.onclick=()=>openAdmissao(l.leito); if(bU) bU.onclick=()=>openAtualizacao(l.leito); if(bD) bD.onclick=()=>darAltaFlow(l.leito); c.appendChild(card); }); }

  // ================== RENDER – TABELA ==================
  function renderTable(){ const tb=$('#tbLeitos'); tb.innerHTML=''; (banco[currentHospital]||[]).forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.leito}</td><td>${l.tipo||''}</td><td>${l.status}</td><td>${l.nome||'—'}</td><td>${l.matricula||'—'}</td><td>${l.idade??'—'}</td><td>${fmtDateTime(l.admAt)}</td><td>${l.pps??'—'}</td><td>${l.spict==='elegivel'?'Elegível':(l.spict==='nao_elegivel'?'Não elegível':'—')}</td><td>${l.prevAlta||'—'}</td><td>${(l.linhas||[]).join(', ')||'—'}</td><td>${(l.concessoes||[]).join(', ')||'—'}</td>`; tr.style.cursor='pointer'; tr.onclick=()=>{ selectedLeito=l.leito; if(l.status==='Vago') openAdmissao(l.leito); else openAtualizacao(l.leito); }; tb.appendChild(tr); }); }

  // ================== RENDER – ULTIMATE ==================
  function getScopeData(){
    if(scope==='H1') return [...banco.H1];
    if(scope==='H2') return [...banco.H2];
    return [...banco.H1, ...banco.H2];
  }

  function calcKPIs(){
    const data=getScopeData();
    const total = data.length;
    const ocupados = data.filter(x=>x.status==='Em uso').length;
    const vagos = total-ocupados;
    const tx = total? Math.round(100*ocupados/total):0;
    const altas24 = data.filter(x=>['24h Ouro','24h 2R','24h 3R'].includes(x.prevAlta)).length;
    const idadeMedia = (()=>{ const arr=data.filter(x=>x.idade!=null).map(x=>x.idade); return arr.length? Math.round(sum(arr)/arr.length):0; })();
    const ppsMedio = (()=>{ const arr=data.filter(x=>x.pps!=null).map(x=>x.pps); return arr.length? (sum(arr)/arr.length).toFixed(1):'0.0'; })();
    const rotatividade = altas24; // proxy simples no MVP
    return { total, ocupados, vagos, tx, altas24, idadeMedia, ppsMedio, rotatividade };
  }

  function countBy(arr, key){ const map=new Map(); arr.forEach(o=>{ const v=key(o); if(!v) return; if(Array.isArray(v)) v.forEach(i=> map.set(i,(map.get(i)||0)+1) ); else map.set(v,(map.get(v)||0)+1); }); return map; }

  function renderKpis(){
    const k=calcKPIs();
    const tpl=(label,val,delta)=>`<div class="kpi"><div class="label">${label}</div><div class="value">${val}</div>${delta?`<div class="delta">${delta}</div>`:''}</div>`;
    $('#kpiRow').innerHTML = [
      tpl('Leitos (total)', k.total),
      tpl('Ocupados', k.ocupados),
      tpl('Disponíveis', k.vagos),
      tpl('Taxa de ocupação', k.tx + '%'),
      tpl('Altas previstas 24h', k.altas24),
      tpl('PPS médio / Idade média', `${k.ppsMedio} / ${k.idadeMedia}`)
    ].join('');
  }

  function destroyChart(id){ if(charts[id]){ charts[id].destroy(); charts[id]=null; } }

  function renderUltimate(){
    renderKpis();
    const data=getScopeData();

    // Gauges
    const total = data.length; const ocupados = data.filter(x=>x.status==='Em uso').length; const vagos = total-ocupados;
    const h1 = banco.H1; const h2=banco.H2;
    const o1 = h1.filter(x=>x.status==='Em uso').length; const t1=h1.length; const o2=h2.filter(x=>x.status==='Em uso').length; const t2=h2.length;

    const gaugeOpts=(max=100)=>({ type:'doughnut', data:{ labels:['Ocupado','Disponível'], datasets:[{ data:[ocupados, vagos], backgroundColor:['#0b74ff','#e5e7eb'] }] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', rotation:Math.PI, circumference:Math.PI, plugins:{ legend:{display:false}, tooltip:{enabled:true} } }});

    destroyChart('gaugeOverall');
    charts.gaugeOverall = new Chart($('#gaugeOverall'), { type:'doughnut', data:{ labels:['Ocupado','Disponível'], datasets:[{ data:[ocupados, vagos], backgroundColor:['#0b74ff','#e5e7eb'] }] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', rotation:Math.PI, circumference:Math.PI, plugins:{ legend:{display:false}, tooltip:{enabled:true} } } });

    destroyChart('gaugeHospitais');
    charts.gaugeHospitais = new Chart($('#gaugeHospitais'), { type:'bar', data:{ labels:['Neomater','Cruz Azul'], datasets:[{ label:'Ocupados', data:[o1,o2] }, { label:'Disponíveis', data:[t1-o1,t2-o2] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} }, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{ precision:0 } } } });

    // Altas
    const altasMap = ALTAS_BUCKETS.reduce((acc,k)=> (acc[k]=0,acc),{});
    data.forEach(x=>{ if(altasMap[x.prevAlta]!=null) altasMap[x.prevAlta]++; });
    destroyChart('chartAltas');
    charts.chartAltas = new Chart($('#chartAltas'), { type:'bar', data:{ labels:Object.keys(altasMap), datasets:[{ label:'Prev. de alta (qtde)', data:Object.values(altasMap) }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } });

    // Linhas e Concessões
    const linhasMap = countBy(data, x=>x.linhas||[]);
    const concMap   = countBy(data, x=>x.concessoes||[]);
    const toSeries = (m)=>({ labels:[...m.keys()], data:[...m.values()] });
    const L = toSeries(linhasMap), C = toSeries(concMap);

    destroyChart('chartLinhas');
    charts.chartLinhas = new Chart($('#chartLinhas'), { type:'doughnut', data:{ labels:L.labels, datasets:[{ data:L.data }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });

    destroyChart('chartConcessoes');
    charts.chartConcessoes = new Chart($('#chartConcessoes'), { type:'doughnut', data:{ labels:C.labels, datasets:[{ data:C.data }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });

    // PPS e SPICT
    const ppsMap = new Map([[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0]]);
    data.forEach(x=>{ if(x.pps!=null){ const v=Math.max(0,Math.min(10,Number(x.pps))); ppsMap.set(v, (ppsMap.get(v)||0)+1 ); } });
    destroyChart('chartPPS');
    charts.chartPPS = new Chart($('#chartPPS'), { type:'bar', data:{ labels:[...ppsMap.keys()], datasets:[{ label:'PPS', data:[...ppsMap.values()] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } });

    const spMap = { elegivel:0, nao_elegivel:0, vazio:0 };
    data.forEach(x=>{ if(x.spict==='elegivel') spMap.elegivel++; else if(x.spict==='nao_elegivel') spMap.nao_elegivel++; else spMap.vazio++; });
    destroyChart('chartSPICT');
    charts.chartSPICT = new Chart($('#chartSPICT'), { type:'pie', data:{ labels:['Elegível','Não elegível','—'], datasets:[{ data:[spMap.elegivel, spMap.nao_elegivel, spMap.vazio] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
  }

  // ================== FLUXOS – ADMITIR/ATUALIZAR/ALTA ==================
  function openAdmissao(id){ const l=(banco[currentHospital]||[]).find(x=>x.leito===id); selectedLeito=id; $('#a_hospital').textContent=HOSPITAIS[currentHospital].nome; $('#a_leito').textContent='Leito '+id; $('#a_tipo').textContent=l?.tipo||''; $('#a_linhas').innerHTML=LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}"/> ${v}</label>`).join(''); $('#a_concessoes').innerHTML=CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}"/> ${v}</label>`).join(''); $('#a_nome').value=''; $('#a_idade').value=''; $('#a_matricula').value=''; $('#a_pps').value=''; $('#a_spict').value='elegivel'; $('#a_prev').value='24h Ouro'; openModal('#modalAdmissao'); }

  $('#a_cancel').onclick=async()=>{ const ok=await confirmAction('Cancelar admissão?'); if(!ok) return; if(isQrMode){ closeModal('#modalAdmissao'); showThanks('Ação cancelada. Obrigado! Você pode fechar o navegador.'); return; } closeModal('#modalAdmissao'); };

  $('#a_save').onclick=async()=>{ const ok=await confirmAction('Salvar e admitir este paciente?'); if(!ok) return; const payload={ action:'admit', hospital:currentHospital, leito:selectedLeito, nome:$('#a_nome').value.trim(), idade:Number($('#a_idade').value)||null, matricula:$('#a_matricula').value.trim(), pps:Number($('#a_pps').value)||null, spict:$('#a_spict').value, prevAlta:$('#a_prev').value, linhas:[...document.querySelectorAll('#a_linhas input:checked')].map(i=>i.value), concessoes:[...document.querySelectorAll('#a_concessoes input:checked')].map(i=>i.value) };
    try{ await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}); closeModal('#modalAdmissao'); await loadHospital(currentHospital); if(isQrMode){ showThanks('Admissão registrada. Obrigado! Você pode fechar o navegador.'); } }
    catch(e){ alert('Erro ao admitir: '+(e.message||e)); }
  };

  function openAtualizacao(id){ const l=(banco[currentHospital]||[]).find(x=>x.leito===id); selectedLeito=id; $('#u_hospital').textContent=HOSPITAIS[currentHospital].nome; $('#u_leito').textContent='Leito '+id; $('#u_tipo').textContent=l?.tipo||''; $('#u_nome').value=l?.nome||''; $('#u_matricula').value=l?.matricula||''; $('#u_adm').value=fmtDateTime(l?.admAt)||''; $('#u_idade').value=l?.idade??''; $('#u_pps').value=l?.pps??''; $('#u_spict').value=l?.spict||'elegivel'; $('#u_prev').value=l?.prevAlta||'Sem previsão'; $('#u_linhas').innerHTML=LINHAS.map(v=>{const chk=(l?.linhas||[]).includes(v)?'checked':''; return `<label class="badge"><input type="checkbox" value="${v}" ${chk}/> ${v}</label>`;}).join(''); $('#u_concessoes').innerHTML=CONC.map(v=>{const chk=(l?.concessoes||[]).includes(v)?'checked':''; return `<label class="badge"><input type="checkbox" value="${v}" ${chk}/> ${v}</label>`;}).join(''); $('#internadoHa').textContent=l?.admAt?`Internado há ${elapsedSince(l.admAt)}`:''; openModal('#modalAtualizacao'); }

  $('#u_cancel').onclick=async()=>{ const ok=await confirmAction('Cancelar alterações?'); if(!ok) return; if(isQrMode){ closeModal('#modalAtualizacao'); showThanks('Ação cancelada. Obrigado! Você pode fechar o navegador.'); return; } closeModal('#modalAtualizacao'); };

  $('#u_save').onclick=async()=>{ const ok=await confirmAction('Salvar alterações?'); if(!ok) return; const payload={ action:'update', hospital:currentHospital, leito:selectedLeito, idade:Number($('#u_idade').value)||null, pps:Number($('#u_pps').value)||null, spict:$('#u_spict').value, prevAlta:$('#u_prev').value, linhas:[...document.querySelectorAll('#u_linhas input:checked')].map(i=>i.value), concessoes:[...document.querySelectorAll('#u_concessoes input:checked')].map(i=>i.value) };
    try{ await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}); closeModal('#modalAtualizacao'); await loadHospital(currentHospital); if(isQrMode){ showThanks('Atualização salva. Obrigado! Você pode fechar o navegador.'); } }
    catch(e){ alert('Erro ao salvar: '+(e.message||e)); }
  };

  async function darAltaFlow(id){ const ok=await confirmAction('Confirmar ALTA deste paciente?'); if(!ok) return; const payload={action:'alta',hospital:currentHospital,leito:id}; try{ await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}); closeModal('#modalAtualizacao'); await loadHospital(currentHospital); if(isQrMode){ showThanks('Alta registrada. Obrigado! Você pode fechar o navegador.'); } } catch(e){ alert('Erro ao dar alta: '+(e.message||e)); } }
  $('#u_alta').onclick=()=>darAltaFlow(selectedLeito);

  // ================== NAVEGAÇÃO ==================
  function setTab(tab){ document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); const btn=document.querySelector(`.tab[data-tab='${tab}']`); if(btn) btn.classList.add('active'); activeTab=tab; route(); }
  function setHospitalSelectors(h){ currentHospital=h; const s2=document.getElementById('selHospital2'); if(s2) s2.value=h; }
  function route(){ ['leitos','leitos2','dashUltimate'].forEach(id=>{ const mapId=id==='leitos'?'leitosView':(id==='leitos2'?'leitos2View':id); const el=document.getElementById(mapId); if(!el) return; if(activeTab===id) el.classList.remove('hidden'); else el.classList.add('hidden'); }); if(activeTab==='leitos') renderCards(); if(activeTab==='leitos2') renderTable(); if(activeTab==='dashUltimate') renderUltimate(); }

  // ================== QR ==================
  let qrReader=null; function handleScan(text){ try{ const u=new URL(String(text)); const h=u.searchParams.get('h'); const leito=Number(u.searchParams.get('leito')); if(h&&['H1','H2'].includes(h)&&leito>0){ closeModal('#modalQRScan'); stopScan(); location.href=`${location.pathname}?h=${h}&leito=${leito}`; } }catch(e){} }
  async function startScan(){ if(!window.Html5Qrcode){ alert('Leitor não disponível neste dispositivo.'); return; } try{ if(qrReader){ await stopScan(); } qrReader=new Html5Qrcode('qrRegion'); await qrReader.start({facingMode:'environment'},{fps:10,qrbox:250},handleScan,()=>{}); }catch(e){ alert('Não foi possível acessar a câmera.'); stopScan(); closeModal('#modalQRScan'); } }
  function stopScan(){ if(!qrReader) return Promise.resolve(); return qrReader.stop().then(()=>{qrReader.clear();qrReader=null;}).catch(()=>{}); }

  function openBulkQR(){ $('#b_hospital').value=currentHospital; const limit=currentHospital==='H1'?13:16; $('#b_from').value=1; $('#b_to').value=limit; $('#qr_grid').innerHTML=''; openModal('#modalBulkQR'); }
  function buildQRGrid(){ const h=$('#b_hospital').value; const from=Math.max(1,parseInt($('#b_from').value||'1')); const to=Math.max(from,parseInt($('#b_to').value||'1')); const limit=h==='H1'?13:16; const f=Math.min(from,limit); const t=Math.min(to,limit); const base=`${location.origin}${location.pathname}`; const grid=$('#qr_grid'); grid.innerHTML=''; for(let i=f;i<=t;i++){ const url=`${base}?h=${h}&leito=${i}`; const cell=document.createElement('div'); cell.className='qr-cell'; cell.innerHTML=`<div class="qr-box"></div><div class="mini">Leito ${i} • ${HOSPITAIS[h].nome}</div>`; grid.appendChild(cell); new QRCode(cell.querySelector('.qr-box'),{text:url,width:160,height:160}); } }

  function startQrTimer(seconds){ qrExpiresAt=Date.now()+seconds*1000; const badge=document.createElement('div'); badge.className='qrTimerBadge'; badge.id='qrBadge'; document.body.appendChild(badge); qrTick=setInterval(()=>{ const left=Math.max(0,qrExpiresAt-Date.now()); const mm=String(Math.floor(left/60000)).padStart(2,'0'); const ss=String(Math.floor((left%60000)/1000)).padStart(2,'0'); badge.textContent=`⏱ ${mm}:${ss} para concluir`; if(left<=0){ clearInterval(qrTick); badge.textContent='Acesso expirado'; document.querySelectorAll('.backdrop').forEach(b=> b.style.display='none'); openModal('#modalQrExpired'); } },500); }

  function enterQrMode(h,leito){ isQrMode=true; document.body.classList.add('qr-only'); ['leitosView','leitos2View','dashUltimate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=''; }); (async()=>{ await loadHospital(h); const l=(banco[h]||[]).find(x=>x.leito===leito); if(!l){ openModal('#modalQrExpired'); return; } currentHospital=h; if(l.status==='Vago') openAdmissao(leito); else openAtualizacao(leito); startQrTimer(120); })(); }

  // ================== EXPORT ==================
  function exportCsv(){
    const rows = [['hospital','leito','tipo','status','nome','matricula','idade','admAt','pps','spict','prevAlta','linhas','concessoes']];
    const data = getScopeData();
    data.forEach(o=> rows.push([o.hospital,o.leito,o.tipo,o.status,o.nome||'',o.matricula||'',o.idade??'',o.admAt||'',o.pps??'',o.spict||'',o.prevAlta||'',(o.linhas||[]).join('|'),(o.concessoes||[]).join('|')]));
    const csv = rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='archipelago-export.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ================== EVENTOS ==================
  // Tabs
  document.querySelectorAll('.tab').forEach(b=> b.onclick=()=> setTab(b.dataset.tab));
  // Botões hospital (cards/tabela)
  $('#btnH1').onclick=()=>{ setHospitalSelectors('H1'); loadHospital('H1'); };
  $('#btnH2').onclick=()=>{ setHospitalSelectors('H2'); loadHospital('H2'); };
  // Tabela select
  $('#selHospital2') && ($('#selHospital2').onchange = e=>{ setHospitalSelectors(e.target.value); loadHospital(e.target.value); });
  // QR scan + fechar
  $('#btnScan').onclick=()=>{ openModal('#modalQRScan'); startScan(); };
  document.querySelectorAll('[data-close]').forEach(b=> b.onclick=()=>{ const which=b.getAttribute('data-close'); if(which==='#modalQRScan'){ stopScan(); } closeModal(which); });
  // Bulk QR
  $('#btnBulkQR').onclick=openBulkQR; $('#b_generate').onclick=buildQRGrid; $('#qrOk').onclick=()=>{ closeModal('#modalQrExpired'); };
  // Export
  $('#btnExportCsv').onclick=exportCsv;
  // Filtro Ultimate
  document.querySelectorAll('[data-scope]').forEach(b=> b.onclick=()=>{ scope=b.getAttribute('data-scope'); renderUltimate(); });

  // ================== BOOT ==================
  (function(){ const p=new URLSearchParams(location.search); const h=p.get('h'); const leito=Number(p.get('leito')); if(h&&['H1','H2'].includes(h)&&leito>0){ enterQrMode(h,leito); } else { setHospitalSelectors('H1'); setTab('dashUltimate'); loadHospital('H1'); loadHospital('H2'); } })();
  </script>
</body>
</html>
