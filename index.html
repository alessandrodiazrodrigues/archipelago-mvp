<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago ‚Äì Gest√£o de Leitos (MVP)</title>

  <!-- ======= ESTILO ======= -->
  <style>
    :root{
      --nav:#0a2b52;          /* azul escuro Prevent */
      --nav-2:#083052;
      --bg:#eaf1f9;           /* base do fundo */
      --bg-deep:#d9e7fb;      /* varia√ß√£o do fundo */
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;           /* VAGO */
      --warn:#f59e0b;         /* EM USO */
      --danger:#dc2626;       /* UTI / a√ß√µes cr√≠ticas */
      --blue-veil:#4f86ff33;  /* v√©u azul transl√∫cido */
      --shadow-1:0 10px 22px rgba(11,44,82,.10);
      --shadow-2:0 18px 48px rgba(11,44,82,.14);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      color:var(--text);
      /* Fundo com sensa√ß√£o de profundidade */
      background:
        radial-gradient(1200px 600px at 15% -10%, #cfe2ff 0%, transparent 55%),
        radial-gradient(1000px 500px at 85% 0%, #c9dffe 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 100%);
    }

    /* Header */
    header{
      background:linear-gradient(90deg,var(--nav),var(--nav-2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      box-shadow:0 6px 18px rgba(8,48,82,.20);
      position:relative; z-index:5;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff33;backdrop-filter:blur(2px)}
    .logo::after{content:"PS";font-weight:700}
    .title h1{margin:0;font-size:18px}
    .title small{display:block;color:#dbe7f5}
    #qrTimer{margin-left:10px;padding:4px 8px;border-radius:999px;background:#ffffff20;border:1px solid #ffffff40}

    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--nav);border-color:#fff}

    /* Layout */
    main{max-width:1200px;margin:18px auto 100px;padding:0 16px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--nav);border-color:var(--nav);color:#fff}
    .btn.ghost{background:transparent;color:#fff;border-color:#ffffff66}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.hospital{background:var(--nav);border-color:var(--nav);color:#fff}
    .btn.hospital.active{background:#1e40af;border-color:#1e40af;box-shadow:0 0 0 3px rgba(30,64,175,0.2)}
    .select{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px}
    
    /* Indicador de tempo dentro do bot√£o */
    #btnRefresh {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #lastUpdateInfo {
      font-size: 11px;
      opacity: 0.9;
    }

    /* GRID DE CARDS (flutuantes) */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;position:relative;z-index:1}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{
      position:relative;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      padding:16px;
      /* m√∫ltiplas sombras para profundidade */
      box-shadow:
        var(--shadow-1),
        var(--shadow-2),
        0 0 0 1px rgba(255,255,255,.6) inset;
      transform:translateY(0);
      transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
      /* glow/veil azul leve sob o card */
    }
    .card::before{
      content:"";
      position:absolute; inset:-8px -8px -16px -8px;
      border-radius:24px;
      background:radial-gradient(500px 220px at 30% -20%, var(--blue-veil), transparent 70%);
      z-index:-1;
      filter:blur(8px);
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:
        0 16px 38px rgba(11,44,82,.16),
        0 26px 64px rgba(11,44,82,.18),
        0 0 0 1px rgba(255,255,255,.7) inset;
      filter:saturate(1.02);
    }

    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted);font-size:12px}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;color:#111;border:1px solid var(--border);background:#fff}
    .status.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .status.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}
    .tipo{font-size:12px;color:#fff;background:#6b7280;border-radius:999px;padding:4px 8px}
    .tipo.uti{background:var(--danger)}
    .tipo.enf{background:#0ea5e9}

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px}
    .field .label{font-size:11px;color:#6b7280}
    .field .value{font-weight:600}
    .wrap{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;color:#1e40af;padding:2px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Tabela (Leitos ‚Äì Tabela) */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
    th{font-size:12px;color:#6b7280;text-align:left}
    td{font-size:13px}
    .hidden{display:none}

    /* Modais */
    .backdrop{position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;overflow:auto}
    .modal{background:#fff;max-width:860px;width:100%;max-height:90vh;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
    .modal .content{padding:16px;overflow-y:auto;flex:1}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .input,.select2,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    .label{font-size:12px;color:#6b7280;margin-bottom:4px;display:block}
    .danger{color:var(--danger)}

    /* QR em massa (impress√£o) */
    .qr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-height:none;overflow:visible}
    .qr-cell{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;min-height:200px}
    .qr-box{display:inline-block;border:1px solid var(--border);padding:8px;border-radius:10px;background:#fff}

    /* Modo QR (m√©dico): ocultar navega√ß√£o e fixar temporizador */
    .qr-only header, .qr-only .toolbar, .qr-only nav.tabs, .qr-only .footer{display:none!important}
    .qrTimerBadge{
      position:fixed; top:10px; right:10px; z-index:2000;
      background:#111827; color:#fff; border:1px solid #00000033; padding:8px 10px; border-radius:999px;
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }

    /* Success message styling */
    .success-message{
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:20px;
      padding:40px;
      text-align:center;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
      z-index:3000;
      display:none;
    }

    /* Dashboard Styles */
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }
    
    .dashboard-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .dashboard-card h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: var(--text);
    }
    
    .gauge-container {
      position: relative;
      width: 200px;
      height: 120px;
      margin: 0 auto;
    }
    
    .gauge-container canvas {
      width: 100%;
      height: 100%;
    }
    
    .gauge-value {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      font-weight: bold;
      color: var(--nav);
    }
    
    .gauge-label {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-box {
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--nav);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .chart-container {
      position: relative;
      height: 250px;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <!-- ======= BARRA SUPERIOR ======= -->
  <header id="appHeader">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Archipelago ‚Äì Gest√£o de Leitos</h1>
        <small>Prot√≥tipo (estado atual, sem hist√≥rico)</small>
      </div>
      <div id="qrTimer" class=""> </div>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="leitos">Leitos (Cards)</button>
      <button class="tab" data-tab="leitos2">Leitos (Tabela)</button>
      <button class="tab" data-tab="dash1">Dash 1</button>
      <button class="tab" data-tab="dash2">Dash 2</button>
      <button class="tab" data-tab="dash3">Dash 3</button>
      <button class="tab" data-tab="dash4">Dash 4</button>
    </nav>
  </header>

  <!-- ======= CONTE√öDO ======= -->
  <main>
    <!-- Toolbar superior (Gestor) -->
    <div class="toolbar" id="portalToolbar">
      <div class="row">
        <button class="btn primary" id="btnBulkQR">QR Codes (imprimir)</button>
        <button class="btn" id="btnScan">Ler QR Code</button>
        <button class="btn primary" id="btnRefresh">
          üîÑ Atualizar
          <span id="lastUpdateInfo">h√° 0s</span>
        </button>
      </div>
      <div class="row">
        <button class="btn hospital active" data-h="H1" id="btnH1">Neomater</button>
        <button class="btn hospital" data-h="H2" id="btnH2">Cruz Azul</button>
      </div>
    </div>

    <!-- Grade de Cards -->
    <section id="leitosView" class="grid" aria-label="Leitos (Cards)"></section>

    <!-- Tabela (Leitos ‚Äì Tabela) -->
    <section id="leitos2View" class="hidden">
      <div style="margin-bottom:8px">
        <select id="selHospital2" class="select">
          <option value="H1">Neomater</option>
          <option value="H2">Cruz Azul</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Leito</th><th>Tipo</th><th>Status</th><th>Nome</th><th>Matr√≠cula</th><th>Idade</th>
            <th>Admiss√£o</th><th>PPS</th><th>SPICT-BR</th><th>Prev. Alta</th>
            <th>Linhas de Cuidado</th><th>Concess√µes</th>
          </tr>
        </thead>
        <tbody id="tbLeitos"></tbody>
      </table>
    </section>

    <!-- Dash 1 - Vis√£o Geral dos 4 Hospitais -->
    <section id="dash1" class="hidden">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <!-- Neomater (H1) -->
        <div class="dashboard-card">
          <h3 style="text-align:center;color:var(--nav);margin-bottom:15px">Neomater</h3>
          
          <!-- 4 mini gr√°ficos em grade 2x2 -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <!-- Taxa de Ocupa√ß√£o -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeOcupacaoH1"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeOcupacaoH1Value">0%</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Taxa Ocupa√ß√£o</div>
            </div>
            
            <!-- Leitos Ocupados -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeOcupadosH1"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeOcupadosH1Value">0</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Ocupados</div>
            </div>
            
            <!-- Leitos Dispon√≠veis -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeDisponiveisH1"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeDisponiveisH1Value">0</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Dispon√≠veis</div>
            </div>
            
            <!-- Previs√£o de Altas -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div style="font-size:20px;font-weight:bold;color:var(--nav)" id="altasH1">0</div>
              <div style="font-size:10px;color:var(--muted)">Altas 24h</div>
            </div>
          </div>
          
          <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:11px">
              <div><strong>Total:</strong> 13 leitos</div>
              <div><strong>UTI:</strong> 3 leitos</div>
            </div>
          </div>
        </div>

        <!-- Cruz Azul (H2) -->
        <div class="dashboard-card">
          <h3 style="text-align:center;color:var(--nav);margin-bottom:15px">Cruz Azul</h3>
          
          <!-- 4 mini gr√°ficos em grade 2x2 -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <!-- Taxa de Ocupa√ß√£o -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeOcupacaoH2"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeOcupacaoH2Value">0%</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Taxa Ocupa√ß√£o</div>
            </div>
            
            <!-- Leitos Ocupados -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeOcupadosH2"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeOcupadosH2Value">0</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Ocupados</div>
            </div>
            
            <!-- Leitos Dispon√≠veis -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div class="gauge-container" style="width:100px;height:60px;margin:0 auto">
                <canvas id="gaugeDisponiveisH2"></canvas>
                <div class="gauge-value" style="font-size:16px;bottom:5px" id="gaugeDisponiveisH2Value">0</div>
              </div>
              <div style="font-size:10px;color:var(--muted);margin-top:5px">Dispon√≠veis</div>
            </div>
            
            <!-- Previs√£o de Altas -->
            <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px">
              <div style="font-size:20px;font-weight:bold;color:var(--nav)" id="altasH2">0</div>
              <div style="font-size:10px;color:var(--muted)">Altas 24h</div>
            </div>
          </div>
          
          <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:11px">
              <div><strong>Total:</strong> 16 leitos</div>
              <div><strong>Enfermaria:</strong> 16 leitos</div>
            </div>
          </div>
        </div>

        <!-- Hospital 3 (Placeholder) -->
        <div class="dashboard-card" style="opacity:0.5">
          <h3 style="text-align:center;color:var(--muted);margin-bottom:15px">Hospital 3</h3>
          <div style="text-align:center;padding:40px;color:var(--muted)">
            <p>Em breve</p>
            <small>Dados n√£o dispon√≠veis</small>
          </div>
        </div>

        <!-- Hospital 4 (Placeholder) -->
        <div class="dashboard-card" style="opacity:0.5">
          <h3 style="text-align:center;color:var(--muted);margin-bottom:15px">Hospital 4</h3>
          <div style="text-align:center;padding:40px;color:var(--muted)">
            <p>Em breve</p>
            <small>Dados n√£o dispon√≠veis</small>
          </div>
        </div>
      </div>

      <!-- Gr√°ficos Temporais -->
      <div style="margin-top:30px">
        <h3 style="margin-bottom:20px">Proje√ß√£o Temporal - Pr√≥ximos 7 dias</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="dashboard-card">
            <h4 style="margin:0 0 15px 0;font-size:14px">Concess√µes por Tempo</h4>
            <div class="chart-container" style="height:300px">
              <canvas id="chartConcessoesTempo"></canvas>
            </div>
          </div>
          <div class="dashboard-card">
            <h4 style="margin:0 0 15px 0;font-size:14px">Linhas de Cuidado por Tempo</h4>
            <div class="chart-container" style="height:300px">
              <canvas id="chartLinhasTempo"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="dash2" class="hidden">
      <h2 style="margin-bottom:20px">Dashboard - Previs√£o de Altas</h2>
      <div class="dashboard-container">
        <div class="dashboard-card" style="grid-column: span 2">
          <h3>Altas Previstas por Per√≠odo</h3>
          <div class="chart-container">
            <canvas id="chartAltas"></canvas>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3>Resumo de Altas</h3>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="altas24h">0</div>
              <div class="stat-label">Pr√≥ximas 24h</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="altas48h">0</div>
              <div class="stat-label">Pr√≥ximas 48h</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="altas72h">0</div>
              <div class="stat-label">Pr√≥ximas 72h</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="altasSem">0</div>
              <div class="stat-label">Sem previs√£o</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="dash3" class="hidden">
      <h2 style="margin-bottom:20px">Dashboard - Linhas de Cuidado</h2>
      <div class="dashboard-container">
        <div class="dashboard-card" style="grid-column: span 2">
          <h3>Distribui√ß√£o de Linhas de Cuidado</h3>
          <div class="chart-container">
            <canvas id="chartLinhas"></canvas>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3>Top Linhas de Cuidado</h3>
          <div id="topLinhas" style="padding:10px"></div>
        </div>
      </div>
    </section>
    
    <section id="dash4" class="hidden">
      <h2 style="margin-bottom:20px">Dashboard - Concess√µes</h2>
      <div class="dashboard-container">
        <div class="dashboard-card" style="grid-column: span 2">
          <h3>Distribui√ß√£o de Concess√µes</h3>
          <div class="chart-container">
            <canvas id="chartConcessoes"></canvas>
          </div>
        </div>
        
        <div class="dashboard-card">
          <h3>Top Concess√µes</h3>
          <div id="topConcessoes" style="padding:10px"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ======= RODAP√â ======= -->
  <div class="footer">
    <div>¬© Prot√≥tipo ilustrativo ‚Äì Prevent Senior (sem dados reais)</div>
    <div><strong>MVP Archipelago</strong></div>
  </div>

  <!-- Success Message -->
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Opera√ß√£o realizada com sucesso.</p>
    <p style="color:#6b7280;font-size:14px">Voc√™ pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>

  <!-- ======= MODAIS ======= -->

  <!-- Admiss√£o -->
  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Admiss√£o de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matr√≠cula (n√∫mero)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0‚Äì10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="a_prev">Previs√£o de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:8px;color:#6b7280">
          * Data e hora de admiss√£o ser√£o registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <!-- Atualiza√ß√£o -->
  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Atualiza√ß√£o de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>

        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matr√≠cula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admiss√£o (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0‚Äì10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Eleg√≠vel</option>
              <option value="nao_elegivel">N√£o eleg√≠vel</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_prev">Previs√£o de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concess√µes (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>

        <div class="mini" id="internadoHa" style="margin-top:8px;color:#6b7280"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <!-- Confirm gen√©rico -->
  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Confirma√ß√£o</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">N√£o</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <!-- Ler QR -->
  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div class="mini" style="margin-bottom:8px">Se a c√¢mera n√£o abrir, use a sele√ß√£o manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <!-- QR em massa (impress√£o) -->
  <div id="modalBulkQR" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impress√£o</strong>
        <button class="btn" data-close="#modalBulkQR" style="padding:5px 10px;font-size:16px;line-height:1">‚úï</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:#fff;padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button> 
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" class="qr-grid"></div>
      </div>
    </div>
  </div>

  <!-- QR Expired Modal -->
  <div id="modalQRExpired" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Sess√£o Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code pr√≥ximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>

  <!-- ======= LIBS ======= -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ======= SCRIPT ======= -->
  <script>
  // -------------------- CONFIGURA√á√ÉO DA API --------------------
  // URL ATUALIZADA DO GOOGLE APPS SCRIPT
  const API_URL = 'https://script.google.com/macros/s/AKfycbzn8BlUD8by0GykYlJa1pmbYtuXOr8aEUzOOBhpfSGl-i1x8LhAnGSRzqdyV2lANnIP/exec';

  // Sistema de logs para debug
  function logInfo(message, data = null) {
    console.log(`üîµ [Archipelago] ${message}`, data ? data : '');
  }

  function logSuccess(message, data = null) {
    console.log(`üü¢ [SUCCESS] ${message}`, data ? data : '');
  }

  function logError(message, error = null) {
    console.error(`üî¥ [ERROR] ${message}`, error ? error : '');
  }

  function logWarning(message, data = null) {
    console.warn(`üü° [WARNING] ${message}`, data ? data : '');
  }

  // -------------------- DADOS FIXOS --------------------
  // Hospitais / leitos (H1: 13 ‚Äì 10 Enf + 3 UTI | H2: 16 Enf)
  const HOSPITAIS = {
    H1: { nome:"Neomater", leitos:[
      ...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })),
      ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))
    ]},
    H2: { nome:"Cruz Azul", leitos:[
      ...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))
    ]}
  };

  // Estado atual dos leitos (carregados da API)
  const banco = { H1: [], H2: [] };

  const LINHAS = ["Assistencia","Geriatria","APS","Cardiologia","Pneumologia","Neurologia","Melhor Cuidado"];
  const CONC  = ["PAD","Fisioterapia","Fonoaudiologia","Aspiracoes","Curativos"];

  // -------------------- ESTADO DE UI --------------------
  let currentHospital = "H1";
  let activeTab = "leitos";
  let selectedLeito = null;
  let isQRMode = false;
  let lastUpdateTime = Date.now();
  let autoRefreshInterval = null;
  let updateIndicatorInterval = null;

  // Timer QR (somente em modo QR)
  let qrTick = null;
  let qrExpiresAt = 0;

  // -------------------- HELPERS --------------------
  const $ = sel => document.querySelector(sel);
  function openModal(sel){ const el=$(sel); el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
  function closeModal(sel){ const el=$(sel); el.style.display="none"; el.setAttribute("aria-hidden","true"); }
  function confirmAction(msg){
    return new Promise(res=>{
      $("#confirmMsg").textContent = msg || "Confirma?";
      openModal("#modalConfirm");
      $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
      $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
    });
  }
  function initials(nome){ if(!nome) return "‚Äî"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }
  function fmtDateTime(iso){
    if(!iso) return "‚Äî";
    const d=new Date(iso);
    const dd=String(d.getDate()).padStart(2,"0");
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const yy=d.getFullYear();
    const hh=String(d.getHours()).padStart(2,"0");
    const mi=String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }
  function elapsedSince(iso){
    if(!iso) return "‚Äî";
    const ms = Date.now() - new Date(iso).getTime();
    const d = Math.floor(ms/86400000);
    const h = Math.floor((ms%86400000)/3600000);
    const m = Math.floor((ms%3600000)/60000);
    return `${d} dias, ${h} horas, ${m} minutos`;
  }

  function showSuccessMessage() {
    document.getElementById('successMessage').style.display = 'block';
  }

  // -------------------- API FUNCTIONS --------------------
  async function testConnection() {
    logInfo("Testando conex√£o com a API...");
    
    try {
      const res = await fetch(API_URL + '?action=test', {
        method: 'GET'
      });
      
      logInfo(`Status da conex√£o: ${res.status} ${res.statusText}`);
      
      if (res.ok) {
        try {
          const json = await res.json();
          logSuccess("Conex√£o com a API estabelecida!", json);
          return true;
        } catch(e) {
          logWarning("Conex√£o estabelecida mas resposta n√£o √© JSON v√°lido");
          return true;
        }
      } else {
        logError(`Falha na conex√£o: HTTP ${res.status}`);
        return false;
      }
    } catch(error) {
      logError("Erro ao testar conex√£o:", error);
      return false;
    }
  }

  async function loadHospital(h) {
    logInfo(`Iniciando carregamento do hospital: ${h}`);
    logInfo(`URL da API: ${API_URL}`);
    
    try {
      const url = `${API_URL}?action=state&hospital=${h}`;
      logInfo(`Fazendo requisi√ß√£o GET para: ${url}`);
      
      const res = await fetch(url);
      logInfo(`Resposta recebida. Status: ${res.status} ${res.statusText}`);
      logInfo(`Headers da resposta:`, Object.fromEntries(res.headers.entries()));
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const json = await res.json();
      logInfo(`JSON parseado:`, json);
      
      if(!json.ok) {
        throw new Error(json.error || 'Resposta da API indica erro');
      }
      
      // Sucesso - usa dados da API
      banco[h] = json.data;
      lastUpdateTime = Date.now(); // Atualiza timestamp
      logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${json.data.length}`);
      logInfo(`Estrutura dos dados:`, json.data.slice(0, 2)); // mostra apenas os primeiros 2 para n√£o poluir
      
      if (activeTab==='leitos') renderCards();
      if (activeTab==='leitos2') renderTable();
      
    } catch(error) {
      logError(`Erro ao carregar hospital ${h}:`, error);
      
      // Verifica se √© erro de rede espec√≠fico
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        logError('Erro de rede/CORS detectado. Poss√≠veis causas:', [
          '1. URL da API incorreta',
          '2. Google Apps Script n√£o est√° publicado como "Anyone"', 
          '3. Problema de conectividade',
          '4. Bloqueio de CORS pelo navegador'
        ]);
      }
      
      alert(`Erro ao conectar com a planilha: ${error.message}\n\nVerifique o console para mais detalhes.`);
      
      // Inicializa vazio para mostrar que n√£o h√° conex√£o
      banco[h] = [];
      if (activeTab==='leitos') renderCards();
      if (activeTab==='leitos2') renderTable();
    }
  }

  // Fun√ß√£o para atualizar indicador de tempo
  function updateTimeIndicator() {
    if(isQRMode) return; // N√£o mostra no modo QR
    const indicator = document.getElementById('lastUpdateInfo');
    if(indicator) {
      const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
      if(elapsed < 60) {
        indicator.textContent = `Atualizado h√° ${elapsed}s`;
      } else {
        const minutes = Math.floor(elapsed / 60);
        indicator.textContent = `Atualizado h√° ${minutes}min`;
      }
    }
  }

  async function apiCall(payload) {
    logInfo(`Iniciando opera√ß√£o: ${payload.action}`, payload);
    
    try {
      // SEMPRE usa GET para evitar CORS
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(payload)) {
        if (Array.isArray(value)) {
          params.append(key, value.join('|'));
        } else if (value !== null && value !== undefined && value !== '') {
          params.append(key, String(value));
        }
      }
      
      const url = `${API_URL}?${params.toString()}`;
      logInfo(`Fazendo requisi√ß√£o GET para: ${url}`);
      
      const res = await fetch(url, { 
        method: 'GET'
      });
      
      logInfo(`Resposta recebida. Status: ${res.status} ${res.statusText}`);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const json = await res.json();
      logInfo(`Resposta JSON da opera√ß√£o ${payload.action}:`, json);
      
      if (!json.ok) {
        throw new Error(json.error || 'Erro na opera√ß√£o');
      }
      
      logSuccess(`Opera√ß√£o ${payload.action} realizada com sucesso!`);
      return json.data;
      
    } catch(error) {
      logError(`Erro na opera√ß√£o ${payload.action}:`, error);
      throw new Error(error.message || 'Erro na opera√ß√£o');
    }
  }

  // -------------------- RENDER ‚Äì CARDS --------------------
  function renderCards(){
    const container = $("#leitosView");
    container.innerHTML = "";
    const leitos = banco[currentHospital];

    leitos.forEach(l=>{
      const card = document.createElement("div");
      card.className = "card";

      const statusClass = l.status==="Em uso" ? "warn" : "ok";
      const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
      const internado   = l.status==="Em uso" ? ` ‚Ä¢ Internado h√° ${elapsedSince(l.admAt)}` : "";

      const chipsLinhas = (l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join("");
      const chipsConc   = (l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join("");

      card.innerHTML = `
        <div class="top">
          <div class="wrap">
            <span class="status ${statusClass}">Leito ${l.leito} ‚Äì ${l.status}</span>
            <span class="tipo ${tipoClass}">${l.tipo}</span>
            <span class="badge">${HOSPITAIS[l.hospital].nome}${internado? `<span class="badge" style="margin-left:6px">${internado}</span>`:""}</span>
          </div>
        </div>

        <div class="row">
          <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"‚Äî"}</div></div>
          <div class="field"><div class="label">Matr√≠cula</div><div class="value">${l.matricula||"‚Äî"}</div></div>
          <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"‚Äî"}</div></div>
          <div class="field"><div class="label">Admiss√£o</div><div class="value">${fmtDateTime(l.admAt)}</div></div>

          <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"‚Äî"}</div></div>
          <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</div></div>
          <div class="field"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||"‚Äî"}</div></div>
          <div class="field"><div class="label">‚Äî</div><div class="value"> </div></div>

          <div class="field" style="grid-column:1/3">
            <div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||"‚Äî"}</div>
          </div>
          <div class="field" style="grid-column:3/5">
            <div class="label">Concess√µes</div><div class="wrap">${chipsConc||"‚Äî"}</div>
          </div>
        </div>

        <div class="actions">
          ${l.status==="Vago"
            ? `<button class="btn primary" data-act="admitir">Admitir</button>`
            : `<button class="btn primary" data-act="atualizar">Atualizar</button>
               <button class="btn danger"  data-act="alta">Dar Alta</button>`
          }
        </div>
      `;

      // Em modo QR, s√≥ mostra o leito espec√≠fico
      if (isQRMode && l.leito !== selectedLeito) {
        card.style.display = 'none';
      }

      // A√ß√µes (sem bot√£o "Abrir")
      const btnAdmitir   = card.querySelector('[data-act="admitir"]');
      const btnAtualizar = card.querySelector('[data-act="atualizar"]');
      const btnAlta      = card.querySelector('[data-act="alta"]');

      if(btnAdmitir)   btnAdmitir.onclick   = ()=> openAdmissao(l.leito);
      if(btnAtualizar) btnAtualizar.onclick = ()=> openAtualizacao(l.leito);
      if(btnAlta)      btnAlta.onclick      = ()=> darAltaFlow(l.leito);

      container.appendChild(card);
    });
  }

  // -------------------- RENDER ‚Äì TABELA --------------------
  function renderTable(){
    const tb = $("#tbLeitos");
    tb.innerHTML = "";
    banco[currentHospital].forEach(l=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.leito}</td><td>${l.tipo}</td><td>${l.status}</td>
        <td>${l.nome||"‚Äî"}</td><td>${l.matricula||"‚Äî"}</td><td>${l.idade??"‚Äî"}</td>
        <td>${fmtDateTime(l.admAt)}</td><td>${l.pps??"‚Äî"}</td>
        <td>${l.spict==="elegivel"?"Eleg√≠vel":(l.spict==="nao_elegivel"?"N√£o eleg√≠vel":"‚Äî")}</td>
        <td>${l.prevAlta||"‚Äî"}</td>
        <td>${(l.linhas||[]).join(", ")||"‚Äî"}</td>
        <td>${(l.concessoes||[]).join(", ")||"‚Äî"}</td>
      `;
      tr.style.cursor="pointer";
      tr.onclick = ()=> { 
        selectedLeito = l.leito; 
        if(l.status==="Vago") openAdmissao(l.leito); 
        else openAtualizacao(l.leito); 
      };
      tb.appendChild(tr);
    });
  }

  // -------------------- FLUXOS ‚Äì ADMITIR/ATUALIZAR/ALTA --------------------
  function openAdmissao(leito){
    const l = banco[currentHospital].find(x=>x.leito===leito);
    selectedLeito = leito;
    $("#a_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#a_leito").textContent = "Leito " + l.leito;
    $("#a_tipo").textContent = l.tipo;

    $("#a_linhas").innerHTML = LINHAS.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");
    $("#a_concessoes").innerHTML = CONC.map(v=>`<label class="badge"><input type="checkbox" value="${v}" /> ${v}</label>`).join("");

    $("#a_nome").value=""; $("#a_idade").value=""; $("#a_matricula").value=""; $("#a_pps").value="";
    $("#a_spict").value="elegivel"; $("#a_prev").value="24h Ouro";

    openModal("#modalAdmissao");
  }

  $("#a_cancel").onclick = async ()=>{
    if (isQRMode) {
      const ok = await confirmAction("Cancelar admiss√£o? O sistema ser√° encerrado.");
      if(ok) {
        closeModal("#modalAdmissao");
        showSuccessMessage();
      }
    } else {
      const ok = await confirmAction("Cancelar admiss√£o?");
      if(ok) closeModal("#modalAdmissao");
    }
  };

  $("#a_save").onclick = async ()=>{
    const ok = await confirmAction("Salvar e admitir este paciente?");
    if(!ok) return;

    try {
      const lines = Array.from(document.querySelectorAll("#a_linhas input:checked")).map(i=>i.value);
      const concs = Array.from(document.querySelectorAll("#a_concessoes input:checked")).map(i=>i.value);

      const payload = {
        action: 'admit',
        hospital: currentHospital,
        leito: selectedLeito,
        nome: $("#a_nome").value.trim(),
        idade: Number($("#a_idade").value)||null,
        matricula: $("#a_matricula").value.trim(),
        pps: Number($("#a_pps").value)||null,
        spict: $("#a_spict").value,
        prevAlta: $("#a_prev").value,
        linhas: lines,
        concessoes: concs
      };

      await apiCall(payload);
      closeModal("#modalAdmissao");
      
      if (isQRMode) {
        showSuccessMessage();
      } else {
        await loadHospital(currentHospital);
      }
    } catch(error) {
      alert('Erro ao salvar admiss√£o: ' + error.message);
    }
  };

  function openAtualizacao(leito){
    const l = banco[currentHospital].find(x=>x.leito===leito);
    selectedLeito = leito;

    $("#u_hospital").textContent = HOSPITAIS[currentHospital].nome;
    $("#u_leito").textContent = "Leito " + l.leito;
    $("#u_tipo").textContent = l.tipo;

    $("#u_nome").value = l.nome||"";
    $("#u_matricula").value = l.matricula||"";
    $("#u_adm").value = fmtDateTime(l.admAt)||"";

    $("#u_idade").value = l.idade??"";
    $("#u_pps").value = l.pps??"";
    $("#u_spict").value = l.spict||"elegivel";
    $("#u_prev").value = l.prevAlta||"Sem previsao";

    $("#u_linhas").innerHTML = LINHAS.map(v=>{
      const chk = (l.linhas||[]).includes(v) ? "checked":"";
      return `<label class="badge"><input type="checkbox" value="${v}" ${chk}/> ${v}</label>`;
    }).join("");

    $("#u_concessoes").innerHTML = CONC.map(v=>{
      const chk = (l.concessoes||[]).includes(v) ? "checked":"";
      return `<label class="badge"><input type="checkbox" value="${v}" ${chk}/> ${v}</label>`;
    }).join("");

    $("#internadoHa").textContent = `Internado h√° ${elapsedSince(l.admAt)}`;

    openModal("#modalAtualizacao");
  }

  $("#u_cancel").onclick = async ()=>{
    if (isQRMode) {
      const ok = await confirmAction("Cancelar altera√ß√µes? O sistema ser√° encerrado.");
      if(ok) {
        closeModal("#modalAtualizacao");
        showSuccessMessage();
      }
    } else {
      const ok = await confirmAction("Cancelar altera√ß√µes?");
      if(ok) closeModal("#modalAtualizacao");
    }
  };

  $("#u_save").onclick = async ()=>{
    const ok = await confirmAction("Salvar altera√ß√µes?");
    if(!ok) return;

    try {
      const payload = {
        action: 'update',
        hospital: currentHospital,
        leito: selectedLeito,
        idade: Number($("#u_idade").value)||null,
        pps: Number($("#u_pps").value)||null,
        spict: $("#u_spict").value,
        prevAlta: $("#u_prev").value,
        linhas: Array.from(document.querySelectorAll("#u_linhas input:checked")).map(i=>i.value),
        concessoes: Array.from(document.querySelectorAll("#u_concessoes input:checked")).map(i=>i.value)
      };

      await apiCall(payload);
      closeModal("#modalAtualizacao");
      
      if (isQRMode) {
        showSuccessMessage();
      } else {
        await loadHospital(currentHospital);
      }
    } catch(error) {
      alert('Erro ao salvar atualiza√ß√£o: ' + error.message);
    }
  };

  async function darAltaFlow(leito){
    const ok = await confirmAction("Confirmar ALTA deste paciente?");
    if(!ok) return;
    
    try {
      const payload = { action:'alta', hospital: currentHospital, leito: leito };
      await apiCall(payload);
      
      if (isQRMode) {
        closeModal("#modalAtualizacao");
        showSuccessMessage();
      } else {
        await loadHospital(currentHospital);
      }
    } catch(error) {
      alert('Erro ao dar alta: ' + error.message);
    }
  }
  $("#u_alta").onclick = ()=> darAltaFlow(selectedLeito);

  // -------------------- NAVEGA√á√ÉO --------------------
  function setTab(tab){
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelector(`.tab[data-tab='${tab}']`).classList.add("active");
    activeTab = tab;
    route();
    
    // Se mudou para um dashboard, renderiza os gr√°ficos
    if(tab.startsWith('dash')) {
      setTimeout(() => renderDashboards(), 100);
    }
  }

  function setHospitalSelectors(h){
    currentHospital = h;
    const s2 = document.getElementById('selHospital2');
    if (s2) s2.value = h;
    
    // Atualiza visual dos bot√µes de hospital
    document.querySelectorAll('.btn.hospital').forEach(btn => {
      btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`.btn.hospital[data-h="${h}"]`);
    if(activeBtn) activeBtn.classList.add('active');
  }

  function route(){
    const sections = ["leitos","leitos2","dash1","dash2","dash3","dash4"];
    sections.forEach(id=>{
      const el = document.getElementById(id==="leitos"?"leitosView":(id==="leitos2"?"leitos2View":id));
      if(!el) return;
      if(activeTab===id) el.classList.remove("hidden"); else el.classList.add("hidden");
    });

    if(activeTab==="leitos"){ renderCards(); }
    if(activeTab==="leitos2"){ renderTable(); }
  }

  // -------------------- DASHBOARDS --------------------
  function drawGauge(canvasId, value, maxValue, color, small = false) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width = small ? 100 : 200;
    const height = canvas.height = small ? 60 : 120;
    const centerX = width / 2;
    const centerY = height - (small ? 5 : 20);
    const radius = small ? 35 : 70;
    
    // Limpa canvas
    ctx.clearRect(0, 0, width, height);
    
    // Desenha arco de fundo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI, 0, false);
    ctx.lineWidth = small ? 10 : 20;
    ctx.strokeStyle = '#e5e7eb';
    ctx.stroke();
    
    // Desenha arco de progresso
    const percentage = Math.min(value / maxValue, 1);
    const endAngle = Math.PI + (Math.PI * percentage);
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI, endAngle, false);
    ctx.lineWidth = small ? 10 : 20;
    ctx.strokeStyle = color || '#0a2b52';
    ctx.lineCap = 'round';
    ctx.stroke();
  }

  function calculateProjections() {
    // Calcula proje√ß√µes para os pr√≥ximos 7 dias
    const hoje = new Date();
    const labels = ['Hoje'];
    for(let i = 1; i <= 7; i++) {
      labels.push(`D+${i}`);
    }
    
    // Dados para todos os hospitais
    const allData = [...(banco.H1 || []), ...(banco.H2 || [])];
    
    // Inicializa contadores para concess√µes
    const concessoesData = {};
    CONC.forEach(c => {
      concessoesData[c] = new Array(8).fill(0);
    });
    
    // Inicializa contadores para linhas
    const linhasData = {};
    LINHAS.forEach(l => {
      linhasData[l] = new Array(8).fill(0);
    });
    
    // Processa cada paciente
    allData.filter(l => l.status === 'Em uso').forEach(leito => {
      let diasAteAlta = 7; // Default para sem previs√£o
      
      // Calcula dias at√© alta baseado na previs√£o
      if (leito.prevAlta) {
        if (leito.prevAlta.includes('24h')) diasAteAlta = 1;
        else if (leito.prevAlta === '48h') diasAteAlta = 2;
        else if (leito.prevAlta === '72h') diasAteAlta = 3;
        else if (leito.prevAlta === '96h') diasAteAlta = 4;
      }
      
      // Adiciona concess√µes aos dias at√© alta
      (leito.concessoes || []).forEach(conc => {
        if (concessoesData[conc]) {
          for(let d = 0; d <= Math.min(diasAteAlta, 7); d++) {
            concessoesData[conc][d]++;
          }
        }
      });
      
      // Adiciona linhas aos dias at√© alta
      (leito.linhas || []).forEach(linha => {
        if (linhasData[linha]) {
          for(let d = 0; d <= Math.min(diasAteAlta, 7); d++) {
            linhasData[linha][d]++;
          }
        }
      });
    });
    
    return { labels, concessoesData, linhasData };
  }

  function renderDashboards() {
    // Dashboard 1 - Vis√£o Geral
    if (activeTab === 'dash1') {
      // Carrega dados de ambos hospitais primeiro
      Promise.all([
        loadHospital('H1'),
        loadHospital('H2')
      ]).then(() => {
        // Renderiza cada hospital
        ['H1', 'H2'].forEach(hospital => {
          const dados = banco[hospital] || [];
          
          const totalLeitos = dados.length;
          const ocupados = dados.filter(l => l.status === 'Em uso').length;
          const disponiveis = totalLeitos - ocupados;
          const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
          
          // Calcula altas em 24h
          const altas24h = dados.filter(l => 
            l.status === 'Em uso' && 
            l.prevAlta && 
            (l.prevAlta.includes('24h'))
          ).length;
          
          // Taxa de ocupa√ß√£o
          drawGauge(`gaugeOcupacao${hospital}`, taxaOcupacao, 100, 
            taxaOcupacao > 90 ? '#ef4444' : 
            taxaOcupacao > 85 ? '#f59e0b' : 
            taxaOcupacao > 70 ? '#10b981' : '#3b82f6',
            true
          );
          $(`#gaugeOcupacao${hospital}Value`).textContent = taxaOcupacao + '%';
          
          // Leitos ocupados
          drawGauge(`gaugeOcupados${hospital}`, ocupados, totalLeitos, '#f59e0b', true);
          $(`#gaugeOcupados${hospital}Value`).textContent = ocupados;
          
          // Leitos dispon√≠veis
          drawGauge(`gaugeDisponiveis${hospital}`, disponiveis, totalLeitos, '#10b981', true);
          $(`#gaugeDisponiveis${hospital}Value`).textContent = disponiveis;
          
          // Altas em 24h
          $(`#altas${hospital}`).textContent = altas24h;
        });
        
        // Gr√°ficos temporais
        const projections = calculateProjections();
        
        // Gr√°fico de Concess√µes por Tempo
        const canvasConc = document.getElementById('chartConcessoesTempo');
        if (canvasConc) {
          const ctx = canvasConc.getContext('2d');
          if (window.chartConcessoesTempo) window.chartConcessoesTempo.destroy();
          
          const datasets = Object.entries(projections.concessoesData)
            .filter(([key, values]) => values.some(v => v > 0)) // S√≥ mostra linhas com dados
            .map(([conc, values], idx) => ({
              label: conc,
              data: values,
              borderColor: [
                '#0a2b52', '#16a34a', '#f59e0b', '#dc2626', '#8b5cf6'
              ][idx % 5],
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.3
            }));
          
          window.chartConcessoesTempo = new Chart(ctx, {
            type: 'line',
            data: {
              labels: projections.labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: `Data base: ${new Date().toLocaleDateString('pt-BR')}`,
                  font: { size: 11 }
                },
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 10 } }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Quantidade de Benefici√°rios',
                    font: { size: 10 }
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Tempo',
                    font: { size: 10 }
                  }
                }
              }
            }
          });
        }
        
        // Gr√°fico de Linhas de Cuidado por Tempo
        const canvasLinhas = document.getElementById('chartLinhasTempo');
        if (canvasLinhas) {
          const ctx = canvasLinhas.getContext('2d');
          if (window.chartLinhasTempo) window.chartLinhasTempo.destroy();
          
          const datasets = Object.entries(projections.linhasData)
            .filter(([key, values]) => values.some(v => v > 0)) // S√≥ mostra linhas com dados
            .map(([linha, values], idx) => ({
              label: linha,
              data: values,
              borderColor: [
                '#1e40af', '#059669', '#ea580c', '#be123c', '#7c3aed', '#0891b2', '#be185d'
              ][idx % 7],
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.3
            }));
          
          window.chartLinhasTempo = new Chart(ctx, {
            type: 'line',
            data: {
              labels: projections.labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: `Data base: ${new Date().toLocaleDateString('pt-BR')}`,
                  font: { size: 11 }
                },
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 10 } }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Quantidade de Benefici√°rios',
                    font: { size: 10 }
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Tempo',
                    font: { size: 10 }
                  }
                }
              }
            }
          });
        }
      });
    }
    
    // Dashboard 2 - Previs√£o de Altas (mant√©m como est√°)
    if (activeTab === 'dash2') {
      const dados = banco[currentHospital];
      if (!dados || dados.length === 0) return;
      
      const altas = {
        '24h Ouro': 0, '24h 2R': 0, '24h 3R': 0,
        '48h': 0, '72h': 0, '96h': 0, 'Sem previsao': 0
      };
      
      dados.filter(l => l.status === 'Em uso').forEach(l => {
        if (altas.hasOwnProperty(l.prevAlta)) {
          altas[l.prevAlta]++;
        }
      });
      
      // Atualiza estat√≠sticas
      $('#altas24h').textContent = altas['24h Ouro'] + altas['24h 2R'] + altas['24h 3R'];
      $('#altas48h').textContent = altas['48h'];
      $('#altas72h').textContent = altas['72h'];
      $('#altasSem').textContent = altas['Sem previsao'];
      
      // Gr√°fico de barras
      const canvas = document.getElementById('chartAltas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        if (window.chartAltas) window.chartAltas.destroy();
        
        window.chartAltas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(altas),
            datasets: [{
              label: 'Pacientes',
              data: Object.values(altas),
              backgroundColor: [
                '#10b981', '#22c55e', '#34d399',
                '#3b82f6', '#60a5fa', '#f59e0b', '#ef4444'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
      }
    }
    
    // Dashboards 3 e 4 mant√™m como est√£o...
    // (c√≥digo existente para dash3 e dash4)
  }

  // -------------------- QR ‚Äì Scanner & Em Massa --------------------
  let qrReader = null;
  function handleScan(text){
    try{
      const u = new URL(String(text));
      const h = u.searchParams.get('h');
      const leito = Number(u.searchParams.get('leito'));
      if(h && ["H1","H2"].includes(h) && leito>0){
        closeModal("#modalQRScan");
        stopScan();
        // Abre no mesmo HTML entrando em modo QR
        location.href = `${location.pathname}?h=${h}&leito=${leito}`;
      }
    }catch(e){
      // ignorar
    }
  }
  async function startScan(){
    if(!window.Html5Qrcode){ alert("Leitor n√£o dispon√≠vel neste dispositivo."); return; }
    try{
      if(qrReader){ await stopScan(); }
      qrReader = new Html5Qrcode('qrRegion');
      await qrReader.start({ facingMode:'environment' }, { fps:10, qrbox:250 }, handleScan, ()=>{});
    }catch(e){
      alert("N√£o foi poss√≠vel acessar a c√¢mera.");
      stopScan(); closeModal("#modalQRScan");
    }
  }
  function stopScan(){
    if(!qrReader) return Promise.resolve();
    return qrReader.stop().then(()=>{ qrReader.clear(); qrReader=null; }).catch(()=>{});
  }

  function openBulkQR(){
    $("#b_hospital").value = currentHospital;
    const limit = currentHospital==="H1"?13:16;
    $("#b_from").value = 1;
    $("#b_to").value = limit;
    $("#qr_grid").innerHTML = "";
    openModal("#modalBulkQR");
  }
  function buildQRGrid(){
    const h = $("#b_hospital").value;
    const from = Math.max(1, parseInt($("#b_from").value||"1"));
    const to   = Math.max(from, parseInt($("#b_to").value||"1"));
    const limit = h==="H1"?13:16;
    const f = Math.min(from, limit);
    const t = Math.min(to, limit);

    const base = `${location.origin}${location.pathname}`;
    const grid = $("#qr_grid");
    grid.innerHTML = "";
    for(let i=f;i<=t;i++){
      const url = `${base}?h=${h}&leito=${i}`;
      const cell = document.createElement("div");
      cell.className="qr-cell";
      cell.innerHTML = `<div class="qr-box"></div><div class="mini">Leito ${i} ‚Ä¢ ${HOSPITAIS[h].nome}</div>`;
      grid.appendChild(cell);
      new QRCode(cell.querySelector(".qr-box"), {text:url, width:160, height:160});
    }
  }

  // -------------------- MODO QR (m√©dico) --------------------
  function startQrTimer(seconds){
    qrExpiresAt = Date.now() + seconds*1000;
    const badge = document.createElement("div");
    badge.className = "qrTimerBadge";
    badge.id = "qrBadge";
    document.body.appendChild(badge);

    qrTick = setInterval(()=>{
      const left = Math.max(0, qrExpiresAt - Date.now());
      const mm = String(Math.floor(left/60000)).padStart(2,"0");
      const ss = String(Math.floor((left%60000)/1000)).padStart(2,"0");
      badge.textContent = `‚è± ${mm}:${ss} para concluir`;
      if(left<=0){
        clearInterval(qrTick);
        // Fechar todos os modais
        document.querySelectorAll(".backdrop").forEach(b=> b.style.display="none");
        // Mostrar modal de expira√ß√£o
        openModal("#modalQRExpired");
      }
    }, 500);
  }

  async function enterQrMode(h, leito){
    isQRMode = true;
    document.body.classList.add("qr-only");
    // esconder navega√ß√£o/toolbar
    $("#appHeader").style.display = "none";
    $("#portalToolbar").style.display = "none";

    // Seleciona hospital e carrega dados
    currentHospital = h; 
    setHospitalSelectors(h);
    activeTab = "leitos"; 
    
    await loadHospital(h);
    selectedLeito = leito;
    
    route();

    const l = banco[currentHospital].find(x=>x.leito===leito);
    if(!l) return;
    if(l.status==="Vago") openAdmissao(leito); else openAtualizacao(leito);

    // inicia timer 2 min
    startQrTimer(120);
  }

  // -------------------- EVENTOS --------------------
  // Tabs
  document.querySelectorAll(".tab").forEach(b=> b.onclick = ()=> setTab(b.dataset.tab) );
  // Hospital selectors
  const selHospital2 = document.getElementById('selHospital2');
  if (selHospital2) {
    selHospital2.onchange = e=>{ setHospitalSelectors(e.target.value); loadHospital(e.target.value); };
  }
  $("#btnH1").onclick = ()=>{ setHospitalSelectors("H1"); loadHospital("H1"); };
  $("#btnH2").onclick = ()=>{ setHospitalSelectors("H2"); loadHospital("H2"); };

  // Bot√£o de refresh manual
  $("#btnRefresh").onclick = ()=>{ 
    logInfo("Refresh manual executado");
    loadHospital(currentHospital); 
  };

  // QR scan (para uso do gestor em desktop)
  $("#btnScan").onclick = ()=>{ openModal("#modalQRScan"); startScan(); };
  document.querySelectorAll("[data-close]").forEach(b=> b.onclick = ()=> closeModal(b.getAttribute("data-close")) );
  // Bulk QR
  $("#btnBulkQR").onclick = openBulkQR;
  $("#b_generate").onclick = buildQRGrid;

  // QR Expired Modal
  $("#reloadPage").onclick = ()=> location.reload();

  // -------------------- PARAMS (URL) --------------------
  (async function checkParams(){
    const p = new URLSearchParams(location.search);
    const h = p.get("h");
    const leito = Number(p.get("leito"));
    
    logInfo("=== INICIALIZANDO ARCHIPELAGO MVP ===");
    logInfo("URL da API configurada:", API_URL);
    logInfo("Par√¢metros da URL:", { hospital: h, leito: leito });
    
    // Testa conex√£o primeiro
    const connected = await testConnection();
    
    if(h && ["H1","H2"].includes(h) && leito>0){
      logInfo("üè• MODO QR DETECTADO - Sess√£o m√©dica iniciada");
      logInfo(`Hospital: ${h}, Leito: ${leito}`);
      // fluxo m√©dico direto do QR: entrar no modo QR (sem PIN, com timer)
      enterQrMode(h, leito);
    }else{
      logInfo("üíº MODO PORTAL DETECTADO - Sess√£o gestor iniciada");
      // portal normal (sem timer)
      setHospitalSelectors("H1");
      setTab("leitos");
      
      // Carrega dados de ambos hospitais
      loadHospital("H1");
      loadHospital("H2");
      
      // Auto-refresh a cada 1 minuto no modo portal
      autoRefreshInterval = setInterval(() => {
        logInfo("Auto-refresh executado");
        loadHospital("H1"); // Carrega H1
        loadHospital("H2"); // Carrega H2
        
        // Se estiver em um dashboard, renderiza
        if(activeTab.startsWith('dash')) {
          renderDashboards();
        }
      }, 60000); // 60 segundos
      
      // Atualiza indicador de tempo a cada segundo
      updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
    }
    
    logInfo("=== INICIALIZA√á√ÉO CONCLU√çDA ===");
  })();
  </script>
</body>
</html>
