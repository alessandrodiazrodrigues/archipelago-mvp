<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago – Gestão de Leitos (MVP)</title>

  <style>
    :root{
      --nav:#0a2b52;          /* azul escuro Prevent */
      --nav-2:#083052;
      --bg:#eaf1f9;           /* base do fundo */
      --bg-deep:#d9e7fb;      /* variacao do fundo */
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;           /* VAGO */
      --warn:#f59e0b;         /* EM USO */
      --danger:#dc2626;       /* UTI / acoes criticas */
      --blue-veil:#4f86ff33;  /* veu azul translucido */
      --shadow-1:0 10px 22px rgba(11,44,82,.10);
      --shadow-2:0 18px 48px rgba(11,44,82,.14);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, #cfe2ff 0%, transparent 55%),
        radial-gradient(1000px 500px at 85% 0%, #c9dffe 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 100%);
    }

    /* Header */
    header{
      background:linear-gradient(90deg,var(--nav),var(--nav-2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      box-shadow:0 6px 18px rgba(8,48,82,.20);
      position:sticky; top: 0; z-index:100;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff1;display:grid;place-items:center;border:1px solid #ffffff33;backdrop-filter:blur(2px)}
    .logo::after{content:"PS";font-weight:700}
    .title h1{margin:0;font-size:18px}
    .title small{display:block;color:#dbe7f5}
    #qrTimer{margin-left:10px;padding:4px 8px;border-radius:999px;background:#ffffff20;border:1px solid #ffffff40}

    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--nav);border-color:#fff}

    /* Layout */
    main{max-width:1600px;margin:18px auto 100px;padding:0 24px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--nav);border-color:var(--nav);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    
    .btn.hospital{
      background:var(--nav); border-color:var(--nav); color:#fff; transition: all 0.2s ease;
    }
    .btn.hospital.active{
      background:#1e40af; border-color:#1e40af; box-shadow:0 0 0 3px rgba(30,64,175,0.3); transform: translateY(-1px);
    }
    .btn.hospital:hover{ background:#1e40af; }
    
    .select{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px}
    
    #btnRefresh {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      background: var(--nav); border-color: var(--nav); color: #fff;
    }
    #lastUpdateInfo { font-size: 9px; opacity: 0.8; line-height: 1; }

    /* GRID DE CARDS */
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(450px, 1fr));gap:18px;position:relative;z-index:1}

    .card{
      position:relative; background:var(--card); border:1px solid var(--border);
      border-radius:20px; padding:16px;
      box-shadow: var(--shadow-1), var(--shadow-2), 0 0 0 1px rgba(255,255,255,.6) inset;
      transform:translateY(0); transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .card::before{
      content:""; position:absolute; inset:-8px -8px -16px -8px; border-radius:24px;
      background:radial-gradient(500px 220px at 30% -20%, var(--blue-veil), transparent 70%);
      z-index:-1; filter:blur(8px);
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16), 0 26px 64px rgba(11,44,82,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
      filter:saturate(1.02);
    }

    .card .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted);font-size:12px}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;color:#111;border:1px solid var(--border);background:#fff}
    .status.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .status.warn{background:#fff7ed;border-color:#fed7aa;color:#92400e}
    .tipo{font-size:12px;color:#fff;background:#6b7280;border-radius:999px;padding:4px 8px}
    .tipo.uti{background:var(--danger)}
    .tipo.enf{background:#0ea5e9}

    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .field{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px}
    .field .label{font-size:11px;color:#6b7280}
    .field .value{font-weight:600}
    .wrap{display:flex;flex-wrap:wrap;gap:6px}
    .chip{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;color:#1e40af;padding:2px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Tabela */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
    th{font-size:12px;color:#6b7280;text-align:left}
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f9fafb; }
    td{font-size:13px}
    .hidden{display:none}

    /* Dashboard Styles */
    .dashboard-container { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 24px; 
      margin-top: 20px;
    }
    .hospital-dashboard {
      background: #fff; 
      border: 1px solid var(--border); 
      border-radius: 16px; 
      padding: 20px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .hospital-title { 
      font-size: 20px; 
      font-weight: 700; 
      color: var(--nav); 
      text-align: center; 
      margin-bottom: 20px; 
      padding-bottom: 10px; 
      border-bottom: 2px solid var(--border);
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--nav);
    }
    .metric-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .gauge-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 120px;
      margin: 20px 0;
    }
    .gauge-chart {
      position: relative;
      width: 100px;
      height: 50px;
    }
    .gauge-text {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }
    .gauge-percent {
      font-size: 16px;
      font-weight: 700;
      color: var(--nav);
    }
    .gauge-label {
      font-size: 10px;
      color: var(--muted);
    }

    .chart-container { 
      position: relative; 
      width: 100%; 
      height: 200px; 
      margin: 15px 0;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin: 20px 0 10px 0;
      border-left: 3px solid var(--nav);
      padding-left: 8px;
    }

    /* Modais & Overlays */
    .backdrop{position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;overflow:auto}
    .modal{background:#fff;max-width:860px;width:100%;max-height:90vh;border-radius:20px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
    .modal .content{padding:16px;overflow-y:auto;flex:1}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .input,.select2,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    .label{font-size:12px;color:#6b7280;margin-bottom:4px;display:block}
    
    .qr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-height:none;overflow:visible}
    .qr-cell{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;min-height:200px}
    .qr-box{display:inline-block;border:1px solid var(--border);padding:8px;border-radius:10px;background:#fff}

    .success-message{
      position:fixed; top:50%;left:50%; transform:translate(-50%,-50%);
      background:#fff; border:1px solid var(--border); border-radius:20px;
      padding:40px; text-align:center; box-shadow:0 10px 28px rgba(0,0,0,.25);
      z-index:3000; display:none;
    }
    
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header id="appHeader">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Archipelago – Gestão de Leitos</h1>
        <small>Protótipo (estado atual, sem histórico)</small>
      </div>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="leitos">Leitos (Cards)</button>
      <button class="tab" data-tab="leitos2">Leitos (Tabela)</button>
    </nav>
  </header>

  <main>
    <!-- Toolbar - apenas para views de leitos -->
    <div class="toolbar" id="portalToolbar">
      <div class="row">
        <button class="btn primary" id="btnBulkQR">QR Codes (imprimir)</button>
        <button class="btn" id="btnScan">Ler QR Code</button>
        <button class="btn primary" id="btnRefresh">
          🔄 Atualizar
          <span id="lastUpdateInfo">há 0s</span>
        </button>
      </div>
      <div class="row">
        <button class="btn hospital active" data-h="H1" id="btnH1">Neomater</button>
        <button class="btn hospital" data-h="H2" id="btnH2">Cruz Azul</button>
      </div>
    </div>

    <!-- Dashboard View -->
    <section id="dashboardView">
      <h2 style="text-align: center; color: var(--nav); margin-bottom: 30px;">Dashboard Consolidado - Visão Geral</h2>
      
      <div class="dashboard-container">
        <!-- Neomater -->
        <div class="hospital-dashboard">
          <div class="hospital-title">Neomater</div>
          
          <div class="gauge-container">
            <div class="gauge-chart">
              <canvas id="gaugeH1" width="100" height="50"></canvas>
              <div class="gauge-text">
                <div class="gauge-percent" id="percentH1">0%</div>
                <div class="gauge-label">Ocupação</div>
              </div>
            </div>
          </div>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="ocupadosH1">0</div>
              <div class="metric-label">Ocupados</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="vagosH1">0</div>
              <div class="metric-label">Vagos</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="utiH1">0</div>
              <div class="metric-label">UTI</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="totalH1">13</div>
              <div class="metric-label">Total</div>
            </div>
          </div>

          <div class="section-title">Projeção de Altas (7 dias)</div>
          <div class="chart-container">
            <canvas id="chartAltasH1"></canvas>
          </div>
        </div>

        <!-- Cruz Azul -->
        <div class="hospital-dashboard">
          <div class="hospital-title">Cruz Azul</div>
          
          <div class="gauge-container">
            <div class="gauge-chart">
              <canvas id="gaugeH2" width="100" height="50"></canvas>
              <div class="gauge-text">
                <div class="gauge-percent" id="percentH2">0%</div>
                <div class="gauge-label">Ocupação</div>
              </div>
            </div>
          </div>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="ocupadosH2">0</div>
              <div class="metric-label">Ocupados</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="vagosH2">0</div>
              <div class="metric-label">Vagos</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="utiH2">0</div>
              <div class="metric-label">UTI</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="totalH2">16</div>
              <div class="metric-label">Total</div>
            </div>
          </div>

          <div class="section-title">Projeção de Altas (7 dias)</div>
          <div class="chart-container">
            <canvas id="chartAltasH2"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Cards View -->
    <section id="leitosView" class="grid hidden"></section>

    <!-- Tabela View -->
    <section id="leitos2View" class="hidden">
      <div style="margin-bottom:8px">
        <select id="selHospital2" class="select">
          <option value="H1">Neomater</option>
          <option value="H2">Cruz Azul</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th class="sortable" data-sort="leito">Leito</th>
            <th class="sortable" data-sort="tipo">Tipo</th>
            <th class="sortable" data-sort="status">Status</th>
            <th class="sortable" data-sort="nome">Nome</th>
            <th class="sortable" data-sort="matricula">Matrícula</th>
            <th class="sortable" data-sort="idade">Idade</th>
            <th class="sortable" data-sort="admAt">Admissão</th>
            <th class="sortable" data-sort="pps">PPS</th>
            <th class="sortable" data-sort="spict">SPICT-BR</th>
            <th class="sortable" data-sort="prevAlta">Prev. Alta</th>
            <th>Linhas de Cuidado</th>
            <th>Concessões</th>
          </tr>
        </thead>
        <tbody id="tbLeitos"></tbody>
      </table>
    </section>
  </main>

  <!-- Modais -->
  <div id="modalAdmissao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Admissão de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matrícula (número)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0–10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="a_prev">Previsão de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div class="mini" style="margin-top:8px;color:#6b7280">
          * Data e hora de admissão serão registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <div id="modalAtualizacao" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong>Atualização de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>

        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matrícula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admissão (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0–10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label class="label" for="u_prev">Previsão de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>

        <div class="mini" id="internadoHa" style="margin-top:8px;color:#6b7280"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <div id="modalConfirm" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
      <header><strong>Confirmação</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">Não</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div class="mini" style="margin-bottom:8px">Se a câmera não abrir, use a seleção manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impressão</strong>
        <button class="btn" data-close="#modalBulkQR" style="padding:5px 10px;font-size:16px;line-height:1">✕</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:#fff;padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" class="qr-grid"></div>
      </div>
    </div>
  </div>
  
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Operação realizada com sucesso.</p>
    <p style="color:#6b7280;font-size:14px">Você pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // ======================= CONFIGURAÇÃO =======================
  const API_URL = 'https://script.google.com/macros/s/AKfycbzn8BlUD8by0GykYlJa1pmbYtuXOr8aEUzOOBhpfSGl-i1x8LhAnGSRzqdyV2lANnIP/exec';

  function logInfo(message, data = null) { console.log(`🔵 [Archipelago] ${message}`, data || ''); }
  function logSuccess(message, data = null) { console.log(`🟢 [SUCCESS] ${message}`, data || ''); }
  function logError(message, error = null) { console.error(`🔴 [ERROR] ${message}`, error || ''); }
  function logWarning(message, data = null) { console.warn(`🟡 [WARNING] ${message}`, data || ''); }

  const HOSPITAIS = {
    H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
    H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
  };

  const banco = { H1: [], H2: [] };
  const LINHAS = ["Assistencia","Geriatria","APS","Cardiologia","Pneumologia","Neurologia","Melhor Cuidado"];
  const CONC   = ["PAD","Fisioterapia","Fonoaudiologia","Aspiracoes","Curativos"];
  
  LINHAS.sort((a, b) => a.localeCompare(b));
  CONC.sort((a, b) => a.localeCompare(b));

  // ======================= ESTADO DA UI =======================
  let currentHospital = "H1";
  let activeTab = "dashboard";
  let selectedLeito = null;
  let isQRMode = false;
  let lastUpdateTime = Date.now();
  let autoRefreshInterval = null;
  let updateIndicatorInterval = null;
  let sortState = { key: 'leito', direction: 'asc' };

  // ======================= HELPERS =======================
  const $ = sel => document.querySelector(sel);
  
  function openModal(sel){ const el=$(sel); el.style.display="flex"; el.setAttribute("aria-hidden","false"); }
  function closeModal(sel){ const el=$(sel); el.style.display="none"; el.setAttribute("aria-hidden","true"); }
  
  function confirmAction(msg){
    return new Promise(res=>{
      $("#confirmMsg").textContent = msg || "Confirma?";
      openModal("#modalConfirm");
      $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
      $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
    });
  }
  
  function initials(nome){ if(!nome) return "–"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }
  
  function fmtDateTime(iso){
    if(!iso) return "–";
    const d=new Date(iso);
    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function elapsedMsToDays(ms) {
    if (ms === null || ms === undefined) return 0;
    return Math.floor(ms / 86400000);
  }
  
  function elapsedSince(iso){
    if(!iso) return { text: "–", days: 0 };
    const ms = Date.now() - new Date(iso).getTime();
    const d = elapsedMsToDays(ms);
    const h = Math.floor((ms%86400000)/3600000);
    return { text: `${d}d ${h}h`, days: d };
  }
  
  function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }
  
  function updateTimeIndicator() {
    if(isQRMode) return;
    const indicator = document.getElementById('lastUpdateInfo');
    if(indicator) {
      const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
      indicator.textContent = elapsed < 60 ? `há ${elapsed}s` : `há ${Math.floor(elapsed / 60)}min`;
    }
  }

  // ======================= API FUNCTIONS =======================
  async function testConnection() {
    logInfo("Testando conexão com a API...");
    try {
      const res = await fetch(API_URL + '?action=test');
      if (res.ok) {
        logSuccess("Conexão com a API estabelecida!");
        return true;
      }
      logError(`Falha na conexão: HTTP ${res.status}`);
      return false;
    } catch(error) {
      logError("Erro ao testar conexão:", error);
      return false;
    }
  }
  
  async function loadAllData() {
    await Promise.all([
        banco.H1.length === 0 ? loadHospital('H1') : Promise.resolve(),
        banco.H2.length === 0 ? loadHospital('H2') : Promise.resolve()
    ]);
  }

  async function loadHospital(h) {
    logInfo(`Iniciando carregamento do hospital: ${h}`);
    try {
      const url = `${API_URL}?action=state&hospital=${h}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
      
      banco[h] = json.data;
      lastUpdateTime = Date.now();
      logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${json.data.length}`);
      
      if (activeTab === 'leitos') renderCards();
      if (activeTab === 'leitos2') renderTable();
      if (activeTab === 'dashboard') renderDashboard();
    } catch(error) {
      logError(`Erro ao carregar hospital ${h}:`, error);
      alert(`Erro ao conectar com a planilha: ${error.message}\n\nVerifique se o deploy do Google Apps Script está como 'Acessível para qualquer pessoa'.`);
      banco[h] = [];
      if (activeTab === 'leitos') renderCards();
      if (activeTab === 'leitos2') renderTable();
      if (activeTab === 'dashboard') renderDashboard();
    }
  }

  async function apiCall(payload) {
    logInfo(`Iniciando operação: ${payload.action}`, payload);
    try {
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(payload)) {
        if (Array.isArray(value)) params.append(key, value.join('|'));
        else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
      }
      
      const url = `${API_URL}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Erro na operação');
      
      logSuccess(`Operação ${payload.action} realizada com sucesso!`);
      return json.data;
    } catch(error) {
      logError(`Erro na operação ${payload.action}:`, error);
      throw new Error(error.message || 'Erro na operação');
    }
  }

  // ======================= UI FUNCTIONS =======================
  function setTab(tab){
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    $(`.tab[data-tab='${tab}']`).classList.add("active");
    activeTab = tab;
    route();
  }

  function setHospitalSelectors(h){
    currentHospital = h;
    $('#selHospital2').value = h;
    document.querySelectorAll('.btn.hospital').forEach(btn => btn.classList.remove('active'));
    $(`.btn.hospital[data-h="${h}"]`)?.classList.add('active');
  }
  
  function route(){
    const sections = ["dashboardView", "leitosView","leitos2View"];
    sections.forEach(id => {
      const el = $(`#${id}`);
      if(el) el.classList.add("hidden");
    });

    const activeSectionId = activeTab === 'dashboard' ? 'dashboardView' : 
                          activeTab === 'leitos' ? 'leitosView' : 'leitos2View';
    $(`#${activeSectionId}`)?.classList.remove("hidden");

    // Esconder toolbar no dashboard
    $('#portalToolbar').style.display = activeTab === 'dashboard' ? 'none' : 'flex';

    if(activeTab === "leitos") renderCards();
    if(activeTab === "leitos2") renderTable();
    if(activeTab === "dashboard") renderDashboard();
  }

  // ======================= DASHBOARD RENDER =======================
  function renderDashboard() {
    logInfo("Renderizando dashboard consolidado...");
    renderHospitalDashboard('H1');
    renderHospitalDashboard('H2');
  }

  function renderHospitalDashboard(hospital) {
    const dados = banco[hospital] || [];
    const totalLeitos = HOSPITAIS[hospital].leitos.length;
    const ocupados = dados.filter(l => l.status === 'Em uso').length;
    const vagos = totalLeitos - ocupados;
    const utiOcupados = dados.filter(l => l.tipo === 'UTI' && l.status === 'Em uso').length;
    const taxaOcupacao = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;

    // Atualizar métricas
    $(`#ocupados${hospital}`).textContent = ocupados;
    $(`#vagos${hospital}`).textContent = vagos;
    $(`#uti${hospital}`).textContent = utiOcupados;
    $(`#percent${hospital}`).textContent = taxaOcupacao + '%';

    // Criar gauge
    createGaugeChart(`gauge${hospital}`, taxaOcupacao);

    // Criar gráfico de projeção de altas
    createAltasChart(`chartAltas${hospital}`, dados);
  }

  function createGaugeChart(canvasId, percentage) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Destruir chart anterior se existir
    if (window[`chart_${canvasId}`]) {
      window[`chart_${canvasId}`].destroy();
    }

    window[`chart_${canvasId}`] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [percentage, 100 - percentage],
          backgroundColor: [
            percentage > 90 ? '#dc2626' : percentage > 75 ? '#f59e0b' : '#16a34a',
            '#e5e7eb'
          ],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,
        rotation: -90,
        cutout: '75%',
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false }
        }
      }
    });
  }

  function createAltasChart(canvasId, dados) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Destruir chart anterior se existir
    if (window[`chart_${canvasId}`]) {
      window[`chart_${canvasId}`].destroy();
    }

    // Calcular projeção de altas por dia
    const hoje = new Date();
    const labels = [];
    const altasData = [];

    for (let i = 0; i < 7; i++) {
      const dia = new Date(hoje);
      dia.setDate(hoje.getDate() + i);
      labels.push(`D+${i} (${dia.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})})`);
      
      let altasNoDia = 0;
      dados.filter(p => p.status === 'Em uso').forEach(paciente => {
        const diasAteAlta = getDiasAteAlta(paciente.prevAlta);
        if (diasAteAlta === i) altasNoDia++;
      });
      altasData.push(altasNoDia);
    }

    window[`chart_${canvasId}`] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Altas Previstas',
          data: altasData,
          backgroundColor: '#3b82f6',
          borderColor: '#2563eb',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  }

  function getDiasAteAlta(prevAlta) {
    if (!prevAlta) return 6;
    if (prevAlta.includes('24h')) return 0;
    if (prevAlta === '48h') return 1;
    if (prevAlta === '72h') return 2;
    if (prevAlta === '96h') return 3;
    return 6;
  }

  // ======================= CARDS E TABELA =======================
  function renderCards(){
    const container = $("#leitosView");
    container.innerHTML = "";
    const leitos = banco[currentHospital] || [];

    if(leitos.length === 0) {
        container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">Nenhum leito para exibir ou aguardando dados...</p>`;
        return;
    }

    leitos.forEach(l=>{
      const card = document.createElement("div");
      card.className = "card";

      const statusClass = l.status==="Em uso" ? "warn" : "ok";
      const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
      const internado   = l.status==="Em uso" ? ` • ${elapsedSince(l.admAt).text}` : "";

      const chipsLinhas = (l.linhas||[]).map(x=>`<span class="chip">${x}</span>`).join("");
      const chipsConc   = (l.concessoes||[]).map(x=>`<span class="chip">${x}</span>`).join("");

      card.innerHTML = `
        <div class="top">
          <div class="wrap">
            <span class="status ${statusClass}">Leito ${l.leito} – ${l.status}</span>
            <span class="tipo ${tipoClass}">${l.tipo}</span>
          </div>
          <span class="badge">${HOSPITAIS[l.hospital].nome}${internado}</span>
        </div>
        <div class="row">
          <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"–"}</div></div>
          <div class="field"><div class="label">Matrícula</div><div class="value">${l.matricula||"–"}</div></div>
          <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"–"}</div></div>
          <div class="field"><div class="label">Admissão</div><div class="value">${fmtDateTime(l.admAt)}</div></div>
          <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"–"}</div></div>
          <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Elegível":(l.spict==="nao_elegivel"?"Não elegível":"–")}</div></div>
          <div class="field"><div class="label">Prev. Alta</div><div class="value">${l.prevAlta||"–"}</div></div>
          <div class="field" style="grid-column:1/3">
            <div class="label">Linhas de cuidado</div><div class="wrap">${chipsLinhas||"–"}</div>
          </div>
          <div class="field" style="grid-column:3/5">
            <div class="label">Concessões</div><div class="wrap">${chipsConc||"–"}</div>
          </div>
        </div>
        <div class="actions">
          ${l.status==="Vago"
            ? `<button class="btn primary" data-act="admitir">Admitir</button>`
            : `<button class="btn primary" data-act="atualizar">Atualizar</button>
               <button class="btn danger"  data-act="alta">Dar Alta</button>`
          }
        </div>
      `;

      if (isQRMode && l.leito !== selectedLeito) card.style.display = 'none';

      card.querySelector('[data-act="admitir"]')?.addEventListener('click', () => openAdmissao(l.leito));
      card.querySelector('[data-act="atualizar"]')?.addEventListener('click', () => openAtualizacao(l.leito));
      card.querySelector('[data-act="alta"]')?.addEventListener('click', () => darAltaFlow(l.leito));

      container.appendChild(card);
    });
  }

  function renderTable(){
      const tb = $("#tbLeitos");
      const headers = document.querySelectorAll('#leitos2View th.sortable');
      tb.innerHTML = "";

      const sortedData = [...banco[currentHospital]].sort((a, b) => {
          const key = sortState.key;
          const dir = sortState.direction === 'asc' ? 1 : -1;
          
          const aVal = a[key] === null || a[key] === undefined ? '' : a[key];
          const bVal = b[key] === null || b[key] === undefined ? '' : b[key];

          if (key === 'admAt') {
              const dateA = aVal ? new Date(aVal).getTime() : 0;
              const dateB = bVal ? new Date(bVal).getTime() : 0;
              return (dateA - dateB) * dir;
          }
          if (!isNaN(aVal) && !isNaN(bVal) && aVal !== '' && bVal !== '') {
              return (Number(aVal) - Number(bVal)) * dir;
          }
          return String(aVal).localeCompare(String(bVal)) * dir;
      });
      
      sortedData.forEach(l => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${l.leito}</td><td>${l.tipo}</td><td>${l.status}</td>
          <td>${l.nome||"–"}</td><td>${l.matricula||"–"}</td><td>${l.idade??"–"}</td>
          <td>${fmtDateTime(l.admAt)}</td><td>${l.pps??"–"}</td>
          <td>${l.spict==="elegivel"?"Elegível":(l.spict==="nao_elegivel"?"Não elegível":"–")}</td>
          <td>${l.prevAlta||"–"}</td>
          <td>${(l.linhas||[]).join(", ")||"–"}</td>
          <td>${(l.concessoes||[]).join(", ")||"–"}</td>
        `;
        tr.style.cursor="pointer";
        tr.onclick = ()=> {  
          if(l.status==="Vago") openAdmissao(l.leito);  
          else openAtualizacao(l.leito);  
        };
        tb.appendChild(tr);
      });
      
      headers.forEach(th => {
          let text = th.dataset.sort.charAt(0).toUpperCase() + th.dataset.sort.slice(1);
          if (th.dataset.sort === sortState.key) {
              text += sortState.direction === 'asc' ? ' ▲' : ' ▼';
          }
          th.textContent = text.replace('AdmAt', 'Admissão').replace('PrevAlta', 'Prev. Alta');
      });
  }

  // ======================= MODAL FUNCTIONS (PLACEHOLDER) =======================
  function openAdmissao(leito) {
    console.log('Admissão do leito:', leito);
    // Implementar modal de admissão
  }

  function openAtualizacao(leito) {
    console.log('Atualização do leito:', leito);
    // Implementar modal de atualização
  }

  function darAltaFlow(leito) {
    console.log('Alta do leito:', leito);
    // Implementar fluxo de alta
  }

  function buildQRGrid() {
    console.log('Gerando QR codes');
    // Implementar geração de QR codes
  }

  function startScan() {
    console.log('Iniciando scan QR');
    // Implementar scanner QR
  }

  // ======================= EVENT LISTENERS =======================
  function setupEventListeners() {
    document.querySelectorAll(".tab").forEach(b=> b.onclick = ()=> setTab(b.dataset.tab) );
    $('#selHospital2').onchange = e=>{ setHospitalSelectors(e.target.value); loadHospital(e.target.value); };
    $("#btnH1").onclick = ()=>{ setHospitalSelectors("H1"); loadHospital("H1"); };
    $("#btnH2").onclick = ()=>{ setHospitalSelectors("H2"); loadHospital("H2"); };
    $("#btnRefresh").onclick = ()=>{ 
      logInfo("Refresh manual"); 
      if (activeTab === 'dashboard') { 
        loadAllData().then(() => renderDashboard()); 
      } else { 
        loadHospital(currentHospital); 
      } 
    };
    $("#btnScan").onclick = ()=>{ openModal("#modalQRScan"); startScan(); };
    document.querySelectorAll("[data-close]").forEach(b=> b.onclick = ()=> closeModal(b.getAttribute("data-close")) );
    $("#btnBulkQR").onclick = ()=> openModal("#modalBulkQR");
    $("#b_generate").onclick = buildQRGrid;

    document.querySelectorAll('#leitos2View th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.dataset.sort;
            if (sortState.key === key) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.direction = 'asc';
            }
            renderTable();
        });
    });
  }
  
  // ======================= INICIALIZAÇÃO =======================
  (async function init(){
    logInfo("=== INICIALIZANDO ARCHIPELAGO MVP ===");
    setupEventListeners();

    const p = new URLSearchParams(location.search);
    const h = p.get("h");
    const leito = Number(p.get("leito"));
    
    await testConnection();
    
    if(h && ["H1","H2"].includes(h) && leito > 0){
      logInfo(`🏥 MODO QR DETECTADO - Hospital: ${h}, Leito: ${leito}`);
      // QR Mode implementation would go here
    } else {
      logInfo("💼 MODO PORTAL DETECTADO - Sessão gestor iniciada");
      setHospitalSelectors("H1");
      setTab("dashboard");
      await loadAllData();
      renderDashboard();
      
      autoRefreshInterval = setInterval(async () => {
        logInfo("Auto-refresh executado");
        await loadAllData();
        if(activeTab === 'dashboard') renderDashboard();
      }, 60000);
      
      updateIndicatorInterval = setInterval(updateTimeIndicator, 1000);
    }
    logInfo("=== INICIALIZAÇÃO CONCLUÍDA ===");
  })();

  </script>
</body>
</html>
