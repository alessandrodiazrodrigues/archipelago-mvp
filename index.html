<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Protótipo MVP – Archipelago Dashboard</title>
  <style>
    :root{
      --brand:#0F3D73;      /* azul primário aproximado */
      --brand-2:#0B2C52;    /* azul escuro de apoio */
      --accent:#1F73B7;     /* azul médio para destaques */
      --bg:#f6f8fa;         /* fundo neutro */
      --text:#1f2937;       /* texto principal */
      --muted:#6b7280;      /* texto secundário */
      --success:#2ecc71;
      --warning:#f39c12;
      --danger:#e53935;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";color:var(--text);background:var(--bg)}
    header{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:10px;background:#fff1;
      display:grid;place-items:center;border:1px solid #ffffff30
    }
    .logo::after{content:"PS";font-weight:700;letter-spacing:1px}
    .title h1{margin:0;font-size:20px}
    .title small{display:block;color:#e6ecf5}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:#ffffff1a;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .tab.active{background:#fff;color:var(--brand);border-color:#fff}
    main{max-width:1100px;margin:24px auto;padding:0 16px 80px}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent;color:var(--brand);border-color:var(--brand)}
    .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:12px 0 18px}
    .stat{background:var(--card);border:1px solid var(--border);padding:14px;border-radius:12px}
    .stat .kpi{font-size:22px;font-weight:700}
    .grid{
      display:grid;grid-template-columns:repeat(5,minmax(0,1fr));
      gap:12px
    }
    @media (max-width:1000px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    @media (max-width:800px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;cursor:pointer;transition:transform .06s ease, box-shadow .06s ease
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 18px #00000012}
    .card .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#f9fafb;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.vago{background:var(--success)}
    .dot.ocupado{background:var(--warning)}
    .dot.alerta{background:var(--danger)}
    .mini{font-size:12px;color:var(--muted)}
    .h{margin:10px 0 2px;font-weight:700}
    .badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .con{font-size:11px;background:#eef2ff;border:1px solid #dbeafe;color:#1e40af}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:0 8px}
    .table td{background:var(--card);border:1px solid var(--border);padding:8px;border-radius:10px}
    .footer{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);
      padding:10px 16px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:#0b1a2a99;display:none;align-items:center;justify-content:center;padding:16px;z-index:1000
    }
    .modal{background:#fff;max-width:520px;width:100%;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 28px #00000024}
    .modal header{background:none;color:var(--text);display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modal .content{padding:16px}
    .field{margin-bottom:12px}
    .label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .input{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none
    }
    .input:focus{border-color:var(--brand);box-shadow:0 0 0 3px #0f3d7320}
    .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .danger{color:#b91c1c}
    .muted{color:var(--muted)}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid var(--border);background:#f9fafb;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-label="Prevent Senior logo" title="Prevent Senior"></div>
      <div class="title">
        <h1>Protótipo MVP – Archipelago Dashboard</h1>
        <small>Gestão de Leitos • Hospital Piloto (10 leitos)</small>
      </div>
    </div>
    <nav class="tabs" role="tablist" aria-label="Navegação principal">
      <button class="tab active" data-tab="leitos" aria-selected="true">Leitos</button>
      <button class="tab" data-tab="dashboard" aria-selected="false">Dashboard</button>
    </nav>
  </header>

  <main>
    <div class="toolbar">
      <div class="muted">Status em demonstração (dados fictícios)</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="btnLogin">Entrar com Google</button>
        <button class="btn" id="btnRefresh">Atualizar agora</button>
      </div>
    </div>

    <!-- KPIs (apenas na aba Dashboard) -->
    <section id="stats" class="stats hidden" aria-live="polite">
      <div class="stat">
        <div class="mini">Leitos em uso</div>
        <div class="kpi" id="kpiOcupados">–</div>
      </div>
      <div class="stat">
        <div class="mini">Leitos vagos</div>
        <div class="kpi" id="kpiVagos">–</div>
      </div>
      <div class="stat">
        <div class="mini">Altas previstas (próx. 24h)</div>
        <div class="kpi" id="kpiAltas24">–</div>
      </div>
    </section>

    <!-- Grid de Leitos -->
    <section id="leitosView" class="grid" aria-label="Leitos">
      <!-- cards gerados via JS -->
    </section>

    <!-- Tabela Dashboard -->
    <section id="dashboardView" class="hidden" aria-label="Painel Operacional">
      <table class="table" aria-describedby="descDashboard">
        <thead>
          <tr>
            <th>Leito</th>
            <th>Status</th>
            <th>Paciente</th>
            <th>Previsão de Alta</th>
            <th>Linha de Cuidado</th>
            <th>Concessões</th>
          </tr>
        </thead>
        <tbody id="dashBody">
          <!-- linhas via JS -->
        </tbody>
      </table>
    </section>
  </main>

  <!-- Modal de confirmação leve -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div id="modalTitle"><strong>Confirmação do paciente</strong></div>
        <button class="btn" id="btnCloseModal" aria-label="Fechar">Fechar</button>
      </header>
      <div class="content">
        <div class="field">
          <div class="label">Paciente atual</div>
          <div><strong id="pacienteNome"></strong> • Matrícula <span id="pacienteMatricula" class="pill"></span></div>
        </div>
        <div class="field">
          <div class="label">Data de nascimento</div>
          <div><span class="muted">__/</span><strong id="nascMes"></strong><span class="muted">/</span><strong id="nascAno"></strong></div>
          <div class="mini" style="margin-top:4px">Para continuar, digite apenas o <strong>dia</strong> (DD) de nascimento.</div>
        </div>
        <div class="field">
          <label class="label" for="inputDia">Dia (DD)</label>
          <input id="inputDia" class="input" inputmode="numeric" pattern="[0-9]*" maxlength="2" placeholder="DD" aria-describedby="diaHelp" />
          <div id="diaHelp" class="mini">Ex.: 08</div>
        </div>
        <div id="msgErro" class="danger hidden">Dia não confere. Tente novamente.</div>
      </div>
      <div class="actions">
        <button class="btn" id="btnCancelar">Cancelar</button>
        <button class="btn primary" id="btnConfirmar">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>© Protótipo ilustrativo para validação de fluxo (sem dados reais).</div>
    <div><strong>Desesenvolfo por Alessandro Diaz Rodrigues</strong></div>
  </div>

  <script>
    // --- Dados fictícios para demonstração ---
    const concessoesCatalogo = ["Fisioterapia","Nutricionista","Psicólogo","Psiquiatra","Raio-X","Medicação"];
    const leitos = Array.from({length:10}).map((_,i)=>{
      const id = i+1;
      // alterna Vago/Em uso apenas para ilustrar
      const emUso = id % 3 !== 0; // 1,2 em uso; 3 vago; 4,5 em uso; 6 vago; etc.
      const nome = emUso ? ["Maria Aparecida Silva","João Pedro Santos","Ana Paula Reis","Carlos Souza","Luciana Matos","Paulo Andrade","Beatriz Gomes","Rafael Lima","Sônia Oliveira","Marcelo Freitas"][i] : "";
      const iniciais = nome ? nome.split(" ").map(n=>n[0]).slice(0,2).join("") : "";
      const matricula = emUso ? String(100000+i) : "";
      const previsaoBucket = emUso ? (id%2===0? "24h" : (id%5===0?"72h":"48h")) : "";
      const now = new Date();
      const horas = previsaoBucket==="24h"?24:previsaoBucket==="48h"?48:previsaoBucket==="72h"?72:96;
      const previsaoAt = new Date(now.getTime()+horas*3600*1000);
      const linhaCuidado = emUso ? (id%2===0?"Geriatria":"APS") : "";
      const pps = emUso ? (50 + (i%4)*10) : null;
      const spict = emUso ? (i%4===0) : false;
      const acordo = emUso ? concessoesCatalogo.filter((_,k)=> (k+i)%3===0 ) : [];
      // Data de nascimento simulada
      const ano = emUso ? 1948 + (i*3)%50 : null;
      const mes = emUso ? ( (i%12)+1 ) : null;
      const dia = emUso ? ( (i%28)+1 ) : null;
      const dataEntrada = emUso ? new Date(now.getTime()- (i+2)*3600*1000) : null;
      return {
        id, status: emUso?"Em uso":"Vago",
        paciente: {nome, iniciais, matricula, dia, mes, ano},
        previsaoBucket, previsaoAt, linhaCuidado, pps, spict, concessoes: acordo, dataEntrada
      }
    });

    // Estado de UI
    let activeTab = "leitos";
    let selectedLeito = null;
    let failCountByLeito = {}; // contador de tentativas no protótipo

    // Elementos
    const tabs = document.querySelectorAll(".tab");
    const leitosView = document.getElementById("leitosView");
    const dashboardView = document.getElementById("dashboardView");
    const stats = document.getElementById("stats");
    const kpiOcupados = document.getElementById("kpiOcupados");
    const kpiVagos = document.getElementById("kpiVagos");
    const kpiAltas24 = document.getElementById("kpiAltas24");
    const dashBody = document.getElementById("dashBody");

    // Modal
    const modalBackdrop = document.getElementById("modalBackdrop");
    const pacienteNome = document.getElementById("pacienteNome");
    const pacienteMatricula = document.getElementById("pacienteMatricula");
    const nascMes = document.getElementById("nascMes");
    const nascAno = document.getElementById("nascAno");
    const inputDia = document.getElementById("inputDia");
    const btnConfirmar = document.getElementById("btnConfirmar");
    const btnCancelar = document.getElementById("btnCancelar");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const msgErro = document.getElementById("msgErro");

    // Tabs
    tabs.forEach(t=>t.addEventListener("click",()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      t.classList.add("active");
      activeTab = t.dataset.tab;
      if(activeTab==="dashboard"){
        stats.classList.remove("hidden");
        dashboardView.classList.remove("hidden");
        leitosView.classList.add("hidden");
        renderDashboard();
      }else{
        stats.classList.add("hidden");
        dashboardView.classList.add("hidden");
        leitosView.classList.remove("hidden");
      }
    }));

    // Renderização do grid de leitos
    function renderLeitos(){
      leitosView.innerHTML = "";
      leitos.forEach(l=>{
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("role","button");
        card.setAttribute("aria-label", `Leito ${l.id} ${l.status}`);
        card.innerHTML = `
          <div class="row">
            <div class="badge"><span class="dot ${l.status==='Em uso'?'ocupado':'vago'}"></span> Leito ${l.id}</div>
            <div class="mini">${l.status==='Em uso' ? timeTo(l.previsaoAt) : 'Vago'}</div>
          </div>
          <div class="h">${l.status==='Em uso'? (l.paciente.iniciais || '—') : '—'}</div>
          <div class="mini">${l.status==='Em uso'? (l.linhaCuidado || '') : ''}</div>
          <div class="badges">
            ${l.concessoes.map(c=>`<span class="con">${c}</span>`).join("")}
          </div>
        `;
        card.addEventListener("click",()=>openLeito(l.id));
        leitosView.appendChild(card);
      });
    }

    // Renderização do dashboard
    function renderDashboard(){
      const ocupados = leitos.filter(l=>l.status==="Em uso").length;
      const vagos = leitos.length - ocupados;
      const now = new Date();
      const altas24 = leitos.filter(l=>l.status==="Em uso" && (l.previsaoAt - now) <= (24*3600*1000)).length;
      kpiOcupados.textContent = ocupados;
      kpiVagos.textContent = vagos;
      kpiAltas24.textContent = altas24;
      dashBody.innerHTML = "";
      leitos
        .slice()
        .sort((a,b)=> (a.previsaoAt||Infinity) - (b.previsaoAt||Infinity))
        .forEach(l=>{
          const tr = document.createElement("tr");
          const conc = l.concessoes.length? l.concessoes.join(", ") : "—";
          tr.innerHTML = `
            <td><span class="badge"><span class="dot ${l.status==='Em uso'?'ocupado':'vago'}"></span> ${l.id}</span></td>
            <td>${l.status}</td>
            <td>${l.status==='Em uso'? (l.paciente.nome) : '—'}</td>
            <td>${l.status==='Em uso'? timeTo(l.previsaoAt) : '—'}</td>
            <td>${l.status==='Em uso'? (l.linhaCuidado||'—') : '—'}</td>
            <td>${conc}</td>
          `;
          dashBody.appendChild(tr);
        });
    }

    // Abrir um leito (via clique ou simulação de QR: ?leito=ID)
    function openLeito(id){
      const l = leitos.find(x=>x.id===id);
      selectedLeito = id;
      if(!l) return;
      if(l.status==="Vago"){
        alert(`Leito ${id} está Vago. (No MVP funcional, aqui abre a tela de Admissão.)`);
        return;
      }
      // Em uso: abrir modal de confirmação (nome + __/MM/AAAA + input DD)
      pacienteNome.textContent = l.paciente.nome;
      pacienteMatricula.textContent = l.paciente.matricula;
      nascMes.textContent = String(l.paciente.mes).padStart(2,"0");
      nascAno.textContent = String(l.paciente.ano);
      inputDia.value = "";
      msgErro.classList.add("hidden");
      modalBackdrop.style.display = "flex";
      modalBackdrop.setAttribute("aria-hidden","false");
      setTimeout(()=>inputDia.focus(), 100);
    }

    // Modal handlers
    function closeModal(){
      modalBackdrop.style.display = "none";
      modalBackdrop.setAttribute("aria-hidden","true");
    }
    btnCloseModal.addEventListener("click", closeModal);
    btnCancelar.addEventListener("click", closeModal);

    btnConfirmar.addEventListener("click", ()=>{
      const id = selectedLeito;
      const l = leitos.find(x=>x.id===id);
      const dia = Number(inputDia.value);
      failCountByLeito[id] = failCountByLeito[id] || 0;

      if(String(dia).padStart(2,"0") === String(l.paciente.dia).padStart(2,"0")){
        // OK
        msgErro.classList.add("hidden");
        failCountByLeito[id] = 0;
        closeModal();
        alert(`Confirmação OK. (No MVP funcional, aqui liberamos Atualização/Alta do Leito ${id}.)`);
      }else{
        failCountByLeito[id]++;
        msgErro.classList.remove("hidden");
        if(failCountByLeito[id] >= 3){
          btnConfirmar.disabled = true;
          setTimeout(()=>{
            btnConfirmar.disabled = false;
            failCountByLeito[id] = 0;
            msgErro.classList.add("hidden");
          }, 120000); // 2 minutos
        }
      }
    });

    // Utilitário: tempo restante formatado
    function timeTo(date){
      if(!date) return "—";
      const now = new Date();
      const diff = Math.max(0, date - now);
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      return `Alta em ${String(h).padStart(2,"0")}h ${String(m).padStart(2,"0")}m`;
    }

    // Polling leve (simulado aqui com re-render)
    let interval = null;
    function startPolling(){
      if(interval) clearInterval(interval);
      interval = setInterval(()=>{
        // no protótipo estático, apenas re-renderiza
        if(activeTab==="dashboard"){ renderDashboard(); }
        else { renderLeitos(); }
      }, 8000);
    }

    // Botões
    document.getElementById("btnLogin").addEventListener("click",()=>{
      alert("Simulação de login com Google. (No MVP funcional, usar Google Identity Services.)");
    });
    document.getElementById("btnRefresh").addEventListener("click",()=>{
      if(activeTab==="dashboard"){ renderDashboard(); } else { renderLeitos(); }
    });

    // Nav por query (?leito=ID) para simular QR Code
    function checkQRParam(){
      const params = new URLSearchParams(location.search);
      const leito = Number(params.get("leito"));
      if(leito>=1 && leito<=10){
        setTimeout(()=>openLeito(leito), 300);
      }
    }

    // Inicialização
    renderLeitos();
    renderDashboard();
    startPolling();
    checkQRParam();
  </script>
</body>
</html>
