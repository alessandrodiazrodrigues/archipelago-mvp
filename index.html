<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago Dashboard</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* =================== VARIAVEIS GLOBAIS - CORES ORIGINAIS DO PROJETO =================== */
    :root {
      /* Layout Principal - CORES EXATAS DAS IMAGENS */
      --nav-sidebar: #0a2b52;
      --nav-header: linear-gradient(90deg, #0a2b52, #083052);
      --bg-primary: #0a0f1c;
      --bg-secondary: #060b14;
      --card: #1a1f2e;
      --card-hover: #242938;
      --text-white: #ffffff;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --text-accent: #60a5fa;
      --border: #334155;
      --border-light: #475569;

      /* Status e Complexidade */
      --status-vago: #16a34a;
      --status-uso: #f59e0b;
      --status-uti: #dc2626;
      --complex-1: #22c55e;
      --complex-2: #f59e0b;
      --complex-3: #dc2626;

      /* Timeline 24h */
      --ouro: #fbbf24;
      --r2: #3b82f6;
      --r3: #8b5cf6;

      /* Linhas de Cuidado - CORES ORIGINAIS */
      --linha-aps: #f59e0b;
      --linha-assistencia: #0a2b52;
      --linha-cardiologia: #dc2626;
      --linha-geriatria: #16a34a;
      --linha-melhor: #be185d;
      --linha-neurologia: #0891b2;
      --linha-pneumologia: #8b5cf6;

      /* Concessões - CORES ORIGINAIS */
      --conc-aspiracoes: #dc2626;
      --conc-curativos: #8b5cf6;
      --conc-fisioterapia: #16a34a;
      --conc-fonoaudiologia: #f59e0b;
      --conc-pad: #0a2b52;

      /* Cores específicas dos gráficos originais */
      --gauge-verde: #16a34a;
      --gauge-amarelo: #f59e0b;
      --gauge-laranja: #fb923c;

      /* Sombras e Efeitos */
      --shadow: 0 4px 12px rgba(11,44,82,.08);
      --shadow-2: 0 10px 28px rgba(11,44,82,.12);
      --gradient-header: linear-gradient(90deg, #0a2b52, #083052);
      --gradient-card: linear-gradient(145deg, var(--card) 0%, var(--card-hover) 100%);
      --gradient-button: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    /* =================== BASE STYLES =================== */
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0; overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text);
    }

    /* =================== LOADING OVERLAY =================== */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(10px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000; transition: opacity 0.3s ease;
    }

    .loading-spinner {
      width: 60px; height: 60px; border: 3px solid var(--border);
      border-top: 3px solid var(--text-accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 15px; font-size: 16px; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loadingOverlay.hidden { display: none; }

    /* =================== HEADER E NAVEGAÇÃO =================== */
    header {
      background: var(--gradient-header);
      color: var(--text-white); padding: 15px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-2);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 20px; }
    .hamburger-menu { font-size: 24px; cursor: pointer; }
    .brand h1 {
      margin: 0; font-size: 20px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    .header-right {
      display: flex; align-items: center; gap: 16px;
    }

    #lastUpdateInfo {
      font-size: 12px; color: var(--text-muted);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-btn {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text); border-radius: 10px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease; position: relative;
    }

    .header-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
    }

    @media (max-width: 1024px) {
      body { padding-left: 0; }
      #side-menu { left: -300px; }
      #side-menu.open { left: 0; }
    }

    /* =================== MENU LATERAL (300px) =================== */
    #side-menu {
      position: fixed; top: 0; left: 0; width: 300px; height: 100%;
      background: linear-gradient(180deg, var(--nav-sidebar) 0%, var(--bg-primary) 100%);
      box-shadow: var(--shadow-2);
      border-right: 1px solid var(--border);
      z-index: 1001; padding-top: 80px;
      transition: left 0.3s ease; display: flex; flex-direction: column;
    }

    body { padding-left: 300px; }

    .menu-header {
      position: absolute; top: 20px; left: 20px; right: 20px;
      display: flex; justify-content: flex-end;
    }

    .close-menu-btn {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease; font-size: 12px;
    }

    .close-menu-btn:hover {
      background: rgba(96, 165, 250, 0.2);
    }

    .menu-items {
      flex: 1; padding: 0 0 120px 0; overflow-y: auto;
    }

    .side-menu-item {
      display: flex; align-items: center; gap: 15px;
      padding: 20px 25px; color: var(--text); text-decoration: none;
      font-size: 16px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-left: 4px solid transparent;
      transition: all 0.3s ease; height: 60px;
    }

    .side-menu-item:hover {
      background: rgba(96, 165, 250, 0.1);
      border-left-color: var(--text-accent);
    }

    .side-menu-item.active {
      background: rgba(96, 165, 250, 0.2);
      border-left-color: var(--text-accent);
      color: var(--text-accent);
    }

    .menu-footer {
      position: absolute; bottom: 20px; left: 20px; right: 20px;
    }

    .settings-menu-btn {
      width: 100%; background: rgba(96, 165, 250, 0.1); 
      border: 1px solid var(--border); color: var(--text); 
      border-radius: 12px; padding: 15px; cursor: pointer; 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; 
      transition: all 0.3s ease; display: flex; align-items: center; 
      justify-content: center; gap: 10px; position: relative;
    }

    .settings-menu-btn:hover {
      background: rgba(96, 165, 250, 0.2);
    }

    .settings-dropdown-menu {
      display: none; position: absolute; bottom: 110%; left: 0; right: 0;
      background: var(--card); border-radius: 12px; box-shadow: var(--shadow);
      overflow: hidden; border: 1px solid var(--border); margin-bottom: 10px;
    }

    .settings-dropdown-menu.show { display: block; }

    .settings-dropdown-item {
      padding: 12px 15px; color: var(--text); font-size: 14px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    }

    .settings-dropdown-item:last-child {
      border-bottom: none;
    }

    .settings-dropdown-item:hover {
      background: var(--card-hover);
    }

    /* =================== MAIN CONTENT =================== */
    main {
      max-width: 1600px; margin: 18px auto 100px; padding: 0 24px;
      background: rgba(26, 31, 46, 0.3); border-radius: 20px;
      backdrop-filter: blur(10px); border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* =================== TOOLBAR REDESENHADO PARA SELETOR DE HOSPITAL =================== */
    .hospital-selector {
      background: rgba(26, 31, 46, 0.5); 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 24px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .hospital-selector h3 {
      color: var(--text-accent);
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0;
    }

    .hospital-buttons {
      display: flex;
      gap: 12px;
    }

    .hospital-btn {
      background: rgba(96, 165, 250, 0.1);
      border: 2px solid var(--border);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
    }

    .hospital-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      border-color: var(--text-accent);
    }

    .hospital-btn.active {
      background: var(--gradient-button);
      border-color: var(--text-accent);
      color: var(--text-white);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    /* KPI com gauge centralizado */
    .kpi-card-with-gauge {
      position: relative; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .kpi-gauge-mini {
      width: 80px; 
      height: 50px;
      margin-bottom: 10px;
    }

    .kpi-gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      margin-top: -10px;
    }

    /* Separadores discretos */
    .section-divider {
      width: 1px;
      background: rgba(148, 163, 184, 0.3);
      height: 250px;
      margin: 0 20px;
    }

    .horizontal-divider {
      height: 1px;
      background: rgba(148, 163, 184, 0.3);
      margin: 20px 0;
      width: 100%;
    }

    /* =================== CARDS DE LEITOS =================== */
    .grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 18px; position: relative; z-index: 1;
    }

    .card {
      background: var(--card); border-radius: 20px; padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transform: translateY(0); transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16), 0 26px 64px rgba(11,44,82,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
    }

    .card .top {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; margin-bottom: 10px;
    }

    .badge {
      background: rgba(96, 165, 250, 0.1); border: 1px solid var(--border);
      color: var(--text-accent); font-size: 12px; padding: 4px 10px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status {
      background: var(--card); border: 1px solid var(--border);
      color: var(--text); font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 4px 10px; border-radius: 999px;
      display: inline-flex; align-items: center; gap: 6px;
    }

    .status.ok {
      background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);
      color: var(--status-vago);
    }

    .status.warn {
      background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);
      color: var(--status-uso);
    }

    .tipo {
      font-size: 12px; color: var(--text-white); padding: 4px 8px;
      border-radius: 999px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tipo.uti {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
    }

    .tipo.enf {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }

    .row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }

    .field {
      background: rgba(96, 165, 250, 0.05); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px; backdrop-filter: blur(5px);
    }

    .field .label {
      font-size: 11px; color: var(--text-muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .field .value {
      color: var(--text); font-weight: 600;
    }

    .wrap { display: flex; flex-wrap: wrap; gap: 6px; }

    .chip {
      font-size: 12px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-accent);
      padding: 2px 8px; border-radius: 999px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .actions {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;
    }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); padding: 10px 14px; border-radius: 12px;
      cursor: pointer; transition: all 0.2s ease; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn.primary {
      background: var(--gradient-button); border-color: var(--text-accent);
      color: var(--text-white); box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .btn.danger {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
      border-color: var(--status-uti); color: var(--text-white);
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
    }

    /* =================== DASHBOARDS =================== */
    .dash-grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .grid-6 { grid-template-columns: repeat(6, 1fr); }
    .grid-7 { grid-template-columns: repeat(7, 1fr); }

    @media (max-width: 1200px) {
      .grid-2 { grid-template-columns: 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
      .grid-7 { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 900px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-6 { grid-template-columns: repeat(2, 1fr); }
      .grid-7 { grid-template-columns: repeat(2, 1fr); }
    }

    .dashboard-card {
      background: var(--card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 20px; 
      box-shadow: var(--shadow); margin-bottom: 24px;
    }

    .dashboard-card h3 {
      margin: 0 0 15px 0; font-size: 18px; color: var(--text-accent);
      text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .dashboard-card h4 {
      margin: 20px 0 10px 0; font-size: 14px; color: var(--text-white);
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .kpi-card {
      background: var(--card); border: 1px solid var(--border); 
      border-radius: 16px; padding: 15px; text-align: center; 
      position: relative; box-shadow: var(--shadow);
    }

    .kpi-value {
      font-size: 36px; font-weight: 700; color: var(--text-accent);
    }

    .kpi-label {
      font-size: 13px; color: var(--text-muted); margin-top: 5px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    /* Gauge específico para Dashboard Hospitais */
    .dash-hospital-header { 
      display: flex; align-items: center; gap: 24px; margin-bottom: 20px; 
    }
    
    .gauge-wrapper { 
      position: relative; width: 150px; height: 100px; 
    }
    
    .gauge-wrapper canvas { 
      width: 100% !important; height: auto !important; 
    }
    
    .gauge-text { 
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); 
      text-align: center; 
    }
    
    .gauge-text .percent { 
      font-size: 24px; font-weight: 700; color: var(--text-accent); 
    }

    .gauge-text .label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .header-stats { 
      flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
    }
    
    .header-stats .stat-box { 
      padding: 10px; text-align: left; background: rgba(96, 165, 250, 0.1); 
      border-radius: 10px; border: 1px solid var(--border);
    }

    .header-stats .stat-value { 
      font-size: 22px; font-weight: bold; color: var(--text-accent); 
    }

    .header-stats .stat-label { 
      font-size: 11px; color: var(--text-muted); 
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .chart-container { position: relative; width: 100%; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    /* Switch de visualização */
    .view-switcher {
      display: flex; gap: 8px; margin-bottom: 15px; justify-content: center;
    }

    .view-switch-btn {
      padding: 6px 12px; font-size: 12px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-muted);
      border-radius: 8px; cursor: pointer; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;
    }

    .view-switch-btn.active {
      background: var(--gradient-button); color: var(--text-white);
      border-color: var(--text-accent);
    }

    /* =================== MODAIS =================== */
    .backdrop {
      position: fixed; inset: 0; background: rgba(10, 15, 28, 0.8);
      backdrop-filter: blur(10px); display: none; align-items: center;
      justify-content: center; padding: 16px; z-index: 1000; overflow: auto;
    }

    .modal {
      background: var(--gradient-card); max-width: 860px; width: 100%;
      max-height: 90vh; border-radius: 20px; border: 1px solid var(--border);
      box-shadow: var(--shadow-hover); overflow: hidden;
      display: flex; flex-direction: column; backdrop-filter: blur(15px);
    }

    .modal header {
      background: var(--gradient-header); border-bottom: 1px solid var(--border);
      color: var(--text-white); display: flex; align-items: center;
      justify-content: space-between; padding: 12px 16px; flex-shrink: 0;
    }

    .modal header strong {
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .modal .content {
      padding: 16px; overflow-y: auto; flex: 1;
    }

    .modal .actions {
      background: rgba(26, 31, 46, 0.5); border-top: 1px solid var(--border);
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 12px 16px; flex-shrink: 0;
    }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    .input, .select2, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 12px; background: var(--card); color: var(--text);
      font-weight: 600;
    }

    .label {
      font-size: 12px; color: var(--text-muted); margin-bottom: 4px;
      display: block; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* =================== UTILIDADES =================== */
    .hidden { display: none; }

    .success-message {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--gradient-card); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px; text-align: center;
      box-shadow: var(--shadow-hover); z-index: 3000; display: none;
      color: var(--text); backdrop-filter: blur(15px);
    }

    .success-message h2 {
      color: var(--text-accent); font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* =================== RESPONSIVIDADE =================== */
    @media (max-width: 1024px) {
      body { padding-left: 0; }
      #side-menu { left: -300px; }
      #side-menu.open { left: 0; }
    }

    /* =================== IMPRESSÃO DE QR CODES =================== */
    @media print {
      /* Ocultar tudo exceto o modal de QR */
      body * {
        visibility: hidden;
      }
      
      #modalBulkQR, #modalBulkQR * {
        visibility: visible;
      }
      
      #modalBulkQR {
        position: static !important;
        background: white !important;
        box-shadow: none !important;
        border: none !important;
        max-width: none !important;
        max-height: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        overflow: visible !important;
      }
      
      #modalBulkQR .modal {
        position: static !important;
        background: white !important;
        box-shadow: none !important;
        border: none !important;
        max-width: none !important;
        max-height: none !important;
        margin: 0 !important;
        padding: 20px !important;
        width: 100% !important;
        height: 100% !important;
        overflow: visible !important;
      }
      
      #modalBulkQR header,
      #modalBulkQR .actions,
      #modalBulkQR .content > div:first-child {
        display: none !important;
      }
      
      #qr_grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 20px !important;
        page-break-inside: avoid;
      }
      
      .qr-cell {
        background: white !important;
        border: 2px solid #333 !important;
        border-radius: 10px !important;
        padding: 15px !important;
        text-align: center !important;
        page-break-inside: avoid;
        min-height: 250px !important;
      }
      
      .qr-cell canvas,
      .qr-cell img {
        max-width: 160px !important;
        max-height: 160px !important;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <!-- Menu Lateral -->
  <div id="side-menu">
    <!-- Header do Menu com Botão Fechar -->
    <div class="menu-header">
      <button class="close-menu-btn" id="closeMenuBtn">
        ← Fechar
      </button>
    </div>

    <!-- Items do Menu -->
    <div class="menu-items">
      <a href="#" class="side-menu-item active" data-tab="leitos">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2.5 12a.5.5 0 0 1 .5-.5h18a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
          <path d="M20 16H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2zM9 8H7v6h2V8z"/>
        </svg>
        <span>Leitos (Cards)</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash1">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 20v-6M12 8V2M4.93 4.93l4.24 4.24M14.83 14.83l4.24 4.24M17.66 6.34l-4.24 4.24M6.34 17.66l-4.24 4.24M22 12h-6M8 12H2"/>
        </svg>
        <span>Dash Hospitais</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash2">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 20V10M12 20V4M6 20V14"/>
        </svg>
        <span>Dashboard Executivo</span>
      </a>
    </div>

    <!-- Footer do Menu com Configurações -->
    <div class="menu-footer">
      <button class="settings-menu-btn" id="settingsMenuBtn">
        <span>⚙️</span>
        <span>Configurações</span>
        <div class="settings-dropdown-menu" id="settingsMenuDropdown">
          <div class="settings-dropdown-item" id="btnReadQR">Ler QR Code</div>
          <div class="settings-dropdown-item" id="btnPrintQR">Imprimir QR Codes</div>
          <div class="settings-dropdown-item" id="btnCores">Configurar Cores</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-left">
      <div class="hamburger-menu" id="hamburgerMenu">☰</div>
      <div class="brand">
        <h1>Archipelago Dashboard</h1>
      </div>
    </div>
    
    <div class="header-right">
      <span id="lastUpdateInfo"></span>
      <button class="header-btn" id="refreshBtn">Atualizar</button>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Toolbar para seleção de hospital -->
    <div class="hospital-selector" id="hospitalSelector" style="display: none;">
      <h3>Selecionar Hospital:</h3>
      <div class="hospital-buttons">
        <button class="hospital-btn active" data-h="H1" id="btnH1New">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          Neomater
        </button>
        <button class="hospital-btn" data-h="H2" id="btnH2New">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          Cruz Azul
        </button>
      </div>
    </div>

    <!-- Leitos View -->
    <section id="leitosView" class="grid"></section>

    <!-- Dashboard Hospitais -->
    <section id="dash1" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dash Hospitais: Visão Detalhada por Hospital</h2>
      <div class="dash-grid grid-2">
        <!-- Neomater -->
        <div class="dashboard-card" id="dash-card-h1">
          <h3>Neomater</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacaoH1"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercentH1">0%</div>
                <div class="label">Ocupação</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statTotalH1">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statOcupadosH1">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagosH1">0</div>
                <div class="stat-label">Vagos</div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <h4>Projeção de Concessões</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoesH1"></canvas>
          </div>

          <h4>Projeção de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhasH1"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidadeH1"></canvas>
          </div>
        </div>

        <!-- Cruz Azul -->
        <div class="dashboard-card" id="dash-card-h2">
          <h3>Cruz Azul</h3>
          
          <!-- Header com Gauge e Stats -->
          <div class="dash-hospital-header">
            <div class="gauge-wrapper">
              <canvas id="chartOcupacaoH2"></canvas>
              <div class="gauge-text">
                <div class="percent" id="gaugePercentH2">0%</div>
                <div class="label">Ocupação</div>
              </div>
            </div>
            <div class="header-stats">
              <div class="stat-box">
                <div class="stat-value" id="statTotalH2">0</div>
                <div class="stat-label">Total Leitos</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statOcupadosH2">0</div>
                <div class="stat-label">Ocupados</div>
              </div>
              <div class="stat-box">
                <div class="stat-value" id="statVagosH2">0</div>
                <div class="stat-label">Vagos</div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <h4>Projeção de Concessões</h4>
          <div class="chart-container h-250">
            <canvas id="chartConcessoesH2"></canvas>
          </div>

          <h4>Projeção de Linhas de Cuidado</h4>
          <div class="chart-container h-250">
            <canvas id="chartLinhasH2"></canvas>
          </div>

          <h4>Complexidade</h4>
          <div class="chart-container h-250">
            <canvas id="chartComplexidadeH2"></canvas>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Dashboard Executivo -->
    <section id="dash2" class="hidden">
      <h2 style="margin-bottom:20px; color: var(--text-white);">Dashboard Executivo: Rede Hospitalar Externa</h2>
      
      <!-- KPIs Operacionais Consolidados -->
      <div class="dashboard-card">
        <h3>KPIs Operacionais Consolidados</h3>
        <div class="dash-grid grid-7">
          <div class="kpi-card kpi-card-with-gauge">
            <div class="kpi-gauge-mini">
              <canvas id="kpiGaugeOcupacao"></canvas>
              <div class="kpi-gauge-text">
                <div class="kpi-value" id="kpiOcupacaoGeral" style="font-size: 24px;">0%</div>
              </div>
            </div>
            <div class="kpi-label">Taxa de Ocupação Geral</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiLeitosOcupados">0</div>
            <div class="kpi-label">Total de Leitos Ocupados</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiTMP">0 dias</div>
            <div class="kpi-label">Tempo Médio Permanência</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiRotatividade">0%</div>
            <div class="kpi-label">Taxa de Rotatividade</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiAltas24h">0</div>
            <div class="kpi-label">Altas Previstas em 24h</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiSpictPercent">0%</div>
            <div class="kpi-label">SPICT-BR Elegível</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpiPpsMedia">0</div>
            <div class="kpi-label">PPS Média Geral</div>
          </div>
        </div>
      </div>

      <!-- Análise Preditiva de Altas -->
      <div class="dashboard-card">
        <h3>Análise Preditiva de Altas</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Comparativo por Prazo</h4>
            <div class="chart-container h-250">
              <canvas id="chartAltasComparativo"></canvas>
            </div>
          </div>
          <div>
            <h4>Timeline de Liberação em 24h</h4>
            <div class="chart-container h-250">
              <canvas id="chartTimeline24h"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Projeções Consolidadas -->
      <div class="dashboard-card">
        <h3>Projeções Consolidadas (7 dias)</h3>
        <div class="view-switcher">
          <button class="view-switch-btn active" data-mode="separate">Barras Separadas</button>
          <button class="view-switch-btn" data-mode="stacked">Barras Empilhadas</button>
        </div>
        <div class="dash-grid grid-2">
          <div>
            <h4>Concessões Necessárias</h4>
            <div class="chart-container h-300">
              <canvas id="chartConcessoesConsolidado"></canvas>
            </div>
          </div>
          <div>
            <h4>Linhas de Cuidado</h4>
            <div class="chart-container h-300">
              <canvas id="chartLinhasConsolidado"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Análises PPS e SPICT -->
      <div class="dashboard-card">
        <h3>Análise de Indicadores Clínicos</h3>
        <div class="dash-grid grid-2">
          <div>
            <h4>Análise PPS (Performance Status)</h4>
            <div class="chart-container h-250">
              <canvas id="chartPpsAnalise"></canvas>
            </div>
          </div>
          <div>
            <h4>Análise SPICT-BR</h4>
            <div class="chart-container h-250">
              <canvas id="chartSpictAnalise"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Eficiência Operacional -->
      <div class="dashboard-card">
        <h3>Eficiência Operacional</h3>
        <div class="chart-container h-400">
          <canvas id="chartEficienciaRadar"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Admissão -->
  <div id="modalAdmissao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Admissão de Paciente</strong>
        <button class="btn" data-close="#modalAdmissao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="a_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="a_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="a_tipo" class="badge"></div></div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label class="label" for="a_nome">Nome completo</label>
            <input id="a_nome" class="input" />
          </div>
          <div>
            <label class="label" for="a_idade">Idade</label>
            <input id="a_idade" class="input" inputmode="numeric" />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_matricula">Matrícula (número)</label>
            <input id="a_matricula" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_pps">PPS (0–10)</label>
            <input id="a_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="a_spict">SPICT-BR</label>
            <select id="a_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="a_complexidade">Complexidade</label>
            <select id="a_complexidade" class="select2">
              <option value="I">Nível I</option>
              <option value="II">Nível II</option>
              <option value="III">Nível III</option>
            </select>
          </div>
          <div>
            <label class="label" for="a_prev">Previsão de alta</label>
            <select id="a_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="a_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="a_concessoes" class="wrap"></div>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--text-muted);font-size:12px">
          * Data e hora de admissão serão registradas automaticamente ao salvar.
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="a_cancel">Cancelar</button>
        <button class="btn primary" id="a_save">Salvar e Admitir</button>
      </div>
    </div>
  </div>

  <!-- Modal Atualização -->
  <div id="modalAtualizacao" class="backdrop">
    <div class="modal">
      <header>
        <strong>Atualização de Paciente</strong>
        <button class="btn" data-close="#modalAtualizacao">Fechar</button>
      </header>
      <div class="content">
        <div class="row3">
          <div><span class="label">Hospital</span><div id="u_hospital" class="badge"></div></div>
          <div><span class="label">Leito</span><div id="u_leito" class="badge"></div></div>
          <div><span class="label">Tipo</span><div id="u_tipo" class="badge"></div></div>
        </div>
        <div class="row3" style="margin-top:10px">
          <div>
            <label class="label">Nome (bloqueado)</label>
            <input id="u_nome" class="input" disabled />
          </div>
          <div>
            <label class="label">Matrícula (bloqueado)</label>
            <input id="u_matricula" class="input" disabled />
          </div>
          <div>
            <label class="label">Admissão (bloqueado)</label>
            <input id="u_adm" class="input" disabled />
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_idade">Idade</label>
            <input id="u_idade" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_pps">PPS (0–10)</label>
            <input id="u_pps" class="input" inputmode="numeric" />
          </div>
          <div>
            <label class="label" for="u_spict">SPICT-BR</label>
            <select id="u_spict" class="select2">
              <option value="elegivel">Elegível</option>
              <option value="nao_elegivel">Não elegível</option>
            </select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label class="label" for="u_complexidade">Complexidade</label>
            <select id="u_complexidade" class="select2">
              <option value="I">Nível I</option>
              <option value="II">Nível II</option>
              <option value="III">Nível III</option>
            </select>
          </div>
          <div>
            <label class="label" for="u_prev">Previsão de alta</label>
            <select id="u_prev" class="select2">
              <option>24h Ouro</option><option>24h 2R</option><option>24h 3R</option>
              <option>48h</option><option>72h</option><option>96h</option><option>Sem previsao</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row2">
          <div>
            <span class="label">Linhas de cuidado (multi)</span>
            <div id="u_linhas" class="wrap"></div>
          </div>
          <div>
            <span class="label">Concessões (multi)</span>
            <div id="u_concessoes" class="wrap"></div>
          </div>
        </div>
        <div id="internadoHa" style="margin-top:8px;color:var(--text-muted);font-size:12px"></div>
      </div>
      <div class="actions">
        <button class="btn" id="u_cancel">Cancelar</button>
        <button class="btn primary" id="u_save">Salvar</button>
        <button class="btn danger" id="u_alta">Dar Alta</button>
      </div>
    </div>
  </div>

  <!-- Outros Modais (QR, Confirmação, etc.) -->
  <div id="modalConfirm" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Confirmação</strong></header>
      <div class="content"><div id="confirmMsg">Confirma?</div></div>
      <div class="actions">
        <button class="btn" id="confirmNo">Não</button>
        <button class="btn primary" id="confirmYes">Sim</button>
      </div>
    </div>
  </div>

  <div id="modalQRScan" class="backdrop">
    <div class="modal">
      <header><strong>Ler QR Code</strong><button class="btn" data-close="#modalQRScan">Fechar</button></header>
      <div class="content">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-muted)">Se a câmera não abrir, use a seleção manual.</div>
        <div id="qrRegion" style="width:100%;max-width:420px;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      </div>
      <div class="actions"><button class="btn" data-close="#modalQRScan">Cancelar</button></div>
    </div>
  </div>

  <div id="modalBulkQR" class="backdrop">
    <div class="modal" style="max-width:90vw;max-height:90vh">
      <header>
        <strong>Gerar QR Codes para impressão</strong>
        <button class="btn" data-close="#modalBulkQR">✕</button>
      </header>
      <div class="content" style="overflow-y:auto">
        <div class="row3">
          <div>
            <label class="label" for="b_hospital">Hospital</label>
            <select id="b_hospital" class="select2">
              <option value="H1">Neomater</option>
              <option value="H2">Cruz Azul</option>
            </select>
          </div>
          <div>
            <label class="label" for="b_from">Leito inicial</label>
            <input id="b_from" class="input" inputmode="numeric" placeholder="1" />
          </div>
          <div>
            <label class="label" for="b_to">Leito final</label>
            <input id="b_to" class="input" inputmode="numeric" placeholder="13/16" />
          </div>
        </div>
        <div style="margin:10px 0;position:sticky;top:0;background:var(--card);padding:10px 0;border-bottom:1px solid var(--border);z-index:10">
          <button class="btn primary" id="b_generate">Gerar QR Codes</button>  
          <button class="btn" onclick="window.print()">Imprimir</button>
          <button class="btn" data-close="#modalBulkQR">Fechar</button>
        </div>
        <div id="qr_grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
      </div>
    </div>
  </div>

  <div id="modalQRExpired" class="backdrop">
    <div class="modal" style="max-width:520px">
      <header><strong>Sessão Expirada</strong></header>
      <div class="content">
        <p>O tempo para preenchimento expirou.</p>
        <p>Para continuar, escaneie novamente o QR code próximo ao leito.</p>
      </div>
      <div class="actions">
        <button class="btn primary" id="reloadPage">Escanear Novamente</button>
      </div>
    </div>
  </div>
  
  <div id="successMessage" class="success-message">
    <h2>Obrigado!</h2>
    <p>Operação realizada com sucesso.</p>
    <p style="color:var(--text-muted);font-size:14px">Você pode fechar o navegador.</p>
    <button class="btn primary" onclick="window.close()">Fechar Navegador</button>
  </div>

<script>
// =======================================================================
// ========================== CONFIGURAÇÃO ===============================
// =======================================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbzn8BlUD8by0GykYlJa1pmbYtuXOr8aEUzOOBhpfSGl-i1x8LhAnGSRzqdyV2lANnIP/exec';

function logInfo(message, data = null) { console.log(`🔵 [Archipelago] ${message}`, data || ''); }
function logSuccess(message, data = null) { console.log(`🟢 [SUCCESS] ${message}`, data || ''); }
function logError(message, error = null) { console.error(`🔴 [ERROR] ${message}`, error || ''); }
function logWarning(message, data = null) { console.warn(`🟡 [WARNING] ${message}`, data || ''); }

const HOSPITAIS = {
  H1: { nome:"Neomater", leitos:[...Array.from({length:10}, (_,i)=>({ id:i+1,  tipo:"Enfermaria/Apto" })), ...Array.from({length:3},  (_,i)=>({ id:11+i, tipo:"UTI" }))]},
  H2: { nome:"Cruz Azul", leitos:[...Array.from({length:16}, (_,i)=>({ id:i+1, tipo:"Enfermaria/Apto" }))]}
};

const banco = { H1: [], H2: [] };
const LINHAS = ["APS","Assistencia","Cardiologia","Geriatria","Melhor Cuidado","Neurologia","Pneumologia"];
const CONC = ["Aspiracoes","Curativos","Fisioterapia","Fonoaudiologia","PAD"];

// Cores originais dos gráficos usando CSS variables
const LINHAS_CORES = {
  "APS": "#f59e0b", 
  "Assistencia": "#0a2b52", 
  "Cardiologia": "#dc2626",
  "Geriatria": "#16a34a", 
  "Melhor Cuidado": "#be185d", 
  "Neurologia": "#0891b2",
  "Pneumologia": "#8b5cf6"
};

const CONC_CORES = {
  "Aspiracoes": "#dc2626", 
  "Curativos": "#8b5cf6",
  "Fisioterapia": "#16a34a", 
  "Fonoaudiologia": "#f59e0b", 
  "PAD": "#0a2b52"
};

// =======================================================================
// ========================== ESTADO DA UI ===============================
// =======================================================================
let currentHospital = "H1";
let activeTab = "leitos";
let selectedLeito = null;
let isQRMode = false;
let qrSessionTimeout = null;
let lastUpdateTime = Date.now();
let autoRefreshInterval = null;
let updateIndicatorInterval = null;
let sortState = { key: 'leito', direction: 'asc' };
let currentViewMode = 'separate'; // Para o switch de visualização

// =======================================================================
// ===================== FUNÇÕES DE LOADING ============================
// =======================================================================
function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }, 500);
}

// =======================================================================
// ========================== FUNÇÕES HELPERS ============================
// =======================================================================
const $ = sel => document.querySelector(sel);

function openModal(sel){ const el=$(sel); if(el) { el.style.display="flex"; el.setAttribute("aria-hidden","false"); } }
function closeModal(sel){ const el=$(sel); if(el) { el.style.display="none"; el.setAttribute("aria-hidden","true"); } }

function confirmAction(msg){
  return new Promise(res=>{
    $("#confirmMsg").textContent = msg || "Confirma?";
    openModal("#modalConfirm");
    $("#confirmYes").onclick = ()=>{ closeModal("#modalConfirm"); res(true); };
    $("#confirmNo").onclick  = ()=>{ closeModal("#modalConfirm"); res(false); };
  });
}

function initials(nome){ if(!nome) return "—"; return nome.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase(); }

function fmtDateTime(iso){
  if(!iso) return "—";
  const d=new Date(iso);
  return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function elapsedMsToDays(ms) {
  if (ms === null || ms === undefined) return 0;
  return Math.floor(ms / 86400000);
}

function elapsedSince(iso){
  if(!iso) return { text: "—", days: 0 };
  const ms = Date.now() - new Date(iso).getTime();
  const d = elapsedMsToDays(ms);
  const h = Math.floor((ms%86400000)/3600000);
  return { text: `${d}d ${h}h`, days: d };
}

function showSuccessMessage() { document.getElementById('successMessage').style.display = 'block'; }

function updateTimeIndicator() {
  if(isQRMode) return;
  const indicator = document.getElementById('lastUpdateInfo');
  if(indicator) {
    const elapsed = Math.floor((Date.now() - lastUpdateTime) / 1000);
    const seconds = elapsed % 60;
    const minutes = Math.floor(elapsed / 60);
    if (minutes > 0) {
      indicator.textContent = `Atualizado há ${minutes}m`;
    } else {
      indicator.textContent = `Atualizado há ${seconds}s`;
    }
  }
}

// =======================================================================
// ===================== FUNÇÕES DE API (BACKEND) ========================
// =======================================================================
async function testConnection() {
  logInfo("Testando conexão com a API...");
  try {
    const res = await fetch(API_URL + '?action=test');
    if (res.ok) {
      logSuccess("Conexão com a API estabelecida!");
      return true;
    }
    logError(`Falha na conexão: HTTP ${res.status}`);
    return false;
  } catch(error) {
    logError("Erro ao testar conexão:", error);
    return false;
  }
}

async function loadAllData() {
  await Promise.all([
      loadHospital('H1'),
      loadHospital('H2')
  ]);
}

function processarDadosLeito(dadosBrutos) {
  // Função para processar e mapear corretamente os dados de cada leito
  return dadosBrutos.map(leito => {
    // Se os dados vierem da API como objeto estruturado
    if (typeof leito === 'object' && leito !== null) {
      return {
        hospital: leito.hospital || leito.H || '',
        leito: parseInt(leito.leito || leito.bed || leito.id || 0),
        tipo: leito.tipo || leito.type || 'Enfermaria/Apto',
        status: leito.status || 'Vago',
        nome: leito.nome || leito.name || null,
        idade: parseInt(leito.idade || leito.age || 0) || null,
        matricula: leito.matricula || leito.registration || null,
        pps: parseInt(leito.pps || 0) || null,
        spict: leito.spict || 'nao_elegivel',
        complexidade: leito.complexidade || leito.complexity || null,
        prevAlta: leito.prevAlta || leito.discharge || null,
        linhas: Array.isArray(leito.linhas) ? leito.linhas : 
                (typeof leito.linhas === 'string' && leito.linhas !== 'Sem previsao') ? 
                leito.linhas.split(',').map(l => l.trim()).filter(l => l && l !== 'Sem previsao') : [],
        concessoes: Array.isArray(leito.concessoes) ? leito.concessoes : 
                   (typeof leito.concessoes === 'string') ? 
                   leito.concessoes.split(',').map(c => c.trim()).filter(c => c) : [],
        admAt: leito.admAt || leito.admission || null
      };
    }
    
    // Se os dados vierem como array (da planilha)
    if (Array.isArray(leito)) {
      return {
        hospital: leito[0] || '',
        leito: parseInt(leito[1]) || 0,
        tipo: leito[2] || 'Enfermaria/Apto', 
        status: leito[3] || 'Vago',
        nome: leito[4] || null,
        matricula: leito[5] || null,
        idade: parseInt(leito[6]) || null,
        admAt: leito[7] || null,
        pps: parseInt(leito[8]) || null,
        spict: leito[9] || 'nao_elegivel',
        complexidade: leito[10] || null,  // Coluna K = complexidade
        prevAlta: leito[11] || null,      // Coluna L = prevAlta  
        linhas: (leito[12] && leito[12] !== 'Sem previsao') ? 
               leito[12].split(',').map(l => l.trim()).filter(l => l) : [],
        concessoes: leito[13] ? 
                   leito[13].split(',').map(c => c.trim()).filter(c => c) : []
      };
    }
    
    return leito; // Retorna como está se não conseguir processar
  });
}

async function loadHospital(h) {
  logInfo(`Iniciando carregamento do hospital: ${h}`);
  try {
    const url = `${API_URL}?action=state&hospital=${h}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'Resposta da API indica erro');
    
    // CORREÇÃO: Processar dados corretamente
    banco[h] = processarDadosLeito(json.data);
    lastUpdateTime = Date.now();
    logSuccess(`Dados carregados com sucesso para ${h}. Total de leitos: ${banco[h].length}`);
    
    if (activeTab === 'leitos') renderCards();
  } catch(error) {
    logError(`Erro ao carregar hospital ${h}:`, error);
    
    // DADOS DE TESTE CORRIGIDOS - SIMULANDO ESTRUTURA DA PLANILHA
    const dadosTesteEstruturados = [];
    
    // Simular dados como se viessem da planilha
    HOSPITAIS[h].leitos.forEach((leito, index) => {
      const isOcupado = index % 3 !== 0;
      
      if (isOcupado) {
        // Dados de exemplo baseados na planilha
        dadosTesteEstruturados.push([
          h,                                           // hospital
          leito.id,                                   // leito  
          leito.tipo,                                 // tipo
          "Em uso",                                   // status
          `Paciente ${h}-${leito.id}`,              // nome
          `${h}${String(leito.id).padStart(6, '0')}`, // matricula
          45 + (index * 7) % 40,                      // idade
          new Date(Date.now() - (index * 24 * 60 * 60 * 1000)).toISOString(), // admAt
          (index % 10) + 1,                          // pps
          index % 2 === 0 ? "elegivel" : "nao_elegivel", // spict
          ["I", "II", "III"][index % 3],             // complexidade (posição 10)
          ["24h Ouro", "48h", "72h", "96h", "Sem previsao"][index % 5], // prevAlta (posição 11)
          LINHAS.slice(0, Math.max(1, (index % 4))).join(','), // linhas (posição 12)
          CONC.slice(0, Math.max(1, (index % 3))).join(',')    // concessoes (posição 13)
        ]);
      } else {
        // Leito vago
        dadosTesteEstruturados.push([
          h, leito.id, leito.tipo, "Vago", null, null, null, null, null, null, null, null, "", ""
        ]);
      }
    });
    
    // Processar os dados de teste através da função de mapeamento
    banco[h] = processarDadosLeito(dadosTesteEstruturados);
    logWarning(`Usando dados de teste estruturados para ${h}. Total: ${banco[h].length}`);
    
    if (activeTab === 'leitos') renderCards();
  }
}

async function apiCall(payload) {
  logInfo(`Iniciando operação: ${payload.action}`, payload);
  try {
    const params = new URLSearchParams();
    for (const [key, value] of Object.entries(payload)) {
      if (Array.isArray(value)) params.append(key, value.join('|'));
      else if (value !== null && value !== undefined && value !== '') params.append(key, String(value));
    }
    
    const url = `${API_URL}?${params.toString()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'Erro na operação');
    
    logSuccess(`Operação ${payload.action} realizada com sucesso!`);
    return json.data;
  } catch(error) {
    logError(`Erro na operação ${payload.action}:`, error);
    throw new Error(error.message || 'Erro na operação');
  }
}

// =======================================================================
// ======================= LÓGICA DE NAVEGAÇÃO =========================
// =======================================================================
function setTab(tab){
  document.querySelectorAll(".side-menu-item").forEach(b=>b.classList.remove("active"));
  
  const activeSideMenuItem = $(`.side-menu-item[data-tab='${tab}']`);
  if(activeSideMenuItem) activeSideMenuItem.classList.add("active");

  activeTab = tab;
  route();
  
  if(tab.startsWith('dash')) {
    setTimeout(() => renderDashboards(), 50);
  }
}

function setHospitalSelectors(h){
  currentHospital = h;
  // Atualizar botões novos
  document.querySelectorAll('.hospital-btn').forEach(btn => btn.classList.remove('active'));
  $(`.hospital-btn[data-h="${h}"]`)?.classList.add('active');
  
  // Manter compatibilidade com botões antigos
  document.querySelectorAll('.btn[data-h]').forEach(btn => btn.classList.remove('active'));
  $(`.btn[data-h="${h}"]`)?.classList.add('active');
}

function route(){
  const sections = ["leitosView","dash1","dash2","dash3"];
  sections.forEach(id => {
    const el = $(`#${id}`);
    if(el) el.classList.add("hidden");
  });

  const activeSectionId = activeTab === 'leitos' ? 'leitosView' : activeTab;
  $(`#${activeSectionId}`)?.classList.remove("hidden");

  // Mostrar seletor de hospital apenas no modo leitos
  const hospitalSelector = $('#hospitalSelector');
  if (hospitalSelector) {
    if (activeTab === 'leitos') {
      hospitalSelector.style.display = 'flex';
    } else {
      hospitalSelector.style.display = 'none';
    }
  }

  if(activeTab === "leitos") renderCards();
}

// =======================================================================
// ======================= RENDERIZAÇÃO DE LEITOS ======================
// =======================================================================
function renderCards(){
  const container = $("#leitosView");
  if(!container) return;
  
  container.innerHTML = "";
  const leitos = banco[currentHospital] || [];

  if(leitos.length === 0) {
      container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted);">Nenhum leito para exibir ou aguardando dados...</p>`;
      return;
  }

  leitos.forEach(l=>{
    const card = document.createElement("div");
    card.className = "card";

    const statusClass = l.status==="Em uso" ? "warn" : "ok";
    const tipoClass   = l.tipo==="UTI" ? "uti" : "enf";
    
    // Exibição correta dos dados
    const complexidadeDisplay = l.complexidade ? `Nível ${l.complexidade}` : "—";
    const prevAltaDisplay = l.prevAlta || "—";
    
    // Processar linhas e concessões
    let linhasChips = "";
    let concessoesChips = "";
    
    if (Array.isArray(l.linhas) && l.linhas.length > 0) {
      linhasChips = l.linhas.map(x=>`<span class="chip">${x}</span>`).join("");
    }
    
    if (Array.isArray(l.concessoes) && l.concessoes.length > 0) {
      concessoesChips = l.concessoes.map(x=>`<span class="chip">${x}</span>`).join("");
    }
    
    card.innerHTML = `
      <div class="top">
        <div class="wrap">
          <span class="status ${statusClass}">Leito ${l.leito} — ${l.status}</span>
          <span class="tipo ${tipoClass}">${l.tipo}</span>
        </div>
        <span class="badge">${HOSPITAIS[l.hospital].nome}</span>
      </div>
      <div class="row">
        <div class="field"><div class="label">Iniciais</div><div class="value">${l.status==="Em uso"?initials(l.nome):"—"}</div></div>
        <div class="field"><div class="label">Matrícula</div><div class="value">${l.matricula||"—"}</div></div>
        <div class="field"><div class="label">Idade</div><div class="value">${l.idade??"—"}</div></div>
        <div class="field"><div class="label">Tempo de Internação</div><div class="value">${l.status === "Em uso" ? elapsedSince(l.admAt).text : "—"}</div></div>
        <div class="field"><div class="label">PPS</div><div class="value">${l.pps??"—"}</div></div>
        <div class="field"><div class="label">SPICT-BR</div><div class="value">${l.spict==="elegivel"?"Elegível":(l.spict==="nao_elegivel"?"Não elegível":"—")}</div></div>
        <div class="field"><div class="label">Complexidade</div><div class="value">${complexidadeDisplay}</div></div>
        <div class="field" style="grid-column: 4 / 5"><div class="label">Prev. Alta</div><div class="value">${prevAltaDisplay}</div></div>
        <div class="field" style="grid-column:1/3">
          <div class="label">Linhas de cuidado</div><div class="wrap">${linhasChips||`<span style="color: var(--text-muted);">—</span>`}</div>
        </div>
        <div class="field" style="grid-column:3/5">
          <div class="label">Concessões</div><div class="wrap">${concessoesChips||`<span style="color: var(--text-muted);">—</span>`}</div>
        </div>
      </div>
      <div class="actions">
        ${l.status==="Vago"
          ? `<button class="btn primary" data-act="admitir">Admitir</button>`
          : `<button class="btn" data-act="atualizar">Atualizar / Ver Detalhes</button>`
        }
      </div>
    `;

    const admitBtn = card.querySelector('[data-act="admitir"]');
    if(admitBtn) admitBtn.addEventListener('click', () => openAdmissao(l.leito));
    
    const updateBtn = card.querySelector('[data-act="atualizar"]');
    if(updateBtn) updateBtn.addEventListener('click', () => openAtualizacao(l.leito));

    container.appendChild(card);
  });
}
